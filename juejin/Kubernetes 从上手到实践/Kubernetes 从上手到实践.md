

# å¼€ç¯‡ï¼š Kubernetes æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒ

Kubernetes æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ï¼Œç”¨äºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºç¼–æ’ï¼Œç®¡ç†çš„å¹³å°ã€‚ç”± Google äº 2014 å¹´åŸºäºå…¶å¤§è§„æ¨¡ç”Ÿäº§å®è·µç»éªŒè€Œå¼€æºå‡ºæ¥çš„ã€‚Kubernetes ç›®å‰åœ¨å®¹å™¨ç¼–æ’é¢†åŸŸå·²ç»æˆä¸ºäº‹å®ä¸Šçš„æ ‡å‡†ï¼Œç¤¾åŒºä¹Ÿéå¸¸æ´»è·ƒã€‚

Kubernetes åœ¨å›½å†…å¤–éƒ½å·²ç»å¾—åˆ°å¹¿æ³›çš„åº”ç”¨ï¼Œæ— è®ºæ˜¯Google, Amazon, GitHub ç­‰è¿˜æ˜¯å›½å†…çš„é˜¿é‡Œï¼Œè…¾è®¯ï¼Œç™¾åº¦ï¼Œåä¸ºï¼Œäº¬ä¸œæˆ–å…¶ä»–ä¸­å°å…¬å¸ç­‰ä¹Ÿéƒ½å·²å…¨åŠ›æ¨è¿› Kubernetes åœ¨ç”Ÿäº§ä¸­çš„ä½¿ç”¨ã€‚

ç°åœ¨æ— è®ºæ˜¯è¿ç»´ï¼Œåç«¯ï¼ŒDBAï¼Œäº¦æˆ–è€…æ˜¯å‰ç«¯ï¼Œæœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆç­‰éƒ½éœ€è¦åœ¨å·¥ä½œä¸­æˆ–å¤šæˆ–å°‘çš„ç”¨åˆ° Dockerï¼Œ è€Œåœ¨ç”Ÿäº§ä¸­å¤§é‡ä½¿ç”¨çš„è¯ Kubernetes ä¹Ÿå°†ä¼šæˆä¸ºè¶‹åŠ¿ï¼Œæ‰€ä»¥äº†è§£æˆ–æŒæ¡ Kubernetes ä¹Ÿæˆä¸ºäº†å·¥ç¨‹å¸ˆå¿…ä¸å¯å°‘çš„æŠ€èƒ½ä¹‹ä¸€ã€‚

## Kubernetes æ˜¯ä»€ä¹ˆ?

å½“æåˆ° Kubernetes çš„æ—¶å€™ï¼Œå¤§å¤šæ•°äººçš„å¯èƒ½ä¼šæƒ³åˆ°å®ƒå¯ä»¥å®¹å™¨ç¼–æ’ï¼Œæƒ³åˆ°å®ƒæ˜¯ PaaS (Platform as a Service) ç³»ç»Ÿï¼Œä½†å…¶å®ä¸ç„¶ï¼ŒKubernetes å¹¶ä¸æ˜¯ PasS ç³»ç»Ÿï¼Œå› ä¸ºå®ƒå·¥ä½œåœ¨å®¹å™¨å±‚è€Œä¸æ˜¯ç¡¬ä»¶å±‚ï¼Œå®ƒåªä¸è¿‡æä¾›äº†ä¸€äº›ä¸ PasS ç±»ä¼¼æˆ–è€…å…±åŒçš„åŠŸèƒ½ï¼Œç±»ä¼¼éƒ¨ç½²ï¼Œæ‰©å®¹ï¼Œç›‘æ§ï¼Œè´Ÿè½½å‡è¡¡ï¼Œæ—¥å¿—è®°å½•ç­‰ã€‚ç„¶è€Œå®ƒå¹¶ä¸æ˜¯ä¸ªå®Œå…¨ä¸€ä½“åŒ–çš„å¹³å°ï¼Œè¿™äº›åŠŸèƒ½åŸºæœ¬éƒ½æ˜¯å¯é€‰å¯é…ç½®çš„ã€‚

Kubernetes å¯æ”¯æŒå…¬æœ‰äº‘ï¼Œç§æœ‰äº‘åŠæ··åˆäº‘ç­‰ï¼Œå…·å¤‡è‰¯å¥½çš„å¯ç§»æ¤æ€§ã€‚æˆ‘ä»¬å¯ç›´æ¥ä½¿ç”¨å®ƒæˆ–åœ¨å…¶ä¹‹ä¸Šæ„å»ºè‡ªå·±çš„å®¹å™¨/äº‘å¹³å°ï¼Œä»¥è¾¾åˆ°å¿«é€Ÿéƒ¨ç½²ï¼Œå¿«é€Ÿæ‰©å±•ï¼ŒåŠä¼˜åŒ–èµ„æºä½¿ç”¨ç­‰ã€‚

å®ƒè‡´åŠ›äºæä¾›é€šç”¨æ¥å£ç±»ä¼¼ CNI( Container Network Interface ), CSIï¼ˆContainer Storage Interfaceï¼‰, CRIï¼ˆContainer Runtime Interfaceï¼‰ç­‰è§„èŒƒï¼Œä»¥ä¾¿æœ‰æ›´å¤šå¯èƒ½, è®©æ›´å¤šçš„å‚å•†å…±åŒåŠ å…¥å…¶ç”Ÿæ€ä½“ç³»å†…ã€‚å®ƒçš„ç›®æ ‡æ˜¯å¸Œæœ›åœ¨ä»¥åï¼Œä»»ä½•å›¢é˜Ÿéƒ½å¯ä»¥åœ¨ä¸ä¿®æ”¹ Kubernetes æ ¸å¿ƒä»£ç çš„å‰æä¸‹ï¼Œå¯ä»¥æ–¹ä¾¿çš„æ‰©å±•å’Œæ„å»ºç¬¦åˆè‡ªå·±éœ€æ±‚çš„å¹³å°ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ Kubernetes

æˆ‘ä»¬å›åˆ°å®é™…çš„å·¥ä½œç¯å¢ƒä¸­ã€‚

- å¦‚æœä½ æ˜¯ä¸ªå‰ç«¯ï¼Œä½ æ˜¯å¦é‡åˆ°è¿‡ npm ä¾èµ–å®‰è£…ææ…¢ï¼Œæˆ–æ˜¯ node sass å®‰è£…ä¸äº†æˆ–è€…ç‰ˆæœ¬ä¸å¯¹çš„æƒ…å†µï¼Ÿ
- å¦‚æœä½ æ˜¯ä¸ªåç«¯ï¼Œæ˜¯å¦é‡åˆ°è¿‡æœåŠ¡å™¨ä¸æœ¬åœ°ç¯å¢ƒä¸ä¸€è‡´çš„æƒ…å†µï¼Œå¯¼è‡´éƒ¨åˆ†åŠŸèƒ½å‡ºç°éé¢„æœŸçš„æƒ…å†µï¼Ÿ
- å¦‚æœä½ æ˜¯ä¸ªè¿ç»´ï¼Œæ˜¯å¦é‡åˆ°è¿‡é¢‘ç¹éƒ¨ç½²ç¯å¢ƒï¼Œä½†ä¸­é—´å¯èƒ½å‡ºç°å„ç§å®‰è£…ä¸äº†æˆ–è€…ç‰ˆæœ¬ä¸å¯¹çš„é—®é¢˜ï¼Ÿ

ç›®å‰æ¥çœ‹ï¼Œå¯¹äºè¿™äº›é—®é¢˜ï¼Œæœ€å¥½çš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯æ ‡å‡†åŒ–ï¼Œå®¹å™¨åŒ–ï¼Œç°åœ¨ç”¨åˆ°æœ€å¤šçš„ä¹Ÿå°±æ˜¯ Dockerã€‚ Docker é€šè¿‡ Dockerfile æ¥å¯¹ç¯å¢ƒè¿›è¡Œæè¿°ï¼Œé€šè¿‡é•œåƒè¿›è¡Œäº¤ä»˜ï¼Œä½¿ç”¨æ—¶ä¸å†éœ€è¦å…³æ³¨ç¯å¢ƒä¸ä¸€è‡´ç›¸å…³çš„é—®é¢˜ã€‚

ç°åœ¨é¢è¯•çš„æ—¶å€™ï¼Œæ— è®ºå‰åç«¯ï¼Œæˆ‘ä»¬æ€»ä¼šå¤šé—®ä¸‹æ˜¯å¦äº†è§£æˆ–è€…ä½¿ç”¨è¿‡ Docker ã€‚å¦‚æœä½¿ç”¨è¿‡ï¼Œé‚£è‡ªç„¶ä¼šé—®å¦‚æœè§„æ¨¡å˜å¤§æˆ–è€…åœ¨ç”Ÿäº§ä¸­å¦‚ä½•è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œéƒ¨ç½²æ‰©å®¹æœºåˆ¶å¦‚ä½•ã€‚

å¤šæ•°äººåœ¨è¿™ä¸ªæ—¶å€™éƒ½å·²ç»å›ç­”ä¸ä¸Šæ¥äº†ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºéè¿ç»´ç›¸å…³å²—ä½çš„åŒå­¦ï¼Œå¯èƒ½åœ¨å®é™…å·¥ä½œä¸­å¹¶ä¸äº†è§£æ•´ä½“çš„æ¶æ„ä½“ç³»ï¼Œæ²¡æœ‰ç›¸å…³çš„çŸ¥è¯†ç§¯ç´¯ã€‚å¦ä¸€æ–¹é¢ï¼Œå¯¹äºè¿ç»´åŒå­¦å¯èƒ½å°šæœªæ¥è§¦åˆ°è¿™éƒ¨åˆ†ã€‚

ä½œä¸ºä¸€ä¸ªæŠ€æœ¯äººå‘˜ï¼Œæˆ‘ä»¬åº”è¯¥å¯¹æ•´ä½“çš„ä½“ç³»æ¶æ„æœ‰æ‰€äº†è§£, æŒæ¡æ›´å¤šçš„æŠ€èƒ½ï¼Œäº†è§£è½¯ä»¶çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¼€å‘ï¼Œäº¤ä»˜ï¼Œéƒ¨ç½²ï¼Œä»¥åŠå½“æµé‡å˜å¤§æ—¶çš„æ‰©å®¹ç­‰ã€‚

åœ¨å®¹å™¨ç¼–æ’é¢†åŸŸï¼Œæ¯”è¾ƒè‘—åçš„ä¸»è¦æœ‰ä¸‰ä¸ªï¼šKubernetes, Mesos, åŠ Docker è‡ªå®¶çš„ Swarm . å¯¹è¿™ä¸‰è€…è€Œè¨€ï¼Œè¾ƒä¸ºç®€å•çš„æ˜¯ Swarm, å› ä¸ºå®ƒæœ¬èº«åªä¸“æ³¨äºå®¹å™¨ç¼–æ’ï¼Œå¹¶ä¸”æ˜¯å®˜æ–¹å›¢é˜Ÿæ‰€ä½œï¼Œä»å„æ–¹é¢æ¥çœ‹ï¼Œå¯¹äºæ–°æ‰‹éƒ½ç›¸å¯¹å‹å¥½ä¸€äº›ã€‚ä½†å¦‚æœæ˜¯ç”¨äºç”Ÿäº§ä¸­å¤§è§„æ¨¡ä½¿ç”¨ï¼Œåè€Œå°±ç•¥æœ‰ä¸åŠã€‚

è€Œ Mesos ä¹Ÿå¹¶ä¸ä»…é™äºå®¹å™¨ç¼–æ’ï¼Œå®ƒçš„åˆ›å»ºæœ¬èº«æ˜¯ä¸ºäº†å°†æ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰èµ„æºè¿›è¡ŒæŠ½è±¡ï¼Œæ¯”å¦‚ CPUï¼Œå†…å­˜ï¼Œç½‘ç»œï¼Œå­˜å‚¨ç­‰ï¼Œå°†æ•´ä¸ª Mesos é›†ç¾¤å½“ä½œæ˜¯ä¸€ä¸ªå¤§çš„èµ„æºæ± ï¼Œå…è®¸å„ç§ Framework æ¥è¿›è¡Œè°ƒåº¦ã€‚æ¯”å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ Marathon æ¥å®ç° PaaSï¼Œå¯ä»¥è¿è¡Œ Sparkï¼ŒHadoop ç­‰è¿›è¡Œè®¡ç®—ç­‰ã€‚åŒæ—¶å› ä¸ºå®ƒæ”¯æŒæ¯”å¦‚ Docker æˆ–è€… LXC ç­‰ä½œèµ„æºéš”ç¦»ï¼Œæ‰€ä»¥å‰å‡ å¹´ä¹Ÿè¢«å¤§é‡ç”¨äºå®¹å™¨ç¼–æ’ã€‚

éšç€ Kubernetes åœ¨ç›®å‰çš„è®¤å¯åº¦å·²ç»è¶…è¿‡ Mesosï¼Œ Docker Swarm ç­‰ï¼Œæ— ç–‘å®ƒæ˜¯ç”Ÿäº§ç¯å¢ƒä¸­å®¹å™¨åº”ç”¨ç®¡ç†çš„ä¸äºŒä¹‹é€‰ã€‚

æœ¬å°å†Œçš„ç›®æ ‡æ˜¯å¸®åŠ©æ›´å¤šå¼€å‘è€…ï¼ˆä¸å±€é™äºè¿ç»´ï¼Œåç«¯ï¼Œå‰ç«¯ç­‰ï¼‰è®¤è¯†å¹¶æŒæ¡ Kubernetes çš„åŸºç¡€æŠ€èƒ½ï¼Œäº†è§£å…¶åŸºç¡€æ¶æ„ç­‰ã€‚ä½†æ˜¯ Kubernetes æ¶‰åŠçŸ¥è¯†ç‚¹å¾ˆå¤šï¼Œä¸”æ›´æ–°è¿­ä»£å¾ˆå¿«ï¼Œæœ¬å°å†Œé›†ä¸­äºä½¿ç”¨è½»å¿«çš„æ–‡å­—å¸®åŠ©å¤§å®¶æŒæ¡ K8S çš„é€šç”¨åŸºç¡€æŠ€èƒ½ï¼Œå¯¹äºå…¶ä¸­éœ€æŒæ¡çš„å…³äº Dockerï¼ŒåŠ Linux å†…æ ¸ç›¸å…³çš„çŸ¥è¯†ä¸ä¼šè¿‡äºæ·±å…¥è§£é‡Šã€‚ä¸»è¦ä»¥æœ€å¸¸è§ case å…¥æ‰‹ï¼Œå¸®åŠ©å¤§å®¶æ›´å¿«çš„æŒæ¡ç›¸å…³çŸ¥è¯†å¹¶å°†å…¶ç”¨äºç”Ÿäº§å®è·µä¸­ã€‚

# åˆæ­¥è®¤è¯†ï¼šKubernetes åŸºç¡€æ¦‚å¿µ

å¥½äº†ï¼Œæ€»ç®—å¼€å§‹è¿›å…¥æ­£é¢˜ï¼ŒæŠ›å¼ƒæ‰æ­»æ¿çš„è¯´æ•™æ¨¡å¼ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªè™šæ„çš„æ–°æˆç«‹çš„é¡¹ç›®ç»„ä¸ºä¾‹å¼€å§‹æˆ‘ä»¬çš„ Kubernetes æ¢ç´¢ã€‚(ä»¥ä¸‹ç»Ÿä¸€å°† Kubernetes ç®€å†™ä¸º K8S) é¡¹ç›®ç»„ç›®å‰å°±åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼Œæˆ‘ä»¬ç§°ä»–ä¸ºå°å¼ ã€‚é¡¹ç›®ç»„åˆšæˆç«‹çš„æ—¶å€™ï¼Œå°å¼ ä¹Ÿæ²¡æƒ³å¥½ï¼Œå…·ä½“è¦åšä»€ä¹ˆï¼Œä½†è‚¯å®šè¦å¯¹å¤–æä¾›æœåŠ¡çš„ï¼Œæ‰€ä»¥å…ˆå‘å…¬å¸ç”³è¯·äº†ä¸€å°æœåŠ¡å™¨ã€‚

## Node

è¿™å°æœåŠ¡å™¨å¯ä»¥ç”¨æ¥åšä»€ä¹ˆå‘¢ï¼Ÿè·‘æœåŠ¡ï¼Œè·‘æ•°æ®åº“ï¼Œè·‘æµ‹è¯•ä¹‹ç±»çš„éƒ½å¯ä»¥ï¼Œæˆ‘ä»¬å°†å®ƒæ‰€åšçš„äº‹æƒ…ç»Ÿç§°ä¸ºå·¥ä½œ(work) é‚£ä¹ˆï¼Œå®ƒä¾¿æ˜¯å·¥ä½œèŠ‚ç‚¹ (worker Node) å¯¹åº”äº K8S ä¸­ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬é¦–å…ˆè¦è®¤è¯†çš„ Node ã€‚

Node å¯ä»¥æ˜¯ä¸€å°ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæœºï¼Œå¯¹äºæˆ‘ä»¬æ­¤å¤„çš„é¡¹ç›®æ¥è®²ï¼Œè¿™å°æœåŠ¡å™¨ä¾¿æ˜¯ K8S ä¸­çš„ Node ã€‚

### Node çŠ¶æ€

å½“æˆ‘ä»¬æ‹¿åˆ°è¿™å°æœåŠ¡å™¨åï¼Œé¦–å…ˆæˆ‘ä»¬ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹ä¸‹æœåŠ¡å™¨çš„åŸºæœ¬é…ç½®å’Œä¿¡æ¯ã€‚å…¶å®å¯¹äºä¸€ä¸ªæ–°åŠ å…¥ K8S é›†ç¾¤çš„ Node ä¹Ÿæ˜¯ä¸€æ ·ï¼Œéœ€è¦å…ˆæ£€æŸ¥å®ƒçš„çŠ¶æ€ï¼Œå¹¶å°†çŠ¶æ€ä¸ŠæŠ¥è‡³é›†ç¾¤çš„ master ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹æœåŠ¡å™¨æœ‰å“ªäº›ä¿¡æ¯æ˜¯æˆ‘ä»¬æ‰€å…³å¿ƒçš„ã€‚

#### åœ°å€

é¦–å…ˆï¼Œæˆ‘ä»¬æ‰€å…³å¿ƒçš„æ˜¯æˆ‘ä»¬æœåŠ¡å™¨çš„ IP åœ°å€ï¼ŒåŒ…æ‹¬å†…ç½‘ IP å’Œå¤–ç½‘ IPã€‚å¯¹åº”äº K8S é›†ç¾¤çš„è¯è¿™ä¸ªæ¦‚å¿µæ˜¯ç±»ä¼¼çš„ï¼Œå†…éƒ¨ IP å¯åœ¨ K8S é›†ç¾¤å†…è®¿é—®ï¼Œå¤–éƒ¨ IP å¯åœ¨é›†ç¾¤å¤–è®¿é—®ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå…³å¿ƒä¸€ä¸‹æˆ‘ä»¬çš„ä¸»æœºåï¼Œæ¯”å¦‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `hostname` å‘½ä»¤ï¼Œä¾¿å¯å¾—åˆ°ä¸»æœºåã€‚K8S é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Node çš„ä¸»æœºåä¹Ÿä¼šè¢«è®°å½•ä¸‹æ¥ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™ Kubelet ä¼ é€’ä¸€ä¸ª `--hostname-override` çš„å‚æ•°æ¥è¦†ç›–é»˜è®¤çš„ä¸»æœºåã€‚ (Kubelet æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬åé¢ä¼šè§£é‡Š)

#### ä¿¡æ¯

å†ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸‹æœåŠ¡å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚çœ‹çœ‹ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯ï¼Œ `cat /etc/issue` æˆ–è€… `cat /etc/os-release` ç­‰æ–¹æ³•å‡å¯æŸ¥çœ‹ã€‚å¯¹äº K8S é›†ç¾¤ä¼šå°†æ¯ä¸ª Node çš„è¿™äº›åŸºç¡€ä¿¡æ¯éƒ½è®°å½•ä¸‹æ¥ã€‚

#### å®¹é‡

æˆ‘ä»¬é€šå¸¸ä¹Ÿéƒ½ä¼šå…³æ³¨ä¸‹ï¼Œæˆ‘ä»¬æœ‰å‡ ä¸ªæ ¸å¿ƒçš„ CPU ï¼Œå¯é€šè¿‡ `cat /proc/cpuinfo` æŸ¥çœ‹ï¼Œæœ‰å¤šå¤§çš„å†…å­˜ é€šè¿‡ `cat /proc/meminfo` æˆ– `free` ç­‰æŸ¥çœ‹ã€‚å¯¹äº K8S é›†ç¾¤ï¼Œä¼šé»˜è®¤ç»Ÿè®¡è¿™äº›ä¿¡æ¯ï¼Œå¹¶è®¡ç®—åœ¨æ­¤ Node ä¸Šå¯è°ƒåº¦çš„ Pod æ•°é‡ã€‚ï¼ˆPod åé¢åšè§£é‡Šï¼‰

#### æ¡ä»¶

å¯¹äºæˆ‘ä»¬æ‹¿åˆ°çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å…³å¿ƒä¸Šè¿°çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿™äº›ä¿¡æ¯è¿›è¡Œåˆ¤æ–­ï¼Œè¿™å°æœºå™¨æ˜¯å¦èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦ã€‚å¯¹ K8S é›†ç¾¤ä¹ŸåŒæ ·ï¼Œå½“åˆ¤æ–­ä¸Šè¿°ä¿¡æ¯å‡æ»¡è¶³è¦æ±‚æ—¶å€™ï¼Œä¾¿å°†é›†ç¾¤å†…è®°å½•çš„è¯¥ Node ä¿¡æ¯æ ‡è®°ä¸º `Ready` ï¼ˆ`Ready = True`ï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬çš„æœåŠ¡å™¨ä¾¿æ­£å¼çš„å®Œæˆäº¤ä»˜ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å…¶ä»–çš„éƒ¨åˆ†ã€‚

## Deployment å’Œ Pod

ç°åœ¨å°å¼ æ‹¿åˆ°çš„æœåŠ¡å™¨å·²ç»æ˜¯å¯ç”¨çŠ¶æ€ï¼Œè™½ç„¶æ­¤æ—¶å°šä¸çŸ¥è¦å…·ä½“åšä»€ä¹ˆï¼Œä½†å§‘ä¸”å…ˆéƒ¨ç½²ä¸€ä¸ªä¸»é¡µæ¥å®£å¸ƒä¸‹é¡¹ç›®ç»„çš„æˆç«‹ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€èˆ¬æƒ…å†µä¸‹çš„åšæ³•ï¼Œå…ˆå†™ä¸€ä¸ªé™æ€é¡µé¢ï¼Œæ¯”å¦‚å« index.html ç„¶ååœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨ä¸€ä¸ª Nginx æˆ–è€…å…¶ä»–ä»»ä½• Web æœåŠ¡å™¨ï¼Œæ¥æä¾›å¯¹ index.html çš„è®¿é—®ã€‚

Nginx çš„å®‰è£…åŠé…ç½®å¯å‚è€ƒ [Nginx çš„å®˜æ–¹æ–‡æ¡£](https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/)ã€‚æœ€ç®€å•çš„é…ç½®å¤§æ¦‚ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼ˆä»…ä¿ç•™å…³é”®éƒ¨åˆ†ï¼‰ï¼š

```
location / {
    root   /www;
    index  index.html;
}
```

å¯¹äº K8S è€Œè¨€ï¼Œæˆ‘ä»¬æƒ³è¦çš„ï¼Œèƒ½æä¾›å¯¹ index.html è®¿é—®çš„æœåŠ¡ä¾¿å¯ç†è§£ä¸º Deployment çš„æ¦‚å¿µï¼Œè¡¨æ˜ä¸€ç§æˆ‘ä»¬é¢„æœŸçš„ç›®æ ‡çŠ¶æ€ã€‚

è€Œå¯¹äº Nginx å’Œ index.html è¿™ä¸ªç»„åˆå¯ä»¥ç†è§£ä¸ºå…¶ä¸­çš„ Pod æ¦‚å¿µï¼Œä½œä¸ºæœ€å°çš„è°ƒåº¦å•å…ƒã€‚

## Container Runtime

è™½ç„¶æ­¤åˆ»éƒ¨ç½²çš„å†…å®¹åªæœ‰å®˜ç½‘ï¼Œä½†æ˜¯ä¸ºäº†é¿å…å•ç‚¹æ•…éšœï¼Œäºæ˜¯å°å¼ åˆç”³è¯·äº†ä¸¤å°æœåŠ¡å™¨ï¼ˆè™½ç„¶çœ‹èµ·æ¥å¯èƒ½æ˜¯æµªè´¹äº†ç‚¹ï¼‰ï¼Œç°åœ¨è¦å¯¹åŸæœ‰çš„æœåŠ¡è¿›è¡Œæ‰©å®¹ï¼Œå…¶å®åœ¨æ–°çš„æœåŠ¡å™¨ä¸Šæˆ‘ä»¬æ‰€åšçš„äº‹æƒ…ä¹Ÿè¿˜ä¿æŒåŸæ ·ï¼Œéƒ¨ç½² Nginxï¼Œæä¾›å¯¹ index.html çš„è®¿é—®ï¼Œç”šè‡³é…ç½®æ–‡ä»¶éƒ½å®Œå…¨æ˜¯ä¸€æ ·çš„ã€‚å¯ä»¥çœ‹åˆ°åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¢åŠ ä¸€å°æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€ä»¶å®Œå…¨é‡å¤çš„äº‹æƒ…ã€‚

æœ¬ç€ä¸æµªè´¹æ—¶é—´åšé‡å¤çš„å·¥ä½œçš„æƒ³æ³•ï¼Œå°å¼ æƒ³ï¼Œè¦ä¸ç„¶ç”¨ [Ansible](https://www.ansible.com/) æ¥ç»Ÿä¸€ç®¡ç†æœåŠ¡å™¨æ“ä½œå’Œé…ç½®å§ï¼Œä½†è€ƒè™‘åˆ°åç»­æœåŠ¡å™¨ä¸Šè¿˜éœ€è¦éƒ¨ç½²å…¶ä»–çš„æœåŠ¡ï¼Œå¸¸è§„çš„è¿™æ ·éƒ¨ç½²ï¼Œå®¹æ˜“å¹²æ‰°å½¼æ­¤çš„ç¯å¢ƒã€‚

æ‰€ä»¥æˆ‘ä»¬æƒ³åˆ°äº†ç”¨è™šæ‹ŸåŒ–çš„æŠ€æœ¯ï¼Œä½†æ˜¯æ ¹æ®ä¸€èˆ¬çš„ç»éªŒï¼Œç±»ä¼¼ [KVM](https://www.linux-kvm.org/page/Main_Page) è¿™æ ·çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå¯èƒ½åœ¨èµ„æºæ¶ˆè€—ä¸Šè¾ƒå¤š, ä¸å¤Ÿè½»é‡çº§ã€‚è€Œå®¹å™¨åŒ–ç›¸å¯¹æ¥çœ‹ï¼Œæ¯”è¾ƒè½»é‡çº§ï¼Œä¹Ÿæ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œä¸€æ¬¡æ„å»ºï¼Œéšå¤„æ‰§è¡Œã€‚æˆ‘ä»¬é€‰æ‹©å½“å‰æœ€çƒ­é—¨çš„ Docker .

æ—¢ç„¶æŠ€æœ¯é€‰å‹ç¡®å®šäº†ï¼Œé‚£å¾ˆç®€å•ï¼Œåœ¨æˆ‘ä»¬ç°åœ¨ä¸‰å°æœåŠ¡å™¨ä¸Šå®‰è£… Docker ï¼Œå®‰è£…è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼Œå¯ä»¥å‚è€ƒ [Docker çš„å®˜æ–¹å®‰è£…æ–‡æ¡£](https://docs.docker.com/install/linux/docker-ce/centos/) ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…ï¼Œä¹Ÿä¾¿åªæ˜¯å°†æˆ‘ä»¬çš„æœåŠ¡æ„å»ºæˆä¸€ä¸ªé•œåƒï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ª Dockerfileï¼Œæ„å»ºä¸€ä¸ªé•œåƒå¹¶éƒ¨ç½²åˆ°æ¯å°æœåŠ¡å™¨ä¸Šä¾¿å¯ã€‚

èŠäº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å°†æˆ‘ä»¬çš„æœåŠ¡è¿è¡Œåˆ°äº†å®¹å™¨ä¸­ï¼Œè€Œæ­¤å¤„çš„ Docker ä¾¿æ˜¯æˆ‘ä»¬é€‰æ‹©çš„å®¹å™¨è¿è¡Œæ—¶ã€‚é€‰æ‹©å®ƒçš„æœ€ä¸»è¦åŸå› ï¼Œä¾¿æ˜¯ä¸ºäº†ç¯å¢ƒéš”ç¦»å’Œé¿å…é‡å¤å·¥ä½œã€‚

è€Œ Docker å¦‚æœå¯¹åº”äº K8S é›†ç¾¤ä¸­çš„æ¦‚å¿µï¼Œä¾¿æ˜¯ Container Runtimeï¼Œè¿™é‡Œè¿˜æœ‰å…¶ä»–çš„é€‰æ‹©ï¼Œæ¯”å¦‚ rktï¼Œrunc å’Œå…¶ä»–å®ç°äº† OCI è§„èŒƒçš„è¿è¡Œæ—¶ã€‚

## æ€»ç»“

åœ¨è¿™èŠ‚é‡Œé¢ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº† Node å…¶å®å°±æ˜¯ç”¨äºå·¥ä½œçš„æœåŠ¡å™¨ï¼Œå®ƒæœ‰ä¸€äº›çŠ¶æ€å’Œä¿¡æ¯ï¼Œå½“è¿™äº›æ¡ä»¶éƒ½æ»¡è¶³ä¸€äº›æ¡ä»¶åˆ¤æ–­æ—¶ï¼ŒNode ä¾¿å¤„äº Ready çŠ¶æ€ï¼Œå¯ç”¨äºæ‰§è¡Œåç»­çš„å·¥ä½œã€‚

Deployment å¯ç†è§£ä¸ºä¸€ç§å¯¹æœŸæœ›çŠ¶æ€çš„æè¿°ï¼Œ Pod ä½œä¸ºé›†ç¾¤ä¸­å¯è°ƒåº¦çš„æœ€å°å•å…ƒï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢è¯¦ç»†è®²è§£å…¶ç»†èŠ‚ã€‚

Docker æ˜¯æˆ‘ä»¬é€‰æ‹©çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¯è¿è¡Œæˆ‘ä»¬æ„å»ºçš„æœåŠ¡é•œåƒï¼Œå‡å°‘åœ¨ç¯å¢ƒæ–¹é¢æ‰€åšçš„é‡å¤å·¥ä½œï¼Œå¹¶ä¸”ä¹Ÿéå¸¸ä¾¿äºéƒ¨ç½²ã€‚é™¤äº† Docker å¤–è¿˜å­˜åœ¨å…¶ä»–çš„å®¹å™¨è¿è¡Œæ—¶ã€‚

äº†è§£åˆ°è¿™äº›åŸºæœ¬æ¦‚å¿µåï¼Œä¸‹èŠ‚æˆ‘ä»¬ä»å®è§‚çš„è§’åº¦ä¸Šæ¥è®¤è¯† K8S çš„æ•´ä½“æ¶æ„ï¼Œä»¥ä¾¿æˆ‘ä»¬åç»­çš„å­¦ä¹ å’Œå®è·µã€‚

# å®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„

å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æœ¬èŠ‚æˆ‘ä»¬æ¥ä»å®è§‚ä¸Šè®¤è¯†ä¸‹ K8S çš„æ•´ä½“æ¶æ„ï¼Œä»¥ä¾¿äºåç»­åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ¢ç´¢å’Œå®è·µã€‚

## C/S æ¶æ„

ä»æ›´é«˜å±‚æ¥çœ‹ï¼ŒK8S æ•´ä½“ä¸Šéµå¾ª C/S æ¶æ„ï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œå¯ç”¨ä¸‹é¢çš„å›¾æ¥è¡¨ç¤ºå…¶ç»“æ„ï¼š

```
                               +-------------+                              
                               |             |                              
                               |             |               +---------------+
                               |             |       +-----> |     Node 1    |
                               | Kubernetes  |       |       +---------------+
+-----------------+            |   Server    |       |                      
|       CLI       |            |             |       |       +---------------+
|    (Kubectl)    |----------->| ( Master )  |<------+-----> |     Node 2    |
|                 |            |             |       |       +---------------+
+-----------------+            |             |       |       
                               |             |       |       +---------------+
                               |             |       +-----> |     Node 3    |
                               |             |               +---------------+
                               +-------------+               
```

å·¦ä¾§æ˜¯ä¸€ä¸ªå®˜æ–¹æä¾›çš„åä¸º `kubectl` çš„ CLI ï¼ˆCommand Line Interfaceï¼‰å·¥å…·ï¼Œç”¨äºä½¿ç”¨ K8S å¼€æ”¾çš„ API æ¥ç®¡ç†é›†ç¾¤å’Œæ“ä½œå¯¹è±¡ç­‰ã€‚

å³ä¾§åˆ™æ˜¯ K8S é›†ç¾¤çš„åç«¯æœåŠ¡åŠå¼€æ”¾å‡ºçš„ API ç­‰ã€‚æ ¹æ®ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ Node æ˜¯ç”¨äºå·¥ä½œçš„æœºå™¨ï¼Œè€Œ Master æ˜¯ä¸€ç§è§’è‰²ï¼ˆRoleï¼‰ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸ª Node ä¸ŠåŒ…å«ç€ç®¡ç†é›†ç¾¤çš„ä¸€äº›å¿…è¦ç»„ä»¶ã€‚å…·ä½“ç»„ä»¶çš„è¯¦ç»†ä»‹ç»å‚è€ƒç¬¬ 11 å°èŠ‚å¯¹å„ç»„ä»¶çš„è¯¦ç»†å‰–æã€‚

å½“ç„¶åœ¨è¿™é‡Œï¼Œåªç”»å‡ºäº†ä¸€ä¸ª Masterï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†ä¿éšœé›†ç¾¤çš„é«˜å¯ç”¨ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šéƒ¨ç½²å¤šä¸ª Master ã€‚

## Master

ä¸‹é¢æˆ‘ä»¬æ¥é€å±‚åˆ†è§£ï¼Œ é¦–å…ˆæ˜¯ Master ï¼Œè¿™é‡Œæˆ‘ä»¬åªä»‹ç»å…¶ç®¡ç†é›†ç¾¤çš„ç›¸å…³ç»„ä»¶ã€‚Master æ˜¯æ•´ä¸ª K8S é›†ç¾¤çš„â€œå¤§è„‘â€ï¼Œä¸å¤§è„‘ç±»ä¼¼ï¼Œå®ƒæœ‰å‡ ä¸ªé‡è¦çš„åŠŸèƒ½ï¼š

- æ¥æ”¶ï¼šå¤–éƒ¨çš„è¯·æ±‚å’Œé›†ç¾¤å†…éƒ¨çš„é€šçŸ¥åé¦ˆ
- å‘å¸ƒï¼šå¯¹é›†ç¾¤æ•´ä½“çš„è°ƒåº¦å’Œç®¡ç†
- å­˜å‚¨ï¼šå­˜å‚¨

è¿™äº›åŠŸèƒ½ï¼Œä¹Ÿé€šè¿‡ä¸€äº›ç»„ä»¶æ¥å…±åŒå®Œæˆï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸º control plane ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

```
+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +------->|        API Server       |<--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
```

å®ƒä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚

### Cluster state store

å­˜å‚¨é›†ç¾¤æ‰€æœ‰éœ€æŒä¹…åŒ–çš„çŠ¶æ€ï¼Œå¹¶ä¸”æä¾› watch çš„åŠŸèƒ½æ”¯æŒï¼Œå¯ä»¥å¿«é€Ÿçš„é€šçŸ¥å„ç»„ä»¶çš„å˜æ›´ç­‰æ“ä½œã€‚

å› ä¸ºç›®å‰ Kubernetes çš„å­˜å‚¨å±‚é€‰æ‹©æ˜¯ etcd ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¤§å®¶éƒ½ç›´æ¥ä»¥ etcd æ¥ä»£è¡¨é›†ç¾¤çŠ¶æ€å­˜å‚¨æœåŠ¡ã€‚å³ï¼šå°†æ‰€æœ‰çŠ¶æ€å­˜å‚¨åˆ° etcd å®ä¾‹ä¸­ã€‚

åˆšæ‰æˆ‘ä»¬è¯´ Master ç›¸å½“äºæ˜¯ K8S é›†ç¾¤çš„å¤§è„‘ï¼Œæ›´ç»†åŒ–æ¥çœ‹ï¼Œetcd åˆ™æ˜¯å¤§è„‘ä¸­çš„æ ¸å¿ƒï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿå¯ä»¥å‚è€ƒåé¢è¯¦ç»†å‰–æçš„ç« èŠ‚ï¼Œæœ¬ç« æˆ‘ä»¬å…ˆä»æ›´é«˜çš„å±‚æ¬¡æ¥çœ‹é›†ç¾¤çš„æ•´ä½“æ¶æ„ã€‚

ä½ å¯èƒ½ä¼šé—®ï¼Œ etcd æ˜¯å¿…é¡»çš„å—ï¼Ÿå°±ç›®å‰è€Œè¨€ï¼Œetcd æ˜¯å¿…é¡»çš„ï¼Œè¿™ä¸»è¦æ˜¯ Kubernetes çš„å†…éƒ¨å®ç°ã€‚

è€Œæ—©åœ¨ 2014 å¹´å·¦å³ï¼Œç¤¾åŒºå°±ä¸€ç›´åœ¨æè®®å°†å­˜å‚¨å±‚æŠ½è±¡å‡ºæ¥ï¼Œåç«¯çš„å®é™…å­˜å‚¨ä½œä¸ºä¸€ç§æ’ä»¶åŒ–çš„å­˜åœ¨ã€‚[å‘¼å£°](https://github.com/kubernetes/kubernetes/issues/1957)æ¯”è¾ƒå¤§çš„æ˜¯å¦ä¸€ç§æä¾› k/v å­˜å‚¨åŠŸèƒ½çš„ [Consul](https://www.consul.io/) ã€‚

ä¸è¿‡å¾—ç›Šäº etcd çš„å¼€å‘å›¢é˜Ÿè¾ƒä¸ºæ´»è·ƒï¼Œè€Œä¸”æ ¹æ® K8S ç¤¾åŒºçš„åé¦ˆåšäº†ç›¸å½“å¤§çš„æ”¹è¿›ï¼Œå¹¶ä¸”å½“æ—¶ K8S å›¢é˜Ÿä¸»è¦çš„å…³æ³¨ç‚¹ä¹Ÿä¸åœ¨æ­¤ï¼Œæ‰€ä»¥ç›´åˆ°ç°åœ¨ etcd ä»ä¸æ˜¯ä¸€ä¸ªå¯é€‰é¡¹ã€‚

å¦‚æœç°åœ¨å»çœ‹ä¸‹ Kubernetes çš„æºä»£ç ï¼Œä½ ä¼šå‘ç°å­˜å‚¨å±‚çš„ä»£ç è¿˜æ¯”è¾ƒç®€æ´æ¸…æ™°ï¼Œåç»­å¦‚æœæœ‰ç²¾åŠ›ä¹Ÿè®¸å°†æ­¤å¤„æ’ä»¶åŒ–ä¹Ÿä¸æ˜¯ä¸å¯èƒ½ã€‚

### API Server

è¿™æ˜¯æ•´ä¸ªé›†ç¾¤çš„å…¥å£ï¼Œç±»ä¼¼äºäººä½“çš„æ„Ÿå®˜ï¼Œæ¥æ”¶å¤–éƒ¨çš„ä¿¡å·å’Œè¯·æ±‚ï¼Œå¹¶å°†ä¸€äº›ä¿¡æ¯å†™å…¥åˆ° etcd ä¸­ã€‚

å®é™…å¤„ç†é€»è¾‘æ¯”ä¸‰æ¬¡æ¡æ‰‹ç®€å•çš„å¤šï¼š

- è¯·æ±‚ API Server ï¼šâ€œå—¨ï¼Œæˆ‘æœ‰äº›ä¸œè¥¿è¦æ”¾åˆ° etcd é‡Œé¢â€
- API Server æ”¶åˆ°è¯·æ±‚ï¼šâ€œä½ æ˜¯è°ï¼Ÿæˆ‘ä¸ºå•¥è¦å¬ä½ çš„â€
- ä»è¯·æ±‚ä¸­ï¼Œæ‹¿å‡ºè‡ªå·±çš„èº«ä»½å‡­è¯ï¼ˆä¸€èˆ¬æ˜¯è¯ä¹¦ï¼‰ï¼šâ€œæ˜¯æˆ‘å•Šï¼Œä½ çš„masterï¼Œç»™æˆ‘æŠŠè¿™äº›ä¸œè¥¿æ”¾è¿›å»â€
- è¿™æ—¶å€™å°±è¦çœ‹æ˜¯äº›ä»€ä¹ˆå†…å®¹äº†ï¼Œå¦‚æœè¿™äº›å†…å®¹ API Server èƒ½ç†è§£ï¼Œé‚£å°±æ”¾å…¥ etcd ä¸­ â€œå¥½çš„ master æˆ‘æ”¾è¿›å»äº†â€ï¼›å¦‚æœä¸èƒ½ç†è§£ï¼Œâ€œæŠ±æ­‰ master æˆ‘ç†è§£ä¸äº†â€

å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæä¾›äº†è®¤è¯ç›¸å…³çš„åŠŸèƒ½ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æƒé™è¿›è¡Œæ“ä½œã€‚å½“ç„¶ API Server æ”¯æŒå¤šç§è®¤è¯æ–¹æ³•ï¼Œä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ x509 è¯ä¹¦è¿›è¡Œè®¤è¯ã€‚

API Server çš„ç›®æ ‡æ˜¯æˆä¸ºä¸€ä¸ªæç®€çš„ serverï¼Œåªæä¾› REST æ“ä½œï¼Œæ›´æ–° etcd ï¼Œå¹¶å……å½“ç€é›†ç¾¤çš„ç½‘å…³ã€‚è‡³äºå…¶ä»–çš„ä¸šåŠ¡é€»è¾‘ä¹‹ç±»çš„ï¼Œé€šè¿‡æ’ä»¶æˆ–è€…åœ¨å…¶ä»–ç»„ä»¶ä¸­å®Œæˆã€‚å…³äºè¿™éƒ¨åˆ†çš„è¯¦ç»†å®ç°ï¼Œå¯ä»¥å‚è€ƒåé¢çš„ API Server å‰–æç›¸å…³ç« èŠ‚ã€‚

### Controller Manager

Controller Manager å¤§æ¦‚æ˜¯ K8S é›†ç¾¤ä¸­æœ€ç¹å¿™çš„éƒ¨åˆ†ï¼Œå®ƒåœ¨åå°è¿è¡Œç€è®¸å¤šä¸åŒçš„æ§åˆ¶å™¨è¿›ç¨‹ï¼Œç”¨æ¥è°ƒèŠ‚é›†ç¾¤çš„çŠ¶æ€ã€‚

å½“é›†ç¾¤çš„é…ç½®å‘ç”Ÿå˜æ›´ï¼Œæ§åˆ¶å™¨å°±ä¼šæœç€é¢„æœŸçš„çŠ¶æ€å¼€å§‹å·¥ä½œã€‚

### Scheduler

é¡¾åæ€ä¹‰ï¼ŒScheduler æ˜¯é›†ç¾¤çš„è°ƒåº¦å™¨ï¼Œå®ƒä¼šæŒç»­çš„å…³æ³¨é›†ç¾¤ä¸­æœªè¢«è°ƒåº¦çš„ Pod ï¼Œå¹¶æ ¹æ®å„ç§æ¡ä»¶ï¼Œæ¯”å¦‚èµ„æºçš„å¯ç”¨æ€§ï¼ŒèŠ‚ç‚¹çš„äº²å’Œæ€§æˆ–è€…å…¶ä»–çš„ä¸€äº›é™åˆ¶æ¡ä»¶ï¼Œé€šè¿‡ç»‘å®šçš„ API å°† Pod è°ƒåº¦/ç»‘å®šåˆ° Node ä¸Šã€‚

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦ç¨‹åºä¸€èˆ¬åªè€ƒè™‘è°ƒåº¦å¼€å§‹æ—¶ï¼Œ Node çš„çŠ¶æ€ï¼Œè€Œä¸è€ƒè™‘åœ¨è°ƒåº¦è¿‡ç¨‹ä¸­ Node çš„çŠ¶æ€å˜åŒ– (æ¯”å¦‚èŠ‚ç‚¹äº²å’Œæ€§ç­‰ï¼Œæˆªè‡³åˆ°ç›®å‰ v1.11.2 ä¹Ÿæš‚æœªåŠ å…¥ç›¸å…³åŠŸèƒ½çš„ç¨³å®šç‰¹æ€§)

## Node

Node çš„æ¦‚å¿µæˆ‘ä»¬åœ¨ä¸ŠèŠ‚å·²ç»æè¿‡äº†ï¼Œè¿™é‡Œä¸å†è¿‡å¤šèµ˜è¿°ï¼Œç®€å•ç‚¹ç†è§£ä¸ºåŠ å…¥é›†ç¾¤ä¸­çš„æœºå™¨å³å¯ã€‚

é‚£ Node æ˜¯å¦‚ä½•åŠ å…¥é›†ç¾¤æ¥å—è°ƒåº¦ï¼Œå¹¶è¿è¡ŒæœåŠ¡çš„å‘¢ï¼Ÿè¿™éƒ½è¦å½’åŠŸäºè¿è¡Œåœ¨ Node ä¸Šçš„å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ•´ä½“ç»“æ„ï¼š

```
+--------------------------------------------------------+       
| +---------------------+        +---------------------+ |       
| |      kubelet        |        |     kube-proxy      | |       
| |                     |        |                     | |       
| +---------------------+        +---------------------+ |       
| +----------------------------------------------------+ |       
| | Container Runtime (Docker)                         | |       
| | +---------------------+    +---------------------+ | |       
| | |Pod                  |    |Pod                  | | |       
| | | +-----+ +-----+     |    |+-----++-----++-----+| | |       
| | | |C1   | |C2   |     |    ||C1   ||C2   ||C3   || | |       
| | | |     | |     |     |    ||     ||     ||     || | |       
| | | +-----+ +-----+     |    |+-----++-----++-----+| | |       
| | +---------------------+    +---------------------+ | |       
| +----------------------------------------------------+ |       
+--------------------------------------------------------+  
```

### Kubelet

Kubelet å®ç°äº†é›†ç¾¤ä¸­æœ€é‡è¦çš„å…³äº Node å’Œ Pod çš„æ§åˆ¶åŠŸèƒ½ï¼Œå¦‚æœæ²¡æœ‰ Kubelet çš„å­˜åœ¨ï¼Œé‚£ Kubernetes å¾ˆå¯èƒ½å°±åªæ˜¯ä¸€ä¸ªçº¯ç²¹çš„é€šè¿‡ API Server CRUD çš„åº”ç”¨ç¨‹åºã€‚

K8S åŸç”Ÿçš„æ‰§è¡Œæ¨¡å¼æ˜¯æ“ä½œåº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œè€Œä¸åƒä¼ ç»Ÿæ¨¡å¼é‚£æ ·ï¼Œç›´æ¥æ“ä½œæŸä¸ªåŒ…æˆ–è€…æ˜¯æ“ä½œæŸä¸ªè¿›ç¨‹ã€‚åŸºäºè¿™ç§æ¨¡å¼ï¼Œå¯ä»¥è®©åº”ç”¨ç¨‹åºä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚æ­¤å¤–ï¼Œç”±äºæ˜¯æ“ä½œå®¹å™¨ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºå¯ä»¥è¯´å’Œä¸»æœºä¹Ÿæ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œæ¯•ç«Ÿå®ƒä¸ä¾èµ–äºä¸»æœºï¼Œåœ¨ä»»ä½•çš„å®¹å™¨è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚ Dockerï¼‰ä¸Šéƒ½å¯ä»¥éƒ¨ç½²å’Œè¿è¡Œã€‚

æˆ‘ä»¬åœ¨ä¸ŠèŠ‚ä»‹ç»è¿‡ Podï¼ŒPod å¯ä»¥æ˜¯ä¸€ç»„å®¹å™¨ï¼ˆä¹Ÿå¯ä»¥åŒ…å«å­˜å‚¨å·ï¼‰ï¼ŒK8S å°† Pod ä½œä¸ºå¯è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œ åˆ†ç¦»å¼€äº†æ„å»ºæ—¶å’Œéƒ¨ç½²æ—¶çš„å…³æ³¨ç‚¹ï¼š

- æ„å»ºæ—¶ï¼Œé‡ç‚¹å…³æ³¨æŸä¸ªå®¹å™¨æ˜¯å¦èƒ½æ­£ç¡®æ„å»ºï¼Œå¦‚ä½•å¿«é€Ÿæ„å»º
- éƒ¨ç½²æ—¶ï¼Œå…³å¿ƒæŸä¸ªåº”ç”¨ç¨‹åºçš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œä¾èµ–çš„ç›¸å…³èµ„æºæ˜¯å¦éƒ½èƒ½è®¿é—®åˆ°

è¿™ç§éš”ç¦»çš„æ¨¡å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†åº”ç”¨ç¨‹åºä¸åº•å±‚çš„åŸºç¡€è®¾æ–½è§£è€¦ï¼Œæå¤§çš„æé«˜é›†ç¾¤æ‰©/ç¼©å®¹ï¼Œè¿ç§»çš„çµæ´»æ€§ã€‚

åœ¨å‰é¢ï¼Œæˆ‘ä»¬æåˆ°äº† Master èŠ‚ç‚¹çš„ `Scheduler` ç»„ä»¶ï¼Œå®ƒä¼šè°ƒåº¦æœªç»‘å®šçš„ Pod åˆ°ç¬¦åˆæ¡ä»¶çš„ Node ä¸Šï¼Œè€Œè‡³äºæœ€ç»ˆè¯¥ Pod æ˜¯å¦èƒ½è¿è¡Œäº Node ä¸Šï¼Œåˆ™æ˜¯ç”± `Kubelet` æ¥è£å®šçš„ã€‚å…³äº Kubelet çš„å…·ä½“åŸç†ï¼Œåé¢æœ‰è¯¦ç»†å‰–æçš„ç« èŠ‚ã€‚

### Container runtime

å®¹å™¨è¿è¡Œæ—¶æœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯ä¸‹è½½é•œåƒå’Œè¿è¡Œå®¹å™¨ï¼Œæˆ‘ä»¬æœ€å¸¸è§çš„å®ç°å¯èƒ½æ˜¯ [Docker](https://www.docker.com/) , ç›®å‰è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å®ç°ï¼Œæ¯”å¦‚ [rkt](https://github.com/rkt/rkt), [cri-o](https://github.com/kubernetes-sigs/cri-o)ã€‚

K8S æä¾›äº†ä¸€å¥—é€šç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ CRI (Container Runtime Interface), å‡¡æ˜¯ç¬¦åˆè¿™å¥—æ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶å®ç°ï¼Œå‡å¯åœ¨ K8S ä¸Šä½¿ç”¨ã€‚

### Kube Proxy

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œé‚£è¦ä¹ˆé€šè¿‡åŸŸåï¼Œè¦ä¹ˆé€šè¿‡ IPã€‚è€Œæ¯ä¸ª Pod åœ¨åˆ›å»ºåéƒ½ä¼šæœ‰ä¸€ä¸ªè™šæ‹Ÿ IPï¼ŒK8S ä¸­æœ‰ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå«åš `Service` ï¼Œ`kube-proxy` ä¾¿æ˜¯æä¾›ä¸€ç§ä»£ç†çš„æœåŠ¡ï¼Œè®©ä½ å¯ä»¥é€šè¿‡ `Service` è®¿é—®åˆ° Podã€‚

å®é™…çš„å·¥ä½œåŸç†æ˜¯åœ¨æ¯ä¸ª Node ä¸Šå¯åŠ¨ä¸€ä¸ª `kube-proxy` çš„è¿›ç¨‹ï¼Œé€šè¿‡ç¼–æ’ `iptables` è§„åˆ™æ¥è¾¾åˆ°æ­¤æ•ˆæœã€‚æ·±å…¥çš„è§£æï¼Œåœ¨åé¢æœ‰å¯¹åº”çš„ç« èŠ‚ã€‚

## æ€»ç»“

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°äº† K8S çš„æ•´ä½“éµå¾ª C/S æ¶æ„ï¼Œé›†ç¾¤çš„ Master åŒ…å«ç€å‡ ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œæ¯”å¦‚ `API Server`, `Controller Manager` ç­‰ã€‚

è€Œ Node ä¸Šï¼Œåˆ™è¿è¡Œç€ä¸‰ä¸ªå¿…è¦çš„ç»„ä»¶ `kubelet`, `container runtime` (ä¸€èˆ¬æ˜¯ Docker), `kube-proxy` ã€‚

é€šè¿‡æ‰€æœ‰ç»„ä»¶çš„åˆ†å·¥åä½œï¼Œæœ€ç»ˆå®ç°äº† K8S å¯¹å®¹å™¨çš„ç¼–æ’å’Œè°ƒåº¦ã€‚

å®Œæˆäº†è¿™èŠ‚çš„å­¦ä¹ ï¼Œé‚£æˆ‘ä»¬å°±å¼€å§‹ç€æ‰‹æ­å»ºä¸€ä¸ªå±äºæˆ‘ä»¬è‡ªå·±çš„é›†ç¾¤å§ã€‚

# æ­å»º Kubernetes é›†ç¾¤ - æœ¬åœ°å¿«é€Ÿæ­å»º

é€šè¿‡ä¹‹å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† K8S ä¸­æœ‰ä¸€äº›ç»„ä»¶æ˜¯å¿…é¡»çš„ï¼Œé›†ç¾¤ä¸­æœ‰ä¸åŒçš„è§’è‰²ã€‚æœ¬èŠ‚ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°å¿«é€Ÿæ­å»ºä¸€ä¸ªé›†ç¾¤ï¼Œä»¥åŠ æ·±æˆ‘ä»¬å­¦ä¹ åˆ°çš„ä¸œè¥¿ã€‚

## æ–¹æ¡ˆé€‰æ‹©

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ K8S ä¸­æœ‰å¤šç§åŠŸèƒ½ç»„ä»¶ï¼Œè€Œè¿™äº›ç»„ä»¶è¦åœ¨æœ¬åœ°å…¨éƒ¨æ­å»ºå¥½ï¼Œéœ€è¦ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠåœ¨æ­å»ºè¿‡ç¨‹ä¸­ä¼šæµªè´¹ä¸å°‘çš„æ—¶é—´ï¼Œä»è€Œå¯èƒ½ä¼šå½±å“æˆ‘ä»¬æ­£å¸¸çš„æ­å»ºé›†ç¾¤çš„ç›®æ ‡ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œæä¾›ä¸¤ä¸ªæœ€ç®€å•ï¼Œæœ€å®¹æ˜“å®ç°æˆ‘ä»¬ç›®æ ‡çš„å·¥å…·

- [KIND](https://github.com/kubernetes-sigs/kind/) ã€‚
- [Minikube](https://github.com/kubernetes/minikube) ã€‚

## KIND

### ä»‹ç»

KINDï¼ˆKubernetes in Dockerï¼‰æ˜¯ä¸ºäº†èƒ½æä¾›æ›´åŠ ç®€å•ï¼Œé«˜æ•ˆçš„æ–¹å¼æ¥å¯åŠ¨ K8S é›†ç¾¤ï¼Œç›®å‰ä¸»è¦ç”¨äºæ¯”å¦‚ `Kubernetes` è‡ªèº«çš„ CI ç¯å¢ƒä¸­ã€‚

### å®‰è£…

- å¯ä»¥ç›´æ¥åœ¨é¡¹ç›®çš„ [Release é¡µé¢](https://github.com/kubernetes-sigs/kind/releases) ä¸‹è½½å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚(ä¸‹æ–‡ä¸­ä½¿ç”¨çš„æ˜¯ v0.1.0 ç‰ˆæœ¬çš„äºŒè¿›åˆ¶åŒ…)

æ³¨æ„ï¼šå¦‚æœä¸ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶åŒ…ï¼Œè€Œæ˜¯ä½¿ç”¨ `go get sigs.k8s.io/kind` çš„æ–¹å¼ä¸‹è½½ï¼Œåˆ™ä¸ä¸‹æ–‡ä¸­çš„é…ç½®æ–‡ä»¶ä¸å…¼å®¹ã€‚**è¯·å‚è€ƒ[ä½¿ç”¨ Kind æ­å»ºä½ çš„æœ¬åœ° Kubernetes é›†ç¾¤](https://zhuanlan.zhihu.com/p/60464867)** è¿™ç¯‡æ–‡ç« ã€‚

æ›´æ–°ï¼ˆ2020å¹´2æœˆ5æ—¥ï¼‰ï¼šKIND å·²ç»å‘å¸ƒäº† v0.7.0 ç‰ˆæœ¬ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼Œå»ºè®®å‚è€ƒ [ä½¿ç”¨ Kind åœ¨ç¦»çº¿ç¯å¢ƒåˆ›å»º K8S é›†ç¾¤](https://zhuanlan.zhihu.com/p/105173589) ï¼Œè¿™ç¯‡æ–‡ç« ä½¿ç”¨äº†æœ€æ–°ç‰ˆæœ¬çš„ KINDã€‚



![img](https://user-gold-cdn.xitu.io/2019/1/29/16898b9e3d57fcab?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### åˆ›å»ºé›†ç¾¤

**åœ¨ä½¿ç”¨ KIND ä¹‹å‰ï¼Œä½ éœ€è¦æœ¬åœ°å…ˆå®‰è£…å¥½ Docker çš„ç¯å¢ƒ** ï¼Œæ­¤å¤„æš‚ä¸åšå±•å¼€ã€‚

ç”±äºç½‘ç»œé—®é¢˜ï¼Œæˆ‘ä»¬æ­¤å¤„ä¹Ÿéœ€è¦å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä»¥ä¾¿è®© `kind` å¯ä»¥ä½¿ç”¨å›½å†…çš„é•œåƒæºã€‚ï¼ˆKIND æœ€æ–°ç‰ˆæœ¬ä¸­å·²ç»å†…ç½®äº†æ‰€æœ‰éœ€è¦çš„é•œåƒï¼Œæ— éœ€æ­¤æ“ä½œï¼‰

```
apiVersion: kind.sigs.k8s.io/v1alpha1
kind: Config

kubeadmConfigPatches:
- |
  apiVersion: kubeadm.k8s.io/v1alpha3
  kind: InitConfiguration
  nodeRegistration:
  kubeletExtraArgs:
    pod-infra-container-image: registry.aliyuncs.com/google_containers/pause-amd64:3.1
- |
  apiVersion: kubeadm.k8s.io/v1alpha3
  kind: ClusterConfiguration
  imageRepository: registry.aliyuncs.com/google_containers
  kubernetesVersion: v1.12.2
  networking:
    serviceSubnet: 10.0.0.0/16
```

å°†ä¸Šé¢çš„å†…å®¹ä¿å­˜æˆ `kind-config.yaml` æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ã€‚

```
kind create cluster --image kindest/node:v1.12.2 --config kind-config.yaml --name moelove                  
```

ä¸‹é¢ä¸ºåœ¨æˆ‘æœºå™¨ä¸Šæ‰§è¡Œçš„ç¨‹åºè¾“å‡ºï¼š

```
(MoeLove) âœ  kind âœ— kind create cluster --image kindest/node:v1.12.2 --config kind-config.yaml --name moelove                  
Creating cluster 'kind-moelove' ...
 âœ“ Ensuring node image (kindest/node:v1.12.2) ğŸ–¼
 âœ“ [kind-moelove-control-plane] Creating node container ğŸ“¦                                                         
 âœ“ [kind-moelove-control-plane] Fixing mounts ğŸ—»
 âœ“ [kind-moelove-control-plane] Starting systemd ğŸ–¥
 âœ“ [kind-moelove-control-plane] Waiting for docker to be ready ğŸ‹                                                  
 âœ“ [kind-moelove-control-plane] Starting Kubernetes (this may take a minute) â˜¸                                     
Cluster creation complete. You can now use the cluster with:

export KUBECONFIG="$(kind get kubeconfig-path --name="moelove")"
kubectl cluster-info
```

è¿™é‡Œï¼Œé€šè¿‡ä¼ é€’ä¸Šé¢çš„ `kind-config.yaml` æ–‡ä»¶ç»™ `kind create cluster`, å¹¶ä¼ é€’äº†ä¸€ä¸ªåå­—é€šè¿‡ `--name` å‚æ•°ã€‚

æˆ‘ä»¬æŒ‰ç…§ç¨‹åºè¾“å‡ºçš„æç¤ºè¿›è¡Œæ“ä½œï¼š

```
export KUBECONFIG="$(kind get kubeconfig-path --name="moelove")"
kubectl cluster-info
```

ä¸‹é¢ä¸ºåœ¨æˆ‘æœºå™¨ä¸Šæ‰§è¡Œçš„ç¨‹åºè¾“å‡ºï¼š

```
(MoeLove) âœ  kind âœ— export KUBECONFIG="$(kind get kubeconfig-path --name="moelove")"
(MoeLove) âœ  kind âœ— kubectl cluster-info
Kubernetes master is running at https://localhost:35911
KubeDNS is running at https://localhost:35911/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
(MoeLove) âœ  kind âœ— kubectl version
Client Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T18:02:47Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
Server Version: version.Info{Major:"1", Minor:"12", GitVersion:"v1.12.2", GitCommit:"17c77c7898218073f14c8d573582e8d2313dc740", GitTreeState:"clean", BuildDate:"2018-10-24T06:43:59Z", GoVersion:"go1.10.4", Compiler:"gc", Platform:"linux/amd64"}
```

æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦å®‰è£… `kubectl`ã€‚ `kubectl` çš„å®‰è£…å¯å‚è€ƒä¸‹é¢çš„å†…å®¹ã€‚

å½“ä½ æ‰§è¡Œ `kubectl cluster-info` å¦‚æœå¯ä»¥çœ‹åˆ°ç±»ä¼¼æˆ‘ä¸Šé¢çš„è¾“å‡ºï¼Œé‚£ä½ æœ¬åœ°çš„ K8S é›†ç¾¤å°±å·²ç»éƒ¨ç½²å¥½äº†ã€‚ä½ å¯ä»¥ç›´æ¥é˜…è¯»ç¬¬ 5 èŠ‚æˆ–è€…ç¬¬ 6 èŠ‚çš„å†…å®¹ã€‚

å¦‚æœä½ å·²ç»å¯¹ K8S æœ‰æ‰€äº†è§£ï¼Œå¹¶ä¸”å¯¹ Dashboard æœ‰æ¯”è¾ƒå¼ºçƒˆéœ€æ±‚çš„è¯, å¯ç›´æ¥å‚è€ƒç¬¬ 20 èŠ‚çš„å†…å®¹ã€‚

## Minikube

### ä»‹ç»

Minikube æ˜¯ K8S å®˜æ–¹ä¸ºäº†å¼€å‘è€…èƒ½åœ¨ä¸ªäººç”µè„‘ä¸Šè¿è¡Œ K8S è€Œæä¾›çš„ä¸€å¥—å·¥å…·ã€‚å®ç°ä¸Šæ˜¯é€šè¿‡ Go è¯­è¨€ç¼–å†™ï¼Œé€šè¿‡è°ƒç”¨è™šæ‹ŸåŒ–ç®¡ç†ç¨‹åºï¼Œåˆ›å»ºå‡ºä¸€ä¸ªè¿è¡Œåœ¨è™šæ‹Ÿæœºå†…çš„å•èŠ‚ç‚¹é›†ç¾¤ã€‚

æ³¨ï¼šä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¯¹äº K8S é›†ç¾¤çš„åŸºæœ¬åŠŸèƒ½è€Œè¨€ï¼ŒèŠ‚ç‚¹æ•°å¹¶æ²¡æœ‰ä»€ä¹ˆé™åˆ¶ã€‚åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹åŒæ ·å¯ä»¥åˆ›å»ºé›†ç¾¤ã€‚

### å‰æœŸå‡†å¤‡

- é¦–å…ˆéœ€è¦ç¡®è®¤ BIOS å·²ç»å¼€å¯äº† `VT-x` æˆ–è€… `AMD-v` è™šæ‹ŸåŒ–çš„æ”¯æŒã€‚å…·ä½“æ–¹å¼å¯å‚è€ƒ [ç¡®è®¤æ˜¯å¦å·²å¼€å¯ BIOS è™šæ‹ŸåŒ–](https://www.shaileshjha.com/how-to-find-out-if-intel-vt-x-or-amd-v-virtualization-technology-is-supported-in-windows-10-windows-8-windows-vista-or-windows-7-machine/), [å¼€å¯ BIOS è™šæ‹ŸåŒ–æ”¯æŒ](https://www.howtogeek.com/213795/how-to-enable-intel-vt-x-in-your-computers-bios-or-uefi-firmware/) è¿™ä¸¤ç¯‡æ–‡ç« ã€‚
- å…¶æ¬¡æˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªè™šæ‹ŸåŒ–ç®¡ç†ç¨‹åºï¼Œè¿™é‡Œçš„é€‰æ‹©å¯æ ¹æ®ä½ å®é™…åœ¨ç”¨çš„æ“ä½œç³»ç»Ÿæ¥å†³å®šã€‚å®˜æ–¹æ¨èå¦‚ä¸‹:
  - macOS: [VirtualBox](https://www.virtualbox.org/wiki/Downloads) æˆ– [VMware Fusion](https://www.vmware.com/products/fusion) æˆ– [HyperKit](https://github.com/moby/hyperkit)ã€‚å¦‚æœä½¿ç”¨ Hyperkit éœ€è¦æ³¨æ„ç³»ç»Ÿå¿…é¡»æ˜¯ `OS X 10.10.3 Yosemite` åŠä¹‹åç‰ˆæœ¬çš„ã€‚
  - Linux: [VirtualBox](https://www.virtualbox.org/wiki/Downloads) æˆ– [KVM](http://www.linux-kvm.org/)ã€‚
  - Windows: [VirtualBox](https://www.virtualbox.org/wiki/Downloads) æˆ– [Hyper-V](https://msdn.microsoft.com/en-us/virtualization/hyperv_on_windows/quick_start/walkthrough_install)ã€‚

æˆ‘ä¸ªäººæ¨èæ— è®ºä½ åœ¨ä»¥ä¸Šå“ªç§æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨ Minikube éƒ½é€‰æ‹©ç”¨ `Virtualbox` ä½œä¸ºè™šæ‹ŸåŒ–ç®¡ç†ç¨‹åºï¼Œ1. Virtualbox æ— è®ºæ“ä½œä½“éªŒè¿˜æ˜¯å®‰è£…éƒ½æ¯”è¾ƒç®€å• 2. Minikube å¯¹å…¶æ”¯æŒæ›´å®Œå¤‡ï¼Œå¹¶ä¸”ä¹Ÿå·²ç»ç»è¿‡å¤§é‡ç”¨æˆ·æµ‹è¯•ï¼Œç›¸å…³é—®é¢˜å‡å·²åŸºæœ¬ä¿®å¤ã€‚

*å¦‚æœä½ æ˜¯åœ¨ Linux ç³»ç»Ÿä¸Šé¢ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªé€‰æ‹©ï¼Œä¾¿æ˜¯å°† Minikube çš„ `--vm-driver` å‚æ•°è®¾ç½®ä¸º `none` ï¼Œå¹¶ä¸”åœ¨æœ¬æœºå·²ç»æ­£ç¡®å®‰è£… Dockerã€‚ è¿™ç§æ–¹å¼æ˜¯æ— éœ€è™šæ‹ŸåŒ–æ”¯æŒçš„ã€‚*

### å®‰è£… kubectl

ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å­¦åˆ° K8S é›†ç¾¤æ˜¯å…¸å‹çš„ C/S æ¶æ„ï¼Œæœ‰ä¸€ä¸ªå®˜æ–¹æä¾›çš„åä¸º `kubectl` çš„ CLI å·¥å…·ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¦å®‰è£… `kubectl` ä»¥ä¾¿åç»­æˆ‘ä»¬å¯ä»¥å¯¹æ­å»ºå¥½çš„é›†ç¾¤è¿›è¡Œç®¡ç†ã€‚

**æ³¨ï¼šç”±äº API ç‰ˆæœ¬å…¼å®¹çš„é—®é¢˜ï¼Œå°½é‡ä¿æŒ `kubectl` ç‰ˆæœ¬ä¸ K8S é›†ç¾¤ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæˆ–ç‰ˆæœ¬ç›¸å·®åœ¨åœ¨ä¸€ä¸ªå°ç‰ˆæœ¬å†…ã€‚**

å®˜æ–¹æ–‡æ¡£æä¾›äº† `macOS`, `Linux`, `Windows` ç­‰æ“ä½œç³»ç»Ÿä¸Šçš„å®‰è£…æ–¹å¼ï¼Œä¸”æè¿°å¾ˆè¯¦ç»†ï¼Œè¿™é‡Œä¸è¿‡å¤šèµ˜è¿°ï¼Œ[æ–‡æ¡£åœ°å€](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl)ã€‚

**æ­¤å¤„æä¾›ä¸€ä¸ªä¸åŒäºå®˜æ–¹æ–‡æ¡£ä¸­çš„å®‰è£…æ–¹å¼ã€‚**

- è®¿é—® K8S ä¸»ä»“åº“çš„ [CHANGELOG æ–‡ä»¶](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md) æ‰¾åˆ°ä½ æ‰€éœ€è¦çš„ç‰ˆæœ¬ã€‚ ç”±äºæˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ Minikube æ˜¯å®˜æ–¹æœ€æ–°çš„ç¨³å®šç‰ˆ v0.28.2ï¼Œè€Œå®ƒå†…ç½®çš„ Kubernetes çš„ç‰ˆæœ¬æ˜¯ v1.10 æ‰€ä»¥ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨å¯¹åº”çš„ [1.10 ç‰ˆæœ¬](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.10.md)çš„ `kubectl`ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºä¸åŒç‰ˆæœ¬çš„é›†ç¾¤ã€‚å¦‚ `minikube start --kubernetes-version v1.11.3` ç”¨æ­¤å‘½ä»¤åˆ›å»º `v1.11.3` ç‰ˆæœ¬çš„é›†ç¾¤ï¼Œå½“ç„¶ `kubectl` çš„ç‰ˆæœ¬ä¹Ÿéœ€è¦ç›¸åº”å‡çº§ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="687" height="538"></svg>)



ç‚¹å‡»[Client Binaries](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.10.md#client-binaries) æ‰¾åˆ°ä½ ç¬¦åˆæ‰€éœ€ç³»ç»Ÿæ¶æ„çš„å¯¹åº”åŒ…ä¸‹è½½å³å¯ã€‚è¿™é‡Œæˆ‘ä»¥ [Linux ä¸‹ 64 ä½çš„åŒ…](https://dl.k8s.io/v1.10.7/kubernetes-client-linux-amd64.tar.gz)ä¸ºä¾‹ã€‚

```
âœ  wget https://dl.k8s.io/v1.10.7/kubernetes-client-linux-amd64.tar.gz
âœ  echo '169b57c6707ed8d8be9643b0088631e5c0c6a37a5e99205f03c1199cd32bc61e  kubernetes-client-linux-amd64.tar.gz' | sha256sum -c -
kubernetes-client-linux-amd64.tar.gz: æˆåŠŸ
âœ  tar zxf kubernetes-client-linux-amd64.tar.gz
âœ  sudo mv kubernetes/client/bin/kubectl /usr/local/bin/kubectl
âœ  /usr/local/bin/kubectl version --client
Client Version: version.Info{Major:"1", Minor:"10", GitVersion:"v1.10.7", GitCommit:"0c38c362511b20a098d7cd855f1314dad92c2780", GitTreeState:"clean", BuildDate:"2018-08-20T10:09:03Z", GoVersion:"go1.9.3", Compiler:"gc", Platform:"linux/amd64"}
```

æ‰§è¡Œä»¥ä¸Šå‘½ä»¤å³å¯å®Œæˆ `kubectl` çš„å®‰è£…ï¼Œæœ€åä¸€æ­¥ä¼šçœ‹åˆ°å½“å‰å®‰è£…çš„ç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚

### å®‰è£… Minikube

å…ˆæŸ¥çœ‹ Minikube çš„ [Release é¡µé¢](https://github.com/kubernetes/minikube/releases)ï¼Œå½“å‰æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬æ˜¯ v0.28.2ï¼Œæ‰¾åˆ°ä½ æ‰€éœ€ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼Œç‚¹å‡»ä¸‹è½½ï¼Œå¹¶å°†ä¸‹è½½å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶åŠ å…¥ä½ çš„ PATH ä¸­ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="948" height="637"></svg>)



**æ³¨ï¼šå½“å‰ Windows ç³»ç»Ÿä¸‹çš„å®‰è£…åŒ…è¿˜å¤„äºå®éªŒæ€§è´¨ï¼Œå¦‚æœä½ æ˜¯åœ¨ Windows ç¯å¢ƒä¸‹ï¼ŒåŒæ ·æ˜¯å¯ä»¥ä¸‹è½½å®‰è£…ä½¿ç”¨çš„**

ä»¥ Linux ä¸‹çš„å®‰è£…ä¸ºä¾‹ï¼š

```
âœ  wget -O minikube https://github.com/kubernetes/minikube/releases/download/v0.28.2/minikube-linux-amd64
âœ  chmod +x minikube
âœ  sudo mv minikube /usr/local/bin/minikube

âœ  /usr/local/bin/minikube version
minikube version: v0.28.2
```

æœ€åä¸€æ­¥å¯æŸ¥çœ‹å½“å‰å·²å®‰è£…å¥½çš„ Minikube çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚å¦‚æœå®‰è£…æˆåŠŸå°†ä¼šçœ‹åˆ°å’Œæˆ‘ä¸Šé¢å†…å®¹ç›¸åŒçš„ç»“æœã€‚

### åˆ›å»ºç¬¬ä¸€ä¸ª K8S é›†ç¾¤

ä½¿ç”¨ Minikube åˆ›å»ºé›†ç¾¤ï¼Œåªè¦ç®€å•çš„æ‰§è¡Œ `minikube start` å³å¯ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ ä¼šçœ‹åˆ°å’Œæˆ‘ç±»ä¼¼çš„è¾“å‡ºã€‚

```
âœ  ~ minikube start
Starting local Kubernetes v1.10.0 cluster...
Starting VM...
Getting VM IP address...
Moving files into cluster...
Setting up certs...
Connecting to cluster...
Setting up kubeconfig...
Starting cluster components...
Kubectl is now configured to use the cluster.
Loading cached images from config file.

âœ  ~ minikube status
minikube: Running
cluster: Running
kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100         
```

ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„é›†ç¾¤ç›®å‰æ˜¯å¦å‡å·²é…ç½®æ­£ç¡®ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ã€‚

```
âœ  ~ kubectl cluster-info 
Kubernetes master is running at https://192.168.99.100:8443
KubeDNS is running at https://192.168.99.100:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.

âœ  ~ kubectl get nodes
NAME       STATUS    ROLES     AGE       VERSION
minikube   Ready     master    1d       v1.10.0
```

å¦‚æœå‡ºç°ç±»ä¼¼æ‹’ç»è¿æ¥ä¹‹ç±»çš„æç¤ºï¼Œé‚£å¯èƒ½æ˜¯å› ä¸ºä½ çš„ `kubectl` é…ç½®ä¸æ­£ç¡®ï¼Œå¯æŸ¥çœ‹ `$HOME/.kube/config` æ–‡ä»¶æ£€æŸ¥é…ç½®ã€‚ç¤ºä¾‹è¾“å‡ºå¦‚ä¸‹ï¼š

```
âœ  ~ cat .kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority: /home/tao/.minikube/ca.crt
    server: https://192.168.99.100:8443
  name: minikube
contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: /home/tao/.minikube/client.crt
    client-key: /home/tao/.minikube/client.key
```

å¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶ï¼Œå¯æŒ‰ä¸Šé¢ç¤ºä¾‹å†…å®¹è¿›è¡Œåˆ›å»ºï¼Œæ›¿æ¢æ‰å…¶ä¸­çš„è·¯å¾„åŠ `server` åœ°å€é…ç½®ã€‚ `server` åœ°å€å¯é€šè¿‡ `minikube status` æˆ–è€… `minikube ip` æŸ¥çœ‹æˆ–æ£€æŸ¥ã€‚

```
(Tao) âœ  ~ minikube ip
192.168.99.100

(Tao) âœ  ~ minikube status
minikube: Running
cluster: Running
kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100
```

### é€šè¿‡ Dashboard æŸ¥çœ‹é›†ç¾¤å½“å‰çŠ¶æ€

ä½¿ç”¨ `Minikube` çš„å¦ä¸€ä¸ªå¥½å¤„åœ¨äºï¼Œä½ å¯ä»¥ä¸ç”¨å…³æ³¨å¤ªå¤šå®‰è£…æ–¹é¢çš„è¿‡ç¨‹ï¼Œç›´æ¥åœ¨ç»ˆç«¯ä¸‹è¾“å…¥ `minikube dashboard` æ‰“å¼€ç³»ç»Ÿ Dashboard å¹¶é€šè¿‡æ­¤æ¥æŸ¥çœ‹é›†ç¾¤ç›¸å…³çŠ¶æ€ã€‚

æ‰§è¡Œ `minikube dashboard` åä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ç›‘å¬åœ¨é€šè¿‡ `minikube ip` æ‰€è·å¾— IP çš„ 3000 ç«¯å£ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š



![img](https://user-gold-cdn.xitu.io/2018/9/16/165de25c7c517d78?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### ç›¸å…³é“¾æ¥:

- [å®‰è£… VirtualBox](https://websiteforstudents.com/installing-virtualbox-ubuntu-17-04/)
- [ä½¿ç”¨ Kind æ­å»ºä½ çš„æœ¬åœ° Kubernetes é›†ç¾¤](https://juejin.im/post/5c99ed6c6fb9a0710e47ebeb)

## æ€»ç»“

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†èƒ½æ›´å¿«çš„ä½“éªŒåˆ° K8S é›†ç¾¤ï¼Œé¿å…å¾ˆå¤šç¹ççš„å®‰è£…æ­¥éª¤ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä½¿ç”¨å®˜æ–¹æä¾›çš„ `Minikube` å·¥å…·æ¥æ­å»ºä¸€ä¸ªæœ¬åœ°é›†ç¾¤ã€‚

Minikube çš„æœ¬è´¨å…¶å®æ˜¯å°†ä¸€å¥— â€œå®šåˆ¶åŒ–â€ çš„ K8S é›†ç¾¤æ‰“åŒ…æˆ ISO é•œåƒï¼Œå½“æ‰§è¡Œ `minikube start` çš„æ—¶å€™ï¼Œä¾¿é€šè¿‡æ­¤é•œåƒå¯åŠ¨ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œåœ¨æ­¤è™šæ‹Ÿæœºä¸Šé€šè¿‡ `kubeadm` å·¥å…·æ¥æ­å»ºä¸€å¥—åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„ K8S é›†ç¾¤ã€‚å…³äº `kubeadm` å·¥å…·ï¼Œæˆ‘ä»¬åœ¨ä¸‹èŠ‚è¿›è¡Œè®²è§£ã€‚

åŒæ—¶ï¼Œä¼šé€šè¿‡è™šæ‹Ÿæœºçš„ç›¸å…³é…ç½®æ¥å£æ‹¿åˆ°åˆšæ‰æ‰€å¯åŠ¨è™šæ‹Ÿæœºçš„åœ°å€ä¿¡æ¯ç­‰ï¼Œå¹¶å®Œæˆæœ¬åœ°çš„ `kubectl` å·¥å…·çš„é…ç½®ï¼Œä»¥ä¾¿äºè®©ç”¨æˆ·é€šè¿‡ `kubectl` å·¥å…·å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œã€‚

äº‹å®ä¸Šï¼Œå½“å‰ Docker for Mac 17.12 CE Edge å’Œ Docker for Windows 18.02 CE Edge ï¼Œä»¥åŠè¿™ä¸¤ç§å¹³å°æ›´é«˜çš„ Edge ç‰ˆæœ¬, å‡å·²å†…ç½®äº†å¯¹ K8S çš„æ”¯æŒï¼Œä½†å‡ä¸º Edge ç‰ˆæœ¬ï¼Œæ­¤å¤„æš‚ä¸åšè¿‡å¤šä»‹ç»ã€‚

# åŠ¨æ‰‹å®è·µï¼šæ­å»ºä¸€ä¸ª Kubernetes é›†ç¾¤ - ç”Ÿäº§å¯ç”¨

é€šè¿‡ä¸Šä¸€èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¿«é€Ÿçš„ä½¿ç”¨ `Minikube` æ­å»ºäº†ä¸€ä¸ªæœ¬åœ°å¯ç”¨çš„ K8S é›†ç¾¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºå®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢ä½“éªŒä¸€äº›åŸºæœ¬çš„åŠŸèƒ½ã€‚

å¤§å¤šæ•°äººçš„éœ€æ±‚å¹¶ä¸åªæ˜¯åŒ…å«ä¸€ä¸ªè™šæ‹ŸæœºèŠ‚ç‚¹çš„æœ¬åœ°æµ‹è¯•é›†ç¾¤ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯åœ¨æœåŠ¡å™¨è¿è¡Œï¼Œå¯è‡ªè¡Œæ‰©/ç¼©å®¹ï¼Œå…·å¤‡å…¨éƒ¨åŠŸèƒ½çš„ï¼Œè¾¾åˆ°ç”Ÿäº§å¯ç”¨çš„é›†ç¾¤ã€‚

K8S é›†ç¾¤çš„æ­å»ºï¼Œä¸€ç›´è®©å¾ˆå¤šäººå¤´ç–¼ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥æ­å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨çš„é›†ç¾¤ï¼Œä¾¿äºåç»­çš„å­¦ä¹ æˆ–ä½¿ç”¨ã€‚

## æ–¹æ¡ˆé€‰æ‹©

K8S ç”Ÿäº§ç¯å¢ƒå¯ç”¨çš„é›†ç¾¤æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæœ¬èŠ‚æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ª Kubernetes å®˜æ–¹æ¨èçš„æ–¹æ¡ˆ `kubeadm` è¿›è¡Œæ­å»ºã€‚

`kubeadm` æ˜¯ Kubernetes å®˜æ–¹æä¾›çš„ä¸€ä¸ª CLI å·¥å…·ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ­å»ºä¸€å¥—ç¬¦åˆå®˜æ–¹æœ€ä½³å®è·µçš„æœ€å°åŒ–å¯ç”¨é›†ç¾¤ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ `kubeadm` æ­å»ºé›†ç¾¤æ—¶ï¼Œé›†ç¾¤å¯ä»¥é€šè¿‡ K8S çš„ä¸€è‡´æ€§æµ‹è¯•ï¼Œå¹¶ä¸” `kubeadm` è¿˜æ”¯æŒå…¶ä»–çš„é›†ç¾¤ç”Ÿå‘½å‘¨æœŸåŠŸèƒ½ï¼Œæ¯”å¦‚å‡çº§/é™çº§ç­‰ã€‚

æˆ‘ä»¬åœ¨æ­¤å¤„é€‰æ‹© `kubeadm` ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¸ç”¨è¿‡äºå…³æ³¨é›†ç¾¤çš„å†…éƒ¨ç»†èŠ‚ï¼Œä¾¿å¯ä»¥å¿«é€Ÿçš„æ­å»ºå‡ºç”Ÿäº§å¯ç”¨çš„é›†ç¾¤ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åç»­ç« èŠ‚çš„å­¦ä¹ ï¼Œå¿«é€Ÿä¸Šæ‰‹ K8S ï¼Œå¹¶å­¦ä¹ åˆ° K8S çš„å†…éƒ¨åŸç†ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæƒ³è¦åœ¨ç‰©ç†æœºä¸Šå®Œå…¨ä¸€æ­¥æ­¥æ­å»ºé›†ç¾¤ï¼Œä¾¿è½»è€Œæ˜“ä¸¾ã€‚

## å®‰è£…åŸºç¡€ç»„ä»¶

### å‰æœŸå‡†å¤‡

ä½¿ç”¨ `kubeadm` å‰ï¼Œæˆ‘ä»¬éœ€è¦æå‰åšä¸€äº›å‡†å¤‡ã€‚

- **æˆ‘ä»¬éœ€è¦ç¦ç”¨ `swap`**ã€‚é€šè¿‡ä¹‹å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸ªå¿…é¡»çš„ç»„ä»¶ï¼Œåä¸º `kubelet`ï¼Œè‡ª K8S 1.8 å¼€å§‹ï¼Œå¯åŠ¨ `kubelet` æ—¶ï¼Œéœ€è¦ç¦ç”¨ `swap` ã€‚æˆ–è€…éœ€è¦æ›´æ”¹ `kubelet` çš„å¯åŠ¨å‚æ•° `--fail-swap-on=false`ã€‚

  è™½è¯´å¯ä»¥æ›´æ”¹å‚æ•°è®©å…¶å¯ç”¨ï¼Œä½†æ˜¯æˆ‘å»ºè®®è¿˜æ˜¯ç¦ç”¨ `swap` é™¤éä½ çš„é›†ç¾¤æœ‰ç‰¹æ®Šçš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šæœ‰å¤§å†…å­˜ä½¿ç”¨çš„éœ€æ±‚ï¼Œä½†åˆæƒ³èŠ‚çº¦æˆæœ¬ï¼›æˆ–è€…ä½ çŸ¥é“ä½ å°†è¦åšä»€ä¹ˆï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°ä¸€äº›éé¢„æœŸçš„æƒ…å†µï¼Œå°¤å…¶æ˜¯åšäº†å†…å­˜é™åˆ¶çš„æ—¶å€™ï¼Œå½“æŸä¸ª Pod è¾¾åˆ°å†…å­˜é™åˆ¶çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½ä¼šæº¢å‡ºåˆ° swap ä¸­ï¼Œè¿™ä¼šå¯¼è‡´ K8S æ— æ³•æ­£å¸¸è¿›è¡Œè°ƒåº¦ã€‚

  å¦‚ä½•ç¦ç”¨ï¼š

  1. ä½¿ç”¨ `sudo cat /proc/swaps` éªŒè¯ swap é…ç½®çš„è®¾å¤‡å’Œæ–‡ä»¶ã€‚
  2. é€šè¿‡ `swapoff -a` å…³é—­ swap ã€‚
  3. ä½¿ç”¨ `sudo blkid` æˆ–è€… `sudo lsblk` å¯æŸ¥çœ‹åˆ°æˆ‘ä»¬çš„è®¾å¤‡å±æ€§ï¼Œè¯·æ³¨æ„è¾“å‡ºç»“æœä¸­å¸¦æœ‰ `swap` å­—æ ·çš„ä¿¡æ¯ã€‚
  4. å°† `/etc/fstab` ä¸­å’Œä¸Šä¸€æ¡å‘½ä»¤ä¸­è¾“å‡ºçš„ï¼Œå’Œ swap ç›¸å…³çš„æŒ‚è½½ç‚¹éƒ½åˆ æ‰ï¼Œä»¥å…åœ¨æœºå™¨é‡å¯æˆ–é‡æŒ‚è½½æ—¶ï¼Œå†æŒ‚è½½ `swap` åˆ†åŒºã€‚

  æ‰§è¡Œå®Œä¸Šè¿°æ“ä½œï¼Œ`swap` ä¾¿ä¼šè¢«ç¦ç”¨ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å†æ¬¡é€šè¿‡ä¸Šè¿°å‘½ä»¤ï¼Œæˆ–è€… `free` å‘½ä»¤æ¥ç¡®è®¤æ˜¯å¦è¿˜æœ‰ `swap` å­˜åœ¨ã€‚

  ```
  [root@master ~]# free 
                total        used        free      shared  buff/cache   available
  Mem:        1882748       85608     1614836       16808      182304     1630476
  Swap:             0           0           0
  ```

- é€šè¿‡ `sudo cat /sys/class/dmi/id/product_uuid` å¯æŸ¥çœ‹æœºå™¨çš„ `product_uuid` è¯·ç¡®ä¿è¦æ­å»ºé›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹çš„ `product_uuid` å‡ä¸ç›¸åŒã€‚åŒæ—¶æ‰€æœ‰èŠ‚ç‚¹çš„ Mac åœ°å€ä¹Ÿä¸èƒ½ç›¸åŒï¼Œé€šè¿‡ `ip a` æˆ–è€… `ifconfig -a` å¯è¿›è¡ŒæŸ¥çœ‹ã€‚

  æˆ‘ä»¬åœ¨ç¬¬äºŒç« æåˆ°è¿‡ï¼Œæ¯ä¸ª Node éƒ½æœ‰ä¸€äº›ä¿¡æ¯ä¼šè¢«è®°å½•è¿›é›†ç¾¤å†…ï¼Œè€Œæ­¤å¤„æˆ‘ä»¬éœ€è¦ä¿è¯çš„è¿™äº›å”¯ä¸€çš„ä¿¡æ¯ï¼Œä¾¿ä¼šè®°å½•åœ¨é›†ç¾¤çš„ `nodeInfo` ä¸­ï¼Œæ¯”å¦‚ `product_uuid` åœ¨é›†ç¾¤å†…ä»¥ `systemUUID` æ¥è¡¨ç¤ºã€‚å…·ä½“ä¿¡æ¯æˆ‘ä»¬å¯ä»¥é€šè¿‡é›†ç¾¤çš„ `API Server` è·å–åˆ°ï¼Œåœ¨åé¢çš„ç« èŠ‚ä¼šè¯¦ç»†è®²è¿°ã€‚

- ç¬¬ä¸‰ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è°ˆè¿‡ K8S æ˜¯ C/S æ¶æ„ï¼Œåœ¨å¯åŠ¨åï¼Œä¼šå›ºå®šç›‘å¬ä¸€äº›ç«¯å£ç”¨äºæä¾›æœåŠ¡ã€‚å¯ä»¥é€šè¿‡ `sudo netstat -ntlp |grep -E '6443|23[79,80]|1025[0,1,2]'` æŸ¥çœ‹è¿™äº›ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨ï¼Œè¯·æ‰‹åŠ¨é‡Šæ”¾ã€‚

  å¦‚æœä½ æ‰§è¡Œä¸Šè¿°å‘½ä»¤æ—¶ï¼Œæç¤º `command not found`ï¼Œåˆ™è¡¨æ˜ä½ éœ€è¦å…ˆå®‰è£… `netstat`ï¼Œåœ¨ CentOS ç³»ç»Ÿä¸­éœ€è¦é€šè¿‡ `sudo yum install net-tools` å®‰è£…ï¼Œè€Œåœ¨ Debian/Ubuntu ç³»ç»Ÿä¸­ï¼Œåˆ™éœ€è¦é€šè¿‡ `sudo apt install net-tools` è¿›è¡Œå®‰è£…ã€‚

- å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯ `Docker`ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡[å®˜æ–¹çš„ Docker æ–‡æ¡£](https://docs.docker.com/install/overview/) è¿›è¡Œå®‰è£…ï¼Œå®‰è£…å®Œæˆåè®°å¾—å¯åŠ¨æœåŠ¡ã€‚

  å®˜æ–¹æ¨èä½¿ç”¨ `17.03` ï¼Œä½†æˆ‘å»ºè®®ä½ å¯ä»¥ç›´æ¥å®‰è£… `18.03` æˆ–è€…æ›´æ–°çš„ç‰ˆæœ¬ï¼Œå› ä¸º `17.03` ç‰ˆæœ¬çš„ Docker å·²ç»åœ¨ 2018 å¹´ 3 æœˆ `EOL`ï¼ˆEnd Of Lifeï¼‰äº†ã€‚å¯¹äºæ›´æ–°ç‰ˆæœ¬çš„ Dockerï¼Œè™½ç„¶ K8S å°šæœªåœ¨æ–°ç‰ˆæœ¬ä¸­ç»è¿‡å¤§é‡æµ‹è¯•ï¼Œä½†æ¯•ç«Ÿæ–°ç‰ˆæœ¬æœ‰å¾ˆå¤š Bugfix å’Œæ–°ç‰¹æ€§çš„å¢åŠ ï¼Œä¹Ÿèƒ½è§„é¿ä¸€äº›å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼ˆæ¯”å¦‚ä¸ªåˆ«æƒ…å†µä¸‹ container ä¸ä¼šè‡ªåŠ¨åˆ é™¤çš„æƒ…å†µ (17.09) ï¼‰ã€‚

  å¦å¤–ï¼Œç”±äº Docker çš„ API éƒ½æ˜¯å¸¦æœ‰ç‰ˆæœ¬çš„ï¼Œä¸”æœ‰è‰¯å¥½çš„å…¼å®¹æ€§ï¼Œå½“ä½¿ç”¨ä½ç‰ˆæœ¬ API è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨é™çº§ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚

### å®‰è£… kubectl

ç¬¬ä¸‰ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯´è¿‡ `kubectl` æ˜¯é›†ç¾¤çš„å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ç°åœ¨æ­å»ºé›†ç¾¤æ—¶ï¼Œä¹Ÿå¿…é¡»è¦å®‰è£…å®ƒï¼Œç”¨äºéªŒè¯é›†ç¾¤åŠŸèƒ½ã€‚

å®‰è£…æ­¥éª¤åœ¨ç¬¬ 4 ç« å·²ç»è¯¦ç»†è¯´æ˜äº†ï¼Œæ­¤å¤„ä¸åšèµ˜è¿°ï¼Œå¯æŸ¥é˜…ç¬¬ 4 ç« æˆ–å‚è€ƒä¸‹é¢çš„å†…å®¹ã€‚

### å®‰è£… kubeadm å’Œ kubelet

é¦–å…ˆæ˜¯ç‰ˆæœ¬çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è·å–åˆ°å½“å‰çš„ stable ç‰ˆæœ¬å·ã€‚è¦è®¿é—®è¿™ä¸ªåœ°å€ï¼Œéœ€è¦è‡ªè¡Œå¤„ç†ç½‘ç»œé—®é¢˜æˆ–ä½¿ç”¨æˆ‘åé¢æä¾›çš„è§£å†³åŠæ³•ã€‚

```
[root@master ~]# curl -sSL https://dl.k8s.io/release/stable.txt
v1.11.3
```

ä¸‹è½½äºŒè¿›åˆ¶åŒ…ï¼Œå¹¶é€šè¿‡ `kubeadm version` éªŒè¯ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ã€‚

```
[root@master ~]# curl -sSL https://dl.k8s.io/release/v1.11.3/bin/linux/amd64/kubeadm > /usr/bin/kubeadm
[root@master ~]# chmod a+rx /usr/bin/kubeadm
[root@master ~]# kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T17:59:42Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
```

å½“ç„¶ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ä½¿ç”¨å¦‚åŒä¸Šä¸€ç« çš„æ–¹å¼ï¼Œç›´æ¥è¿›å…¥åˆ° `kubernetes` çš„[å®˜æ–¹ä»“åº“](https://github.com/kubernetes/kubernetes)ï¼Œæ‰¾åˆ°æˆ‘ä»¬æ‰€éœ€ç‰ˆæœ¬ [v1.11.3](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md#v1113) ä¸‹è½½ `Server Binaries`ï¼Œå¦‚ä¸‹å›¾ï¼š



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1019" height="670"></svg>)



ç»ˆç«¯ä¸‹å¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ä¸‹è½½ï¼š

```
[root@master tmp]# wget -q https://dl.k8s.io/v1.11.3/kubernetes-server-linux-amd64.tar.gz
```

**å¯¹äºå›½å†…ç”¨æˆ·ï¼Œæˆ‘å·²ç»å‡†å¤‡äº†ä¸‹é¢çš„æ–¹å¼ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚**

```
é“¾æ¥: https://pan.baidu.com/s/1FSEcEUplQQGsjyBIZ6j2fA æå–ç : cu4s
```

ä¸‹è½½å®Œæˆåï¼ŒéªŒè¯æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ— è¯¯ï¼ŒéªŒè¯é€šè¿‡åè¿›è¡Œè§£å‹ã€‚

```
[root@master tmp]# echo 'e49d0db1791555d73add107d2110d54487df538b35b9dde0c5590ac4c5e9e039 kubernetes-server-linux-amd64.tar.gz' | sha256sum -c -
kubernetes-server-linux-amd64.tar.gz: ç¡®å®š
[root@master tmp]# tar -zxf kubernetes-server-linux-amd64.tar.gz
[root@master tmp]# ls kubernetes
addons  kubernetes-src.tar.gz  LICENSES  server
[root@master tmp]# ls kubernetes/server/bin/ | grep -E 'kubeadm|kubelet|kubectl'
kubeadm
kubectl
kubelet
```

å¯ä»¥çœ‹åˆ°åœ¨ `server/bin/` ç›®å½•ä¸‹æœ‰æˆ‘ä»¬æ‰€éœ€è¦çš„å…¨éƒ¨å†…å®¹ï¼Œå°†æˆ‘ä»¬æ‰€éœ€è¦çš„ `kubeadm` `kubectl` `kubelet` ç­‰éƒ½ç§»åŠ¨è‡³ `/usr/bin` ç›®å½•ä¸‹ã€‚

```
[root@master tmp]# mv kubernetes/server/bin/kube{adm,ctl,let} /usr/bin/
[root@master tmp]# ls /usr/bin/kube*
/usr/bin/kubeadm  /usr/bin/kubectl  /usr/bin/kubelet
[root@master tmp]# kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T17:59:42Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
[root@master tmp]# kubectl version --client
Client Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T18:02:47Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
[root@master tmp]# kubelet --version
Kubernetes v1.11.3
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰€éœ€çš„ç»„ä»¶ï¼Œç‰ˆæœ¬å‡ä¸º `v1.11.3` ã€‚

## é…ç½®

ä¸ºäº†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿éšœå„ç»„ä»¶çš„ç¨³å®šè¿è¡Œï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†ä¾¿äºç®¡ç†ï¼Œæˆ‘ä»¬å¢åŠ å¯¹ `kubelet` çš„ `systemd` çš„é…ç½®ï¼Œç”± `systemd` å¯¹æœåŠ¡è¿›è¡Œç®¡ç†ã€‚

### é…ç½® kubelet

```
[root@master tmp]# cat <<'EOF' > /etc/systemd/system/kubelet.service
[Unit]
Description=kubelet: The Kubernetes Agent
Documentation=http://kubernetes.io/docs/

[Service]
ExecStart=/usr/bin/kubelet
Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
[root@master tmp]# mkdir -p /etc/systemd/system/kubelet.service.d
[root@master tmp]# cat <<'EOF' > /etc/systemd/system/kubelet.service.d/kubeadm.conf
[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
EnvironmentFile=-/etc/default/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
EOF
[root@master tmp]# systemctl enable kubelet
Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /etc/systemd/system/kubelet.service.
```

åœ¨è¿™é‡Œæˆ‘ä»¬æ·»åŠ äº† `kubelet` çš„ systemd é…ç½®ï¼Œç„¶åæ·»åŠ äº†å®ƒçš„ `Drop-in` æ–‡ä»¶ï¼Œæˆ‘ä»¬å¢åŠ çš„è¿™ä¸ª `kubeadm.conf` æ–‡ä»¶ï¼Œä¼šè¢« systemd è‡ªåŠ¨è§£æï¼Œç”¨äºå¤å†™ `kubelet` çš„åŸºç¡€ systemd é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¢åŠ äº†ä¸€ç³»åˆ—çš„é…ç½®å‚æ•°ã€‚åœ¨ç¬¬ 17 ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šå¯¹ `kubelet` åšè¯¦ç»†å‰–æï¼Œåˆ°æ—¶å†è¿›è¡Œè§£é‡Šã€‚

## å¯åŠ¨

æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„å‰æœŸå‡†å¤‡å·²ç»åŸºæœ¬å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨ `kubeadm` æ¥åˆ›å»ºé›†ç¾¤äº†ã€‚åˆ«ç€æ€¥ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ä¸¤ä¸ªå·¥å…·ï¼Œåä¸º`crictl` å’Œ `socat`ã€‚

### å®‰è£…å‰ç½®ä¾èµ– crictl

`crictl` åŒ…å«åœ¨ [`cri-tools`](https://github.com/kubernetes-sigs/cri-tools.git) é¡¹ç›®ä¸­ï¼Œè¿™ä¸ªé¡¹ç›®ä¸­åŒ…å«ä¸¤ä¸ªå·¥å…·ï¼š

- `crictl` æ˜¯ `kubelet` CRI (Container Runtime Interface) çš„ CLI ã€‚
- `critest` æ˜¯ `kubelet` CRI çš„æµ‹è¯•å·¥å…·é›†ã€‚

å®‰è£…å¯ä»¥é€šè¿‡è¿›å…¥ `cri-tools` é¡¹ç›®çš„ [Release é¡µé¢](https://github.com/kubernetes-sigs/cri-tools/releases) ï¼Œæ ¹æ®é¡¹ç›® [README](https://github.com/kubernetes-sigs/cri-tools#current-status) æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å…¼å®¹å…³ç³»ï¼Œé€‰æ‹©è‡ªå·±æ‰€éœ€çš„å®‰è£…åŒ…ï¼Œä¸‹è½½å³å¯ï¼Œç”±äºæˆ‘ä»¬å®‰è£… K8S 1.11.3 æ‰€ä»¥é€‰æ‹©æœ€æ–°çš„ v1.11.x çš„å®‰è£…åŒ…ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="800" height="600"></svg>)



```
[root@master ~]# wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.11.1/crictl-v1.11.1-linux-amd64.tar.gz
[root@master ~]# echo 'ccf83574556793ceb01717dc91c66b70f183c60c2bbec70283939aae8fdef768 crictl-v1.11.1-linux-amd64.tar.gz' | sha256sum -c -
crictl-v1.11.1-linux-amd64.tar.gz: ç¡®å®š
[root@master ~]# tar zxvf crictl-v1.11.1-linux-amd64.tar.gz
[root@master ~]# mv crictl /usr/bin/
```

### å®‰è£…å‰ç½®ä¾èµ– socat

`socat` æ˜¯ä¸€æ¬¾å¾ˆå¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥å»ºç«‹ä¸¤ä¸ªåŒå‘å­—èŠ‚æµå¹¶åœ¨å…¶ä¸­ä¼ è¾“æ•°æ®ã€‚è¿™ä¹ˆè¯´ä½ ä¹Ÿè®¸ä¸å¤ªç†è§£ï¼Œç®€å•ç‚¹è¯´ï¼Œå®ƒå…¶ä¸­çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯å¯ä»¥å®ç°ç«¯å£è½¬å‘ã€‚

æ— è®ºåœ¨ K8S ä¸­ï¼Œè¿˜æ˜¯åœ¨ Docker ä¸­ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å¤–éƒ¨è®¿é—®æœåŠ¡ï¼Œç«¯å£è½¬å‘æ˜¯ä¸ªå¿…ä¸å¯å°‘çš„éƒ¨åˆ†ã€‚å½“ç„¶ï¼Œä½ å¯èƒ½ä¼šé—®åŸºæœ¬ä¸Šæ²¡æœ‰ä»»ä½•åœ°æ–¹æåˆ°è¯´ `socat` æ˜¯ä¸€ä¸ªä¾èµ–é¡¹å•Šï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹[ K8S çš„æºç ](https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/dockershim/docker_streaming.go#L189-L192)ä¾¿çŸ¥é“äº†ã€‚

```
func portForward(client libdocker.Interface, podSandboxID string, port int32, stream io.ReadWriteCloser) error {
    // çœç•¥äº†å’Œ socat æ— å…³çš„ä»£ç 

	socatPath, lookupErr := exec.LookPath("socat")
	if lookupErr != nil {
		return fmt.Errorf("unable to do port forwarding: socat not found.")
	}

	args := []string{"-t", fmt.Sprintf("%d", containerPid), "-n", socatPath, "-", fmt.Sprintf("TCP4:localhost:%d", port)}

    // ...
}
```

`socat` çš„å®‰è£…å¾ˆç®€å• CentOS ä¸‹æ‰§è¡Œ `sudo yum install -y socat` ï¼ŒDebian/Ubuntu ä¸‹æ‰§è¡Œ `sudo apt-get install -y socat` å³å¯å®Œæˆå®‰è£…ã€‚

### åˆå§‹åŒ–é›†ç¾¤

æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆï¼Œæˆ‘ä»¬å¼€å§‹çœŸæ­£åˆ›å»ºä¸€ä¸ª K8S é›†ç¾¤ã€‚ **æ³¨æ„ï¼šå¦‚æœéœ€è¦é…ç½® Pod ç½‘ç»œæ–¹æ¡ˆï¼Œè¯·å…ˆé˜…è¯»æœ¬ç« æœ€åçš„éƒ¨åˆ† [é…ç½®é›†ç¾¤ç½‘ç»œ](https://juejin.im/book/5b9b2dc86fb9a05d0f16c8ac/section/5b9b8346f265da0af03375ed#é…ç½®é›†ç¾¤ç½‘ç»œ)**

```
[root@master ~]# kubeadm init                                                                                             
[init] using Kubernetes version: v1.11.3               
[preflight] running pre-flight checks
...
I0920 01:09:09.602908   17966 kernel_validator.go:81] Validating kernel version
I0920 01:09:09.603001   17966 kernel_validator.go:96] Validating kernel config
        [WARNING SystemVerification]: docker version is greater than the most recently validated version. Docker version: 18.03.1-ce. Max validated version: 17.03
[preflight/images] Pulling images required for setting up a Kubernetes cluster
[preflight/images] This might take a minute or two, depending on the speed of your internet connection
[preflight/images] You can also perform this action in beforehand using 'kubeadm config images pull'
[kubelet] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[preflight] Activating the kubelet service
[certificates] Generated ca certificate and key.
[certificates] Generated apiserver certificate and key.
...
[markmaster] Marking the node master as master by adding the label "node-role.kubernetes.io/master=''"
[markmaster] Marking the node master as master by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstraptoken] creating the "cluster-info" ConfigMap in the "kube-public" namespace
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes master has initialized successfully!

...

You can now join any number of machines by running the following on each node
as root:

  kubeadm join 202.182.112.120:6443 --token t14kzc.vjurhx5k98dpzqdc --discovery-token-ca-cert-hash sha256:d64f7ce1af9f9c0c73d2d737fd0095456ad98a2816cb5527d55f984c8aa8a762
```

ä»¥ä¸Šçœç•¥äº†éƒ¨åˆ†è¾“å‡ºã€‚

æˆ‘ä»¬ä»ä»¥ä¸Šæ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåˆ›å»ºé›†ç¾¤æ—¶ä¼šæ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼ŒDocker ç‰ˆæœ¬ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œæç¤º Docker ç‰ˆæœ¬è¾ƒé«˜ï¼Œæˆ‘ä»¬å¿½ç•¥è¿™ä¸ªæç¤ºã€‚

ç„¶åä¼šä¸‹è½½ä¸€äº›é•œåƒï¼Œå½“ç„¶è¿™é‡Œæç¤ºæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œ `kubeadm config images pull` æå‰å»ä¸‹è½½é•œåƒã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹

```
[root@master ~]# kubeadm config images pull
[config/images] Pulled k8s.gcr.io/kube-apiserver-amd64:v1.11.3
[config/images] Pulled k8s.gcr.io/kube-controller-manager-amd64:v1.11.3
[config/images] Pulled k8s.gcr.io/kube-scheduler-amd64:v1.11.3
[config/images] Pulled k8s.gcr.io/kube-proxy-amd64:v1.11.3
[config/images] Pulled k8s.gcr.io/pause:3.1
[config/images] Pulled k8s.gcr.io/etcd-amd64:3.2.18
[config/images] Pulled k8s.gcr.io/coredns:1.1.3
```

å¯¹äºå›½å†…ç”¨æˆ·ä½¿ç”¨ `kubeadm` åˆ›å»ºé›†ç¾¤æ—¶ï¼Œå¯èƒ½é‡åˆ°çš„é—®é¢˜ä¾¿æ˜¯è¿™äº›é•œåƒä¸‹è½½ä¸ä¸‹æ¥ï¼Œæœ€ç»ˆå¯¼è‡´åˆ›å»ºå¤±è´¥ã€‚æ‰€ä»¥æˆ‘åœ¨å›½å†…çš„ä»£ç æ‰˜ç®¡å¹³å°æä¾›äº†ä¸€ä¸ª[ä»“åº“](https://gitee.com/K8S-release/kubeadm) å¯ä»¥ clone è¯¥é¡¹ç›®ï¼Œè¿›å…¥ `v1.11.3` ç›®å½•ï¼Œå¯¹æ¯ä¸ª `tar` æ–‡ä»¶æ‰§è¡Œ `sudo docker load -i xx.tar` å³å¯å°†é•œåƒå¯¼å…¥ã€‚

æˆ–è€…å¯ä½¿ç”¨[é˜¿é‡Œäº‘æä¾›çš„é•œåƒ](https://dev.aliyun.com/list.html?namePrefix=google-containers)ï¼Œåªéœ€è¦å°† `k8s.gcr.io` æ›¿æ¢ä¸º `registry.aliyuncs.com/google_containers` ï¼Œæ‰§è¡Œ `docker pull` åå† `docker tag` é‡ tag å³å¯ã€‚

ç»§ç»­çœ‹ä¸Šé¢çš„æ—¥å¿—ï¼Œ`kubeadm init` æ‰§è¡Œèµ·è§ç”Ÿæˆäº†ä¸€äº›æ–‡ä»¶ï¼Œè€Œè¿™äº›æ–‡ä»¶æˆ‘ä»¬å…ˆå‰åœ¨ kubelet server çš„ `Drop-in` çš„é…ç½®ä¸­é…ç½®è¿‡ã€‚

ç”Ÿæˆè¿™äº›é…ç½®æ–‡ä»¶åï¼Œå°†å¯åŠ¨ `kubelet` æœåŠ¡ï¼Œç”Ÿæˆä¸€ç³»åˆ—çš„è¯ä¹¦å’Œç›¸å…³çš„é…ç½®ä¹‹ç±»çš„ï¼Œå¹¶å¢åŠ ä¸€äº›æ‰©å±•ã€‚

æœ€ç»ˆé›†ç¾¤åˆ›å»ºæˆåŠŸï¼Œå¹¶æç¤ºå¯åœ¨ä»»æ„æœºå™¨ä¸Šä½¿ç”¨æŒ‡å®šå‘½ä»¤åŠ å…¥é›†ç¾¤ã€‚

## éªŒè¯

åœ¨ä¸Šé¢çš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®‰è£…äº† K8S çš„ CLI å·¥å…· `kubectl`ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­¤å·¥å…·æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ï¼š

```
[root@master ~]# kubectl cluster-info
Kubernetes master is running at http://localhost:8080

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
The connection to the server localhost:8080 was refused - did you specify the right host or port?
[root@master ~]# kubectl get nodes
The connection to the server localhost:8080 was refused - did you specify the right host or port?
```

ä½¿ç”¨ `kubectl cluster-info` å¯æŸ¥çœ‹é›†ç¾¤ master å’Œé›†ç¾¤æœåŠ¡çš„åœ°å€ï¼Œä½†æˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°æœ€åæœ‰ä¸€å¥æŠ¥é”™ `connection ... refused` å¾ˆæ˜¾ç„¶è¿™é‡Œå­˜åœ¨é”™è¯¯ã€‚

`kubectl get nodes` å¯æŸ¥çœ‹é›†ç¾¤ä¸­ `Node` ä¿¡æ¯ï¼ŒåŒæ ·æŠ¥é”™ã€‚

åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ï¼ŒK8S é»˜è®¤ä¼šç›‘å¬ä¸€äº›ç«¯å£ï¼Œä½†å¹¶ä¸æ˜¯ `8080` ç«¯å£ï¼Œç”±æ­¤å¯çŸ¥ï¼Œæˆ‘ä»¬çš„ `kubectl` é…ç½®æœ‰è¯¯ã€‚

### é…ç½® kubectl

- ä½¿ç”¨ `kubectl` çš„å‚æ•° `--kubeconfig` æˆ–è€…ç¯å¢ƒå˜é‡ `KUBECONFIG` ã€‚

  ```
  [root@master ~]# kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes                                                
  NAME      STATUS     ROLES     AGE       VERSION
  master    NotReady   master    13h       v1.11.3
  [root@master ~]#
  [root@master ~]# KUBECONFIG=/etc/kubernetes/admin.conf kubectl get nodes                                                  
  NAME      STATUS     ROLES     AGE       VERSION
  master    NotReady   master    13h       v1.11.3
  ```

- ä½¿ç”¨ä¼ å‚çš„æ–¹å¼æœªå…å¤ªç¹çï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ›´æ”¹é»˜è®¤é…ç½®æ–‡ä»¶

  ```
  [root@master ~]# mkdir -p $HOME/.kube
  [root@master ~]# sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  [root@master ~]# sudo chown $(id -u):$(id -g) $HOME/.kube/config
  [root@master ~]# kubectl get nodes                                                  
  NAME      STATUS     ROLES     AGE       VERSION
  master    NotReady   master    13h       v1.11.3
  ```

### é…ç½®é›†ç¾¤ç½‘ç»œ

é€šè¿‡ä¸Šé¢çš„é…ç½®ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ­£å¸¸è·å– `Node` ä¿¡æ¯ã€‚ä½†é€šè¿‡ç¬¬ 2 ç« ï¼Œæˆ‘ä»¬äº†è§£åˆ° `Node` éƒ½æœ‰ `status`ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬å”¯ä¸€çš„ `Node` æ˜¯ `NotReady`ã€‚æˆ‘ä»¬é€šè¿‡ç»™ `kubectl` ä¼ é€’ `-o` å‚æ•°æ›´æ”¹è¾“å‡ºæ ¼å¼ï¼ŒæŸ¥çœ‹æ›´è¯¦ç»†çš„æƒ…å†µã€‚

```
[root@master ~]# kubectl get nodes -o yaml
apiVersion: v1       
items:                                       
- apiVersion: v1                              
  kind: Node
  ...
  status:
    addresses:
    - address: master
      type: Hostname
    ...
    - lastHeartbeatTime: 2018-09-20T14:45:45Z
      lastTransitionTime: 2018-09-20T01:09:48Z
      message: 'runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady
        message:docker: network plugin is not ready: cni config uninitialized'
      reason: KubeletNotReady
      status: "False"
      type: Ready
    ...
```

ä»ä»¥ä¸Šè¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° master å¤„äº `NotReady` çš„åŸå› æ˜¯ `network plugin is not ready: cni config uninitialized` é‚£ä¹ˆ `CNI` æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ`CNI` æ˜¯ Container Network Interface çš„ç¼©å†™ï¼Œæ˜¯ K8S ç”¨äºé…ç½® Linux å®¹å™¨ç½‘ç»œçš„æ¥å£è§„èŒƒã€‚

å…³äºç½‘ç»œçš„é€‰æ‹©ï¼Œæˆ‘ä»¬æ­¤å¤„ä¸åšè¿‡å¤šä»‹ç»ï¼Œæˆ‘ä»¬æš‚æ—¶é€‰æ‹©ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„æ–¹æ¡ˆ `flannel`ã€‚ ä½†æ³¨æ„ï¼Œå¦‚æœè¦ä½¿ç”¨ `flannel` éœ€è¦åœ¨ `kubeadm init` çš„æ—¶å€™ï¼Œä¼ é€’ `--pod-network-cidr=10.244.0.0/16` å‚æ•°ã€‚å¦å¤–éœ€è¦æŸ¥çœ‹ `/proc/sys/net/bridge/bridge-nf-call-iptables` æ˜¯å¦å·²è®¾ç½®ä¸º `1`ã€‚ å¯ä»¥é€šè¿‡ `sysctl net.bridge.bridge-nf-call-iptables=1` æ›´æ”¹é…ç½®ã€‚

æˆ‘ä»¬åœ¨å‰é¢åˆ›å»ºé›†ç¾¤æ—¶ï¼Œå¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•å‚æ•°ã€‚ä¸ºäº†èƒ½ä½¿ç”¨ `flannel` , æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå°†é›†ç¾¤é‡ç½®ã€‚ä½¿ç”¨ `kubeadm reset`

```
[root@master ~]# kubeadm reset 
[reset] WARNING: changes made to this host by 'kubeadm init' or 'kubeadm join' will be reverted.
[reset] are you sure you want to proceed? [y/N]: y
[preflight] running pre-flight checks
[reset] stopping the kubelet service
[reset] unmounting mounted directories in "/var/lib/kubelet"
[reset] removing kubernetes-managed containers
[reset] cleaning up running containers using crictl with socket /var/run/dockershim.sock
[reset] failed to list running pods using crictl: exit status 1. Trying to use docker instead[reset] deleting contents of stateful directories: [/var/lib/kubelet /etc/cni/net.d /var/lib/dockershim /var/run/kubernetes /var/lib/etcd]
[reset] deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki]
[reset] deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]
```

é‡æ–°åˆå§‹åŒ–é›†ç¾¤ï¼Œå¹¶ä¼ é€’å‚æ•°ã€‚

```
[root@master ~]# kubeadm init --pod-network-cidr=10.244.0.0/16
[init] using Kubernetes version: v1.11.3
...
Your Kubernetes master has initialized successfully!
```

**æ³¨æ„ï¼šè¿™é‡Œä¼šé‡æ–°ç”Ÿæˆç›¸åº”è¯ä¹¦ç­‰é…ç½®ï¼Œéœ€è¦æŒ‰ä¸Šé¢çš„å†…å®¹é‡æ–°é…ç½® kubectlã€‚**

æ­¤æ—¶ï¼Œ`CNI` ä¹Ÿå°šæœªåˆå§‹åŒ–å®Œæˆï¼Œæˆ‘ä»¬è¿˜éœ€å®Œæˆä»¥ä¸‹çš„æ­¥éª¤ã€‚

```
# æ³¨æ„ï¼Œè¿™é‡Œçš„ flannel é…ç½®ä»…é€‚ç”¨äº 1.11 ç‰ˆæœ¬çš„ K8Sï¼Œè‹¥å®‰è£…å…¶ä»–ç‰ˆæœ¬çš„ K8S éœ€è¦æ›¿æ¢æ‰æ­¤é“¾æ¥
[root@master ~]# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.extensions/kube-flannel-ds created
```

ç¨ç­‰ç‰‡åˆ»ï¼Œå†æ¬¡æŸ¥çœ‹ Node çŠ¶æ€ï¼š

```
[root@master ~]# kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
master    Ready     master    12m       v1.11.3
```

å¯ä»¥çœ‹åˆ° status å·²ç»æ˜¯ `Ready` çŠ¶æ€ã€‚æ ¹æ®ç¬¬ 3 ç« çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ K8S ä¸­æœ€å°çš„è°ƒåº¦å•å…ƒæ˜¯ `Pod` æˆ‘ä»¬æ¥çœ‹ä¸‹é›†ç¾¤ä¸­ç°æœ‰ `Pod` çš„çŠ¶æ€ã€‚

```
[root@master ~]# kubectl get pods --all-namespaces
NAMESPACE     NAME                             READY     STATUS              RESTARTS   AGE 
kube-system   coredns-78fcdf6894-h7pkc         0/1       ContainerCreating   0          12m
kube-system   coredns-78fcdf6894-lhlks         0/1       ContainerCreating   0          12m
kube-system   etcd-master                      1/1       Running             0          5m
kube-system   kube-apiserver-master            1/1       Running             0          5m
kube-system   kube-controller-manager-master   1/1       Running             0          5m
kube-system   kube-flannel-ds-tqvck            1/1       Running             0          6m
kube-system   kube-proxy-25tk2                 1/1       Running             0          12m
kube-system   kube-scheduler-master            1/1       Running             0          5m
```

æˆ‘ä»¬å‘ç°æœ‰ä¸¤ä¸ª `coredns` çš„ `Pod` æ˜¯ `ContainerCreating` çš„çŠ¶æ€ï¼Œä½†å¹¶æœªå°±ç»ªã€‚æ ¹æ®ç¬¬ 3 ç« çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“ `Pod` å®é™…ä¼šæœ‰ä¸€ä¸ªè°ƒåº¦è¿‡ç¨‹ï¼Œæ­¤å¤„æˆ‘ä»¬æš‚ä¸”ä¸è®ºï¼Œåç»­ç« èŠ‚å†å¯¹æ­¤è¿›è¡Œè§£é‡Šã€‚

### æ–°å¢ Node

æˆ‘ä»¬æŒ‰ç…§åˆšæ‰æ‰§è¡Œå®Œ `kubeadm init` åï¼Œç»™å‡ºçš„ä¿¡æ¯ï¼Œåœ¨æ–°çš„æœºå™¨ä¸Šæ‰§è¡Œ `kubeadm join` å‘½ä»¤ã€‚

```
[root@node1 ~]# kubeadm join 202.182.112.120:6443 --token t14kzc.vjurhx5k98dpzqdc --discovery-token-ca-cert-hash sha256:d64f7ce1af9f9c0c73d2d737fd0095456ad98a2816cb5527d55f984c8aa8a762
[preflight] running pre-flight checks
        [WARNING RequiredIPVSKernelModulesAvailable]: the IPVS proxier will not be used, because the following required kernel modules are not loaded: [ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh] or no builtin kernel ipvs support: map[ip_vs:{} ip_vs_rr:{} ip_vs_wrr:{} ip_vs_sh:{} nf_conntrack_ipv4:{}]
you can solve this problem with following methods:
 1. Run 'modprobe -- ' to load missing kernel modules;
2. Provide the missing builtin kernel ipvs support

I0921 04:00:54.805439   10677 kernel_validator.go:81] Validating kernel version                                                  
I0921 04:00:54.805604   10677 kernel_validator.go:96] Validating kernel config                                                   
        [WARNING SystemVerification]: docker version is greater than the most recently validated version. Docker version: 18.03.1-ce. Max validated version: 17.03
[discovery] Trying to connect to API Server "202.182.112.120:6443"
[discovery] Created cluster-info discovery client, requesting info from "https://202.182.112.120:6443"
[discovery] Requesting info from "https://202.182.112.120:6443" again to validate TLS against the pinned public key
[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server "202.182.112.120:6443"
[discovery] Successfully established connection with API Server "202.182.112.120:6443"
[kubelet] Downloading configuration for the kubelet from the "kubelet-config-1.11" ConfigMap in the kube-system namespace
[kubelet] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[preflight] Activating the kubelet service
[tlsbootstrap] Waiting for the kubelet to perform the TLS Bootstrap...
[patchnode] Uploading the CRI Socket information "/var/run/dockershim.sock" to the Node API object "node1" as an annotation

This node has joined the cluster:
* Certificate signing request was sent to master and a response
  was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the master to see this node join the cluster.
```

ä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œæç¤ºå·²ç»æˆåŠŸåŠ å…¥é›†ç¾¤ã€‚ æ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨ master ä¸ŠæŸ¥çœ‹ä¸‹å½“å‰é›†ç¾¤çŠ¶æ€ã€‚

```
[root@master ~]# kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
master    Ready     master    12m       v1.11.3
node1     Ready     <none>    7m        v1.11.3
```

å¯ä»¥çœ‹åˆ° node1 å·²ç»åŠ å…¥äº†é›†ç¾¤ã€‚

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©å®˜æ–¹æ¨èçš„ `kubeadm` å·¥å…·åœ¨æœåŠ¡å™¨ä¸Šæ­å»ºäº†ä¸€å¥—æœ‰ä¸¤ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ã€‚

`kubeadm` å¯ä»¥è‡ªåŠ¨çš„æ‹‰å–ç›¸å…³ç»„ä»¶çš„ Docker é•œåƒï¼Œå¹¶å°†å…¶â€œç»„ç»‡â€èµ·æ¥ï¼Œå…å»äº†æˆ‘ä»¬é€ä¸ªéƒ¨ç½²ç›¸å…³ç»„ä»¶çš„éº»çƒ¦ã€‚

æˆ‘ä»¬é¦–å…ˆå­¦ä¹ åˆ°äº†éƒ¨ç½² K8S æ—¶éœ€è¦å¯¹ç³»ç»Ÿåšçš„åŸºç¡€é…ç½®ï¼Œå…¶æ¬¡å®‰è£…äº†ä¸€äº›å¿…è¦çš„å·¥å…·ï¼Œä»¥ä¾¿ K8S çš„åŠŸèƒ½å¯æ­£å¸¸è¿è¡Œã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº† CNI ç›¸å…³çš„çŸ¥è¯†ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­éƒ¨ç½²äº† `flannel` ç½‘ç»œæ–¹æ¡ˆã€‚

æœ€åï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¢åŠ  Node çš„æ–¹æ³•ï¼Œä»¥ä¾¿åç»­æ‰©å±•é›†ç¾¤ã€‚

é›†ç¾¤æ­å»ºæ–¹é¢çš„å­¦ä¹ æš‚æ—¶å‘Šä¸€æ®µè½ï¼Œä½†è¿™å¹¶ä¸æ˜¯ç»“æŸï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„å¼€å§‹ï¼Œä»ä¸‹ä¸€ç« å¼€å§‹ï¼Œæˆ‘ä»¬è¦å­¦ä¹ é›†ç¾¤ç®¡ç†ç›¸å…³çš„å†…å®¹ï¼Œå­¦ä¹ å¦‚ä½•çœŸæ­£ä½¿ç”¨ K8S ã€‚

# é›†ç¾¤ç®¡ç†ï¼šåˆè¯† kubectl

ä»æœ¬èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬æ¥å­¦ä¹  K8S é›†ç¾¤ç®¡ç†ç›¸å…³çš„çŸ¥è¯†ã€‚é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ K8S éµå¾ª C/S æ¶æ„ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº† CLI å·¥å…· `kubectl` ç”¨äºå®Œæˆå¤§å¤šæ•°é›†ç¾¤ç®¡ç†ç›¸å…³çš„åŠŸèƒ½ã€‚å½“ç„¶å‡¡æ˜¯ä½ å¯ä»¥é€šè¿‡ `kubectl` å®Œæˆçš„ä¸é›†ç¾¤äº¤äº’çš„åŠŸèƒ½ï¼Œéƒ½å¯ä»¥ç›´æ¥é€šè¿‡ API å®Œæˆã€‚

å¯¹äºæˆ‘ä»¬æ¥è¯´ `kubectl` å¹¶ä¸é™Œç”Ÿï¼Œåœ¨ç¬¬ 3 ç« è®² K8S æ•´ä½“æ¶æ„æ—¶ï¼Œæˆ‘ä»¬é¦–æ¬¡æåˆ°äº†å®ƒã€‚åœ¨ç¬¬ 4 ç« å’Œç¬¬ 5 ç« ä»‹ç»äº†ä¸¤ç§å®‰è£… `kubectl` çš„æ–¹å¼æ•…è€Œæœ¬ç« ä¸å†èµ˜è¿°å®‰è£…çš„éƒ¨åˆ†ã€‚

## æ•´ä½“æ¦‚è§ˆ

é¦–å…ˆæˆ‘ä»¬åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œä¸‹ `kubectl`:

```
âœ  ~ kubectl                
kubectl controls the Kubernetes cluster manager.
...
Usage:
  kubectl [flags] [options]
```

`kubectl` å·²ç»å°†å‘½ä»¤åšäº†åŸºæœ¬çš„å½’ç±»ï¼ŒåŒæ—¶æ˜¾ç¤ºäº†å…¶ä¸€èˆ¬çš„ç”¨æ³• `kubectl [flags] [options]` ã€‚

ä½¿ç”¨ `kubectl options` å¯ä»¥çœ‹åˆ°æ‰€æœ‰å…¨å±€å¯ç”¨çš„é…ç½®é¡¹ã€‚

## åŸºç¡€é…ç½®

åœ¨æˆ‘ä»¬çš„ç”¨æˆ·å®¶ç›®å½•ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªåä¸º `.kube/config` çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å…¶ä¸­çš„å†…å®¹ï¼ˆæ­¤å¤„ä»¥æœ¬åœ°çš„ minikube é›†ç¾¤ä¸ºä¾‹ï¼‰ã€‚

```
âœ  ~ ls $HOME/.kube/config 
/home/tao/.kube/config
âœ  ~ cat $HOME/.kube/config
apiVersion: v1
clusters:
- cluster:
    certificate-authority: /home/tao/.minikube/ca.crt
    server: https://192.168.99.101:8443
  name: minikube
contexts:
- context:
    cluster: minikube
    user: minikube
  name: minikube
current-context: minikube
kind: Config
preferences: {}
users:
- name: minikube
  user:
    client-certificate: /home/tao/.minikube/client.crt
    client-key: /home/tao/.minikube/client.key
```

`$HOME/.kube/config` ä¸­ä¸»è¦åŒ…å«ç€ï¼š

- K8S é›†ç¾¤çš„ API åœ°å€
- ç”¨äºè®¤è¯çš„è¯ä¹¦åœ°å€

å½“ç„¶ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 5 ç« æ—¶ï¼Œä¹Ÿå·²ç»è¯´è¿‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `--kubeconfig` æˆ–è€…ç¯å¢ƒå˜é‡ `KUBECONFIG` æ¥ä¼ é€’é…ç½®æ–‡ä»¶ã€‚

å¦å¤–å¦‚æœä½ å¹¶ä¸æƒ³ä½¿ç”¨é…ç½®æ–‡ä»¶çš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ç›´æ¥ä¼ é€’ç›¸å…³å‚æ•°æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š

```
âœ  ~ kubectl --client-key='/home/tao/.minikube/client.key' --client-certificate='/home/tao/.minikube/client.crt' --server='https://192.168.99.101:8443'  get nodes
NAME       STATUS    ROLES     AGE       VERSION
minikube   Ready     master    2d        v1.11.3
```

## ä» `get` è¯´èµ·

æ— è®ºæ˜¯ç¬¬ 4 ç« è¿˜æ˜¯ç¬¬ 5 ç« ï¼Œå½“æˆ‘ä»¬åˆ›å»ºé›†ç¾¤åï¼Œæˆ‘ä»¬éƒ½åšäº†ä¸¤ä¸ªç›¸åŒçš„äº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œ `kubectl get nodes` å¦ä¸€ä¸ªåˆ™æ˜¯ `kubectl cluster-info`ï¼Œæˆ‘ä»¬å…ˆä»æŸ¥çœ‹é›†ç¾¤å†… `Node` å¼€å§‹ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæœ¬åœ°å·²åˆ›å»ºå¥½çš„ `minikube` é›†ç¾¤ã€‚

```
âœ  ~ kubectl get nodes
NAME       STATUS    ROLES     AGE       VERSION
minikube   Ready     master    2d        v1.11.3
âœ  ~ kubectl get node
NAME       STATUS    ROLES     AGE       VERSION
minikube   Ready     master    2d        v1.11.3
âœ  ~ kubectl get no
NAME       STATUS    ROLES     AGE       VERSION
minikube   Ready     master    2d        v1.11.3
```

å¯ä»¥çœ‹åˆ°ä»¥ä¸Šä¸‰ç§â€œåç§°â€å‡å¯è·å–å½“å‰é›†ç¾¤å†… `Node` ä¿¡æ¯ã€‚è¿™æ˜¯ä¸ºäº†ä¾¿äºä½¿ç”¨è€Œå¢åŠ çš„åˆ«åå’Œç¼©å†™ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦çœ‹åˆ°æ›´è¯¦ç»†çš„ä¿¡æ¯å‘¢ï¼Ÿå¯ä»¥é€šè¿‡ä¼ é€’ `-o` å‚æ•°ä»¥å¾—åˆ°ä¸åŒæ ¼å¼çš„è¾“å‡ºã€‚

```
âœ  ~ kubectl get nodes -o wide 
NAME       STATUS    ROLES     AGE       VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE            KERNEL-VERSION   CONTAINER-RUNTIME
minikube   Ready     master    2d        v1.11.3   10.0.2.15     <none>        Buildroot 2018.05   4.15.0           docker://17.12.1-ce
```

å½“ç„¶ä¹Ÿå¯ä»¥ä¼ é€’ `-o yaml` æˆ–è€… `-o json` å¾—åˆ°æ›´åŠ è¯¦å°½çš„ä¿¡æ¯ã€‚

ä½¿ç”¨ `-o json` å°†å†…å®¹ä»¥ JSON æ ¼å¼è¾“å‡ºæ—¶ï¼Œå¯ä»¥é…åˆ [`jq`](https://stedolan.github.io/jq/) è¿›è¡Œå†…å®¹æå–ã€‚ä¾‹å¦‚ï¼š

```
âœ  ~ kubectl get nodes -o json | jq ".items[] | {name: .metadata.name} + .status.nodeInfo"
{
  "name": "minikube",
  "architecture": "amd64",
  "bootID": "d675d75b-e58e-40db-8910-6e5dda9e7cf9",
  "containerRuntimeVersion": "docker://17.12.1-ce",
  "kernelVersion": "4.15.0",
  "kubeProxyVersion": "v1.11.3",
  "kubeletVersion": "v1.11.3",
  "machineID": "078e2d22629747178397e29cf1c96cc7",
  "operatingSystem": "linux",
  "osImage": "Buildroot 2018.05",
  "systemUUID": "4073906D-69A1-46EE-A08C-0252D9F79893"
}
```

ä»¥æ­¤æ–¹æ³•å¯å¾—åˆ° `Node` çš„åŸºç¡€ä¿¡æ¯ã€‚

é‚£ä¹ˆé™¤äº† `Node` å¤–æˆ‘ä»¬è¿˜å¯ä»¥æŸ¥çœ‹é‚£äº›èµ„æºæˆ–åˆ«åå‘¢ï¼Ÿå¯ä»¥é€šè¿‡ `kubectl api-resources` æŸ¥çœ‹æœåŠ¡ç«¯æ”¯æŒçš„ API èµ„æºåŠåˆ«åå’Œæè¿°ç­‰ä¿¡æ¯ã€‚

## ç­”ç–‘è§£æƒ‘ `explain`

å½“é€šè¿‡ä¸Šé¢çš„å‘½ä»¤æ‹¿åˆ°æ‰€æœ‰æ”¯æŒçš„ API èµ„æºåˆ—è¡¨åï¼Œè™½ç„¶åé¢åŸºæœ¬éƒ½æœ‰ä¸€ä¸ªç®€å•çš„è¯´æ˜ï¼Œæ˜¯ä¸æ˜¯ä»ç„¶æ„Ÿè§‰ä¸€å¤´é›¾æ°´ï¼Ÿ

åˆ«æ‹…å¿ƒï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨ Linux çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ `man` ï¼Œåœ¨ä½¿ç”¨ `kubectl` çš„æ—¶å€™ï¼Œæˆ‘ä»¬é™¤äº† `--help` å¤–è¿˜æœ‰ `explain` å¯å¸®æˆ‘ä»¬è¿›è¡Œè¯´æ˜ã€‚ ä¾‹å¦‚ï¼š

```
âœ  ~ kubectl explain node                                                                                                              
KIND:     Node
VERSION:  v1

DESCRIPTION:              
     Node is a worker node in Kubernetes. Each node will have a unique
     identifier in the cache (i.e. in etcd).

# ... çœç•¥è¾“å‡º
```

## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬å¤§è‡´ä»‹ç»äº† `kubectl` çš„åŸºç¡€ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯æœ€å¸¸è§çš„ `get` å‘½ä»¤ã€‚å¯é€šè¿‡ä¼ é€’ä¸åŒå‚æ•°è·å–ä¸åŒæ ¼å¼çš„è¾“å‡ºï¼Œé…åˆ `jq` å·¥å…·å¯æ–¹ä¾¿çš„è¿›è¡Œå†…å®¹æå–ã€‚

ä»¥åŠå…³äº `kubectl` çš„é…ç½®æ–‡ä»¶å’Œæ— é…ç½®æ–‡ä»¶ä¸‹é€šè¿‡ä¼ é€’å‚æ•°ç›´æ¥ä½¿ç”¨ç­‰ã€‚

å¯¹åº”äºæˆ‘ä»¬å‰é¢æåˆ°çš„ K8S æ¶æ„ï¼Œæœ¬èŠ‚ç›¸å½“äº `CURD` ä¸­çš„ `R` å³æŸ¥è¯¢ã€‚æŸ¥è¯¢å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæ—¢æ˜¯æˆ‘ä»¬äº†è§£é›†ç¾¤çš„ç¬¬ä¸€æ­¥ï¼ŒåŒæ—¶ä¹Ÿæ˜¯åç»­éªŒè¯æ“ä½œç»“æœæˆ–é›†ç¾¤çŠ¶æ€å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚

å½“ç„¶ï¼Œä½ åœ¨é›†ç¾¤ç®¡ç†ä¸­å¯èƒ½ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ï¼Œå•çº¯ä¾é  `get` å¹¶ä¸è¶³ä»¥å®šä½é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 21 èŠ‚ä¸­å°†ä»‹ç» Troubleshoot çš„æ€è·¯åŠæ–¹æ³•ã€‚

ä¸‹èŠ‚æˆ‘ä»¬æ¥å­¦ä¹ å…³äº `C` çš„éƒ¨åˆ†ï¼Œå³åˆ›å»ºã€‚

# é›†ç¾¤ç®¡ç†ï¼šä»¥ Redis ä¸ºä¾‹-éƒ¨ç½²åŠè®¿é—®

ä¸ŠèŠ‚æˆ‘ä»¬å·²ç»å­¦ä¹ äº† `kubectl` çš„åŸºç¡€ä½¿ç”¨ï¼Œæœ¬èŠ‚æˆ‘ä»¬ä½¿ç”¨ `kubectl` åœ¨ K8S ä¸­è¿›è¡Œéƒ¨ç½²ã€‚

**å‰é¢æˆ‘ä»¬å·²ç»è¯´è¿‡ï¼ŒPod æ˜¯ K8S ä¸­æœ€å°çš„è°ƒåº¦å•å…ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨ K8S ä¸­è¿è¡Œä¸€ä¸ª container ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€ä¸ª Pod è€Œè¿™ä¸ª Pod ä¸­åªåŒ…å«ä¸€ä¸ª container ã€‚**

## ä» `kubectl run` å¼€å§‹

`kubectl run` çš„åŸºç¡€ç”¨æ³•å¦‚ä¸‹ï¼š

```
Usage:
  kubectl run NAME --image=image [--env="key=value"] [--port=port] [--replicas=replicas] [--dry-run=bool] [--overrides=inline-json] [--command] -- [COMMAND] [args...] [options]
```

`NAME` å’Œ `--image` æ˜¯å¿…éœ€é¡¹ã€‚åˆ†åˆ«ä»£è¡¨æ­¤æ¬¡éƒ¨ç½²çš„åå­—åŠæ‰€ä½¿ç”¨çš„é•œåƒï¼Œå…¶ä½™éƒ¨åˆ†ä¹‹åè¿›è¡Œè§£é‡Šã€‚å½“ç„¶ï¼Œåœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨æ—¶ï¼Œæ¨èç¼–å†™é…ç½®æ–‡ä»¶å¹¶é€šè¿‡ `kubectl create` è¿›è¡Œéƒ¨ç½²ã€‚

## ä½¿ç”¨æœ€å°çš„ Redis é•œåƒ

åœ¨ Redis çš„[å®˜æ–¹é•œåƒåˆ—è¡¨](https://hub.docker.com/_/redis/)å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šçš„ tag å¯ä¾›é€‰æ‹©ï¼Œå…¶ä¸­ä½¿ç”¨ [Alpine Linux](https://alpinelinux.org/) ä½œä¸ºåŸºç¡€çš„é•œåƒä½“ç§¯æœ€å°ï¼Œä¸‹è½½è¾ƒä¸ºæ–¹ä¾¿ã€‚æˆ‘ä»¬é€‰æ‹© `redis:alpine` è¿™ä¸ªé•œåƒè¿›è¡Œéƒ¨ç½²ã€‚

## éƒ¨ç½²

ç°åœ¨æˆ‘ä»¬åªéƒ¨ç½²ä¸€ä¸ª Redis å®ä¾‹ã€‚

```
âœ  ~ kubectl run redis --image='redis:alpine'
deployment.apps/redis created
```

å¯ä»¥çœ‹åˆ°æç¤º `deployment.apps/redis created` è¿™ä¸ªç¨åè¿›è¡Œè§£é‡Šï¼Œæˆ‘ä»¬ä½¿ç”¨ `kubectl get all` æ¥çœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

```
âœ  ~ kubectl get all
NAME                         READY     STATUS    RESTARTS   AGE
pod/redis-7c7545cbcb-2m6rp   1/1       Running   0          30s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   32s

NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/redis   1         1         1            1           30s

NAME                               DESIRED   CURRENT   READY     AGE
replicaset.apps/redis-7c7545cbcb   1         1         1         30s
```

å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰æˆ‘ä»¬åˆšæ‰æ‰§è¡Œ `run` æ“ä½œååˆ›å»ºçš„ `deployment.apps/redis`ï¼Œè¿˜æœ‰ `replicaset.apps/redis-7c7545cbcb`, `service/kubernetes` ä»¥åŠ `pod/redis-7c7545cbcb-f984p`ã€‚

ä½¿ç”¨ `kubectl get all` è¾“å‡ºå†…å®¹çš„æ ¼å¼ `/` å‰ä»£è¡¨ç±»å‹ï¼Œ`/` åæ˜¯åç§°ã€‚

è¿™äº›åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ

### Deployment

`Deployment` æ˜¯ä¸€ç§é«˜çº§åˆ«çš„æŠ½è±¡ï¼Œå…è®¸æˆ‘ä»¬è¿›è¡Œæ‰©å®¹ï¼Œæ»šåŠ¨æ›´æ–°åŠé™çº§ç­‰æ“ä½œã€‚æˆ‘ä»¬ä½¿ç”¨ `kubectl run redis --image='redis:alpine` å‘½ä»¤ä¾¿åˆ›å»ºäº†ä¸€ä¸ªåä¸º `redis` çš„ `Deployment`ï¼Œå¹¶æŒ‡å®šäº†å…¶ä½¿ç”¨çš„é•œåƒä¸º `redis:alpine`ã€‚

åŒæ—¶ K8S ä¼šé»˜è®¤ä¸ºå…¶å¢åŠ ä¸€äº›æ ‡ç­¾ï¼ˆ`Label`ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹ `get` çš„è¾“å‡ºæ ¼å¼è¿›è¡ŒæŸ¥çœ‹ã€‚

```
âœ  ~ kubectl get deployment.apps/redis -o wide 
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTOR
redis     1         1         1            1           40s       redis        redis:alpine   run=redis
âœ  ~ kubectl get deploy redis -o wide          
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTOR
redis     1         1         1            1           40s       redis        redis:alpine   run=redis
```

é‚£ä¹ˆè¿™äº› `Label` æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå®ƒä»¬å¯ä½œä¸ºé€‰æ‹©æ¡ä»¶è¿›è¡Œä½¿ç”¨ã€‚å¦‚ï¼š

```
âœ  ~ kubectl get deploy -l run=redis -o wide 
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES         SELECTOR
redis     1         1         1            1           11h       redis        redis:alpine   run=redis
âœ  ~ kubectl get deploy -l run=test -o wide  # ç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰åˆ›å»ºè¿‡ test æ‰€ä»¥æŸ¥ä¸åˆ°ä»»ä½•ä¸œè¥¿
No resources found.
```

æˆ‘ä»¬åœ¨åº”ç”¨éƒ¨ç½²æˆ–æ›´æ–°æ—¶æ€»æ˜¯ä¼šè€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å¹³æ»‘å‡çº§ï¼Œåˆ©ç”¨ `Deployment` ä¹Ÿèƒ½å¾ˆæ–¹ä¾¿çš„è¿›è¡Œé‡‘ä¸é›€å‘å¸ƒï¼ˆCanary deploymentsï¼‰ã€‚è¿™ä¸»è¦ä¹Ÿä¾èµ– `Label` å’Œ `Selector`ï¼Œ åé¢æˆ‘ä»¬å†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°ã€‚

`Deployment` çš„åˆ›å»ºé™¤äº†ä½¿ç”¨æˆ‘ä»¬è¿™é‡Œæåˆ°çš„æ–¹å¼å¤–ï¼Œæ›´æ¨èçš„æ–¹å¼ä¾¿æ˜¯ä½¿ç”¨ `yaml` æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸»è¦æ˜¯å£°æ˜ä¸€ç§é¢„æœŸçš„çŠ¶æ€ï¼Œè€Œå…¶ä»–ç»„ä»¶åˆ™è´Ÿè´£ååŒè°ƒåº¦å¹¶æœ€ç»ˆè¾¾æˆè¿™ç§é¢„æœŸçš„çŠ¶æ€ã€‚å½“ç„¶è¿™ä¹Ÿæ˜¯å®ƒçš„å…³é”®ä½œç”¨ä¹‹ä¸€ï¼Œå°† `Pod` æ‰˜ç®¡ç»™ä¸‹é¢å°†è¦ä»‹ç»çš„ `ReplicaSet`ã€‚

### ReplicaSet

`ReplicaSet` æ˜¯ä¸€ç§è¾ƒä½çº§åˆ«çš„ç»“æ„ï¼Œå…è®¸è¿›è¡Œæ‰©å®¹ã€‚

æˆ‘ä»¬ä¸Šé¢å·²ç»æåˆ° `Deployment` ä¸»è¦æ˜¯å£°æ˜ä¸€ç§é¢„æœŸçš„çŠ¶æ€ï¼Œå¹¶ä¸”ä¼šå°† `Pod` æ‰˜ç®¡ç»™ `ReplicaSet`ï¼Œè€Œ `ReplicaSet` åˆ™ä¼šå»æ£€æŸ¥å½“å‰çš„ `Pod` æ•°é‡åŠçŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¹¶å°½é‡æ»¡è¶³è¿™ä¸€é¢„æœŸã€‚

`ReplicaSet` å¯ä»¥ç”±æˆ‘ä»¬è‡ªè¡Œåˆ›å»ºï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ä¸æ¨èè¿™æ ·å»åšï¼Œå› ä¸ºå¦‚æœè¿™æ ·åšäº†ï¼Œé‚£å…¶å®å°±ç›¸å½“äºè·³è¿‡äº† `Deployment` çš„éƒ¨åˆ†ï¼Œ`Deployment` æ‰€å¸¦æ¥çš„åŠŸèƒ½æˆ–è€…ç‰¹æ€§æˆ‘ä»¬ä¾¿éƒ½ä½¿ç”¨ä¸åˆ°äº†ã€‚

é™¤äº† `ReplicaSet` å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé€‰æ‹©åä¸º `ReplicationController`ï¼Œè¿™ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ›´å¤šçš„åœ¨é€‰æ‹©å™¨ä¸Šï¼Œæˆ‘ä»¬åé¢å†åšè®¨è®ºã€‚ç°åœ¨æ¨èçš„åšæ³•æ˜¯ `ReplicaSet` æ‰€ä»¥ä¸åšå¤ªå¤šè§£é‡Šã€‚

`ReplicaSet` å¯ç®€å†™ä¸º `rs`ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

```
âœ  ~ kubectl get rs -o wide
NAME               DESIRED   CURRENT   READY     AGE       CONTAINERS   IMAGES         SELECTOR                           
redis-7c7545cbcb   1         1         1         11h       redis        redis:alpine   pod-template-hash=3731017676,run=redis
```

åœ¨è¾“å‡ºç»“æœä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œé™¤äº†æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„ `run=redis` æ ‡ç­¾å¤–ï¼Œè¿˜å¤šäº†ä¸€ä¸ª `pod-template-hash=3731017676` æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾æ˜¯ç”± `Deployment controller` è‡ªåŠ¨æ·»åŠ çš„ï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°é‡å¤ï¼Œæ‰€ä»¥å°† `pod-template` è¿›è¡Œ hash ç”¨ä½œå”¯ä¸€æ€§æ ‡è¯†ã€‚

### Service

`Service` ç®€å•ç‚¹è¯´å°±æ˜¯ä¸ºäº†èƒ½æœ‰ä¸ªç¨³å®šçš„å…¥å£è®¿é—®æˆ‘ä»¬çš„åº”ç”¨æœåŠ¡æˆ–è€…æ˜¯ä¸€ç»„ `Pod`ã€‚é€šè¿‡ `Service` å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚

```
âœ  ~ kubectl get service -o wide
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE       SELECTOR
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   16m        <none>
```

é€šè¿‡ä½¿ç”¨ `kubectl` æŸ¥çœ‹ï¼Œèƒ½çœ‹åˆ°ä¸»è¦ä¼šæ˜¾ç¤º `Service` çš„åç§°ï¼Œç±»å‹ï¼ŒIPï¼Œç«¯å£åŠåˆ›å»ºæ—¶é—´å’Œé€‰æ‹©å™¨ç­‰ã€‚æˆ‘ä»¬æ¥å…·ä½“æ‹†è§£ä¸‹ã€‚

#### ç±»å‹

`Service` ç›®å‰æœ‰ 4 ç§ç±»å‹ï¼š

- `ClusterIP`ï¼š æ˜¯ K8S å½“å‰é»˜è®¤çš„ `Service` ç±»å‹ã€‚å°† service æš´éœ²äºä¸€ä¸ªä»…é›†ç¾¤å†…å¯è®¿é—®çš„è™šæ‹Ÿ IP ä¸Šã€‚
- `NodePort`ï¼š æ˜¯é€šè¿‡åœ¨é›†ç¾¤å†…æ‰€æœ‰ `Node` ä¸Šéƒ½ç»‘å®šå›ºå®šç«¯å£çš„æ–¹å¼å°†æœåŠ¡æš´éœ²å‡ºæ¥ï¼Œè¿™æ ·ä¾¿å¯ä»¥é€šè¿‡ `:` è®¿é—®æœåŠ¡äº†ã€‚
- `LoadBalancer`ï¼š æ˜¯é€šè¿‡ `Cloud Provider` åˆ›å»ºä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå°†æœåŠ¡æš´éœ²å‡ºæ¥ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨åˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨è·¯ç”±è¯·æ±‚æ‰€éœ€çš„ `Nodeport` æˆ– `ClusterIP` ã€‚
- `ExternalName`ï¼š æ˜¯é€šè¿‡å°†æœåŠ¡ç”± DNS CNAME çš„æ–¹å¼è½¬å‘åˆ°æŒ‡å®šçš„åŸŸåä¸Šå°†æœåŠ¡æš´éœ²å‡ºæ¥ï¼Œè¿™éœ€è¦ `kube-dns` 1.7 æˆ–æ›´é«˜ç‰ˆæœ¬æ”¯æŒã€‚

#### å®è·µ

ä¸Šé¢å·²ç»è¯´å®Œäº† `Service` çš„åŸºæœ¬ç±»å‹ï¼Œè€Œæˆ‘ä»¬ä¹Ÿå·²ç»éƒ¨ç½²äº†ä¸€ä¸ª Redis ,å½“è¿˜æ— æ³•è®¿é—®åˆ°è¯¥æœåŠ¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆšæ‰éƒ¨ç½²çš„ Redis æœåŠ¡æš´éœ²å‡ºæ¥ã€‚

```
âœ  ~ kubectl expose deploy/redis --port=6379 --protocol=TCP --target-port=6379 --name=redis-server  
service/redis-server exposed
âœ  ~ kubectl get svc -o wide                                                                       
NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE       SELECTOR
kubernetes     ClusterIP   10.96.0.1       <none>        443/TCP    49m       <none>
redis-server   ClusterIP   10.108.105.63   <none>        6379/TCP   4s        run=redis
```

é€šè¿‡ `kubectl expose` å‘½ä»¤å°† redis server æš´éœ²å‡ºæ¥ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œä¸‹è¯´æ˜ï¼š

- `port`ï¼š æ˜¯ `Service` æš´éœ²å‡ºæ¥çš„ç«¯å£ï¼Œå¯é€šè¿‡æ­¤ç«¯å£è®¿é—® `Service`ã€‚
- `protocol`ï¼š æ˜¯æ‰€ç”¨åè®®ã€‚å½“å‰ K8S æ”¯æŒ TCP/UDP åè®®ï¼Œåœ¨ 1.12 ç‰ˆæœ¬ä¸­å®éªŒæ€§çš„åŠ å…¥äº†å¯¹ [SCTP åè®®](https://zh.wikipedia.org/zh-hans/æµæ§åˆ¶ä¼ è¾“åè®®)çš„æ”¯æŒã€‚é»˜è®¤æ˜¯ TCP åè®®ã€‚
- `target-port`ï¼š æ˜¯å®é™…æœåŠ¡æ‰€åœ¨çš„ç›®æ ‡ç«¯å£ï¼Œè¯·æ±‚ç”± `port` è¿›å…¥é€šè¿‡ä¸Šè¿°æŒ‡å®š `protocol` æœ€ç»ˆæµå‘è¿™é‡Œé…ç½®çš„ç«¯å£ã€‚
- `name`ï¼š `Service` çš„åå­—ï¼Œå®ƒçš„ç”¨å¤„ä¸»è¦åœ¨ dns æ–¹é¢ã€‚
- `type`ï¼š æ˜¯å‰é¢æåˆ°çš„ç±»å‹ï¼Œå¦‚æœæ²¡æŒ‡å®šé»˜è®¤æ˜¯ `ClusterIP`ã€‚

ç°åœ¨æˆ‘ä»¬çš„ redis æ˜¯ä½¿ç”¨çš„é»˜è®¤ç±»å‹ `ClusterIP`ï¼Œæ‰€ä»¥å¹¶ä¸èƒ½ç›´æ¥é€šè¿‡å¤–éƒ¨è¿›è¡Œè®¿é—®ï¼Œæˆ‘ä»¬ä½¿ç”¨ `port-forward` çš„æ–¹å¼è®©å®ƒå¯åœ¨é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚

```
âœ  ~ kubectl port-forward svc/redis-server 6379:6379
Forwarding from 127.0.0.1:6379 -> 6379
Forwarding from [::1]:6379 -> 6379
Handling connection for 6379
```

åœ¨å¦ä¸€ä¸ªæœ¬åœ°ç»ˆç«¯å†…å¯é€šè¿‡ redis-cli å·¥å…·è¿›è¡Œè¿æ¥ï¼š

```
âœ  ~ redis-cli -h 127.0.0.1 -p 6379
127.0.0.1:6379> ping
PONG
```

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ `NodePort` çš„æ–¹å¼å¯¹å¤–æš´éœ²æœåŠ¡ã€‚

```
âœ  ~ kubectl expose deploy/redis --port=6379 --protocol=TCP --target-port=6379 --name=redis-server-nodeport --type=NodePort
service/redis-server-nodeport exposed
âœ  ~ kubectl get service/redis-server-nodeport -o wide 
NAME                    TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE       SELECTOR
redis-server-nodeport   NodePort   10.109.248.204   <none>        6379:31913/TCP   11s       run=redis
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»»æ„ `Node` ä¸Šçš„ 31913 ç«¯å£ä¾¿å¯è¿æ¥æˆ‘ä»¬çš„ redis æœåŠ¡ã€‚å½“ç„¶ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªç«¯å£èŒƒå›´å…¶å®æ˜¯å¯ä»¥é€šè¿‡ `kube-apiserver` çš„ `service-node-port-range` è¿›è¡Œé…ç½®çš„ï¼Œé»˜è®¤æ˜¯ `30000-32767`ã€‚

### Pod

ç¬¬äºŒèŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°è¿‡ `Pod` æ˜¯ K8S ä¸­çš„æœ€å°åŒ–éƒ¨ç½²å•å…ƒã€‚æˆ‘ä»¬çœ‹ä¸‹å½“å‰é›†ç¾¤ä¸­ `Pod` çš„çŠ¶æ€ã€‚

```
âœ  ~ kubectl get pods
NAME                     READY     STATUS    RESTARTS   AGE
redis-7c7545cbcb-jwcf2   1/1       Running   0          8h
```

æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡ç®€å•çš„æ‰©å®¹æ“ä½œã€‚

```
âœ  ~ kubectl scale deploy/redis --replicas=2
deployment.extensions/redis scaled
âœ  ~ kubectl get pods
NAME                     READY     STATUS    RESTARTS   AGE
redis-7c7545cbcb-jwcf2   1/1       Running   0          8h
redis-7c7545cbcb-wzh6w   1/1       Running   0          4s
```

å¯ä»¥çœ‹åˆ° `Pod` æ•°å·²ç»å¢åŠ ï¼Œå¹¶ä¸”ä¹Ÿå·²ç»æ˜¯ `Running` çš„çŠ¶æ€äº†ã€‚(å½“ç„¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ Redis æœåŠ¡çš„æ‰©å®¹å¹¶ä¸æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œæ‰©å®¹çš„ï¼Œéœ€è¦çœ‹å®é™…çš„éƒ¨ç½²æ–¹å¼ä»¥åŠä¸šåŠ¡çš„ä½¿ç”¨å§¿åŠ¿ã€‚)

## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬ä½¿ç”¨ Redis ä½œä¸ºä¾‹å­ï¼Œå­¦ä¹ äº†é›†ç¾¤ç®¡ç†ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€‚å­¦ä¹ äº†å¦‚ä½•è¿›è¡Œåº”ç”¨éƒ¨ç½²ï¼Œ `Service` çš„åŸºç¡€ç±»å‹ä»¥åŠå¦‚ä½•é€šè¿‡ `port-forward` æˆ– `NodePort` ç­‰æ–¹å¼å°†æœåŠ¡æä¾›è‡³é›†ç¾¤çš„å¤–éƒ¨è®¿é—®ã€‚

åŒæ—¶æˆ‘ä»¬å­¦ä¹ äº†åº”ç”¨éƒ¨ç½²ä¸­ä¸»è¦ä¼šæ¶‰åŠåˆ°çš„å‡ ç±»èµ„æº `Deployment`ï¼Œ`Replicaset`ï¼Œ`Service` å’Œ `Pod` ç­‰ã€‚å¯¹è¿™äº›èµ„æºåŠå®ƒä»¬ä¹‹é—´å…³ç³»çš„æŒæ¡ï¼Œå¯¹äºåç»­é›†ç¾¤ç»´æŠ¤æˆ–å®šä½é—®é¢˜æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ K8S è‡³å…³é‡è¦çš„ä¸€ç¯ï¼Œæƒé™æ§åˆ¶ã€‚

# å®‰å…¨é‡ç‚¹: è®¤è¯å’Œæˆæƒ

æœ¬èŠ‚æˆ‘ä»¬å°†å¼€å§‹å­¦ä¹ å°† K8S åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ï¼Œæƒé™æ§åˆ¶ã€‚å½“ç„¶ï¼Œä¸ä»…æ˜¯ K8S å¯¹äºä»»ä½•åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­çš„ç³»ç»Ÿï¼Œæƒé™ç®¡ç†æˆ–è€…è¯´è®¿é—®æ§åˆ¶éƒ½æ˜¯å¾ˆé‡è¦çš„ã€‚

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ K8S ä¸­å‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦ç»è¿‡ `kube-apiserver` å¤„ç†ï¼Œæ‰€ä»¥ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒK8S ä¸ºå®ƒæä¾›äº†ä¸‰ç±»å®‰å…¨è®¿é—®çš„æªæ–½ã€‚åˆ†åˆ«æ˜¯ï¼šç”¨äºè¯†åˆ«ç”¨æˆ·èº«ä»½çš„è®¤è¯ï¼ˆAuthenticationï¼‰ï¼Œç”¨äºæ§åˆ¶ç”¨æˆ·å¯¹èµ„æºè®¿é—®çš„æˆæƒï¼ˆAuthorizationï¼‰ä»¥åŠç”¨äºèµ„æºç®¡ç†æ–¹é¢çš„å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰ã€‚

ä¸‹é¢çš„å›¾åŸºæœ¬å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ã€‚æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ†åˆ«ç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ä¹‹åï¼Œæ‰èƒ½çœŸæ­£æ‰§è¡Œã€‚

å½“ç„¶ï¼Œè¿™é‡Œè¯´**åŸºæœ¬å±•ç¤º**æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ `kubectl proxy` çš„æ–¹å¼ç›´æ¥é€šè¿‡ HTTP è¯·æ±‚è®¿é—® `kube-apiserver` è€Œæ— éœ€ä»»ä½•è®¤è¯è¿‡ç¨‹ã€‚

å¦å¤–ï¼Œä¹Ÿå¯é€šè¿‡åœ¨ `kube-apiserver` æ‰€å¯åŠ¨çš„æœºå™¨ä¸Šï¼Œç›´æ¥è®¿é—®å¯åŠ¨æ—¶ `--insecure-port` å‚æ•°é…ç½®çš„ç«¯å£è¿›è¡Œç»•è¿‡è®¤è¯å’Œæˆæƒï¼Œé»˜è®¤æ˜¯ 8080ã€‚ä¸ºäº†é¿å…å®‰å…¨é—®é¢˜ï¼Œä¹Ÿå¯å°†æ­¤å‚æ•°è®¾ç½®ä¸º 0 ä»¥è§„é¿é—®é¢˜ã€‚æ³¨æ„ï¼šè¿™ä¸ªå‚æ•°å’Œ `--insecure-bind-address` éƒ½å·²è¿‡æœŸï¼Œå¹¶å°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ç§»é™¤ã€‚

```
+-----------------------------------------------------------------------------------------------------------+
|                                                                                                           |
|               +---------------------------------------------------------------------------+    +--------+ |
|               |                                                                           |    |        | |
| +--------+    |   +------------------+   +----------------+   +--------------+   +------+ |    |        | |
| |        |    |   |                  |   |                |   | Admission    |   |      | |    |        | |
| | Client +------> | Authentication   +-> | Authorization  +-> | Control      +-> |Logic | +--> | Others | |
| |        |    |   |                  |   |                |   |              |   |      | |    |        | |
| +--------+    |   +------------------+   +----------------+   +--------------+   +------+ |    |        | |
|               |                                                                           |    |        | |
|               |                                                                           |    |        | |
|               |                          Kube-apiserver                                   |    |        | |
|               +---------------------------------------------------------------------------+    +--------+ |
|                                                                                                           |
+-----------------------------------------------------------------------------------------------------------+
```

## è®¤è¯ï¼ˆAuthenticationï¼‰

è®¤è¯ï¼Œæ— éæ˜¯åˆ¤æ–­å½“å‰å‘èµ·è¯·æ±‚çš„ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬é€šå¸¸ç™»å½•æœåŠ¡å™¨æ—¶å€™éœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ–è€… SSH Keys ä¹‹ç±»çš„ã€‚

åœ¨è®²è®¤è¯å‰ï¼Œæˆ‘ä»¬åº”è¯¥å…ˆç†ä¸€ä¸‹ K8S ä¸­çš„ç”¨æˆ·ã€‚

K8S ä¸­æœ‰ä¸¤ç±»ç”¨æˆ·ï¼Œä¸€èˆ¬ç”¨æˆ·åŠ `Service Account`ã€‚

- ä¸€èˆ¬ç”¨æˆ·ï¼šä¸€èˆ¬ç”¨æˆ·åªèƒ½é€šè¿‡å¤–éƒ¨æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œç”±ç®¡ç†å‘˜è¿›è¡Œç§é’¥åˆ†å‘ã€‚è¿™ä¹Ÿæ„å‘³ç€ K8S ä¸­å¹¶æ²¡æœ‰ä»»ä½•è¡¨ç¤ºä¸€èˆ¬ç”¨æˆ·çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨æˆ·æ˜¯æ— æ³•é€šè¿‡ API ç›´æ¥æ·»åŠ åˆ°é›†ç¾¤çš„ã€‚
- `Service Account`ï¼šç”± K8S API ç®¡ç†çš„ç”¨æˆ·ï¼Œä¸ç‰¹å®šçš„ `NameSpace`ï¼ˆå‘½åç©ºé—´ï¼‰ç»‘å®šã€‚ç”± `API Server` è‡ªåŠ¨åˆ›å»ºæˆ–è€…é€šè¿‡ API æ‰‹åŠ¨è¿›è¡Œåˆ›å»ºã€‚ åŒæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æŒ‚è½½åˆ° `Pod` ä¸­å®¹å™¨çš„ `/var/run/secrets/kubernetes.io/serviceaccount/` ç›®å½•ä¸­ï¼Œå…¶ä¸­ä¼šåŒ…å« `NameSpace` `token` ç­‰ä¿¡æ¯ï¼Œå¹¶å…è®¸é›†ç¾¤å†…è¿›ç¨‹ä¸ `API Server` è¿›è¡Œäº¤äº’ã€‚

å¯¹é›†ç¾¤æ“ä½œçš„ API éƒ½æ˜¯ä¸ç”¨æˆ·ç›¸å…³è”çš„ï¼Œæˆ–è€…è¢«è§†ä¸ºåŒ¿åè¯·æ±‚ã€‚åŒ¿åè¯·æ±‚å¯é€šè¿‡ `kube-apiserver` çš„ `--anonymous-auth` å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ï¼ŒåŒ¿åç”¨æˆ·é»˜è®¤çš„ç”¨æˆ·åä¸º `system:anonymous`ï¼Œæ‰€å±ç»„ä¸º `system:unauthenticated`ã€‚

ç†å®Œ K8S ä¸­çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ K8S ä¸­çš„è®¤è¯æœºåˆ¶ã€‚

K8S æ”¯æŒä»¥ä¸‹è®¤è¯æœºåˆ¶ï¼š

- X509 å®¢æˆ·ç«¯è¯ä¹¦ï¼šè¿™ä¸ªè®¤è¯æœºåˆ¶æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œæˆ‘ä»¬å‰é¢æ­å»ºé›†ç¾¤æ—¶ï¼Œè™½ç„¶æ²¡æœ‰æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œä½† `kubeadm` å·²ç»æ·»åŠ äº†é»˜è®¤å‚æ•° `--client-ca-file=/etc/kubernetes/pki/ca.crt` è€Œåœ¨è¿›è¡Œè®¤è¯æ—¶ï¼Œå°†ä¼šä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦ subject çš„ `CN` åŸŸï¼ˆCommon Nameï¼‰ç”¨ä½œç”¨æˆ·åï¼Œ`O` åŸŸï¼ˆOrganizationï¼‰ç”¨ä½œç»„åã€‚
- å¼•å¯¼ Tokenï¼šè¿™ä¸ªæˆ‘ä»¬ä¹Ÿä¸ä¼šé™Œç”Ÿï¼Œå‰é¢æˆ‘ä»¬æ­å»ºé›†ç¾¤æ—¶ï¼Œå½“é›†ç¾¤é€šè¿‡ `kubeadm init` åˆå§‹åŒ–å®Œæˆåï¼Œå°†ä¼šå±•ç¤ºä¸€è¡Œæç¤ºï¼Œå…¶ä¸­ä¾¿æºå¸¦ç€å¼•å¯¼ Tokenã€‚å¦‚æœä¸ä½¿ç”¨ `kubeadm` æ—¶ï¼Œéœ€è¦è®¾ç½® `--enable-bootstrap-token-auth=true`ã€‚
- é™æ€ Token æ–‡ä»¶ï¼šå¯åŠ¨ `Kube-apiserver` æ—¶ï¼Œè®¾ç½® `--token-auth-file=SOMEFILE` å¹¶åœ¨è¯·æ±‚æ—¶ï¼ŒåŠ ä¸Š `Authorization: Bearer TOKEN` çš„è¯·æ±‚å¤´å³å¯ã€‚
- é™æ€å¯†ç æ–‡ä»¶ï¼šä¸é™æ€ Token æ–‡ä»¶ç±»ä¼¼ï¼Œè®¾ç½® `--basic-auth-file=SOMEFILE` å¹¶åœ¨è¯·æ±‚æ—¶ï¼ŒåŠ ä¸Š `Authorization: Basic BASE64ENCODED(USER:PASSWORD)` çš„å¤´å³å¯ã€‚
- Service Account Tokenï¼šè¿™æ˜¯é»˜è®¤å¯ç”¨çš„æœºåˆ¶ï¼Œå…³äº `Service Account` å‰é¢ä¹Ÿå·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸å†èµ˜è¿°ã€‚
- OpenIDï¼šå…¶å®æ˜¯æä¾›äº† [OAuth2](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html) çš„è®¤è¯æ”¯æŒï¼Œåƒ Azure æˆ– Google è¿™ç±»äº‘å‚å•†éƒ½æä¾›äº†ç›¸å…³æ”¯æŒã€‚
- è®¤è¯ä»£ç†ï¼šä¸»è¦æ˜¯é…åˆèº«ä»½éªŒè¯ä»£ç†è¿›è¡Œä½¿ç”¨ï¼Œæ¯”å¦‚æä¾›ä¸€ä¸ªé€šç”¨çš„æˆæƒç½‘å…³ä¾›ç”¨æˆ·ä½¿ç”¨ã€‚
- Webhookï¼šæä¾› Webhook é…åˆä¸€ä¸ªè¿œç«¯æœåŠ¡å™¨ä½¿ç”¨ã€‚

å¯é€‰æ‹©åŒæ—¶å¼€å¯å¤šä¸ªè®¤è¯æœºåˆ¶ã€‚æ¯”å¦‚å½“æˆ‘ä»¬ä½¿ç”¨ `kubeadm` åˆ›å»ºé›†ç¾¤æ—¶ï¼Œé»˜è®¤ä¾¿ä¼šå¼€å¯ X509 å®¢æˆ·ç«¯è¯ä¹¦å’Œå¼•å¯¼ Token ç­‰è®¤è¯æœºåˆ¶ã€‚

## æˆæƒï¼ˆAuthorizationï¼‰

æˆæƒï¼Œä¹Ÿå°±æ˜¯åœ¨éªŒè¯å½“å‰å‘èµ·è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦æœ‰ç›¸å…³çš„æƒé™ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ Linux ç³»ç»Ÿä¸­å¸¸è§çš„æ–‡ä»¶å¤¹æƒé™ä¹‹ç±»çš„ã€‚

æˆæƒæ˜¯ä»¥è®¤è¯çš„ç»“æœä¸ºåŸºç¡€çš„ï¼Œæˆæƒæœºåˆ¶æ£€æŸ¥ç”¨æˆ·é€šè¿‡è®¤è¯åçš„è¯·æ±‚ä¸­æ‰€åŒ…å«çš„å±æ€§æ¥è¿›è¡Œåˆ¤æ–­ã€‚

K8S æ”¯æŒå¤šç§æˆæƒæœºåˆ¶ï¼Œç”¨æˆ·æƒ³è¦æ­£ç¡®æ“ä½œèµ„æºï¼Œåˆ™å¿…é¡»è·å¾—æˆæƒï¼Œæ‰€ä»¥ K8S é»˜è®¤æƒ…å†µä¸‹çš„æƒé™éƒ½æ˜¯æ‹’ç»ã€‚å½“æŸç§æˆæƒæœºåˆ¶é€šè¿‡æˆ–è€…æ‹’ç»åï¼Œä¾¿ä¼šç«‹å³è¿”å›ï¼Œä¸å†å»è¯·æ±‚å…¶ä»–çš„æˆæƒæœºåˆ¶ï¼›å½“æ‰€æœ‰æˆæƒæœºåˆ¶éƒ½æœªé€šè¿‡æ—¶ä¾¿ä¼šè¿”å› 403 é”™è¯¯äº†ã€‚

K8S æ”¯æŒä»¥ä¸‹æˆæƒæœºåˆ¶ï¼š

- ABAC(Attribute-Based Access Control)ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦å…ˆé…ç½® `--authorization-mode=ABAC` å’Œ `--authorization-policy-file=SOME_FILENAME` ã€‚ABAC æœ¬èº«è®¾è®¡æ˜¯éå¸¸å¥½çš„ï¼Œä½†æ˜¯åœ¨ K8S ä¸­ä½¿ç”¨å´æœ‰ç‚¹è¿‡äºç¹çï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
- RBAC(Role-based access control)ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œè‡ª K8S 1.6 å¼€å§‹ betaï¼Œ1.8 è¿›å…¥ç¨³å®šç‰ˆï¼Œå·²è¢«å¤§é‡ä½¿ç”¨ã€‚è€Œå½“æˆ‘ä»¬ä½¿ç”¨ `kubeadm` å®‰è£…é›†ç¾¤çš„æ—¶å€™ï¼Œé»˜è®¤å°†ä¼šæ·»åŠ  `--authorization-mode=Node,RBAC` çš„å‚æ•°ï¼Œè¡¨ç¤ºåŒæ—¶å¼€å¯ `Node` å’Œ `RBAC` æˆæƒæœºåˆ¶ã€‚å½“ç„¶ï¼Œå¦‚æœä½ å¯¹ [MongoDB](https://www.mongodb.com/cn) æœ‰æ‰€äº†è§£æˆ–è€…æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹å°±ä¼šå¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸º MongoDB çš„æƒé™æ§åˆ¶ä¹Ÿä½¿ç”¨äº† `RBAC` ï¼ˆRole-based access controlï¼‰ã€‚
- Nodeï¼šè¿™æ˜¯ä¸€ç§ç‰¹æ®Šç”¨é€”çš„æˆæƒæœºåˆ¶ï¼Œä¸“é—¨ç”¨äºå¯¹ `kubelet` å‘å‡ºçš„ API è¯·æ±‚åšæˆæƒéªŒè¯ã€‚
- Webhookï¼šä½¿ç”¨å¤–éƒ¨çš„ Server é€šè¿‡ API è¿›è¡Œæˆæƒæ ¡éªŒï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶å€™å¢åŠ  `--authorization-webhook-config-file=SOME_FILENAME` ä»¥åŠ `--authorization-mode=Webhook`
- AlwaysAllowï¼šé»˜è®¤é…ç½®ï¼Œå…è®¸å…¨éƒ¨ã€‚
- AlwaysDenyï¼šé€šå¸¸ç”¨äºæµ‹è¯•ï¼Œç¦æ­¢å…¨éƒ¨ã€‚

## è§’è‰²ï¼ˆRoleï¼‰

ä¸Šé¢æåˆ°äº† `RBAC`ï¼Œä¸ºäº†èƒ½æ›´å¥½çš„ç†è§£ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¤è¯†ä¸‹ K8S ä¸­çš„è§’è‰²ã€‚K8S ä¸­çš„è§’è‰²ä»ç±»åˆ«ä¸Šä¸»è¦æœ‰ä¸¤ç±»ï¼Œ`Role` å’Œ `ClusterRole`ã€‚

- `Role`ï¼šå¯ä»¥å½“ä½œæ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œä½†è¢«é™åˆ¶åœ¨æŸä¸ª `Namespace` å†…ï¼ˆK8S çš„ `Namespace`ï¼‰ã€‚
- `ClusterRole`ï¼šå¯¹äºé›†ç¾¤çº§åˆ«çš„èµ„æºæ˜¯ä¸è¢« `Namespace` æ‰€é™åˆ¶çš„ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€äº›éèµ„æºç±»çš„è¯·æ±‚ï¼Œæ‰€ä»¥ä¾¿äº§ç”Ÿäº†å®ƒã€‚

å½“å·²ç»äº†è§£åˆ°è§’è‰²åï¼Œå‰©ä¸‹ç»™ç”¨æˆ·æˆæƒä¹Ÿå°±åªæ˜¯éœ€è¦åšä¸€æ¬¡ç»‘å®šå³å¯ã€‚åœ¨ K8S ä¸­å°†è¿™ä¸€è¿‡ç¨‹ç§°ä¹‹ä¸º bindingï¼Œå³ `rolebinding` å’Œ `clusterrolebinding`ã€‚ æˆ‘ä»¬æ¥çœ‹ä¸‹é›†ç¾¤åˆšåˆå§‹åŒ–åçš„æƒ…å†µï¼š

```
âœ  ~ kubectl get roles --all-namespaces=true
NAMESPACE     NAME                                             AGE
kube-public   kubeadm:bootstrap-signer-clusterinfo             1h
kube-public   system:controller:bootstrap-signer               1h
kube-system   extension-apiserver-authentication-reader        1h
kube-system   kube-proxy                                       1h
kube-system   kubeadm:kubelet-config-1.12                      1h
kube-system   kubeadm:nodes-kubeadm-config                     1h
kube-system   system::leader-locking-kube-controller-manager   1h
kube-system   system::leader-locking-kube-scheduler            1h
kube-system   system:controller:bootstrap-signer               1h
kube-system   system:controller:cloud-provider                 1h
kube-system   system:controller:token-cleaner                  1h
âœ  ~ kubectl get rolebindings --all-namespaces=true
NAMESPACE     NAME                                             AGE
kube-public   kubeadm:bootstrap-signer-clusterinfo             1h
kube-public   system:controller:bootstrap-signer               1h
kube-system   kube-proxy                                       1h
kube-system   kubeadm:kubelet-config-1.12                      1h
kube-system   kubeadm:nodes-kubeadm-config                     1h
kube-system   system::leader-locking-kube-controller-manager   1h
kube-system   system::leader-locking-kube-scheduler            1h
kube-system   system:controller:bootstrap-signer               1h
kube-system   system:controller:cloud-provider                 1h
kube-system   system:controller:token-cleaner                  1h
```

å¯ä»¥çœ‹åˆ°é»˜è®¤å·²ç»å­˜åœ¨äº†ä¸€äº› `role` å’Œ `rolebindings`ã€‚ å¯¹äºè¿™éƒ¨åˆ†æš‚ä¸”ä¸åšè¿‡å¤šè¯´æ˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¯¹äºé›†ç¾¤å…¨å±€æœ‰æ•ˆçš„ `ClusterRole` ã€‚

```
âœ  ~ kubectl get clusterroles
NAME                                                                   AGE
admin                                                                  1h
cluster-admin                                                          1h
edit                                                                   1h
flannel                                                                1h
system:aggregate-to-admin                                              1h
system:aggregate-to-edit                                               1h
system:aggregate-to-view                                               1h
system:auth-delegator                                                  1h
system:aws-cloud-provider                                              1h
system:basic-user                                                      1h
system:certificates.k8s.io:certificatesigningrequests:nodeclient       1h
system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   1h
system:controller:attachdetach-controller                              1h
system:controller:certificate-controller                               1h
system:controller:clusterrole-aggregation-controller                   1h
system:controller:cronjob-controller                                   1h
system:controller:daemon-set-controller                                1h
system:controller:deployment-controller                                1h
system:controller:disruption-controller                                1h
system:controller:endpoint-controller                                  1h
system:controller:expand-controller                                    1h
system:controller:generic-garbage-collector                            1h
system:controller:horizontal-pod-autoscaler                            1h
system:controller:job-controller                                       1h
system:controller:namespace-controller                                 1h
system:controller:node-controller                                      1h
system:controller:persistent-volume-binder                             1h
system:controller:pod-garbage-collector                                1h
system:controller:pv-protection-controller                             1h
system:controller:pvc-protection-controller                            1h
system:controller:replicaset-controller                                1h
system:controller:replication-controller                               1h
system:controller:resourcequota-controller                             1h
system:controller:route-controller                                     1h
system:controller:service-account-controller                           1h
system:controller:service-controller                                   1h
system:controller:statefulset-controller                               1h
system:controller:ttl-controller                                       1h
system:coredns                                                         1h
system:csi-external-attacher                                           1h
system:csi-external-provisioner                                        1h
system:discovery                                                       1h
system:heapster                                                        1h
system:kube-aggregator                                                 1h
system:kube-controller-manager                                         1h
system:kube-dns                                                        1h
system:kube-scheduler                                                  1h
system:kubelet-api-admin                                               1h
system:node                                                            1h
system:node-bootstrapper                                               1h
system:node-problem-detector                                           1h
system:node-proxier                                                    1h
system:persistent-volume-provisioner                                   1h
system:volume-scheduler                                                1h
view                                                                   1h
âœ  ~ kubectl get clusterrolebindings
NAME                                                   AGE
cluster-admin                                          1h
flannel                                                1h
kubeadm:kubelet-bootstrap                              1h
kubeadm:node-autoapprove-bootstrap                     1h
kubeadm:node-autoapprove-certificate-rotation          1h
kubeadm:node-proxier                                   1h
system:aws-cloud-provider                              1h
system:basic-user                                      1h
system:controller:attachdetach-controller              1h
system:controller:certificate-controller               1h
system:controller:clusterrole-aggregation-controller   1h
system:controller:cronjob-controller                   1h
system:controller:daemon-set-controller                1h
system:controller:deployment-controller                1h
system:controller:disruption-controller                1h
system:controller:endpoint-controller                  1h
system:controller:expand-controller                    1h
system:controller:generic-garbage-collector            1h
system:controller:horizontal-pod-autoscaler            1h
system:controller:job-controller                       1h
system:controller:namespace-controller                 1h
system:controller:node-controller                      1h
system:controller:persistent-volume-binder             1h
system:controller:pod-garbage-collector                1h
system:controller:pv-protection-controller             1h
system:controller:pvc-protection-controller            1h
system:controller:replicaset-controller                1h
system:controller:replication-controller               1h
system:controller:resourcequota-controller             1h
system:controller:route-controller                     1h
system:controller:service-account-controller           1h
system:controller:service-controller                   1h
system:controller:statefulset-controller               1h
system:controller:ttl-controller                       1h
system:coredns                                         1h
system:discovery                                       1h
system:kube-controller-manager                         1h
system:kube-dns                                        1h
system:kube-scheduler                                  1h
system:node                                            1h
system:node-proxier                                    1h
system:volume-scheduler                                1h
```

å¯ä»¥çœ‹åˆ° K8S ä¸­é»˜è®¤å·²ç»æœ‰å¾ˆå¤šçš„ `ClusterRole` å’Œ `clusterrolebindings` äº†ï¼Œæˆ‘ä»¬é€‰æ‹©å…¶ä¸­ä¸€ä¸ªåšä¸‹æ¢ç©¶ã€‚

## æŸ¥çœ‹ç”¨æˆ·æƒé™

æˆ‘ä»¬ä¸€ç›´éƒ½åœ¨ä½¿ç”¨ `kubectl` å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆå½“å‰ç”¨æˆ·æ˜¯ä»€ä¹ˆæƒé™å‘¢ï¼Ÿ å¯¹åº”äº `RBAC` ä¸­åˆæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

```
âœ  ~ kubectl config current-context   # è·å–å½“å‰ä¸Šä¸‹æ–‡
kubernetes-admin@kubernetes  # åä¸º kubernetes-admin çš„ç”¨æˆ·ï¼Œåœ¨åä¸º kubernetes çš„ cluster ä¸Š
âœ  ~ kubectl config view users -o yaml  # æŸ¥çœ‹ user é…ç½®ï¼Œä»¥ä¸‹çœç•¥äº†éƒ¨åˆ†å†…å®¹
apiVersion: v1
clusters:                                   
- cluster:                            
    ...
contexts:                    
- context:  
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
```

`client-certificate-data` çš„éƒ¨åˆ†é»˜è®¤æ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œè€Œå®ƒçš„**å†…å®¹å®é™…æ˜¯é€šè¿‡ `base64` åŠ å¯†åçš„è¯ä¹¦å†…å®¹**ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡ŒæŸ¥çœ‹

```
âœ  ~ kubectl config view users --raw -o jsonpath='{ .users[?(@.name == "kubernetes-admin")].user.client-certificate-data}' |base64 -d  
-----BEGIN CERTIFICATE-----
MIIC8jCCAdqgAwIBAgIIGuC27C9B8LIwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE
...
kae1A/d4D5Cm5Qt7M5gr3SxqE5t+O7DP0YhuEPlfY7RzYDksYa8=
-----END CERTIFICATE-----
âœ  ~ kubectl config view users --raw -o jsonpath='{ .users[?(@.name == "kubernetes-admin")].user.client-certificate-data}' |base64 -d |openssl x509 -text -noout  # é™äºç¯‡å¹… çœç•¥éƒ¨åˆ†è¾“å‡º
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 1936748965290700978 (0x1ae0b6ec2f41f0b2)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=kubernetes
        Subject: O=system:masters, CN=kubernetes-admin
        ...
```

æ ¹æ®å‰é¢è®¤è¯éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘ä»¬çŸ¥é“å½“å‰çš„ç”¨æˆ·æ˜¯ `kubernetes-admin` ï¼ˆCN åŸŸï¼‰ï¼Œæ‰€å±ç»„æ˜¯ `system:masters` ï¼ˆO åŸŸï¼‰ ã€‚

æˆ‘ä»¬çœ‹ä¸‹ `clusterrolebindings` ä¸­çš„ `cluster-admin` ã€‚

```
âœ  ~ kubectl get clusterrolebindings  cluster-admin  -o yaml                         
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  ...
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: "116"
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/cluster-admin
  uid: 71c550f1-e0e4-11e8-866a-fa163e938a99
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:masters
```

é‡ç‚¹å†…å®¹åœ¨ `roleRef` å’Œ `subjects` ä¸­ï¼Œåä¸º `cluster-admin` çš„ `ClusterRole` ä¸åä¸º `system:masters` çš„ `Group` ç›¸ç»‘å®šã€‚æˆ‘ä»¬ç»§ç»­æ¢ç©¶ä¸‹å®ƒä»¬æ‰€ä»£è¡¨çš„å«ä¹‰ã€‚

å…ˆçœ‹çœ‹è¿™ä¸ª `ClusterRole` çš„å®é™…å†…å®¹ï¼š

```
âœ  ~ kubectl get clusterrole cluster-admin -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  ...
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: "58"
  selfLink: /apis/rbac.authorization.k8s.io/v1/clusterroles/cluster-admin
  uid: 71307108-e0e4-11e8-866a-fa163e938a99
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
- nonResourceURLs:
  - '*'
  verbs:
  - '*'
```

`rules` ä¸­å®šä¹‰äº†å®ƒæ‰€èƒ½æ“ä½œçš„èµ„æºåŠå¯¹åº”åŠ¨ä½œï¼Œ`*` æ˜¯é€šé…ç¬¦ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºç»“è®ºäº†ï¼Œå½“å‰ç”¨æˆ· `kubernetes-admin` å±äº `system:masters` ç»„ï¼Œè€Œè¿™ä¸ªç»„ä¸ `cluster-admin` è¿™ä¸ª `ClusterRole` æ‰€ç»‘å®šï¼Œæ‰€ä»¥ç”¨æˆ·ä¹Ÿå°±ç»§æ‰¿äº†å…¶æƒé™ã€‚å…·å¤‡äº†å¯¹å¤šç§èµ„æºå’Œ API çš„ç›¸å…³æ“ä½œæƒé™ã€‚

## å®è·µï¼šåˆ›å»ºæƒé™å¯æ§çš„ç”¨æˆ·

å‰é¢æ˜¯é€šè¿‡å®é™…ç”¨æˆ·æ¥åæ¨å®ƒæ‰€å…·å¤‡çš„æƒé™ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å®è·µçš„éƒ¨åˆ†ï¼Œåˆ›å»ºç”¨æˆ·å¹¶ä¸ºå®ƒè¿›è¡Œæˆæƒã€‚

æˆ‘ä»¬è¦åˆ›å»ºçš„ç”¨æˆ·åä¸º `backend` æ‰€å±ç»„ä¸º `dev`ã€‚

### åˆ›å»º NameSpace

ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ `NameSpace` ï¼Œåä¸º `work`ã€‚

```
âœ  ~ kubectl create namespace work
namespace/work created
âœ  ~ kubectl get ns work
NAME   STATUS   AGE
work   Active   14s
```

### åˆ›å»ºç”¨æˆ·

#### åˆ›å»ºç§é’¥

```
âœ  ~ mkdir work
âœ  ~ cd work
âœ  work openssl genrsa -out backend.key 2048
Generating RSA private key, 2048 bit long modulus
..........................................+++                            
........................+++                   
e is 65537 (0x10001)            
âœ  work ls                                       
backend.key 

âœ  work cat backend.key                                              
-----BEGIN RSA PRIVATE KEY-----                                          
MIIEpAIBAAKCAQEAzk7blZthwSzachPxrk6pHsuaImTVh6Iw8mNDmtn6sqOqBfZS
...
bNKDWDk8HZREugaOAwjt7xaWOlr9SPCCoXrWoaA1z2215IC4qSA2Nw==
-----END RSA PRIVATE KEY-----
```

#### ä½¿ç”¨ç§é’¥ç”Ÿæˆè¯ä¹¦è¯·æ±‚ã€‚å‰é¢å·²ç»è®²è¿‡å…³äºè®¤è¯çš„éƒ¨åˆ†ï¼Œåœ¨è¿™é‡Œéœ€è¦æŒ‡å®š `subject` ä¿¡æ¯ï¼Œä¼ é€’ç”¨æˆ·åå’Œç»„å

```
âœ  work openssl req -new -key backend.key -out backend.csr -subj "/CN=backend/O=dev"
âœ  work ls
backend.csr  backend.key
âœ  work cat backend.csr
-----BEGIN CERTIFICATE REQUEST-----
MIICZTCCAU0CAQAwIDEQMA4GA1UEAwwHYmFja2VuZDEMMAoGA1UECgwDZGV2MIIB
...
lpoSVlNA0trJoiEiZjUqMfXX6ogBhQC4aeRfmbXkW2ZCNxsIm3PDk1Y=
-----END CERTIFICATE REQUEST-----
```

#### ä½¿ç”¨ CA è¿›è¡Œç­¾åã€‚K8S é»˜è®¤çš„è¯ä¹¦ç›®å½•ä¸º `/etc/kubernetes/pki`ã€‚

```
âœ  work openssl x509 -req -in backend.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out backend.crt -days 365
Signature ok
subject=/CN=backend/O=dev
Getting CA Private Key
âœ  work ls
backend.crt  backend.csr  backend.key
```

æŸ¥çœ‹ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶

```
âœ  work openssl x509 -in backend.crt -text -noout
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            d9:7f:62:f7:38:66:2a:7b
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=kubernetes
        Subject: CN=backend, O=dev
        ...
```

å¯ä»¥çœ‹åˆ° `CN` åŸŸå’Œ `O` åŸŸå·²ç»æ­£ç¡®è®¾ç½®

#### æ·»åŠ  context

```
âœ  work kubectl config set-credentials backend --client-certificate=/root/work/backend.crt  --client-key=/root/work/backend.key
User "backend" set.
âœ  work kubectl config set-context backend-context --cluster=kubernetes --namespace=work --user=backend
Context "backend-context" created.
```

#### ä½¿ç”¨æ–°ç”¨æˆ·æµ‹è¯•è®¿é—®

```
âœ  work kubectl --context=backend-context get pods
Error from server (Forbidden): pods is forbidden: User "backend" cannot list resource "pods" in API group "" in the namespace "work"
# å¯èƒ½çœ‹å¾—ä¸å¤Ÿæ¸…æ¥šï¼Œæˆ‘ä»¬æ·»åŠ  `-v` å‚æ•°æ¥æ˜¾ç¤ºè¯¦æƒ…
âœ  work kubectl --context=backend-context get pods -n work -v 5
I1109 05:35:11.870639   18626 helpers.go:201] server response object: [{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "pods is forbidden: User \"backend\" cannot list resource \"pods\" in API group \"\" in the namespace \"work\"",
  "reason": "Forbidden",
  "details": {
    "kind": "pods"
  },
  "code": 403
}]
F1109 05:35:11.870688   18626 helpers.go:119] Error from server (Forbidden): pods is forbidden: User "backend" cannot list resource "pods" in API group "" in the namespace "work"
```

å¯ä»¥çœ‹åˆ°å·²ç»ä½¿ç”¨äº†æ–°çš„ `backend` ç”¨æˆ·ï¼Œå¹¶ä¸”é»˜è®¤çš„ `Namespace` è®¾ç½®æˆäº† `work`ã€‚

#### åˆ›å»º Role

æˆ‘ä»¬æƒ³è¦è®©è¿™ä¸ªç”¨æˆ·åªå…·å¤‡æŸ¥çœ‹ `Pod` çš„æƒé™ã€‚å…ˆæ¥åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚

```
âœ  work cat <<EOF > backend-role.yaml 
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: work
  name: backend-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
EOF
```

åˆ›å»ºå¹¶æŸ¥çœ‹å·²ç”Ÿæˆçš„ `Role`ã€‚

```
âœ  work kubectl create -f backend-role.yaml 
role.rbac.authorization.k8s.io/backend-role created
âœ  work kubectl get roles  -n work -o yaml
apiVersion: v1
items:
- apiVersion: rbac.authorization.k8s.io/v1
  kind: Role
  metadata:
    ...
    name: backend-role
    namespace: work
    selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/work/roles/backend-role
  rules:
  - apiGroups:
    - ""
    resources:
    - pods
    verbs:
    - get
    - list
    - watch
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""
```

#### åˆ›å»º Rolebinding

å…ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚

```
âœ  work cat <<EOF > backend-rolebind.yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: backend-rolebinding          
  namespace: work
subjects:      
- kind: User
  name: backend
  apiGroup: ""     
roleRef:    
  kind: Role 
  name: backend-role
  apiGroup: ""
EOF
```

åˆ›å»ºå¹¶æŸ¥çœ‹å·²ç”Ÿæˆçš„ Rolebinding ã€‚

```
âœ  work kubectl create -f backend-rolebind.yaml
rolebinding.rbac.authorization.k8s.io/backend-rolebinding created
âœ  work kubectl get rolebinding -o yaml -n work
apiVersion: v1
items:
- apiVersion: rbac.authorization.k8s.io/v1
  kind: RoleBinding
  metadata:
    name: backend-rolebinding
    namespace: work
    ...
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: backend-role
  subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: backend
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""
```

#### æµ‹è¯•ç”¨æˆ·æƒé™

```
âœ  work kubectl --context=backend-context get pods -n work
No resources found.
âœ  work kubectl --context=backend-context get ns
Error from server (Forbidden): namespaces is forbidden: User "backend" cannot list resource "namespaces" in API group "" at the cluster scope
âœ  work kubectl --context=backend-context get deploy -n work
Error from server (Forbidden): deployments.extensions is forbidden: User "backend" cannot list resource "deployments" in API group "extensions" in the namespace "work"
```

å¯ä»¥çœ‹åˆ°ç”¨æˆ·å·²ç»å…·å¤‡æŸ¥çœ‹ `Pod` çš„æƒé™ï¼Œä½†å¹¶ä¸èƒ½æŸ¥çœ‹ `Namespace` æˆ–è€… `deployment` ç­‰å…¶ä»–èµ„æºã€‚å½“ç„¶ï¼ŒK8S ä¹Ÿå†…ç½®äº†ä¸€ç§å¾ˆæ–¹ä¾¿çš„è°ƒè¯•æœºåˆ¶ã€‚

```
âœ  work kubectl auth can-i list pods -n work --as="backend"
yes
âœ  work kubectl auth can-i list deploy -n work --as="backend"
no - no RBAC policy matched
```

`--as` æ˜¯ä¸€ç§å»ºç«‹åœ¨ K8S è®¤è¯æœºåˆ¶ä¹‹ä¸Šçš„æœºåˆ¶ï¼Œå¯ä»¥ä¾¿äºç³»ç»Ÿç®¡ç†å‘˜éªŒè¯æˆæƒæƒ…å†µï¼Œæˆ–è¿›è¡Œè°ƒè¯•ã€‚

ä½ ä¹Ÿå¯ä»¥ä»¿ç…§ `~/.kube/config` æ–‡ä»¶çš„å†…å®¹ï¼Œå°†å½“å‰ç”Ÿæˆçš„è¯ä¹¦åŠç§é’¥æ–‡ä»¶ç­‰å†™å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œé€šè¿‡æŒ‡å®š `KUBECONFIG` çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…ç»™ `kubectl` ä¼ é€’ `--kubeconfig` å‚æ•°æ¥ä½¿ç”¨ã€‚

## æ€»ç»“

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº† K8S çš„è®¤è¯åŠæˆæƒé€»è¾‘ï¼ŒK8S æ”¯æŒå¤šç§è®¤è¯åŠæˆæƒæ¨¡å¼ï¼Œå¯æŒ‰éœ€ä½¿ç”¨ã€‚é€šè¿‡ X509 å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯çš„æ–¹å¼ä½¿ç”¨æ¯”è¾ƒæ–¹ä¾¿ä¹Ÿæ¯”è¾ƒæ¨èï¼Œåœ¨å®¢æˆ·ç«¯è¯ä¹¦çš„ `CN` åŸŸå’Œ `O` åŸŸå¯ä»¥æŒ‡å®šç”¨æˆ·åå’Œæ‰€å±ç»„åã€‚

RBAC çš„æˆæƒæ¨¡å¼ç°åœ¨ä½¿ç”¨æœ€å¤šï¼Œå¯ä»¥é€šè¿‡å¯¹ `Role` å’Œ `subjects` (å¯ä»¥æ˜¯ç”¨æˆ·æˆ–ç»„) è¿›è¡Œç»‘å®šï¼Œä»¥è¾¾åˆ°æˆæƒçš„ç›®çš„ã€‚

æœ€åï¼Œæˆ‘ä»¬å®é™…æ–°åˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶å¯¹å…¶æˆäºˆäº†é¢„æœŸçš„æƒé™ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ä¹Ÿæ¶‰åŠåˆ°äº† `openssl` å®¢æˆ·ç«¯çš„å¸¸è§„æ“ä½œï¼Œåœ¨ä¹‹åä¹Ÿä¼šå¸¸å¸¸ç”¨åˆ°ã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†å¼€å§‹éƒ¨ç½²å®é™…çš„é¡¹ç›®åˆ° K8S ä¸­ï¼Œé€æ­¥æŒæ¡ç”Ÿæˆç¯å¢ƒä¸­å¯¹ K8S çš„ä½¿ç”¨å®è·µã€‚

PS: ä¹Ÿè®¸ä½ ä¼šè§‰å¾—åˆ‡æ¢ `Namespace` ä¹‹ç±»çš„æ“ä½œå¾ˆç¹çï¼Œæœ‰ä¸€ä¸ªé¡¹ç›®ï¼š[kubectx](https://github.com/ahmetb/kubectx) å¯å¸®ä½ ç®€åŒ–è¿™äº›æ­¥éª¤ï¼Œæ¨èå°è¯•ã€‚

ç•™è¨€

# åº”ç”¨å‘å¸ƒ: éƒ¨ç½²å®é™…é¡¹ç›®

æœ¬èŠ‚æˆ‘ä»¬å¼€å§‹å­¦ä¹ å¦‚ä½•å°†å®é™…é¡¹ç›®éƒ¨ç½²è‡³ K8S ä¸­ï¼Œå¼€å¯ç”Ÿäº§å®è·µä¹‹è·¯ã€‚

## æ•´ä½“æ¦‚è§ˆ

æœ¬èŠ‚æ‰€ç”¨ç¤ºä¾‹é¡¹ç›®æ˜¯ä¸€ä¸ªæ··åˆäº† Goï¼ŒNodeJSï¼ŒPython ç­‰è¯­è¨€çš„é¡¹ç›®ï¼Œçµæ„Ÿæ¥è‡ªäºçŸ¥åç¨‹åºå‘˜ [Kenneth Reitz](https://github.com/kennethreitz) çš„ [Say Thanks](https://saythanks.io/) é¡¹ç›®ã€‚æœ¬é¡¹ç›®å®ç°çš„åŠŸèƒ½ä¸»è¦æœ‰ä¸¤ä¸ªï¼š1. ç”¨æˆ·é€šè¿‡å‰ç«¯å‘é€æ„Ÿè°¢æ¶ˆæ¯ 2. æœ‰ä¸ªå·¥ä½œè¿›ç¨‹ä¼šæŒç»­çš„è®¡ç®—æ”¶åˆ°æ„Ÿè°¢æ¶ˆæ¯çš„æ’è¡Œæ¦œã€‚é¡¹ç›®ä»£ç å¯åœ¨ [GitHub ä¸Šè·å¾—](https://github.com/tao12345666333/saythx)ã€‚æ¥ä¸‹æ¥å‡ èŠ‚ä¸­å¦‚æœéœ€è¦ç”¨åˆ°æ­¤é¡¹ç›®æˆ‘ä¼šç»Ÿä¸€ç§°ä¹‹ä¸º saythx é¡¹ç›®ã€‚

saythx é¡¹ç›®çš„åŸºç¡€ç»“æ„å¦‚ä¸‹å›¾ï¼š



![img](https://user-gold-cdn.xitu.io/2018/11/18/16722d23f282fa8b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## æ„å»ºé•œåƒ

### å‰ç«¯

æˆ‘ä»¬ä½¿ç”¨äº†å‰ç«¯æ¡†æ¶ [Vue](https://vuejs.org/)ï¼Œæ‰€ä»¥åœ¨åšç”Ÿäº§éƒ¨ç½²æ—¶ï¼Œéœ€è¦å…ˆåœ¨ [Node JS](http://nodejs.org/) çš„ç¯å¢ƒä¸‹è¿›è¡Œæ‰“åŒ…æ„å»ºã€‚åŒ…ç®¡ç†å™¨ä½¿ç”¨çš„æ˜¯ [Yarn](https://yarnpkg.com/)ã€‚ç„¶åä½¿ç”¨ [Nginx](http://nginx.com/) æä¾›æœåŠ¡ï¼Œå¹¶è¿›è¡Œåå‘ä»£ç†ï¼Œå°†è¯·æ±‚æ­£ç¡®çš„ä»£ç†è‡³åç«¯ã€‚

```
FROM node:10.13 as builder

WORKDIR /app
COPY . /app

RUN yarn install \
        && yarn build


FROM nginx:1.15

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/dist /usr/share/nginx/html/

EXPOSE 80
```

Nginx çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š

```
upstream backend-up {
    server saythx-backend:8080;
}
server {
    listen       80;
    server_name  localhost;

    charset     utf-8;

    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    location ~ ^/(api) {
        proxy_pass   http://backend-up;
    }
}
```

å°† API çš„è¯·æ±‚åå‘ä»£ç†åˆ°åç«¯æœåŠ¡ä¸Šã€‚å…¶ä½™è¯·æ±‚å…¨éƒ¨ç•™ç»™å‰ç«¯è¿›è¡Œå¤„ç†ã€‚

### åç«¯

åç«¯æ˜¯ä½¿ç”¨ [Golang](http://golang.org/) ç¼–å†™çš„ API æœåŠ¡ï¼Œå¯¹è¯·æ±‚è¿›è¡Œç›¸åº”å¤„ç†ï¼Œå¹¶å°†æ•°æ®å­˜å‚¨è‡³ [Redis](http://redis.io/) å½“ä¸­ã€‚ä¾èµ–ç®¡ç†ä½¿ç”¨çš„æ˜¯ [dep](https://github.com/golang/dep)ã€‚ç”±äº Golang æ˜¯ç¼–è¯‘å‹è¯­è¨€ï¼Œç¼–è¯‘å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸ºäº†è®©é•œåƒå°½å¯èƒ½å°ï¼Œæ‰€ä»¥ Dockerfile å’Œå‰ç«¯çš„å·®ä¸å¤šï¼Œéƒ½ä½¿ç”¨äº†[å¤šé˜¶æ®µæ„å»º](https://docs.docker.com/develop/develop-images/multistage-build/)çš„ç‰¹æ€§ã€‚

```
FROM golang:1.11.1 as builder

WORKDIR /go/src/be
COPY . /go/src/be
RUN go get -u github.com/golang/dep/cmd/dep \
        && dep ensure \
        && go build

FROM debian:stretch-slim
COPY --from=builder /go/src/be/be /usr/bin/be
ENTRYPOINT ["/usr/bin/be"]
EXPOSE 8080
```

æ³¨æ„è¿™é‡Œä¼šæš´éœ²å‡ºæ¥åç«¯æœåŠ¡æ‰€ç›‘å¬çš„ç«¯å£ã€‚

### Work

Work ç«¯ä½¿ç”¨çš„æ˜¯ [Python](http://python.org/)ï¼Œç”¨äºè®¡ç®—å·²ç»å­˜å‚¨è‡³ Redis å½“ä¸­çš„æ•°æ®ï¼Œå¹¶ç”Ÿæˆæ’è¡Œæ¦œã€‚ä¾èµ–ä½¿ç”¨ [pip](https://github.com/pypa/pip) è¿›è¡Œå®‰è£…ã€‚å¯¹äº Python çš„é•œåƒé€‰æ‹©ï¼Œæˆ‘åšäº†ä¸€ç»„[æ€§èƒ½å¯¹æ¯”çš„æµ‹è¯•](http://moelove.info/docker-python-perf/) æœ‰å…´è¶£å¯ä»¥äº†è§£ä¸‹ã€‚

```
FROM python:3.7-slim

WORKDIR /app
COPY . /app
RUN pip install -r requirements.txt

ENTRYPOINT ["python", "work.py"]
```

### æ„å»ºå‘å¸ƒ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªè¦åœ¨å¯¹åº”é¡¹ç›®ç›®å½•ä¸­ï¼Œæ‰§è¡Œ `docker build [OPTIONS] PATH` å³å¯ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨ `-t name:tag` çš„æ–¹å¼æ‰“ tagã€‚

```
# ä»¥ä¸‹åˆ†åˆ«æ˜¯åœ¨å„æ¨¡å—è‡ªå·±çš„ç›®å½•å†…
âœ  be docker build -t  taobeier/saythx-be .
âœ  fe docker build -t  taobeier/saythx-fe .
âœ  work docker build -t  taobeier/saythx-work .
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰ç«¯é¡¹ç›®ç”±äºç›®å½•å†…åŒ…å«å¼€å‘æ—¶çš„ `node_modules` ç­‰æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„æ·»åŠ  `.dockerignore` æ–‡ä»¶ï¼Œå¿½ç•¥ä¸€äº›éé¢„æœŸçš„æ–‡ä»¶ã€‚å…³äº Docker çš„ build åŸç†ï¼Œæœ‰æƒ³æ·±å…¥ç†è§£çš„ï¼Œå¯å‚è€ƒæˆ‘ä¹‹å‰å†™çš„ [Docker æ·±å…¥ç¯‡ä¹‹ Build åŸç†](http://moelove.info/2018/09/04/Docker-æ·±å…¥ç¯‡ä¹‹-Build-åŸç†/) ã€‚ å½“é•œåƒæ„å»ºå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬å‘å¸ƒè‡³é•œåƒä»“åº“ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„ [Docker Hub](http://hub.docker.com/)ï¼Œæ‰§è¡Œ `docker login` è¾“å…¥ç”¨æˆ·åå¯†ç éªŒè¯æˆåŠŸåä¾¿å¯è¿›è¡Œå‘å¸ƒï¼ˆéœ€è¦å…ˆå» Docker Hub æ³¨å†Œå¸å·ï¼‰ã€‚

ç™»å½•æˆåŠŸåï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨ `$HOME/.docker/config.json` ä¸­ä¼šå­˜å‚¨ç”¨æˆ·ç›¸å…³å‡­è¯ã€‚

æ¥ä¸‹æ¥è¿›è¡Œå‘å¸ƒåªéœ€è¦æ‰§è¡Œ `docker push` å³å¯ã€‚

```
âœ  ~ docker push taobeier/saythx-be
âœ  ~ docker push taobeier/saythx-fe
âœ  ~ docker push taobeier/saythx-work
```

## å®¹å™¨ç¼–æ’ Docker Compose

[Docker Compose](https://docs.docker.com/compose/overview/) æ˜¯ä¸€ç§è¾ƒä¸ºç®€å•çš„å¯è¿›è¡Œå®¹å™¨ç¼–æ’çš„æŠ€æœ¯ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸º `docker-compose.yml` ã€‚åœ¨ saythx é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æˆ‘å·²ç»åˆ›å»ºå¥½äº† `docker-compose.yml` çš„é…ç½®æ–‡ä»¶ã€‚

```
version: '3'

services:
  saythx-frontend:
    build:
      context: fe/.
    image: taobeier/saythx-fe
    ports:
      - "8088:80"
    depends_on:
      - saythx-backend
    networks:
      - saythx

  saythx-backend:
    build:
      context: be/.
    image: taobeier/saythx-be
    depends_on:
      - saythx-redis
    networks:
      - saythx
    environment:
      - REDIS_HOST=saythx-redis
    
  saythx-work:
    build:
      context: work/.
    image: taobeier/saythx-work
    depends_on:
      - saythx-redis
    networks:
      - saythx
    environment:
      - REDIS_HOST=saythx-redis
      - REDIS_PORT=6379

  saythx-redis:
    image: "redis:5"
    networks:
      - saythx

networks:
  saythx:
```

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ `docker-compose up` å³å¯å¯åŠ¨è¯¥é¡¹ç›®ã€‚åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://127.0.0.1:8088/ å³å¯çœ‹åˆ°é¡¹ç›®çš„å‰ç«¯ç•Œé¢ã€‚å¦‚ä¸‹å›¾ï¼š



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="628"></svg>)



æ‰“å¼€å¦å¤–çš„ç»ˆç«¯ï¼Œè¿›å…¥é¡¹ç›®æ ¹ç›®å½•å†…ï¼Œæ‰§è¡Œ `docker-compose ps` å‘½ä»¤å³å¯çœ‹åˆ°å½“å‰çš„æœåŠ¡æƒ…å†µã€‚

```
âœ  saythx git:(master) âœ— docker-compose ps

          Name                        Command               State          Ports
----------------------------------------------------------------------------------------
saythx_saythx-backend_1    /usr/bin/be                      Up      8080/tcp
saythx_saythx-frontend_1   nginx -g daemon off;             Up      0.0.0.0:8088->80/tcp
saythx_saythx-redis_1      docker-entrypoint.sh redis ...   Up      6379/tcp
saythx_saythx-work_1       python work.py                   Up
```

å¯ä»¥çœ‹åˆ°å„ç»„ä»¶å‡æ˜¯ `Up` çš„çŠ¶æ€ï¼Œç›¸å…³ç«¯å£ä¹Ÿå·²ç»æš´éœ²å‡ºæ¥ã€‚

å¯åœ¨æµè§ˆå™¨ç›´æ¥è®¿é—®ä½“éªŒã€‚ç”±äº `Docker Compose` å¹¶éæœ¬å†Œçš„é‡ç‚¹ï¼Œæ•…ä¸åšå¤ªå¤šä»‹ç»ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£è¿›è¡Œå­¦ä¹ ã€‚æ¥ä¸‹æ¥è¿›å…¥æœ¬èŠ‚çš„é‡ç‚¹å†…å®¹ï¼Œå°†é¡¹ç›®éƒ¨ç½²è‡³ K8S ä¸­ã€‚

## ç¼–å†™é…ç½®æ–‡ä»¶å¹¶éƒ¨ç½²

åœ¨ K8S ä¸­è¿›è¡Œéƒ¨ç½²æˆ–è€…è¯´ä¸ K8S äº¤äº’çš„æ–¹å¼ä¸»è¦æœ‰ä¸‰ç§ï¼š

- å‘½ä»¤å¼
- å‘½ä»¤å¼å¯¹è±¡é…ç½®
- å£°æ˜å¼å¯¹è±¡é…ç½®

ç¬¬ 7 èŠ‚ä»‹ç»è¿‡çš„ `kubectl run redis --image='redis:alpine'` è¿™ç§æ–¹å¼ä¾¿æ˜¯å‘½ä»¤å¼ï¼Œè¿™ç§æ–¹å¼å¾ˆç®€å•ï¼Œä½†æ˜¯å¯é‡ç”¨æ€§ä½ã€‚æ¯•ç«Ÿä½ çš„å‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…¶ä»–äººä¹Ÿå¹¶ä¸æ¸…æ¥šåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

å‘½ä»¤å¼å¯¹è±¡é…ç½®ï¼Œä¸»è¦æ˜¯ç¼–å†™é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯é€šè¿‡ç±»ä¼¼ `kubectl create` ä¹‹ç±»å‘½ä»¤å¼çš„æ–¹å¼è¿›è¡Œæ“ä½œã€‚

å†æœ‰ä¸€ç§ä¾¿æ˜¯å£°æ˜å¼å¯¹è±¡é…ç½®ï¼Œä¸»è¦ä¹Ÿæ˜¯é€šè¿‡ç¼–å†™é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯ä½¿ç”¨ `kubectl apply` ä¹‹ç±»çš„æ”¾å¥½ä¼¼è¿›è¡Œæ“ä½œã€‚ä¸ç¬¬äºŒç§å‘½ä»¤å¼å¯¹è±¡é…ç½®çš„åŒºåˆ«ä¸»è¦åœ¨äºå¯¹å¯¹è±¡çš„æ“ä½œå°†ä¼šå¾—åˆ°ä¿ç•™ã€‚ä½†åŒæ—¶è¿™ç§æ–¹å¼æœ‰æ—¶å€™ä¹Ÿå¹¶ä¸å¥½è¿›è¡Œè°ƒè¯•ã€‚

æ¥ä¸‹æ¥ï¼Œä¸º saythx é¡¹ç›®ç¼–å†™é…ç½®æ–‡ä»¶ï¼Œè®©å®ƒå¯ä»¥éƒ¨ç½²è‡³ K8S ä¸­ã€‚å½“ç„¶ï¼Œè¿™é‡Œæˆ‘ä»¬å·²ç»åˆ›å»ºè¿‡äº† `docker-compose.yml` çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä¹ŸéªŒè¯äº†å…¶å¯ç”¨æ€§ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [Kompose](https://github.com/kubernetes/kompose) å·¥å…·å°† `docker-compose.yml` çš„é…ç½®æ–‡ä»¶è¿›è¡Œè½¬æ¢ã€‚

ä½†è¿™é‡Œé‡‡ç”¨ç›´æ¥ç¼–å†™çš„æ–¹å¼ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬éƒ¨ç½²è‡³ä¸€ä¸ªæ–°çš„åä¸º `work` çš„ `Namespace` ä¸­ã€‚

### Namespace

```
apiVersion: v1
kind: Namespace
metadata:
  name: work
```

æŒ‡å®šäº† `Namespace` name ä¸º `work`ã€‚ç„¶åè¿›è¡Œéƒ¨ç½²

```
âœ  conf git:(master) âœ— kubectl apply -f namespace.yaml 
namespace/work created
```

### Redis èµ„æº

ä»å‰é¢çš„ `docker-compose.yml` ä¸­ä¹Ÿèƒ½å‘ç°ï¼Œsaythx ä¸­å„ä¸ªç»„ä»¶ï¼Œåªæœ‰ Redis æ˜¯æ— ä»»ä½•ä¾èµ–çš„ã€‚æˆ‘ä»¬å…ˆå¯¹å®ƒè¿›è¡Œéƒ¨ç½²ã€‚

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis
  name: saythx-redis
  namespace: work
spec:
  selector:
    matchLabels:
      app: redis
  replicas: 1
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - image: redis:5
        name: redis
        ports:
        - containerPort: 6379
```

ç”±äºè¿™æ˜¯æœ¬å†Œå†…ç¬¬ä¸€æ¬¡å‡ºç°å®Œæ•´çš„ `Deployment` é…ç½®æ–‡ä»¶ï¼Œæ•…è€Œè¿›è¡Œé‡ç‚¹ä»‹ç»ã€‚

- `apiVersion` ï¼šæŒ‡å®šäº† API çš„ç‰ˆæœ¬å·ï¼Œå½“å‰æˆ‘ä»¬ä½¿ç”¨çš„ K8S ä¸­ï¼Œ `Deployment` çš„ç‰ˆæœ¬å·ä¸º `apps/v1`ï¼Œè€Œåœ¨ 1.9 ä¹‹å‰ä½¿ç”¨çš„ç‰ˆæœ¬åˆ™ä¸º `apps/v1beta2`ï¼Œåœ¨ 1.8 ä¹‹å‰çš„ç‰ˆæœ¬ä½¿ç”¨çš„ç‰ˆæœ¬ä¸º `extensions/v1beta1`ã€‚åœ¨ç¼–å†™é…ç½®æ–‡ä»¶æ—¶éœ€è¦æ ¼å¤–æ³¨æ„ã€‚
- `kind` ï¼šæŒ‡å®šäº†èµ„æºçš„ç±»å‹ã€‚è¿™é‡ŒæŒ‡å®šä¸º `Deployment` è¯´æ˜æ˜¯ä¸€æ¬¡éƒ¨ç½²ã€‚
- `metadata` ï¼šæŒ‡å®šäº†èµ„æºçš„å…ƒä¿¡æ¯ã€‚ä¾‹å¦‚å…¶ä¸­çš„ `name` å’Œ `namespace` åˆ†åˆ«è¡¨ç¤ºèµ„æºåç§°å’Œæ‰€å½’å±çš„ `Namespace`ã€‚
- `spec` ï¼šæŒ‡å®šäº†å¯¹èµ„æºçš„é…ç½®ä¿¡æ¯ã€‚ä¾‹å¦‚å…¶ä¸­çš„ `replicas` æŒ‡å®šäº†å‰¯æœ¬æ•°å½“å‰æŒ‡å®šä¸º 1 ã€‚`template.spec` åˆ™æŒ‡å®šäº† `Pod` ä¸­å®¹å™¨çš„é…ç½®ä¿¡æ¯ï¼Œè¿™é‡Œçš„ `Pod` ä¸­åªéƒ¨ç½²äº†ä¸€ä¸ªå®¹å™¨ã€‚

é…ç½®æ–‡ä»¶å·²ç»ç”Ÿäº§ï¼Œç°åœ¨å¯¹å®ƒè¿›è¡Œéƒ¨ç½²ã€‚

```
âœ  conf git:(master) âœ— kubectl -n work get all
No resources found.
âœ  conf git:(master) âœ— kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
âœ  conf git:(master) âœ— kubectl -n work get all
NAME                                READY     STATUS    RESTARTS   AGE
pod/saythx-redis-79d8f9864d-x8fp9   1/1       Running   0          4s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            1           4s

NAME                                      DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-79d8f9864d   1         1         1         4s
```

å¯ä»¥çœ‹åˆ° `Pod` å·²ç»åœ¨æ­£å¸¸è¿è¡Œäº†ã€‚æˆ‘ä»¬è¿›å…¥ `Pod` å†…è¿›è¡Œæµ‹è¯•ã€‚

```
âœ  conf git:(master) âœ— kubectl -n work exec -it saythx-redis-79d8f9864d-x8fp9 bash
root@saythx-redis-79d8f9864d-x8fp9:/data# redis-cli
127.0.0.1:6379> ping
PONG
```

å“åº”æ­£å¸¸ã€‚

### Redis service

ç”±äº `Redis` æ˜¯åç«¯æœåŠ¡çš„ä¾èµ–ï¼Œæˆ‘ä»¬å°†å®ƒä½œä¸º `Service` æš´éœ²å‡ºæ¥ã€‚

```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: redis
  name: saythx-redis
  namespace: work
spec:
  ports:
  - protocol: TCP
    port: 6379
    targetPort: 6379
  selector:
    app: redis
  type: NodePort
```

å…³äº `Service` çš„å†…å®¹ï¼Œå¯å‚è€ƒç¬¬ 7 èŠ‚ï¼Œæˆ‘ä»¬è¯¦ç»†åšè¿‡è§£é‡Šã€‚è¿™é‡Œç›´æ¥ä½¿ç”¨é…ç½®æ–‡ä»¶è¿›è¡Œéƒ¨ç½²ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f redis-service.yaml
service/saythx-redis created
âœ  conf git:(master) âœ— kubectl get svc -n work
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
saythx-redis   NodePort   10.107.31.242   <none>        6379:31467/TCP   1m
```

### åç«¯æœåŠ¡

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯¹åç«¯æœåŠ¡è¿›è¡Œéƒ¨ç½²ã€‚

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: backend
  name: saythx-backend
  namespace: work
spec:
  selector:
    matchLabels:
      app: backend
  replicas: 1
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - env:
        - name: REDIS_HOST
          value: saythx-redis
        image: taobeier/saythx-be
        name: backend
        ports:
        - containerPort: 8080
```

å¯ä»¥çœ‹åˆ°è¿™é‡Œé€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œå°† `REDIS_HOST` ä¼ é€’ç»™äº†åç«¯æœåŠ¡ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f backend-deployment.yaml
deployment.apps/saythx-backend created
âœ  conf git:(master) âœ— kubectl -n work get all
NAME                                 READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn   0/1       ContainerCreating   0          5s
pod/saythx-redis-8558c7d7d-kcmzk     1/1       Running             0          17m

NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.107.31.242   <none>        6379:31467/TCP   1m

NAME                             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend   1         1         1            0           5s
deployment.apps/saythx-redis     1         1         1            1           17m

NAME                                       DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95   1         1         0         5s
replicaset.apps/saythx-redis-8558c7d7d     1         1         1         17m
```

### åç«¯ Service

åç«¯æœåŠ¡æ˜¯å‰ç«¯é¡¹ç›®çš„ä¾èµ–ï¼Œæ•…è€Œæˆ‘ä»¬ä¹Ÿå°†å…¶ä½œä¸º `Service` æš´éœ²å‡ºæ¥ã€‚

```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: backend
  name: saythx-backend
  namespace: work
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector:
    app: backend
  type: NodePort
```

é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œéƒ¨ç½²ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f backend-service.yaml
service/saythx-backend created
âœ  conf git:(master) âœ— kubectl get svc -n work
NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend   NodePort   10.104.0.47     <none>        8080:32051/TCP   8s
service/saythx-redis     NodePort   10.107.31.242   <none>        6379:31467/TCP   3m
```

æˆ‘ä»¬åŒæ ·ä½¿ç”¨ `NodePort` å°†å…¶æš´éœ²å‡ºæ¥ï¼Œå¹¶åœ¨æœ¬åœ°è¿›è¡Œæµ‹è¯•ã€‚

```
âœ  conf git:(master) âœ— curl http://127.0.0.1:32051/api/v1/list
{"HonorDatas":null}
```

æœåŠ¡å¯æ­£å¸¸å“åº”ã€‚

### å‰ç«¯

æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™å‰ç«¯çš„é…ç½®æ–‡ä»¶ã€‚

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: frontend
  name: saythx-frontend
  namespace: work
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - image: taobeier/saythx-fe
        name: frontend
        ports:
        - containerPort: 80
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨åç«¯ `Service` æš´éœ²å‡ºæ¥åæ‰èƒ½è¿›è¡Œå‰ç«¯çš„éƒ¨ç½²ï¼Œå› ä¸ºå‰ç«¯é•œåƒä¸­ Nginx çš„åå‘ä»£ç†é…ç½®ä¸­ä¼šå»æ£€æŸ¥åç«¯æ˜¯å¦å¯è¾¾ã€‚ä½¿ç”¨é…ç½®æ–‡ä»¶è¿›è¡Œéƒ¨ç½²ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f frontend-deployment.yaml
deployment.apps/saythx-frontend created
âœ  conf git:(master) âœ— kubectl -n work get all
NAME                                   READY     STATUS    RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running   0          16m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running   0          30s
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running   0          34m

NAME                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend   NodePort   10.104.0.47     <none>        8080:32051/TCP   15m
service/saythx-redis     NodePort   10.107.31.242   <none>        6379:31467/TCP   18m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    1         1         1            1           16m
deployment.apps/saythx-frontend   1         1         1            1           30s
deployment.apps/saythx-redis      1         1         1            1           34m

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     1         1         1         16m
replicaset.apps/saythx-frontend-678d544b86   1         1         1         30s
replicaset.apps/saythx-redis-8558c7d7d       1         1         1         34m
```

### å‰ç«¯ Service

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è®©å‰ç«¯å¯ä»¥è¢«ç›´æ¥è®¿é—®åˆ°ï¼ŒåŒæ ·çš„éœ€è¦å°†å®ƒä»¥ `Service` çš„å½¢å¼æš´éœ²å‡ºæ¥ã€‚

```
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: saythx-frontend
  namespace: work
spec:
  ports:
  - name: "80"
    port: 80
    targetPort: 80
  selector:
    app: frontend
  type: NodePort
```

åˆ›å»º `Service` ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f frontend-service.yaml
service/saythx-frontend created
âœ  conf git:(master) âœ— kubectl -n work get svc
NAME              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
saythx-backend    NodePort   10.104.0.47     <none>        8080:32051/TCP   17m
saythx-frontend   NodePort   10.96.221.71    <none>        80:32682/TCP     11s
saythx-redis      NodePort   10.107.31.242   <none>        6379:31467/TCP   20m
```

æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ Node çš„ 32682 ç«¯å£è¿›è¡Œè®¿é—®ã€‚

### Work

æœ€åï¼Œæ˜¯æˆ‘ä»¬çš„ Work ç»„ä»¶ï¼Œä¸ºå®ƒç¼–å†™é…ç½®æ–‡ä»¶ã€‚

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: work
  name: saythx-work
  namespace: work
spec:
  selector:
    matchLabels:
      app: work
  replicas: 1
  template:
    metadata:
      labels:
        app: work
    spec:
      containers:
      - env:
        - name: REDIS_HOST
          value: saythx-redis
        - name: REDIS_PORT
          value: "6379"
        image: taobeier/saythx-work
        name: work
```

åŒæ ·çš„ï¼Œæˆ‘ä»¬é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼ä¼ é€’äº† Redis ç›¸å…³çš„é…ç½®è¿›å»ã€‚

```
âœ  conf git:(master) âœ— kubectl apply -f work-deployment.yaml
deployment.apps/saythx-work created
âœ  conf git:(master) âœ— kubectl -n work get all
NAME                                   READY     STATUS              RESTARTS   AGE
pod/saythx-backend-c5f9f6d95-lmtxn     1/1       Running             0          22m
pod/saythx-frontend-678d544b86-wp9gr   1/1       Running             0          5m
pod/saythx-redis-8558c7d7d-kcmzk       1/1       Running             0          39m
pod/saythx-work-6b9958dc47-hh9td       0/1       ContainerCreating   0          7s

NAME                      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/saythx-backend    NodePort   10.104.0.47     <none>        8080:32051/TCP   20m
service/saythx-frontend   NodePort   10.96.221.71    <none>        80:32682/TCP     3m
service/saythx-redis      NodePort   10.107.31.242   <none>        6379:31467/TCP   23m

NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-backend    1         1         1            1           22m
deployment.apps/saythx-frontend   1         1         1            1           5m
deployment.apps/saythx-redis      1         1         1            1           39m
deployment.apps/saythx-work       1         1         1            0           7s

NAME                                         DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-backend-c5f9f6d95     1         1         1         22m
replicaset.apps/saythx-frontend-678d544b86   1         1         1         5m
replicaset.apps/saythx-redis-8558c7d7d       1         1         1         39m
replicaset.apps/saythx-work-6b9958dc47       1         1         0         7s
```

ç°åœ¨å‡å·²ç»éƒ¨ç½²å®Œæˆã€‚å¹¶ä¸”å¯ç›´æ¥é€šè¿‡ Node ç«¯å£è¿›è¡Œè®¿é—®ã€‚

## æ‰©ç¼©å®¹

å¦‚æœæˆ‘ä»¬è§‰å¾—æ’è¡Œæ¦œç”Ÿæˆæ•ˆç‡è¾ƒä½ï¼Œåˆ™å¯é€šè¿‡æ‰©å®¹ Work æ¥å¾—åˆ°è§£å†³ã€‚å…·ä½“åšæ³•æ˜¯å¯ä¿®æ”¹ work çš„ `Deployment` é…ç½®æ–‡ä»¶ï¼Œå°† `spec.replicas` è®¾ç½®ä¸ºé¢„æœŸçš„æ•°å€¼ï¼Œä¹‹åæ‰§è¡Œ `kubectl -f work-deployment.yaml` å³å¯ã€‚

æˆ–è€…å¯ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œè¿›è¡Œæ“ä½œ

```
âœ  conf git:(master) âœ— kubectl -n work scale --replicas=2  deployment/saythx-work
```

ä¸Šé¢çš„å‘½ä»¤æ˜¯å°† `saythx-work` çš„éƒ¨ç½²å‰¯æœ¬æ•°è®¾ç½®ä¸º 2 ã€‚ç¼©å®¹ä¹Ÿå·®ä¸å¤šæ˜¯ç±»ä¼¼çš„æ“ä½œã€‚

## æ€»ç»“

é€šè¿‡æœ¬èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ åˆ°äº†å¦‚ä½•å°†é¡¹ç›®å®é™…éƒ¨ç½²è‡³ K8S ä¸­ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–å†™é…ç½®ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸€äº›å·¥å…·è¿›è¡Œè¾…åŠ©ã€‚åŒæ—¶ä¹Ÿäº†è§£åˆ°äº†å¦‚ä½•åº”å¯¹åº”ç”¨çš„æ‰©ç¼©å®¹ã€‚

ä½†å¦‚æœåº”ç”¨éœ€è¦è¿›è¡Œå‡çº§çš„è¯ï¼Œåˆ™éœ€è¦å»æ›´æ”¹é…ç½®æ–‡ä»¶ä¸­ç›¸å…³çš„é…ç½®ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šè¾ƒä¸ºç¹çï¼Œå¹¶ä¸”æ•´ä½“é¡¹ç›®çº¿ä¸Šçš„ç‰ˆæœ¬ç®¡ç†ä¹Ÿæ˜¯ä¸ªé—®é¢˜ï¼šæ¯”å¦‚ç»„ä»¶çš„ä¸ªäººå‡çº§ï¼Œå›æ»šä¹‹é—´å¦‚æœæœ‰ä¾èµ–çš„è¯ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ã€‚æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„ä¸¤èŠ‚æ¥å­¦ä¹ å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

# åº”ç”¨ç®¡ç†: åˆè¯† Helm

## æ•´ä½“æ¦‚è§ˆ

ä¸ŠèŠ‚ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•é€šè¿‡ç¼–å†™é…ç½®æ–‡ä»¶çš„æ–¹å¼éƒ¨ç½²é¡¹ç›®ã€‚è€Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé¡¹ç›®æ‰€åŒ…å«ç»„ä»¶å¯èƒ½ä¸æ­¢ 3 ä¸ªï¼Œå¹¶ä¸”å¯èƒ½é¡¹ç›®æ•°ä¼šå¾ˆå¤šï¼Œå¦‚æœæ¯ä¸ªé¡¹ç›®çš„å‘å¸ƒï¼Œæ›´æ–°ç­‰éƒ½é€šè¿‡æ‰‹åŠ¨å»ç¼–å†™é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œå®åœ¨ä¸åˆ©äºç®¡ç†ã€‚

å¹¶ä¸”ï¼Œå½“çº¿ä¸Šå‡ºç°ä¸ªåˆ«ç»„ä»¶å‡çº§å›æ»šä¹‹ç±»çš„æ“ä½œï¼Œå¦‚æœç»„ä»¶ä¹‹é—´æœ‰ç›¸å…³ç‰ˆæœ¬ä¾èµ–ç­‰æƒ…å†µï¼Œé‚£äº‹æƒ…ä¼šå˜å¾—å¤æ‚çš„å¤šã€‚æˆ‘ä»¬éœ€è¦æœ‰æ›´ç®€å•çš„æœºåˆ¶æ¥è¾…åŠ©æˆ‘ä»¬å®Œæˆè¿™äº›äº‹æƒ…ã€‚

## Helm ä»‹ç»

[Helm](https://www.helm.sh/) æ˜¯æ„å»ºäº K8S ä¹‹ä¸Šçš„åŒ…ç®¡ç†å™¨ï¼Œå¯ä¸æˆ‘ä»¬å¹³æ—¶æ¥è§¦åˆ°çš„ `Yum`ï¼Œ`APT`ï¼Œ`Homebrew` æˆ–è€… `Pip` ç­‰åŒ…ç®¡ç†å™¨ç›¸ç±»æ¯”ã€‚

ä½¿ç”¨ Helm å¯ç®€åŒ–åŒ…åˆ†å‘ï¼Œå®‰è£…ï¼Œç‰ˆæœ¬ç®¡ç†ç­‰æ“ä½œæµç¨‹ã€‚åŒæ—¶å®ƒä¹Ÿæ˜¯ CNCF å­µåŒ–é¡¹ç›®ã€‚

## Helm å®‰è£…

Helm æ˜¯ C/S æ¶æ„ï¼Œä¸»è¦åˆ†ä¸ºå®¢æˆ·ç«¯ `helm` å’ŒæœåŠ¡ç«¯ `Tiller`ã€‚å®‰è£…æ—¶å¯ç›´æ¥åœ¨ [Helm ä»“åº“çš„ Release é¡µé¢](https://github.com/helm/helm/releases) ä¸‹è½½æ‰€éœ€äºŒè¿›åˆ¶æ–‡ä»¶æˆ–è€…æºç åŒ…ã€‚

ç”±äºå½“å‰é¡¹ç›®çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜å‚¨å·²åˆ‡æ¢ä¸º GCSï¼Œæˆ‘å·²ç»ä¸ºå›½å†…ç”¨æˆ·å‡†å¤‡äº†æœ€æ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶åŒ…ï¼Œå¯é€šè¿‡ä»¥ä¸‹é“¾æ¥è¿›è¡Œä¸‹è½½ã€‚

```
é“¾æ¥: https://pan.baidu.com/s/1n1zj3rlv2NyfiA6kRGrHfg æå–ç : 5huw 
```

ä¸‹è½½åå¯¹æ–‡ä»¶è¿›è¡Œè§£å‹ï¼Œæˆ‘è¿™é‡Œä»¥ Linux amd64 ä¸ºä¾‹ã€‚

```
âœ  /tmp tar -zxvf helm-v2.11.0-linux-amd64.tar.gz
linux-amd64/
linux-amd64/tiller
linux-amd64/README.md
linux-amd64/helm
linux-amd64/LICENSE
âœ  /tmp tree linux-amd64 
linux-amd64
â”œâ”€â”€ helm
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â””â”€â”€ tiller

0 directories, 4 files
```

è§£å‹å®Œæˆåï¼Œå¯çœ‹åˆ°å…¶ä¸­åŒ…å« `helm` å’Œ `tiller` äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

### å®¢æˆ·ç«¯ helm

`helm` æ˜¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç›´æ¥å°†å®ƒç§»åŠ¨è‡³ `/usr/bin` ç›®å½•ä¸‹å³å¯ã€‚

```
âœ  /tmp sudo mv linux-amd64/helm /usr/bin/helm 
```

è¿™æ—¶å€™ä¾¿å¯ç›´æ¥é€šè¿‡ `helm` å‘½ä»¤ä½¿ç”¨äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬éªŒè¯å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚

```
âœ  /tmp helm version
Client: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
Error: Get http://localhost:8080/api/v1/namespaces/kube-system/pods?labelSelector=app%3Dhelm%2Cname%3Dtiller: dial tcp 127.0.0.1:8080: connect: connection refused
```

å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰æ˜æ˜¾çš„æŠ¥é”™ï¼Œå¹¶ä¸”å¾ˆåƒ `kubectl` æœªæ­£ç¡®é…ç½®æ—¶çš„é”™è¯¯ã€‚è¿™æ˜¯å› ä¸º `helm` é»˜è®¤ä¼šå»è¯»å– `$HOME/.kube/config` çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºæ­£ç¡®çš„è¿æ¥è‡³ç›®æ ‡é›†ç¾¤ã€‚

å½“æˆ‘ä»¬æ­£ç¡®çš„é…ç½®å¥½ `$HOME/.kube/config` æ–‡ä»¶æ—¶ï¼Œå†æ¬¡æ‰§è¡Œï¼š

```
âœ  /tmp helm version
Client: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
Error: could not find tiller
```

è¿™æ¬¡æŠ¥é”™æ˜¯å› ä¸ºæ‰¾ä¸åˆ°æœåŠ¡ç«¯ `Tiller`ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éƒ¨ç½²æœåŠ¡ç«¯ã€‚

### æœåŠ¡ç«¯ Tiller

ä»¥ä¸‹è®¨è®ºä¸­ï¼Œå‰æéƒ½æ˜¯ `$HOME/.kube/config` å·²æ­£ç¡®é…ç½®ï¼Œå¹¶ä¸” `kebectl` æœ‰æ“ä½œé›†ç¾¤çš„æƒé™ã€‚

#### æœ¬åœ°å®‰è£…

åˆšæ‰æˆ‘ä»¬è§£å‹çš„æ–‡ä»¶ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ `tiller` ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰§è¡Œå®ƒï¼Œç”¨äºåœ¨æœ¬åœ°å¯åŠ¨æœåŠ¡ã€‚

```
âœ  /tmp ./linux-amd64/tiller
[main] 2018/11/18 23:47:10 Starting Tiller v2.11.0 (tls=false)
[main] 2018/11/18 23:47:10 GRPC listening on :44134
[main] 2018/11/18 23:47:10 Probes listening on :44135
[main] 2018/11/18 23:47:10 Storage driver is ConfigMap
[main] 2018/11/18 23:47:10 Max history per release is 0
```

ç›´æ¥æ‰§è¡Œæ—¶ï¼Œé»˜è®¤ä¼šç›‘å¬ `44134` å’Œ `44135` ç«¯å£ï¼Œ`44134` ç«¯å£ç”¨äºå’Œ `helm` è¿›è¡Œé€šä¿¡ï¼Œè€Œ `44135` ä¸»è¦æ˜¯ç”¨äºåšæ¢æ´»çš„ï¼Œåœ¨éƒ¨ç½²è‡³ K8S æ—¶ä½¿ç”¨ã€‚

å½“æˆ‘ä»¬ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œåªéœ€è®¾ç½® `HELM_HOST` ç¯å¢ƒå˜é‡å³å¯ã€‚

```
âœ  ~ export HELM_HOST=localhost:44134
âœ  ~ helm version
Client: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
Server: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
```

**æ³¨æ„** ä¸€å®šè¦æ­£ç¡®é…ç½® `$HOME/.kube/config` æ–‡ä»¶ï¼Œå¦åˆ™ä¼šå½±å“æ­£å¸¸åŠŸèƒ½ä½¿ç”¨ã€‚

#### é»˜è®¤å®‰è£…

å®˜æ–¹æä¾›äº†ä¸€ç§ä¸€é”®å¼å®‰è£…çš„æ–¹å¼ã€‚é‚£ä¾¿æ˜¯ `helm init` æ‰§è¡Œè¿™æ¡å‘½ä»¤åï¼Œä¼šåŒæ—¶åœ¨ K8S ä¸­éƒ¨ç½²æœåŠ¡ç«¯ Tiller å’Œåˆå§‹åŒ– helm çš„é»˜è®¤ç›®å½• `$HELM_HOME` é»˜è®¤å€¼ä¸º `$HOME/.helm`ã€‚

è¿™ç§æ–¹å¼ä¸‹ä¼šé»˜è®¤ä½¿ç”¨å®˜æ–¹é•œåƒ `gcr.io/kubernetes-helm/tiller` ç½‘ç»œåŸå› å¯èƒ½ä¼šå¯¼è‡´å®‰è£…å¤±è´¥ã€‚æ‰€ä»¥æˆ‘å·²å°†å®˜æ–¹é•œåƒè¿›è¡ŒåŒæ­¥ã€‚å¯ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡Œä½¿ç”¨ï¼š

```
âœ  ~ helm init --tiller-image taobeier/tiller:v2.11.0 
Creating /root/.helm
Creating /root/.helm/repository
Creating /root/.helm/repository/cache
Creating /root/.helm/repository/local
Creating /root/.helm/plugins
Creating /root/.helm/starters
Creating /root/.helm/cache/archive
Creating /root/.helm/repository/repositories.yaml
Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com
Adding local repo with URL: http://127.0.0.1:8879/charts
$HELM_HOME has been configured at /root/.helm.

Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.
To prevent this, run `helm init` with the --tiller-tls-verify flag.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
Happy Helming!
âœ  ~ helm version
Client: &version.Version{SemVer:"v2.11.0", GitCommit:"9ad53aac42165a5fadc6c87be0dea6b115f93090", GitTreeState:"clean"}
Server: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
```

å¯ä»¥çœ‹åˆ° `$HELM_HOME` ç›®å½•å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å·²å¯ä»¥æ­£å¸¸é€šä¿¡ã€‚æŸ¥çœ‹ä¸‹å½“å‰ K8S é›†ç¾¤ä¸­çš„æƒ…å†µï¼š

```
âœ  ~ kubectl -n kube-system get deploy tiller-deploy
NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
tiller-deploy   1         1         1            1           6m
```

å¯ä»¥çœ‹åˆ°å·²æ­£å¸¸éƒ¨ç½²ã€‚

#### æ‰‹åŠ¨å®‰è£…

é€šè¿‡ä¸Šé¢çš„æè¿°ï¼Œå¯èƒ½ä½ å·²ç»å‘ç°ï¼Œå®‰è£…æœåŠ¡ç«¯ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€æ¬¡æ™®é€šçš„éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥è‡ªè¡Œé€šè¿‡ `kubectl` å®Œæˆéƒ¨ç½²ã€‚

```
âœ  ~ helm init --dry-run --debug  # ç¯‡å¹…åŸå› ï¼Œä»¥ä¸‹å†…å®¹è¿›è¡Œäº†çœç•¥
---                               
apiVersion: extensions/v1beta1
kind: Deployment                                    
metadata:                            
  creationTimestamp: null
  labels:         
    app: helm              
    name: tiller       
  name: tiller-deploy           
  namespace: kube-system   
spec:               
  replicas: 1 
  strategy: {}                
  ...
status: {}

---
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: helm
    name: tiller
  name: tiller-deploy
  namespace: kube-system
spec:
  ports:
  - name: tiller
    port: 44134
    targetPort: tiller
  selector:
    app: helm
    name: tiller
  type: ClusterIP
status:
  loadBalancer: {}
```

å°†è¾“å‡ºå†…å®¹ä¿å­˜è‡³æ–‡ä»¶ä¸­ï¼Œè‡ªè¡Œä¿®æ”¹åï¼Œé€šè¿‡ `kubectl` è¿›è¡Œéƒ¨ç½²å³å¯ã€‚å»ºè®®åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ï¼Œå°½é‡ä¸è¦å»æ›´æ”¹æ ‡ç­¾åŠé€‰æ‹©å™¨ã€‚

#### RBAC ä½¿ç”¨

ä¸Šé¢çš„å†…å®¹ä¸­ï¼Œå‡æœªæåŠåˆ°æƒé™æ§åˆ¶ç›¸å…³çš„å†…å®¹ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä¼šè¿›è¡Œæƒé™æ§åˆ¶çš„ã€‚

åœ¨ç¬¬ 8 èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†çš„è§£é‡Šäº†è®¤è¯æˆæƒç›¸å…³çš„å†…å®¹ã€‚æ‰€ä»¥ä¸‹é¢çš„å†…å®¹ä¸åšå¤ªå¤šè¯¦ç»†è§£é‡Šã€‚

è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `ServiceAccount` å‘½åä¸º `tiller`ï¼Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥å°†å®ƒä¸ `cluster-admin` è¿›è¡Œç»‘å®šã€‚

```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: tiller
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tiller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: tiller
    namespace: kube-system
```

å°†æ­¤å†…å®¹ä¿å­˜ä¸º `tiller-rbac.yaml`ï¼Œå¼€å§‹è¿›è¡Œéƒ¨ç½²æ“ä½œã€‚

```
âœ  ~ kubectl apply -f tiller-rbac.yaml
serviceaccount/tiller created
clusterrolebinding.rbac.authorization.k8s.io/tiller created
âœ  ~ helm init --service-account tiller
Creating /root/.helm
Creating /root/.helm/repository
Creating /root/.helm/repository/cache
Creating /root/.helm/repository/local
Creating /root/.helm/plugins
Creating /root/.helm/starters
Creating /root/.helm/cache/archive
Creating /root/.helm/repository/repositories.yaml
Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com
Adding local repo with URL: http://127.0.0.1:8879/charts
$HELM_HOME has been configured at /root/.helm.

Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.
To prevent this, run `helm init` with the --tiller-tls-verify flag.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
Happy Helming!
âœ  ~ helm version
Client: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
Server: &version.Version{SemVer:"v2.11.0", GitCommit:"2e55dbe1fdb5fdb96b75ff144a339489417b146b", GitTreeState:"clean"}
```

ä»¥æ­¤æ–¹å¼å®Œæˆéƒ¨ç½²ã€‚

## Helm æ¦‚å¿µ

### Chart

`chart` å°±æ˜¯ Helm æ‰€ç®¡ç†çš„åŒ…ï¼Œç±»ä¼¼äº `Yum` æ‰€ç®¡ç†çš„ `rpm` åŒ…æˆ–æ˜¯ `Homebrew` ç®¡ç†çš„ `Formulae`ã€‚å®ƒåŒ…å«ç€ä¸€ä¸ªåº”ç”¨è¦éƒ¨ç½²è‡³ K8S ä¸Šæ‰€å¿…é¡»çš„æ‰€æœ‰èµ„æºã€‚

### Release

`Release` å°±æ˜¯ `chart` åœ¨ K8S ä¸Šéƒ¨ç½²åçš„å®ä¾‹ã€‚`chart` çš„æ¯æ¬¡éƒ¨ç½²éƒ½å°†äº§ç”Ÿä¸€æ¬¡ `Release`ã€‚è¿™å’Œä¸Šé¢ç±»æ¯”çš„åŒ…ç®¡ç†å™¨å°±æœ‰æ‰€ä¸åŒäº†ï¼Œå¤šæ•°çš„ç³»ç»Ÿçº§åŒ…ç®¡ç†å™¨æ‰€å®‰è£…çš„åŒ…åªä¼šåœ¨ç³»ç»Ÿä¸­å­˜åœ¨ä¸€ä»½ã€‚æˆ‘ä»¬å¯ä»¥ä»¥ `Pip` åœ¨è™šæ‹Ÿç¯å¢ƒä¸‹çš„åŒ…å®‰è£…ï¼Œæˆ–è€… `Npm` çš„ local install æ¥è¿›è¡Œç±»æ¯”ã€‚

### Repository

`Repository` å°±æ˜¯å­—é¢æ„æ€ï¼Œå­˜å‚¨ `chart` çš„ä»“åº“ã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢æ‰§è¡Œ `helm init` æ—¶çš„è¾“å‡ºå—ï¼Ÿé»˜è®¤æƒ…å†µä¸‹ï¼Œåˆå§‹åŒ– Helm çš„æ—¶å€™ï¼Œä¼šæ·»åŠ ä¸¤ä¸ªä»“åº“ï¼Œä¸€ä¸ªæ˜¯ `stable` ä»“åº“ [kubernetes-charts.storage.googleapis.com](https://kubernetes-charts.storage.googleapis.com/) å¦ä¸€ä¸ªåˆ™æ˜¯ `local` ä»“åº“ï¼Œåœ°å€æ˜¯ http://127.0.0.1:8879/charts ã€‚

### Config

å‰é¢æåˆ°äº† `chart` æ˜¯åº”ç”¨ç¨‹åºæ‰€å¿…é¡»çš„èµ„æºï¼Œå½“ç„¶æˆ‘ä»¬å®é™…éƒ¨ç½²çš„æ—¶å€™ï¼Œå¯èƒ½å°±éœ€è¦æœ‰äº›è‡ªå®šä¹‰çš„é…ç½®äº†ã€‚`Config` ä¾¿æ˜¯ç”¨äºå®Œæˆæ­¤é¡¹åŠŸèƒ½çš„ï¼Œåœ¨éƒ¨ç½²æ—¶å€™ï¼Œä¼šå°† `config` ä¸ `chart` è¿›è¡Œåˆå¹¶ï¼Œå…±åŒæ„æˆæˆ‘ä»¬å°†éƒ¨ç½²çš„åº”ç”¨ã€‚

## Helm çš„å·¥ä½œåŸç†

`helm` é€šè¿‡ `gRPC` å°† `chart` å‘é€è‡³ `Tiller` ï¼Œ`Tiller` åˆ™é€šè¿‡å†…ç½®çš„ `kubernetes` å®¢æˆ·ç«¯åº“ä¸ K8S çš„ API server è¿›è¡Œäº¤æµï¼Œå°† `chart` è¿›è¡Œéƒ¨ç½²ï¼Œå¹¶ç”Ÿæˆ `Release` ç”¨äºç®¡ç†ã€‚

å‰é¢åªè¯´åˆ°äº† `helm` ä¸ `Tiller` äº¤äº’çš„åè®®ï¼Œä½†å°šæœªè¯´å…¶æ•°æ®é“¾è·¯ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ `Tiller` çš„éƒ¨ç½²æƒ…å†µã€‚ä¸»è¦çœ‹ `Service`ï¼š

```
âœ  ~ kubectl -n kube-system get svc
NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
kube-dns        ClusterIP   10.96.0.10       <none>        53/UDP,53/TCP   1h
tiller-deploy   ClusterIP   10.107.204.164   <none>        44134/TCP       33m
```

`Tiller` é»˜è®¤é‡‡ç”¨ `ClusterIP` ç±»å‹çš„ `Service` è¿›è¡Œéƒ¨ç½²ã€‚è€Œæˆ‘ä»¬çŸ¥é“çš„ `ClusterIP` ç±»å‹çš„ `Service` æ˜¯ä»…é™é›†ç¾¤å†…è®¿é—®çš„ã€‚

åœ¨è¿™é‡Œæ‰€ä¾èµ–çš„æŠ€æœ¯ï¼Œä¾¿æ˜¯åœ¨ç¬¬ 5 èŠ‚ï¼Œæˆ‘ä»¬æåˆ°çš„ `socat` ã€‚`helm` é€šè¿‡ `socat` çš„ç«¯å£è½¬å‘ï¼ˆæˆ–è€…è¯´ K8S çš„ä»£ç†ï¼‰ï¼Œè¿›è€Œå®ç°äº†æœ¬åœ°ä¸ `Tiller` çš„é€šä¿¡ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šå†…å®¹å‡ä»¥å½“å‰æœ€æ–°ç‰ˆæœ¬ `2.11.0` ä¸ºä¾‹ã€‚å½“ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬ Helm v3 å‡ºç°æ—¶ï¼Œ `Tiller` å°†ä¸å¤å­˜åœ¨ï¼Œé€šä¿¡æœºåˆ¶å’Œå·¥ä½œåŸç†ä¹Ÿå°†å‘ç”Ÿå˜åŒ–ã€‚

## æ€»ç»“

é€šè¿‡æœ¬èŠ‚ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ åˆ°äº† Helm çš„åŸºç¡€çŸ¥è¯†å’Œå·¥ä½œåŸç†ï¼Œäº†è§£åˆ°äº† Helm çš„ç”¨é€”ä»¥åŠå¦‚ä½•åœ¨æœ¬åœ°å’Œ K8S ä¸­éƒ¨ç½²å®ƒã€‚éœ€è¦æ³¨æ„çš„æ˜¯ `$HOME/.kube/config` éœ€è¦æå‰é…ç½®å¥½ï¼Œä»¥åŠ `socat` å·¥å…·éœ€è¦æå‰å®‰è£…ï¼Œå¯å‚è€ƒç¬¬ 5 èŠ‚çš„å†…å®¹ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¸ŠèŠ‚ä¸­çš„ç¤ºä¾‹é¡¹ç›®ä½¿ç”¨ Helm éƒ¨ç½²è‡³ K8S é›†ç¾¤ä¸­ã€‚

# éƒ¨ç½²å®è·µ: ä»¥ Helm éƒ¨ç½²é¡¹ç›®

## æ¦‚è§ˆ

ä¸ŠèŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº† Helm çš„åŸºç¡€æ¦‚å¿µå’Œå·¥ä½œåŸç†ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°† Helm ç”¨äºæˆ‘ä»¬çš„å®é™…é¡¹ç›®ï¼Œç¼–å†™ Helm `chart` ä»¥åŠé€šè¿‡ Helm è¿›è¡Œéƒ¨ç½²ã€‚

## Helm chart

ä¸ŠèŠ‚æˆ‘ä»¬è§£é‡Šè¿‡ `chart` çš„å«ä¹‰ï¼Œç°åœ¨æˆ‘ä»¬è¦å°†é¡¹ç›®ä½¿ç”¨ Helm éƒ¨ç½²ï¼Œé‚£ä¹ˆé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª `chart`ã€‚

### Chart ç»“æ„

åœ¨æˆ‘ä»¬é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª `chart`ã€‚

```
âœ  saythx git:(master) helm create saythx
Creating saythx
âœ  saythx git:(master) âœ— tree -a saythx
saythx
â”œâ”€â”€ charts
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ .helmignore
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â””â”€â”€ service.yaml
â””â”€â”€ values.yaml

2 directories, 8 files
```

åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é»˜è®¤åˆ›å»ºçš„ `chart` ä¸­åŒ…å«äº†å‡ ä¸ªæ–‡ä»¶å’Œç›®å½•ã€‚æˆ‘ä»¬å…ˆå¯¹å…¶è¿›è¡Œè§£é‡Šã€‚

#### Chart.yaml

```
âœ  saythx git:(master) âœ— cat saythx/Chart.yaml
apiVersion: v1
appVersion: "1.0"
description: A Helm chart for Kubernetes
name: saythx
version: 0.1.0
```

è¿™ä¸ªæ–‡ä»¶æ˜¯æ¯ä¸ª `chart` å¿…ä¸å¯å°‘çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ç€å‡ ä¸ªé‡è¦çš„å±æ€§ï¼Œå¦‚ï¼š

- `apiVersion`ï¼šç›®å‰ç‰ˆæœ¬éƒ½ä¸º `v1`
- `appVersion`ï¼šè¿™æ˜¯åº”ç”¨çš„ç‰ˆæœ¬å·ï¼Œéœ€è¦ä¸ `apiVersion`ï¼Œ `version` ç­‰å­—æ®µæ³¨æ„åŒºåˆ†
- `name`: é€šå¸¸è¦æ±‚ `chart` çš„åå­—å¿…é¡»å’Œå®ƒæ‰€åœ¨ç›®å½•ä¿æŒä¸€è‡´ï¼Œä¸”æ­¤å­—æ®µå¿…é¡»
- `version`ï¼šè¡¨æ˜å½“å‰ `chart` çš„ç‰ˆæœ¬å·ï¼Œä¼šç›´æ¥å½±å“ `Release` çš„è®°å½•ï¼Œä¸”æ­¤å­—æ®µå¿…é¡»
- `description`ï¼šæè¿°

#### charts

`charts` æ–‡ä»¶å¤¹æ˜¯ç”¨äºå­˜æ”¾ä¾èµ–çš„ `chart` çš„ã€‚å½“æœ‰ä¾èµ–éœ€è¦ç®¡ç†æ—¶ï¼Œå¯æ·»åŠ  `requirements.yaml` æ–‡ä»¶ï¼Œå¯ç”¨äºç®¡ç†é¡¹ç›®å†…æˆ–è€…å¤–éƒ¨çš„ä¾èµ–ã€‚

#### .helmignore

`.helmignore` ç±»ä¼¼äº `.gitignore` å’Œ `.dockerignore` ä¹‹ç±»çš„ï¼Œç”¨äºå¿½ç•¥æ‰ä¸€äº›ä¸æƒ³åŒ…å«åœ¨ `chart` å†…çš„æ–‡ä»¶ã€‚

#### templates

`templates` æ–‡ä»¶å¤¹å†…å­˜æ”¾ç€ `chart` æ‰€ä½¿ç”¨çš„æ¨¡æ¿æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ `chart` çš„å®é™…æ‰§è¡Œå†…å®¹ã€‚åœ¨ä½¿ç”¨ `chart` è¿›è¡Œå®‰è£…çš„æ—¶å€™ï¼Œä¼šå°† ä¸‹é¢ä»‹ç»çš„ `values.yaml` ä¸­çš„é…ç½®é¡¹ä¸ `templates` ä¸­çš„æ¨¡æ¿è¿›è¡Œç»„è£…ï¼Œç”Ÿæˆæœ€ç»ˆè¦æ‰§è¡Œçš„é…ç½®æ–‡ä»¶ã€‚

`templates` ä¸­ï¼Œæ¨èå‘½ååº”è¯¥æ¸…æ™°ï¼Œå¦‚ `xx-deployment.yaml`ï¼Œä¸­é—´ä½¿ç”¨ `-` è¿›è¡Œåˆ†å‰²ï¼Œé¿å…ä½¿ç”¨é©¼å³°å¼å‘½åã€‚

`Notes.txt` æ–‡ä»¶åœ¨ `helm install` å®Œæˆåï¼Œä¼šè¿›è¡Œå›æ˜¾ï¼Œå¯ç”¨äºè§£é‡Šè¯´æ˜å¦‚ä½•è®¿é—®æœåŠ¡ç­‰ã€‚

#### values.yaml

`values.yaml` å­˜æ”¾ç€é¡¹ç›®çš„ä¸€äº›å¯é…ç½®é¡¹ï¼Œå¦‚é•œåƒçš„åç§°æˆ–è€… tag ä¹‹ç±»çš„ã€‚ä½œç”¨å°±æ˜¯ç”¨äºå’Œæ¨¡æ¿è¿›è¡Œç»„è£…ã€‚

### ç¼–å†™ chart

äº†è§£å®Œç»“æ„ä¹‹åï¼Œæˆ‘ä»¬æ¥å®é™…ç¼–å†™æˆ‘ä»¬çš„ chart ã€‚æ‰€æœ‰å®Œæ•´çš„ä»£ç å¯åœ¨ [SayThx é¡¹ç›®](https://github.com/tao12345666333/saythx) è·å–ã€‚

```
# Chart.yaml
apiVersion: v1
appVersion: "1.0"
description: A Helm chart for SayThx.
name: saythx
version: 0.1.0
maintainers:
  - name: Jintao Zhang
```

å¯æ·»åŠ  `maintainers` å­—æ®µï¼Œè¡¨ç¤ºç»´æŠ¤è€…ã€‚

```
# values.yaml

# backend is the values for backend
backend:
  image: taobeier/saythx-be
  tag: "1.0"
  pullPolicy: IfNotPresent
  replicas: 1

# namespace is the values for deploy namespace
namespace: work

# service.type is the values for service type
service:
  type: NodePort
```

`values.yaml` æ–‡ä»¶ä¸­å®šä¹‰äº†æˆ‘ä»¬é¢„æœŸå“ªäº›ä¸œè¥¿æ˜¯å¯é…ç½®çš„ï¼Œæ¯”å¦‚ `namespace` ä»¥åŠé•œåƒåç§° tag ç­‰ã€‚è¿™é‡Œåªæ˜¯è´´å‡ºäº†éƒ¨åˆ†å†…å®¹ï¼Œä»…åšè¯´æ˜ä½¿ç”¨ï¼Œå®Œæ•´å†…å®¹å¯æŸ¥çœ‹æˆ‘ä»¬çš„[ç¤ºä¾‹é¡¹ç›®](https://github.com/tao12345666333/saythx) ã€‚

å†™ `values.yaml` æ–‡ä»¶çš„æ—¶å€™ï¼Œç”±äºæ˜¯ä½¿ç”¨ `YAML` æ ¼å¼çš„é…ç½®ï¼Œæ‰€ä»¥å®ƒéå¸¸çš„çµæ´»ï¼Œå³å¯ä»¥ä½¿ç”¨å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ `backend` é‚£ç§å­—å…¸ç±»å‹çš„ï¼Œ ä¹Ÿå¯ä»¥å†™æˆç®€å•çš„ k-v å½¢å¼ã€‚ä½†é€šå¸¸æ¥è®²ï¼Œåº”è¯¥å°½å¯èƒ½çš„å°†å®ƒå†™çš„æ¸…æ™°æ˜ç¡®ã€‚å¹¶ä¸”å®¹æ˜“è¢«æ›¿æ¢ã€‚

```
# templates/backend-service.yaml 

apiVersion: v1
kind: Service
metadata:
  labels:
    app: backend
  name: saythx-backend
  namespace: {{ .Values.namespace }}
spec:
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
  selector:
    app: backend
  type: {{ .Values.service.type }}
```

å°†æˆ‘ä»¬ä¹‹å‰å†™çš„éƒ¨ç½²æ–‡ä»¶æ¨¡æ¿åŒ–ï¼Œä¸é…ç½®é¡¹è¿›è¡Œç»„è£…ã€‚

```
1. Get the application URL by running these commands:
{{- if contains "NodePort" .Values.service.type }}
  export NODE_PORT=$(kubectl get --namespace {{ .Values.namespace }} -o jsonpath="{.spec.ports[0].nodePort}" services saythx-frontend)
  export NODE_IP=$(kubectl get nodes --namespace {{ .Values.namespace }} -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
{{- else if contains "ClusterIP" .Values.service.type }}
  export POD_NAME=$(kubectl get pods --namespace {{ .Values.namespace }} -l "app=frontend" -o jsonpath="{.items[0].metadata.name}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace {{ .Values.namespace }} port-forward $POD_NAME 8080:80
{{- end }}
```

ä¸Šé¢è¿™æ˜¯ `NOTES.txt` æ–‡ä»¶å†…çš„å†…å®¹ã€‚ è¿™äº›å†…å®¹ä¼šåœ¨ `helm install` æ‰§è¡ŒæˆåŠŸåæ˜¾ç¤ºåœ¨ç»ˆç«¯ï¼Œç”¨äºè¯´æ˜æœåŠ¡å¦‚ä½•è®¿é—®æˆ–è€…å…¶ä»–æ³¨æ„äº‹é¡¹ç­‰ã€‚

å½“ç„¶ï¼Œè¿™é‡Œçš„å†…å®¹ä¸»è¦æ˜¯ä¸ºäº†è¯´æ˜å¦‚ä½•ç¼–å†™ `chart` ï¼Œåœ¨å®è·µä¸­ï¼Œå°½é‡é¿å…ç¡¬ç¼–ç é…ç½®åœ¨é‡Œé¢ã€‚

## éƒ¨ç½²

### ç›´æ¥éƒ¨ç½²

Helm çš„ `chart` å¯ä»¥ç›´æ¥åœ¨æºç ç›®å½•ä¸‹é€šè¿‡ `helm install` å®Œæˆéƒ¨ç½²ã€‚ä¾‹å¦‚ï¼š

```
âœ  saythx helm install saythx
NAME:   handy-seastar
LAST DEPLOYED: Tue Nov 20 23:33:42 2018
NAMESPACE: default
STATUS: DEPLOYED

RESOURCES:
==> v1/Namespace
NAME  STATUS  AGE
work  Active  1s

==> v1/Service
NAME             TYPE      CLUSTER-IP      EXTERNAL-IP  PORT(S)         AGE
saythx-backend   NodePort  10.102.206.213  <none>       8080:30663/TCP  0s
saythx-frontend  NodePort  10.96.109.45    <none>       80:30300/TCP    0s
saythx-redis     NodePort  10.97.174.8     <none>       6379:30589/TCP  0s

==> v1/Deployment
NAME             DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE
saythx-backend   1        1        1           0          0s
saythx-frontend  1        1        1           0          0s
saythx-redis     1        1        1           0          0s
saythx-work      1        1        1           0          0s

==> v1/Pod(related)
NAME                              READY  STATUS             RESTARTS  AGE
saythx-backend-7f6d86d9c8-xqttg   0/1    ContainerCreating  0         0s
saythx-frontend-777fc64997-9zmq6  0/1    Pending            0         0s
saythx-redis-8558c7d7d-lh5df      0/1    ContainerCreating  0         0s
saythx-work-9b4446d84-c2pr4       0/1    ContainerCreating  0         0s


NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace work -o jsonpath="{.spec.ports[0].nodePort}" services saythx-frontend)
  export NODE_IP=$(kubectl get nodes --namespace work -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```

### æ‰“åŒ…

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°† `chart` æ‰“åŒ…ï¼Œä»¥ä¾¿äºåˆ†å‘ã€‚

```
âœ  saythx helm package saythx 
Successfully packaged chart and saved it to: /root/saythx/saythx-0.1.0.tgz
```

å¯ä»¥çœ‹åˆ°æ‰“åŒ…æ—¶æ˜¯æŒ‰ç…§ `chart` çš„åå­—åŠ ç‰ˆæœ¬å·è¿›è¡Œå‘½åçš„ã€‚

è‡³äºéƒ¨ç½²ï¼Œå’Œå‰é¢æ²¡ä»€ä¹ˆå¤ªå¤§åŒºåˆ«ï¼Œ `helm install saythx-0.1.0.tgz` å³å¯ã€‚

### è®¿é—®æœåŠ¡

å‰é¢åœ¨éƒ¨ç½²å®Œæˆåï¼Œæœ‰ä¸€äº›è¿”å›ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥æŒ‰ç…§å…¶å†…å®¹è®¿é—®æˆ‘ä»¬çš„æœåŠ¡ï¼š

```
âœ  saythx export NODE_PORT=$(kubectl get --namespace work -o jsonpath="{.spec.ports[0].nodePort}" services saythx-frontend)
âœ  saythx export NODE_IP=$(kubectl get nodes --namespace work -o jsonpath="{.items[0].status.addresses[0].address}")
âœ  saythx echo http://$NODE_IP:$NODE_PORT
http://172.17.0.5:30300
âœ  saythx curl http://172.17.0.5:30300
<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.ico><title>fe</title><link href=/css/app.0a6f0b04.css rel=preload as=style><link href=/css/chunk-vendors.ea3fa8e3.css rel=preload as=style><link href=/js/app.ee469174.js rel=preload as=script><link href=/js/chunk-vendors.14b9b088.js rel=preload as=script><link href=/css/chunk-vendors.ea3fa8e3.css rel=stylesheet><link href=/css/app.0a6f0b04.css rel=stylesheet></head><body><noscript><strong>We're sorry but fe doesn't work properly without JavaScript enabled. Please enable it to continue.</strong></noscript><div id=app></div><script src=/js/chunk-vendors.14b9b088.js></script><script src=/js/app.ee469174.js></script></body></html>
```

æœåŠ¡å¯ä»¥æ­£å¸¸è®¿é—®ã€‚

## æ€»ç»“

é€šè¿‡æœ¬èŠ‚æˆ‘ä»¬å­¦ä¹ åˆ°äº† `chart` çš„å®é™…ç»“æ„ï¼ŒåŠç¼–å†™æ–¹å¼ã€‚ä»¥åŠç¼–å†™äº†æˆ‘ä»¬è‡ªå·±çš„ `chart` å¹¶ä½¿ç”¨è¯¥ `chart` éƒ¨ç½²äº†æœåŠ¡ã€‚

ç¤ºä¾‹é¡¹ç›®è¿˜ä»…ä»…æ˜¯ä¸ªå°é¡¹ç›®ï¼Œè¯•æƒ³å½“æˆ‘ä»¬éœ€è¦éƒ¨ç½²ä¸€ä¸ªå¤§å‹é¡¹ç›®ï¼Œå¦‚æœä¸é€šè¿‡ç±»ä¼¼ Helm è¿™æ ·çš„è½¯ä»¶è¿›è¡Œç®¡ç†ï¼Œæ¯æ¬¡çš„æ›´æ–°å‘å¸ƒï¼Œç»´æŠ¤ `YAML` çš„é…ç½®æ–‡ä»¶å°±ä¼šå¾ˆç¹çäº†ã€‚

å¦å¤–ï¼ŒHelm çš„åŠŸèƒ½è¿˜ä¸ä»…é™äºæ­¤ï¼Œä½¿ç”¨ Helm æˆ‘ä»¬è¿˜å¯ä»¥ç®¡ç† `Release` ï¼Œå¹¶è¿›è¡Œæ›´æ–°å›æ»šç­‰æ“ä½œã€‚ä»¥åŠï¼Œæˆ‘ä»¬å¯ä»¥æ­å»ºè‡ªå·±çš„ç§æœ‰ `chart` ä»“åº“ç­‰ã€‚

ä¸‹èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å°†è¿›å…¥æ·±å…¥å­¦ä¹ é˜¶æ®µï¼Œé€ä¸ªè®²è§£ K8S çš„æ ¸å¿ƒç»„ä»¶ï¼Œä»¥ä¾¿åç»­é‡åˆ°é—®é¢˜æ—¶ï¼Œå¯å¿«é€Ÿå®šä½å’Œè§£å†³ã€‚

# åº–ä¸è§£ç‰›ï¼škube-apiserver

## æ•´ä½“æ¦‚è§ˆ

```
+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +------->|        API Server       |<--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
```

åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬åˆæ¬¡è®¤è¯†åˆ°äº† `kube-apiserver` çš„å­˜åœ¨ï¼ˆä»¥ä¸‹å†…å®¹ä¸­å°†ç»Ÿä¸€ç§°ä¹‹ä¸º `kube-apiserver`ï¼‰ï¼ŒçŸ¥é“äº†å®ƒä½œä¸ºé›†ç¾¤çš„ç»Ÿä¸€å…¥å£ï¼Œæ¥æ”¶æ¥è‡ªå¤–éƒ¨çš„ä¿¡å·å’Œè¯·æ±‚ï¼Œå¹¶å°†ä¸€äº›ä¿¡æ¯å­˜å‚¨è‡³ `etcd` ä¸­ã€‚

ä½†è¿™åªæ˜¯ä¸€ç§å¾ˆæ¨¡ç³Šçš„è¯´æ³•ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹ `kube-apiserver` çš„å…³é”®åŠŸèƒ½ä»¥åŠå®ƒçš„å·¥ä½œåŸç†ã€‚

æ³¨æ„ï¼šæœ¬èŠ‚æ‰€æœ‰çš„æºç å‡ä»¥ `v1.11.3` ä¸ºå‡† commit id `a4529464e4629c21224b3d52edfe0ea91b072862`ã€‚

## REST API Server

å…ˆæ¥è¯´ä¸‹ `kube-apiserver` ä½œä¸ºæ•´ä¸ªé›†ç¾¤çš„å…¥å£ï¼Œæ¥å—å¤–éƒ¨çš„ä¿¡å·å’Œè¯·æ±‚æ‰€åº”è¯¥å…·å¤‡çš„åŸºæœ¬åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œå®ƒå¯¹å¤–æä¾›æ¥å£ï¼Œå¯å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯ï¼ˆæ— è®ºæˆ‘ä»¬åœ¨ç”¨çš„ `kubeclt` æˆ–è€… `curl` æˆ–è€…å…¶ä»–è¯­è¨€å®ç°çš„å®¢æˆ·ç«¯ï¼‰çš„è¯·æ±‚ï¼Œå¹¶ä½œå‡ºå“åº”ã€‚

åœ¨ç¬¬ 5 èŠ‚æ­å»ºé›†ç¾¤æ—¶ï¼Œæˆ‘ä»¬æåˆ°è¦å…ˆå»æ£€æŸ¥ `6443` ç«¯å£æ˜¯å¦è¢«å ç”¨ã€‚è¿™æ ·æ£€æŸ¥çš„åŸå› åœ¨äº `kube-apiserver` æœ‰ä¸ª `--secure-port` çš„å‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°æ¥é…ç½®å®ƒå°†è¦ç›‘å¬åœ¨å“ªä¸ªç«¯å£ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ `6443`ã€‚

å½“ç„¶ï¼Œå®ƒè¿˜æœ‰å¦ä¸€ä¸ªå‚æ•° `--insecure-port` ï¼Œè¿™ä¸ªå‚æ•°å¯å°† `kube-apiserver` ç»‘å®šåˆ°å…¶æŒ‡å®šçš„ç«¯å£ä¸Šï¼Œä¸”é€šè¿‡è¯¥ç«¯å£è®¿é—®æ—¶æ— éœ€è®¤è¯ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®å°†å…¶è®¾ç½®ä¸º `0` ä»¥ç¦ç”¨è¯¥åŠŸèƒ½ã€‚å¦å¤–ï¼Œè¿™ä¸ªå‚æ•°ä¹Ÿå·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå°†åœ¨ä¹‹åç‰ˆæœ¬ä¸­ç§»é™¤ã€‚å¦‚æœæœªç¦ç”¨è¯¥åŠŸèƒ½ï¼Œå»ºè®®é€šè¿‡é˜²ç«å¢™ç­–ç•¥ç¦æ­¢ä»å¤–éƒ¨è®¿é—®è¯¥ç«¯å£ã€‚è¯¥ç«¯å£ä¼šç»‘å®šåœ¨ `--insecure-bind-address` å‚æ•°æ‰€è®¾ç½®çš„åœ°å€ä¸Šï¼Œé»˜è®¤ä¸º `127.0.0.1`ã€‚

é‚£ä¹ˆ `secure` å’Œ `insecure` æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ è¿™å°±å¼•å‡ºæ¥äº† `kube-apiserver` ä½œä¸º API Server çš„ä¸€ä¸ªæœ€ä¸»è¦åŠŸèƒ½ï¼šè®¤è¯ã€‚

### è®¤è¯ï¼ˆAuthenticationï¼‰

åœ¨ç¬¬ 8 èŠ‚ã€Šè®¤è¯å’Œæˆæƒã€‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»è®²è¿‡è®¤è¯ç›¸å…³çš„æœºåˆ¶ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä»¥æœ€ç®€å•çš„è·å–é›†ç¾¤ç‰ˆæœ¬å·ä¸ºä¾‹ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬ä½¿ç”¨ `kubeclt version` æ¥è·å–é›†ç¾¤å’Œå½“å‰å®¢æˆ·ç«¯çš„ç‰ˆæœ¬å·ã€‚

```
master $ kubectl version
Client Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T18:02:47Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
Server Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T17:53:03Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
```

è·å–é›†ç¾¤ç‰ˆæœ¬å·çš„æ—¶å€™ï¼Œå…¶å®ä¹Ÿæ˜¯å‘ `kube-apiserver` å‘é€äº†ä¸€ä¸ªè¯·æ±‚è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ é€’ `-v` å‚æ•°æ¥æ”¹å˜ log level ã€‚

```
master $ kubectl version -v 8
I1202 03:15:06.360838   13581 loader.go:359] Config loaded from file /root/.kube/config
I1202 03:15:06.362106   13581 round_trippers.go:383] GET https://172.17.0.99:6443/version?timeout=32s
I1202 03:15:06.362130   13581 round_trippers.go:390] Request Headers:
I1202 03:15:06.362139   13581 round_trippers.go:393]     Accept: application/json, */*
I1202 03:15:06.362146   13581 round_trippers.go:393]     User-Agent: kubectl/v1.11.3 (linux/amd64) kubernetes/a452946
I1202 03:15:06.377653   13581 round_trippers.go:408] Response Status: 200 OK in 15 milliseconds
I1202 03:15:06.377678   13581 round_trippers.go:411] Response Headers:
I1202 03:15:06.377686   13581 round_trippers.go:414]     Content-Type: application/json
I1202 03:15:06.377693   13581 round_trippers.go:414]     Content-Length: 263
I1202 03:15:06.377699   13581 round_trippers.go:414]     Date: Sun, 02 Dec 2018 03:15:06 GMT
I1202 03:15:06.379314   13581 request.go:897] Response Body: {
  "major": "1",
  "minor": "11",
  "gitVersion": "v1.11.3",
  "gitCommit": "a4529464e4629c21224b3d52edfe0ea91b072862",
  "gitTreeState": "clean",
  "buildDate": "2018-09-09T17:53:03Z",
  "goVersion": "go1.10.3",
  "compiler": "gc",
  "platform": "linux/amd64"
}
Client Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T18:02:47Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
Server Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-09T17:53:03Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}
```

é€šè¿‡æ—¥å¿—å°±å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°ï¼Œé¦–å…ˆä¼šåŠ è½½ `$HOME/.kube/config` ä¸‹çš„é…ç½®ï¼Œè·çš„é›†ç¾¤åœ°å€ï¼Œè¿›è€Œè¯·æ±‚ `/version` æ¥å£ï¼Œæœ€åæ ¼å¼åŒ–è¾“å‡ºã€‚

æˆ‘ä»¬ä½¿ç”¨ `curl` å»è¯·æ±‚åŒæ ·çš„æ¥å£ï¼š

```
master $ curl -k https://172.17.0.99:6443/version
{
  "major": "1",
  "minor": "11",
  "gitVersion": "v1.11.3",
  "gitCommit": "a4529464e4629c21224b3d52edfe0ea91b072862",
  "gitTreeState": "clean",
  "buildDate": "2018-09-09T17:53:03Z",
  "goVersion": "go1.10.3",
  "compiler": "gc",
  "platform": "linux/amd64"
}
```

å¾—åˆ°äº†ç›¸åŒçš„ç»“æœã€‚ä½ å¯èƒ½ä¼šæœ‰äº›å¥‡æ€ªï¼Œä½¿ç”¨ `curl -k` ç›¸å½“äºå¿½ç•¥äº†è®¤è¯çš„è¿‡ç¨‹ï¼Œä¸ºä½•è¿˜èƒ½æ‹¿åˆ°æ­£ç¡®çš„ä¿¡æ¯ã€‚åˆ«æ€¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€ä¸ªä¾‹å­ï¼š

```
master $ kubectl get ns  -v 8
I1202 03:25:40.607886   16620 loader.go:359] Config loaded from file /root/.kube/config
I1202 03:25:40.608862   16620 loader.go:359] Config loaded from file /root/.kube/config
I1202 03:25:40.611187   16620 loader.go:359] Config loaded from file /root/.kube/config
I1202 03:25:40.622737   16620 loader.go:359] Config loaded from file /root/.kube/config
I1202 03:25:40.623495   16620 round_trippers.go:383] GET https://172.17.0.99:6443/api/v1/namespaces?limit=500
I1202 03:25:40.623650   16620 round_trippers.go:390] Request Headers:
I1202 03:25:40.623730   16620 round_trippers.go:393]     Accept: application/json;as=Table;v=v1beta1;g=meta.k8s.io, application/json
I1202 03:25:40.623820   16620 round_trippers.go:393]     User-Agent: kubectl/v1.11.3 (linux/amd64) kubernetes/a452946
I1202 03:25:40.644280   16620 round_trippers.go:408] Response Status: 200 OK in 20 milliseconds
I1202 03:25:40.644308   16620 round_trippers.go:411] Response Headers:
I1202 03:25:40.644327   16620 round_trippers.go:414]     Content-Type: application/json
I1202 03:25:40.644334   16620 round_trippers.go:414]     Content-Length: 2061
I1202 03:25:40.644338   16620 round_trippers.go:414]     Date: Sun, 02 Dec 2018 03:25:40 GMT
I1202 03:25:40.644398   16620 request.go:897] Response Body: {"kind":"Table","apiVersion":"meta.k8s.io/v1beta1","metadata":{"selfLink":"/api/v1/namespaces","resourceVersion":"3970"},"columnDefinitions":[{"name":"Name","type":"string","format":"name","description":"Name must be unique within anamespace. Is required when creating resources, although some resources may allow a client to request the generation of an appropriate name automatically. Name is primarily intended for creation idempotence and configuration definition. Cannot be updated. More info: http://kubernetes.io/docs/user-guide/identifiers#names","priority":0},{"name":"Status","type":"string","format":"","description":"The status of the namespace","priority":0},{"name":"Age","type":"string","format":"","description":"CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.\n\nPopulated by the system. Read-only. [truncated 1037 chars]
I1202 03:25:40.645111   16620 get.go:443] no kind is registered for the type v1beta1.Table
NAME          STATUS    AGE
default       Active    45m
kube-public   Active    45m
kube-system   Active    45m
```

ä½¿ç”¨ `curl` å»è¯·æ±‚ï¼š

```
master $ curl -k  https://172.17.0.99:6443/api/v1/namespaces
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {

  },
  "status": "Failure",
  "message": "namespaces is forbidden: User \"system:anonymous\" cannot list namespaces at the cluster scope",
  "reason": "Forbidden",
  "details": {
    "kind": "namespaces"
  },
  "code": 403
}
```

çœ‹åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±å¾ˆæ˜æ˜¾äº†ï¼Œå½“å‰å¿½ç•¥æ‰è®¤è¯è¿‡ç¨‹çš„ `curl` è¢«åˆ¤å®šä¸º `system:anonymous` ç”¨æˆ·ï¼Œè€Œæ­¤ç”¨æˆ·ä¸å…·å¤‡åˆ—å‡º `namespace` çš„æƒé™ã€‚

é‚£æˆ‘ä»¬æ˜¯å¦æœ‰å…¶ä»–åŠæ³•ä½¿ç”¨ `curl` è·å–èµ„æºå‘¢ï¼Ÿ å½“ç„¶æœ‰ï¼Œä½¿ç”¨ `kubectl proxy` å¯ä»¥åœ¨æœ¬åœ°å’Œé›†ç¾¤ä¹‹é—´åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œå°±åƒè¿™æ ·ï¼š

```
master $ kubectl proxy &
[1] 22205
master $ Starting to serve on 127.0.0.1:8001

master $ curl http://127.0.0.1:8001/api/v1/namespaces
{
  "kind": "NamespaceList",
  "apiVersion": "v1",
  "metadata": {
    "selfLink": "/api/v1/namespaces",
    "resourceVersion": "5363"
  },
  "items": [
    {
      "metadata": {
        "name": "default",
        "selfLink": "/api/v1/namespaces/default",
        "uid": "a5124131-f5db-11e8-9237-0242ac110063",
        "resourceVersion": "4",
        "creationTimestamp": "2018-12-02T02:40:35Z"
      },
      "spec": {
        "finalizers": [
          "kubernetes"
        ]
      },
      "status": {
        "phase": "Active"
      }
    },
    {
      "metadata": {
        "name": "kube-public",
        "selfLink": "/api/v1/namespaces/kube-public",
        "uid": "a5153f73-f5db-11e8-9237-0242ac110063",
        "resourceVersion": "10",
        "creationTimestamp": "2018-12-02T02:40:35Z"
      },
      "spec": {
        "finalizers": [
          "kubernetes"
        ]
      },
      "status": {
        "phase": "Active"
      }
    },
    {
      "metadata": {
        "name": "kube-system",
        "selfLink": "/api/v1/namespaces/kube-system",
        "uid": "a514ad25-f5db-11e8-9237-0242ac110063",
        "resourceVersion": "9",
        "creationTimestamp": "2018-12-02T02:40:35Z"
      },
      "spec": {
        "finalizers": [
          "kubernetes"
        ]
      },
      "status": {
        "phase": "Active"
      }
    }
  ]
}
```

å¯ä»¥çœ‹åˆ°å·²ç»èƒ½æ­£ç¡®çš„è·å–èµ„æºäº†ï¼Œè¿™æ˜¯å› ä¸º `kubectl proxy` ä½¿ç”¨äº† `$HOME/.kube/config` ä¸­çš„é…ç½®ã€‚

åœ¨ `staging/src/k8s.io/client-go/tools/clientcmd/loader.go` ä¸­ï¼Œæœ‰ä¸€ä¸ªåä¸º `LoadFromFile` çš„å‡½æ•°ç”¨æ¥æä¾›åŠ è½½é…ç½®æ–‡ä»¶çš„åŠŸèƒ½ã€‚

```
func LoadFromFile(filename string) (*clientcmdapi.Config, error) {
	kubeconfigBytes, err := ioutil.ReadFile(filename)
	if err != nil {
		return nil, err
	}
	config, err := Load(kubeconfigBytes)
	if err != nil {
		return nil, err
	}
	glog.V(6).Infoln("Config loaded from file", filename)

	// set LocationOfOrigin on every Cluster, User, and Context
	for key, obj := range config.AuthInfos {
		obj.LocationOfOrigin = filename
		config.AuthInfos[key] = obj
	}
	for key, obj := range config.Clusters {
		obj.LocationOfOrigin = filename
		config.Clusters[key] = obj
	}
	for key, obj := range config.Contexts {
		obj.LocationOfOrigin = filename
		config.Contexts[key] = obj
	}

	if config.AuthInfos == nil {
		config.AuthInfos = map[string]*clientcmdapi.AuthInfo{}
	}
	if config.Clusters == nil {
		config.Clusters = map[string]*clientcmdapi.Cluster{}
	}
	if config.Contexts == nil {
		config.Contexts = map[string]*clientcmdapi.Context{}
	}

	return config, nil
}
```

é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œè¯»å–æŒ‡å®šçš„æ–‡ä»¶ï¼ˆä¸€èˆ¬åœ¨è°ƒç”¨æ­¤å‡½æ•°å‰ï¼Œéƒ½ä¼šå…ˆå»æ£€æŸ¥æ˜¯å¦æœ‰ `KUBECONFIG` çš„ç¯å¢ƒå˜é‡æˆ– `--kubeconfig`ï¼Œå¦‚æœæ²¡æœ‰æ‰ä¼šä½¿ç”¨é»˜è®¤çš„ `$HOME/.kube/config` ä½œä¸ºæ–‡ä»¶åï¼‰ã€‚

ä»ä»¥ä¸Šçš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨å½“å‰é…ç½®çš„ç”¨æˆ·å¯ä»¥è·å–èµ„æºï¼Œè€Œ `system:anonymous` ä¸å¯ä»¥ã€‚å¯ä»¥å¾—å‡º `kube-apiserver` åˆä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼šæˆæƒã€‚

### æˆæƒï¼ˆAuthorizationï¼‰

åœ¨ç¬¬ 8 èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»è®²è¿‡ï¼ŒK8S æ”¯æŒå¤šç§æˆæƒæœºåˆ¶ï¼Œç°åœ¨å¤šæ•°éƒ½åœ¨ä½¿ç”¨ `RBAC` ï¼Œæˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ `kubeadm` åˆ›å»ºé›†ç¾¤æ—¶ï¼Œé»˜è®¤ä¼šå¼€å¯ `RBAC`ã€‚å¦‚ä½•åˆ›å»ºæƒé™å¯æ§çš„ç”¨æˆ·åœ¨ç¬¬ 8 èŠ‚ä¹Ÿå·²ç»è¯´è¿‡ã€‚æ‰€ä»¥æœ¬èŠ‚ä¸­ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç›´æ¥çœ‹æˆæƒåçš„å¤„ç†é€»è¾‘ã€‚

### å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰

åœ¨è¯·æ±‚è¿›æ¥æ—¶ï¼Œä¼šå…ˆç»è¿‡è®¤è¯ã€æˆæƒæ¥ä¸‹æ¥ä¼šè¿›å…¥å‡†å…¥æ§åˆ¶ç¯èŠ‚ã€‚å‡†å…¥æ§åˆ¶å’Œå‰ä¸¤é¡¹å†…å®¹ä¸åŒï¼Œå®ƒä¸åªæ˜¯å…³æ³¨ç”¨æˆ·å’Œè¡Œä¸ºï¼Œå®ƒè¿˜ä¼šå¤„ç†è¯·æ±‚çš„å†…å®¹ã€‚ä¸è¿‡å®ƒå¯¹è¯»æ“ä½œæ— æ•ˆã€‚

å‡†å…¥æ§åˆ¶ä¸æˆ‘ä»¬å‰é¢è¯´æåˆ°çš„è®¤è¯ã€æˆæƒæ’ä»¶ç±»ä¼¼ï¼Œæ”¯æŒåŒæ—¶å¼€å¯å¤šä¸ªã€‚åœ¨ `v1.11.3` ä¸­ï¼Œé»˜è®¤å¼€å¯çš„å‡†å…¥æ§åˆ¶æ’ä»¶æœ‰ï¼š

```
NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeClaimResize,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,Priority
```

ç›¸å…³çš„ä»£ç å¯æŸ¥çœ‹ `pkg/kubeapiserver/options/plugins.go`

```
func DefaultOffAdmissionPlugins() sets.String {
	defaultOnPlugins := sets.NewString(
		lifecycle.PluginName,                //NamespaceLifecycle
		limitranger.PluginName,              //LimitRanger
		serviceaccount.PluginName,           //ServiceAccount
		setdefault.PluginName,               //DefaultStorageClass
		resize.PluginName,                   //PersistentVolumeClaimResize
		defaulttolerationseconds.PluginName, //DefaultTolerationSeconds
		mutatingwebhook.PluginName,          //MutatingAdmissionWebhook
		validatingwebhook.PluginName,        //ValidatingAdmissionWebhook
		resourcequota.PluginName,            //ResourceQuota
	)

	if utilfeature.DefaultFeatureGate.Enabled(features.PodPriority) {
		defaultOnPlugins.Insert(podpriority.PluginName) //PodPriority
	}

	return sets.NewString(AllOrderedPlugins...).Difference(defaultOnPlugins)
}
```

åœ¨è¿™é‡Œå†™äº†ä¸€äº›é»˜è®¤å¼€å¯çš„é…ç½®ã€‚äº‹å®ä¸Šï¼Œåœ¨æ—©ä¹‹å‰ï¼Œ`PersistentVolumeClaimResize` é»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œå¹¶ä¸”å¼€å¯äº† `PersistentVolumeLabel`ï¼Œå¯¹äºç§»é™¤ `Persistentvolumelabel` æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒä¸‹ [Remove the PersistentVolumeLabel Admission Controller](https://github.com/kubernetes/kubernetes/issues/52617) ã€‚

è¿™é‡Œå¯¹å‡ ä¸ªæ¯”è¾ƒå¸¸è§çš„æ’ä»¶åšä¸‹è¯´æ˜ï¼š

- NamespaceLifecycleï¼šå®ƒå¯ä»¥ä¿è¯æ­£åœ¨ç»ˆæ­¢çš„ `Namespace` ä¸å…è®¸åˆ›å»ºå¯¹è±¡ï¼Œä¸å…è®¸è¯·æ±‚ä¸å­˜åœ¨çš„ `Namespace` ä»¥åŠä¿è¯é»˜è®¤çš„ `default`, `kube-system` ä¹‹ç±»çš„å‘½åç©ºé—´ä¸è¢«åˆ é™¤ã€‚æ ¸å¿ƒçš„ä»£ç æ˜¯ï¼š

  ```
  if a.GetOperation() == admission.Delete && a.GetKind().GroupKind() == v1.SchemeGroupVersion.WithKind("Namespace").GroupKind() && l.immortalNamespaces.Has(a.GetName()) {
  	return errors.NewForbidden(a.GetResource().GroupResource(), a.GetName(), fmt.Errorf("this namespace may not be deleted"))
  }
  ```

  å¦‚æœåˆ é™¤é»˜è®¤çš„ `Namespace` åˆ™ä¼šå¾—åˆ°ä¸‹é¢çš„å¼‚å¸¸ï¼š

  ```
  master $ kubectl delete ns kube-system
  Error from server (Forbidden): namespaces "kube-system" is forbidden: this namespace may not be deleted
  master $ kubectl delete ns kube-public
  Error from server (Forbidden): namespaces "kube-public" is forbidden: this namespace may not be deleted
  master $ kubectl delete ns default
  Error from server (Forbidden): namespaces "default" is forbidden: this namespace may not be deleted
  ```

- LimitRangerï¼šä¸º `Pod` è®¾ç½®é»˜è®¤è¯·æ±‚èµ„æºçš„é™åˆ¶ã€‚

- ServiceAccountï¼šå¯æŒ‰ç…§é¢„è®¾è§„åˆ™åˆ›å»º `Serviceaccount` ã€‚æ¯”å¦‚éƒ½æœ‰ç»Ÿä¸€çš„å‰ç¼€ï¼š`system:serviceaccount:`ã€‚

- DefaultStorageClassï¼šä¸º `PVC` è®¾ç½®é»˜è®¤ `StorageClass`ã€‚

- DefaultTolerationSecondsï¼šè®¾ç½® `Pod` çš„é»˜è®¤ forgiveness toleration ä¸º 5 åˆ†é’Ÿã€‚è¿™ä¸ªå¯èƒ½å¸¸ä¼šçœ‹åˆ°ã€‚

- MutatingAdmissionWebhook å’Œ ValidatingAdmissionWebhookï¼šè¿™ä¸¤ä¸ªéƒ½æ˜¯é€šè¿‡ Webhook éªŒè¯æˆ–è€…ä¿®æ”¹è¯·æ±‚ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ä¸€ä¸ªæ˜¯é¡ºåºè¿›è¡Œï¼Œä¸€ä¸ªæ˜¯å¹¶è¡Œè¿›è¡Œçš„ã€‚

- ResourceQuotaï¼šé™åˆ¶ `Pod` è¯·æ±‚é…é¢ã€‚

- AlwaysPullImagesï¼šæ€»æ˜¯æ‹‰å–é•œåƒã€‚

- AlwaysAdmitï¼šæ€»æ˜¯æ¥å—æ‰€æœ‰è¯·æ±‚ã€‚

### å¤„ç†è¯·æ±‚

å‰é¢å·²ç»è¯´åˆ°ï¼Œä¸€ä¸ªè¯·æ±‚ä¾æ¬¡ä¼šç»è¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ç­‰ç¯èŠ‚ï¼Œå½“è¿™äº›ç¯èŠ‚éƒ½å·²ç»é€šè¿‡åï¼Œè¯¥è¯·æ±‚ä¾¿åˆ°äº† `kube-apiserver` çš„å®é™…å¤„ç†é€»è¾‘ä¸­äº†ã€‚

å…¶å®å’Œæ™®é€šçš„ Web server ç±»ä¼¼ï¼Œ`kube-apiserver` æä¾›äº† `restful` çš„æ¥å£ï¼Œå¢åˆ æ”¹æŸ¥ç­‰åŸºæœ¬åŠŸèƒ½éƒ½åŸºæœ¬ç±»ä¼¼ã€‚è¿™é‡Œå…ˆæš‚æ—¶ä¸å†æ·±å…¥ã€‚

## æ€»ç»“

é€šè¿‡æœ¬èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº† `kube-apiserver` çš„åŸºæœ¬å·¥ä½œé€»è¾‘ï¼Œå„ç±» API è¯·æ±‚å…ˆåé€šè¿‡è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ç­‰ä¸€ç³»åˆ—ç¯èŠ‚åï¼Œè¿›å…¥åˆ° `kube-apiserver` çš„ `Registry` è¿›è¡Œç›¸å…³é€»è¾‘å¤„ç†ã€‚

è‡³äºéœ€è¦è¿›è¡ŒæŒä¹…åŒ–æˆ–è€…éœ€è¦ä¸åç«¯å­˜å‚¨äº¤äº’çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨ä¸‹èŠ‚ä¼šä»‹ç» `etcd` åˆ°æ—¶å†çœ‹ K8S æ˜¯å¦‚ä½•å°†åç«¯å­˜å‚¨æŠ½è±¡åŒ–ï¼Œä» `etcd` v2 å‡çº§è‡³ v3 çš„ã€‚

`kube-apiserver` åŒ…å«çš„ä¸œè¥¿æœ‰å¾ˆå¤šï¼Œå½“ä½ åœ¨ç»ˆç«¯ä¸‹æ‰§è¡Œ `./kube-apiserver -h` æ—¶ï¼Œä¼šå‘ç°æœ‰å¤§é‡çš„å‚æ•°ã€‚

è¿™äº›å‚æ•°é™¤äº†è®¤è¯ï¼Œæˆæƒï¼Œå‡†å…¥æ§åˆ¶ç›¸å…³åŠŸèƒ½

# åº–ä¸è§£ç‰›ï¼šetcd

## æ•´ä½“æ¦‚è§ˆ

```
+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +------->|        API Server       |<--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
```

åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°äº† `etcd` çš„å­˜åœ¨ï¼ŒçŸ¥é“äº† Master æ˜¯ K8S æ˜¯é›†ç¾¤çš„å¤§è„‘ï¼Œè€Œ `etcd` åˆ™æ˜¯å¤§è„‘çš„æ ¸å¿ƒã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿæœ¬èŠ‚æˆ‘ä»¬ä¸€åŒæ¥çœ‹çœ‹ `etcd` ä¸ºä½•å¦‚æ­¤é‡è¦ã€‚

## `etcd` æ˜¯ä»€ä¹ˆ

å…ˆæ‘˜å½•[å®˜æ–¹æ–‡æ¡£](https://etcd.readthedocs.io/en/latest/faq.html#what-is-etcd)çš„ä¸€å¥è¯´æ˜:

> etcd is a consistent distributed key-value store. Mainly used as a separate coordination service, in distributed systems. And designed to hold small amounts of data that can fit entirely in memory.

`etcd` æ˜¯ç”± CoreOS å›¢é˜Ÿå‘èµ·çš„ä¸€ä¸ªåˆ†å¸ƒå¼ï¼Œå¼ºä¸€è‡´çš„é”®å€¼å­˜å‚¨ã€‚å®ƒç”¨ Go è¯­è¨€ç¼–å†™ï¼Œä½¿ç”¨ `Raft` åè®®ä½œä¸ºä¸€è‡´æ€§ç®—æ³•ã€‚å¤šæ•°æƒ…å†µä¸‹ä¼šç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æœåŠ¡æ³¨å†Œå‘ç°ï¼Œæˆ–æ˜¯ç”¨äºå­˜å‚¨ç³»ç»Ÿçš„å…³é”®æ•°æ®ã€‚

## `etcd` æœ‰ä»€ä¹ˆä½œç”¨

`etcd` åœ¨ K8S ä¸­ï¼Œæœ€ä¸»è¦çš„ä½œç”¨ä¾¿æ˜¯å…¶é«˜å¯ç”¨ï¼Œå¼ºä¸€è‡´çš„é”®å€¼å­˜å‚¨ä»¥åŠç›‘å¬æœºåˆ¶ã€‚

åœ¨ `kube-apiserver` æ”¶åˆ°å¯¹åº”è¯·æ±‚ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†åï¼Œæœ€ç»ˆå¦‚æœæ˜¯é›†ç¾¤æ‰€éœ€è¦å­˜å‚¨çš„æ•°æ®ï¼Œä¾¿ä¼šå­˜å‚¨è‡³ `etcd` ä¸­ã€‚ä¸»éƒ¨åˆ†ä¸»è¦æ˜¯é›†ç¾¤çŠ¶æ€ä¿¡æ¯å’Œå…ƒä¿¡æ¯ã€‚

æˆ‘ä»¬æ¥å®é™…æ“ä½œ K8S é›†ç¾¤ä¸­çš„ `etcd` çœ‹ä¸‹çœŸå®æƒ…å†µã€‚

- æŸ¥æ‰¾é›†ç¾¤ä¸­çš„ `etcd` Pod

```
# é»˜è®¤é›†ç¾¤ä¸­çš„ etcd ä¼šæ”¾åˆ° kube-system Namespace ä¸­
master $ kubectl -n kube-system get pods | grep etcd
etcd-master                      1/1       Running   0          1h
```

- è¿›å…¥è¯¥ Pod å¹¶æŸ¥çœ‹ `etcd` é›†ç¾¤çš„ `member`

```
master $ kubectl -n kube-system exec -it etcd-master sh
/ # ETCDCTL_API=3 etcdctl --key=/etc/kubernetes/pki/etcd/server.key  --cert=/etc/kubernetes/pki/etcd/server.crt  --cacert=/etc/kubernetes/pki/etcd/ca.crt member list
a874c87fd42044f, started, master, https://127.0.0.1:2380, https://127.0.0.1:2379
```

è¿™é‡Œç”±äºåœ¨ K8S 1.11.3 ä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯ `etcd` 3.2 ç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦åŠ å…¥ `ETCDCTL_API=3` çš„ç¯å¢ƒå˜é‡ï¼Œä¸” `etcd` ä» 2 åˆ° 3 å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªå˜åŒ–ä¹Ÿæ˜¯ä½¿ç”¨ä¸Šçš„å˜åŒ–ï¼Œåœ¨ 2 ä¸­æ˜¯ HTTP æ¥å£çš„ã€‚

æˆ‘ä»¬é€šè¿‡ä¼ é€’è¯ä¹¦ç­‰ç›¸å…³å‚æ•°è¿›å»ï¼Œå®Œæˆæ ¡éªŒï¼ŒæŸ¥çœ‹ `member` ã€‚

- æŸ¥çœ‹å­˜å‚¨çš„å…ƒä¿¡æ¯

`etcd` ä¸­å­˜å‚¨çš„ K8S é›†ç¾¤å…ƒä¿¡æ¯åŸºæœ¬éƒ½æ˜¯ `/registry` ä¸‹ï¼Œæˆ‘ä»¬å¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿›è¡ŒæŸ¥çœ‹

```
/ # ETCDCTL_API=3 etcdctl --key=/etc/kubernetes/pki/etcd/server.key  --cert=/etc/kubernetes/pki/etcd/server.crt  --cacert=/etc/kubernetes/pki/etcd/ca.crt get /registry --prefix --keys-only
/registry/apiregistration.k8s.io/apiservices/v1.
/registry/clusterroles/system:aggregate-to-admin
/registry/configmaps/kube-public/cluster-info
/registry/masterleases/172.17.0.53
/registry/namespaces/default
/registry/namespaces/kube-public
/registry/namespaces/kube-system
/registry/pods/kube-system/etcd-master
/registry/pods/kube-system/kube-apiserver-master
/registry/ranges/serviceips
/registry/ranges/servicenodeports
...
# ç¯‡å¹…åŸå› ï¼Œåˆ æ‰äº†å¾ˆå¤šè¾“å‡º
```

å¯ä»¥çœ‹åˆ°æœ‰å„ç§ç±»å‹çš„èµ„æºã€‚æˆ‘ä»¬ç›´æ¥ä»¥ Namespaces ä¸ºä¾‹ã€‚

- æŸ¥çœ‹ Namespaces ä¿¡æ¯

```
/ # ETCDCTL_API=3 etcdctl --key=/etc/kubernetes/pki/etcd/server.key  --cert=/etc/kubernetes/pki/etcd/server.crt  --cacert=/etc/kubernetes/pki/etcd/ca.crt get /registry/namespaces --prefix --keys-only
/registry/namespaces/default

/registry/namespaces/kube-public

/registry/namespaces/kube-system
```

- ä½¿ç”¨ `kubectl` åˆ›å»ºåä¸º `moelove` çš„ Namespaces

```
master $ kubectl create  ns moelove
namespace/moelove created
```

- æŸ¥çœ‹ Namespaces ä¿¡æ¯

```
/ # ETCDCTL_API=3 etcdctl --key=/etc/kubernetes/pki/etcd/server.key  --cert=/etc/kubernetes/pki/etcd/server.crt  --cacert=/etc/kubernetes/pki/etcd/ca.crt get /registry/namespaces --prefix --keys-only
/registry/namespaces/default

/registry/namespaces/kube-public

/registry/namespaces/kube-system

/registry/namespaces/moelove
```

å‘ç°åˆšåˆ›å»ºçš„ `moelove` çš„ Namespaces å·²ç»åœ¨ `etcd` ä¸­äº†ã€‚

## `etcd` æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„

é¦–å…ˆï¼Œåœ¨ `staging/src/k8s.io/apiserver/pkg/server/options/etcd.go` ä¸­ï¼Œå­˜åœ¨ä¸€å¤„å£°æ˜ï¼š

```
var storageTypes = sets.NewString(
	storagebackend.StorageTypeUnset,
	storagebackend.StorageTypeETCD2,
	storagebackend.StorageTypeETCD3,
)
```

**åœ¨ 1.13 å‘å¸ƒæ—¶ï¼Œ`etcd 2` çš„ç›¸å…³ä»£ç å·²ç»ç§»é™¤ï¼Œå…¶ä¸­å°±åŒ…å«ä¸Šé¢å£°æ˜ä¸­çš„ `storagebackend.StorageTypeETCD2`**

è¿™é‡Œæ˜¯åœ¨è¿‡æ¸¡æœŸé—´ä¸ºäº†åŒæ—¶å…¼å®¹ `etcd` 2 å’Œ 3 è€Œå¢åŠ çš„ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸‹å®é™…å¯¹å„ç±»èµ„æºçš„æ“ä½œï¼Œè¿˜æ˜¯ä»¥å¯¹ `Namespace` çš„æ“ä½œä¸ºä¾‹ï¼šä»£ç åœ¨ `pkg/registry/core/namespace/storage/storage.go` ä¸­ï¼Œ

æ¯”å¦‚ï¼Œ`Get`ï¼š

```
func (r *REST) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {
	return r.store.Get(ctx, name, options)
}
```

è€Œ `REST` åˆ™æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š

```
type REST struct {
	store  *genericregistry.Store
	status *genericregistry.Store
}
```

é€šè¿‡ `REST` å®ç°äº†ä¸€ä¸ª `RESTStorage`ï¼Œå®é™…ä½¿ç”¨æ—¶ï¼Œä¹Ÿæ˜¯è°ƒç”¨äº† `staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go` å¯¹æ¥å£çš„å°è£…ã€‚

```
func (e *Store) Get(ctx context.Context, name string, options *metav1.GetOptions) (runtime.Object, error) {
	obj := e.NewFunc()
	key, err := e.KeyFunc(ctx, name)
	if err != nil {
		return nil, err
	}
	if err := e.Storage.Get(ctx, key, options.ResourceVersion, obj, false); err != nil {
		return nil, storeerr.InterpretGetError(err, e.qualifiedResourceFromContext(ctx), name)
	}
	if e.Decorator != nil {
		if err := e.Decorator(obj); err != nil {
			return nil, err
		}
	}
	return obj, nil
}
```

åœ¨è¯¥å¤„å®ç°äº†å¯¹å„ç±»åŸºæœ¬æ–¹æ³•çš„å°è£…ï¼Œå„ç§èµ„æºç±»å‹éƒ½ä¼šç»Ÿä¸€å»è°ƒç”¨ã€‚è€Œæ›´ä¸Šå±‚åˆ™æ˜¯å¯¹ `storagebackend` çš„ç»Ÿä¸€å°è£…ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ `etcd` å®¢æˆ·ç«¯çš„å®ç°å®Œæˆæƒ³å¯¹åº”çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†å¤šå±•å¼€äº†ã€‚

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `etcd` ä»¥åŠå®ƒåœ¨ K8S ä¸­çš„ä½œç”¨ä»¥åŠå¦‚ä½•ä½¿ç”¨ã€‚æˆ‘ä»¬è¿˜ä»‹ç»äº†å¦‚ä½•é€šè¿‡ `etcdctl` å·¥å…·å»æ“ä½œ `etcd`ã€‚

åœ¨æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œä¹Ÿè®¸ä½ éœ€è¦é€šè¿‡ç›´æ¥æ“ä½œ `etcd` é›†ç¾¤å»å˜æ›´æ•°æ®ï¼Œè¿™é‡Œæ²¡æœ‰ä»‹ç»æ‰€æœ‰çš„æ“ä½œå‘½ä»¤ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œé€šè¿‡ä¸‹æ–¹çš„é“¾æ¥çœ‹å®˜æ–¹æ–‡æ¡£è¿›è¡Œå­¦ä¹ ã€‚

ä½†é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ç›´æ¥æ“ä½œ `etcd` ï¼Œé™¤éä½ å·²ç»æ˜ç¡®è‡ªå·±åœ¨åšä»€ä¹ˆã€‚

å¦å¤–ï¼Œç”±äº `etcd` é›†ç¾¤ä½¿ç”¨ `Raft` ä¸€è‡´æ€§ç®—æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹ `etcd` é›†ç¾¤éœ€è¦éƒ¨ç½²å¥‡æ•°ä¸ªèŠ‚ç‚¹ï¼Œå¦‚ 3ï¼Œ5ï¼Œ7 ç­‰ã€‚`etcd` é›†ç¾¤ç»´æŠ¤ä¹Ÿç›¸å¯¹å®¹æ˜“ï¼Œå¾ˆå®¹æ˜“å¯ä»¥åšæˆé«˜å¯ç”¨é›†ç¾¤ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯ä¿éšœ K8S é›†ç¾¤é«˜å¯ç”¨çš„é‡è¦ä¸€ç¯ï¼‰

å­¦ä¹ äº† `etcd` ä¹‹åï¼Œä¸‹èŠ‚æˆ‘ä»¬æ¥å­¦ä¹ åŒæ ·å¾ˆé‡è¦çš„ä¸€ä¸ªç»„ä»¶ `Controller Manager`ï¼Œå­¦ä¹ å®ƒæ˜¯å¦‚ä½•ä¿éšœèŠ‚ç¾¤ç¬¦åˆé¢„æœŸçŠ¶æ€çš„ã€‚

## å‚è€ƒé“¾æ¥

- [What is etcd](https://etcd.readthedocs.io/en/latest/faq.html#what-is-etcd)

# åº–ä¸è§£ç‰›ï¼šcontroller-manager

## æ•´ä½“æ¦‚è§ˆ

```
+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +------->|        API Server       |<--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
```

åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°äº† `Controller Manager` çš„å­˜åœ¨ï¼ŒçŸ¥é“äº† Master æ˜¯ K8S æ˜¯é›†ç¾¤çš„å¤§è„‘ï¼Œè€Œå®ƒåˆ™æ˜¯ Master ä¸­æœ€ç¹å¿™çš„éƒ¨åˆ†ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿæœ¬èŠ‚æˆ‘ä»¬ä¸€åŒæ¥çœ‹çœ‹å®ƒä¸ºä½•å¦‚æ­¤ç¹å¿™ã€‚

**æ³¨æ„ï¼š`Controller Manager` å®é™…ç”± `kube-controller-manager` å’Œ `cloud-controller-manager` ä¸¤éƒ¨åˆ†ç»„æˆï¼Œ`cloud-controller-manager` åˆ™æ˜¯ä¸ºå„å®¶äº‘å‚å•†æä¾›äº†ä¸€ä¸ªæŠ½è±¡çš„å°è£…ï¼Œä¾¿äºè®©å„å‚å•†ä½¿ç”¨å„è‡ªçš„ `provide`ã€‚æœ¬æ–‡åªè®¨è®º `kube-controller-manager`ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œä¸‹æ–‡ç»Ÿä¸€ä½¿ç”¨ `kube-controller-manager`ã€‚**

## `kube-controller-manager` æ˜¯ä»€ä¹ˆ

ä¸€å¥è¯æ¥è®² `kube-controller-manager` æ˜¯ä¸€ä¸ªåµŒå…¥äº† K8S æ ¸å¿ƒæ§åˆ¶å¾ªç¯çš„å®ˆæŠ¤è¿›ç¨‹ã€‚

è¿™é‡Œçš„é‡ç‚¹æ˜¯

- åµŒå…¥ï¼šå®ƒå·²ç»å†…ç½®äº†ç›¸å…³é€»è¾‘ï¼Œå¯ç‹¬ç«‹è¿›è¡Œéƒ¨ç½²ã€‚æˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚ä¸‹è½½ K8S æœåŠ¡ç«¯äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹åï¼Œä¾¿å¯ä»¥çœ‹åˆ° `kube-controller-manager` çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ `kubeadm` è¿›è¡Œçš„éƒ¨ç½²ï¼Œå®ƒä¼šé»˜è®¤ä½¿ç”¨ `k8s.gcr.io/kube-controller-manager` çš„é•œåƒã€‚æˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸‹å®é™…æƒ…å†µï¼š

```
master $ kubectl -n kube-system describe pods -l component=kube-controller-manager
Name:               kube-controller-manager-master
Namespace:          kube-system
Priority:           2000000000
PriorityClassName:  system-cluster-critical
Node:               master/172.17.0.35
Start Time:         Mon, 10 Dec 2018 07:14:21 +0000
Labels:             component=kube-controller-manager
                    tier=control-plane
Annotations:        kubernetes.io/config.hash=c7ed7a8fa5c430410e84970f8ee7e067
                    kubernetes.io/config.mirror=c7ed7a8fa5c430410e84970f8ee7e067
                    kubernetes.io/config.seen=2018-12-10T07:14:21.685626322Z
                    kubernetes.io/config.source=file
                    scheduler.alpha.kubernetes.io/critical-pod=
Status:             Running
IP:                 172.17.0.35
Containers:
  kube-controller-manager:
    Container ID:  docker://0653e71ae4287608726490b724c3d064d5f1556dd89b7d3c618e97f0e7f2a533
    Image:         k8s.gcr.io/kube-controller-manager-amd64:v1.11.3
    Image ID:      docker-pullable://k8s.gcr.io/kube-controller-manager-amd64@sha256:a6d115bb1c0116036ac6e6e4d504665bc48879c421a450566c38b3b726f0a123
    Port:          <none>
    Host Port:     <none>
    Command:
      kube-controller-manager
      --address=127.0.0.1
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
      --cluster-signing-key-file=/etc/kubernetes/pki/ca.key
      --controllers=*,bootstrapsigner,tokencleaner
      --kubeconfig=/etc/kubernetes/controller-manager.conf
      --leader-elect=true
      --root-ca-file=/etc/kubernetes/pki/ca.crt
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key
      --use-service-account-credentials=true
    State:          Running
      Started:      Mon, 10 Dec 2018 07:14:24 +0000
    Ready:          True
    Restart Count:  0
    Requests:
      cpu:        200m
    Liveness:     http-get http://127.0.0.1:10252/healthz delay=15s timeout=15s period=10s #success=1 #failure=8
    Environment:  <none>
    Mounts:
      /etc/ca-certificates from etc-ca-certificates (ro)
      /etc/kubernetes/controller-manager.conf from kubeconfig (ro)
      /etc/kubernetes/pki from k8s-certs (ro)
      /etc/ssl/certs from ca-certs (ro)
      /usr/libexec/kubernetes/kubelet-plugins/volume/exec from flexvolume-dir (rw)
      /usr/local/share/ca-certificates from usr-local-share-ca-certificates (ro)
      /usr/share/ca-certificates from usr-share-ca-certificates (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  usr-share-ca-certificates:
    Type:          HostPath (bare host directory volume)
    Path:          /usr/share/ca-certificates
    HostPathType:  DirectoryOrCreate
  usr-local-share-ca-certificates:
    Type:          HostPath (bare host directory volume)
    Path:          /usr/local/share/ca-certificates
    HostPathType:  DirectoryOrCreate
  etc-ca-certificates:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/ca-certificates
    HostPathType:  DirectoryOrCreate
  k8s-certs:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/kubernetes/pki
    HostPathType:  DirectoryOrCreate
  ca-certs:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/ssl/certs
    HostPathType:  DirectoryOrCreate
  kubeconfig:
    Type:          HostPath (bare host directory volume)
    Path:          /etc/kubernetes/controller-manager.conf
    HostPathType:  FileOrCreate
  flexvolume-dir:
    Type:          HostPath (bare host directory volume)
    Path:          /usr/libexec/kubernetes/kubelet-plugins/volume/exec
    HostPathType:  DirectoryOrCreate
QoS Class:         Burstable
Node-Selectors:    <none>
Tolerations:       :NoExecute
Events:            <none>
master
```

è¿™æ˜¯ä½¿ç”¨ `kubeadm` æ­å»ºçš„é›†ç¾¤ä¸­çš„ `kube-controller-manager` çš„ `Pod`ï¼Œé¦–å…ˆå¯ä»¥çœ‹åˆ°å®ƒæ‰€ä½¿ç”¨çš„é•œåƒï¼Œå…¶æ¬¡å¯ä»¥çœ‹åˆ°å®ƒä½¿ç”¨çš„ä¸€ç³»åˆ—å‚æ•°ï¼Œæœ€åå®ƒåœ¨ `10252` ç«¯å£æä¾›äº†å¥åº·æ£€æŸ¥çš„æ¥å£ã€‚ç¨åæˆ‘ä»¬å†å±•å¼€ã€‚

- æ§åˆ¶å¾ªç¯ï¼šè¿™é‡Œæ‹†è§£ä¸ºä¸¤éƒ¨åˆ†ï¼š **æ§åˆ¶** å’Œ **å¾ªç¯** ï¼Œå®ƒæ‰€æ§åˆ¶çš„æ˜¯é›†ç¾¤çš„çŠ¶æ€ï¼›è‡³äºå¾ªç¯å®ƒå½“ç„¶æ˜¯ä¼šæœ‰ä¸ªå¾ªç¯é—´éš”çš„ï¼Œè¿™é‡Œæœ‰ä¸ªå‚æ•°å¯ä»¥è¿›è¡Œæ§åˆ¶ã€‚
- å®ˆæŠ¤è¿›ç¨‹ï¼šè¿™ä¸ªå°±ä¸å•ç‹¬å±•å¼€äº†ã€‚

## `kube-controller-manager` æœ‰ä»€ä¹ˆä½œç”¨

å‰é¢å·²ç»è¯´äº†å®ƒä¸€ä¸ªå¾ˆå…³é”®çš„ç‚¹ â€œæ§åˆ¶â€ï¼šå®ƒé€šè¿‡ `kube-apiserver` æä¾›çš„ä¿¡æ¯æŒç»­çš„ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Œå¹¶å°è¯•å°†é›†ç¾¤è°ƒæ•´è‡³é¢„æœŸçš„çŠ¶æ€ã€‚ç”±äºè®¿é—® `kube-apiserver` ä¹Ÿéœ€è¦é€šè¿‡è®¤è¯ï¼Œæˆæƒç­‰è¿‡ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°ä¸Šé¢å¯åŠ¨ `kube-controller-manager` æ—¶æä¾›äº†ä¸€ç³»åˆ—çš„å‚æ•°ã€‚

æ¯”å¦‚ï¼Œå½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `Deployment`ï¼Œé»˜è®¤å‰¯æœ¬æ•°ä¸º 1 ï¼Œå½“æˆ‘ä»¬æŠŠ `Pod` åˆ é™¤åï¼Œ`kube-controller-manager` ä¼šæŒ‰ç…§åŸå…ˆçš„é¢„æœŸï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ª `Pod` ã€‚ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š

```
master $ kubectl run redis --image='redis'
deployment.apps/redis created
master $ kubectl get all
NAME                        READY     STATUS    RESTARTS   AGE
pod/redis-bb7894d65-w2rsp   1/1       Running   0          3m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   18m

NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/redis   1         1         1            1           3m

NAME                              DESIRED   CURRENT   READY     AGE
replicaset.apps/redis-bb7894d65   1         1         1         3m
master $ kubectl delete pod/redis-bb7894d65-w2rsp
pod "redis-bb7894d65-w2rsp" deleted
master $ kubectl get all  # å¯ä»¥çœ‹åˆ°å·²ç»é‡æ–°è¿è¡Œäº†ä¸€ä¸ª Pod
NAME                        READY     STATUS    RESTARTS   AGE
pod/redis-bb7894d65-62ftk   1/1       Running   0          16s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   19m

NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/redis   1         1         1            1           4m

NAME                              DESIRED   CURRENT   READY     AGE
replicaset.apps/redis-bb7894d65   1         1         1         4m
```

æˆ‘ä»¬æ¥çœ‹ä¸‹ `kube-controller-manager` çš„æ—¥å¿—ï¼š

```
master $ kubectl -n kube-system logs -l component=kube-controller-manager --tail=5
I1210 09:30:17.125377       1 node_lifecycle_controller.go:945] Controller detected that all Nodes are not-Ready. Entering master disruption mode.
I1210 09:31:07.140539       1 node_lifecycle_controller.go:972] Controller detected that some Nodes are Ready. Exiting master disruption mode.
I1210 09:43:30.377649       1 event.go:221] Event(v1.ObjectReference{Kind:"Deployment", Namespace:"default", Name:"redis", UID:"0d1cb2d7-fc60-11e8-a361-0242ac110074", APIVersion:"apps/v1", ResourceVersion:"1494", FieldPath:""}): type: 'Normal' reason: 'ScalingReplicaSet' Scaled up replica setredis-bb7894d65 to 1
I1210 09:43:30.835149       1 event.go:221] Event(v1.ObjectReference{Kind:"ReplicaSet", Namespace:"default", Name:"redis-bb7894d65", UID:"0d344d15-fc60-11e8-a361-0242ac110074", APIVersion:"apps/v1", ResourceVersion:"1495", FieldPath:""}): type: 'Normal' reason: 'SuccessfulCreate' Created pod:redis-bb7894d65-w2rsp
I1210 09:47:41.658781       1 event.go:221] Event(v1.ObjectReference{Kind:"ReplicaSet", Namespace:"default", Name:"redis-bb7894d65", UID:"0d344d15-fc60-11e8-a361-0242ac110074", APIVersion:"apps/v1", ResourceVersion:"1558", FieldPath:""}): type: 'Normal' reason: 'SuccessfulCreate' Created pod:redis-bb7894d65-62ftk
```

å¯ä»¥çœ‹åˆ°å®ƒå…ˆè§‚å¯Ÿåˆ°æœ‰ `Deployment` çš„äº‹ä»¶ï¼Œç„¶å `ScalingReplicaSet` è¿›è€Œåˆ›å»ºäº†å¯¹åº”çš„ `Pod`ã€‚ è€Œå½“æˆ‘ä»¬åˆ æ‰æ­£åœ¨è¿è¡Œçš„ `Pod` åï¼Œå®ƒä¾¿ä¼šé‡æ–°åˆ›å»º `Pod` ä½¿é›†ç¾¤çŠ¶æ€ç¬¦åˆåŸå…ˆçš„é¢„æœŸçŠ¶æ€ã€‚

åŒæ—¶ï¼Œæ³¨æ„ `Pod` çš„åå­—å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚

## `kube-controller-manager` æ˜¯å¦‚ä½•å·¥ä½œçš„

åœ¨ `cmd/kube-controller-manager/app/controllermanager.go` ä¸­åˆ—å‡ºäº†å¤§å¤šæ•°çš„ `controllermanager`ï¼Œä»–ä»¬å¯¹ `controllermanager` å‡½æ•°çš„å®é™…è°ƒç”¨éƒ½åœ¨ `cmd/kube-controller-manager/app/core.go` ä¸­ï¼Œæˆ‘ä»¬ä»¥ `PodGC` ä¸ºä¾‹ï¼š

```
func startPodGCController(ctx ControllerContext) (bool, error) {
	go podgc.NewPodGC(
		ctx.ClientBuilder.ClientOrDie("pod-garbage-collector"),
		ctx.InformerFactory.Core().V1().Pods(),
		int(ctx.ComponentConfig.PodGCController.TerminatedPodGCThreshold),
	).Run(ctx.Stop)
	return true, nil
}
```

åœ¨å‰ä¸¤èŠ‚ä¸­æˆ‘ä»¬å·²ç»å¯¹ `kube-apiserver` å’Œ `etcd` æœ‰äº†ä¸€äº›åŸºæœ¬çš„è®¤è¯†ï¼Œè¿™é‡Œå®ƒä¸»è¦ä¼šå» watch ç›¸å…³çš„èµ„æºï¼Œä½†æ˜¯å‡ºäºæ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œä¹Ÿä¸èƒ½è¿‡äºé¢‘ç¹çš„å»è¯·æ±‚ `kube-apiserver` æˆ–è€…æ°¸ä¹… watch ï¼Œæ‰€ä»¥åœ¨å®ç°ä¸Šå€ŸåŠ©äº† [client-go](https://github.com/kubernetes/client-go) çš„ `informer` åŒ…ï¼Œç›¸å½“äºæ˜¯å®ç°äº†ä¸€ä¸ªæœ¬åœ°çš„äºŒçº§ç¼“å­˜ã€‚è¿™é‡Œä¸åšè¿‡å¤šå±•å¼€ã€‚

å®ƒæœ€ç»ˆä¼šè°ƒç”¨ `PodGC` çš„å…·ä½“å®ç°ï¼Œä½ç½®åœ¨ `pkg/controller/podgc/gc_controller.go` ä¸­ï¼š

```
func NewPodGC(kubeClient clientset.Interface, podInformer coreinformers.PodInformer, terminatedPodThreshold int) *PodGCController {
	if kubeClient != nil && kubeClient.CoreV1().RESTClient().GetRateLimiter() != nil {
		metrics.RegisterMetricAndTrackRateLimiterUsage("gc_controller", kubeClient.CoreV1().RESTClient().GetRateLimiter())
	}
	gcc := &PodGCController{
		kubeClient:             kubeClient,
		terminatedPodThreshold: terminatedPodThreshold,
		deletePod: func(namespace, name string) error {
			glog.Infof("PodGC is force deleting Pod: %v:%v", namespace, name)
			return kubeClient.CoreV1().Pods(namespace).Delete(name, metav1.NewDeleteOptions(0))
		},
	}

	gcc.podLister = podInformer.Lister()
	gcc.podListerSynced = podInformer.Informer().HasSynced

	return gcc
}
```

ä»£ç ä¹Ÿæ¯”è¾ƒç›´è§‚ï¼Œä¸è¿‡è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæ³¨å†Œ `metrics` çš„è¿‡ç¨‹ï¼Œå®é™…ä¸Š `kube-controller-manager` åœ¨å‰é¢çš„ `10252` ç«¯å£ä¸Šä¸ä»…æš´éœ²å‡ºæ¥äº†ä¸€ä¸ª `/healthz` æ¥å£ï¼Œè¿˜æš´éœ²å‡ºäº†ä¸€ä¸ª `/metrics` çš„æ¥å£ï¼Œå¯ç”¨äºè¿›è¡Œç›‘æ§ä¹‹ç±»çš„ã€‚

```
master $ kubectl -n kube-system get pod -l component=kube-controller-manager
NAME                             READY     STATUS    RESTARTS   AGE
kube-controller-manager-master   1/1       Running   1          2m
master $ kubectl -n kube-system exec -it kube-controller-manager-master sh
/ # wget -qO- http://127.0.0.1:10252/metrics|grep gc_controller
# HELP gc_controller_rate_limiter_use A metric measuring the saturation of the rate limiter for gc_controller
# TYPE gc_controller_rate_limiter_use gauge
gc_controller_rate_limiter_use 0
```

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `kube-controller-manager` ä»¥åŠå®ƒåœ¨ K8S ä¸­ä¸»è¦æ˜¯å°†é›†ç¾¤è°ƒèŠ‚è‡³é¢„æœŸçš„çŠ¶æ€ï¼Œå¹¶æä¾›å‡ºäº† `/metrics` çš„æ¥å£å¯ä¾›ç›‘æ§ã€‚

`kube-controller-manager` ä¸­æœ‰å¾ˆå¤šçš„ controller å¤§å¤šæ•°æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå½“ç„¶ä¹Ÿæœ‰é»˜è®¤å…³é—­çš„ï¼Œæ¯”å¦‚ `bootstrapsigner` å’Œ `tokencleaner`ï¼Œåœ¨æˆ‘ä»¬å¯åŠ¨ `kube-controller-manager` çš„æ—¶å€™ï¼Œå¯é€šè¿‡ `--controllers` çš„å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œå°±æ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ `--controllers=*,bootstrapsigner,tokencleaner` è¡¨ç¤ºå¼€å¯æ‰€æœ‰é»˜è®¤å¼€å¯çš„ä»¥åŠ `bootstrapsigner` å’Œ `tokencleaner` ã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦ä¸€ä¸ªä¸èµ„æºè°ƒåº¦æœ‰å…³çš„ç»„ä»¶ `kube-scheduler`ï¼Œäº†è§£ä¸‹å®ƒå¯¹æˆ‘ä»¬ä½¿ç”¨é›†ç¾¤æ‰€å¸¦æ¥çš„æ„ä¹‰ã€‚

ç•™è¨€

- [æ¥Šæ­Œ](https://juejin.im/user/5937807c2f301e006b268c6c)

  Controller Managerä½œä¸ºé›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œè´Ÿè´£é›†ç¾¤å†…çš„Nodeã€Podå‰¯æœ¬ã€æœåŠ¡ç«¯ç‚¹ï¼ˆEndpointï¼‰ã€å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ã€æœåŠ¡è´¦å·ï¼ˆServiceAccountï¼‰ã€èµ„æºå®šé¢ï¼ˆResourceQuotaï¼‰çš„ç®¡ç†ï¼Œå½“æŸä¸ªNodeæ„å¤–å®•æœºæ—¶ï¼ŒController Managerä¼šåŠæ—¶å‘ç°å¹¶æ‰§è¡Œè‡ªåŠ¨åŒ–ä¿®å¤æµç¨‹ï¼Œç¡®ä¿é›†ç¾¤å§‹ç»ˆå¤„äºé¢„æœŸçš„å·¥ä½œçŠ¶æ€ã€‚

# åº–ä¸è§£ç‰›ï¼škube-scheduler

## æ•´ä½“æ¦‚è§ˆ

```
+----------------------------------------------------------+          
| Master                                                   |          
|              +-------------------------+                 |          
|     +------->|        API Server       |<--------+       |          
|     |        |                         |         |       |          
|     v        +-------------------------+         v       |          
|   +----------------+     ^      +--------------------+   |          
|   |                |     |      |                    |   |          
|   |   Scheduler    |     |      | Controller Manager |   |          
|   |                |     |      |                    |   |          
|   +----------------+     v      +--------------------+   |          
| +------------------------------------------------------+ |          
| |                                                      | |          
| |                Cluster state store                   | |          
| |                                                      | |          
| +------------------------------------------------------+ |          
+----------------------------------------------------------+          
```

åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°äº† `Scheduler` çš„å­˜åœ¨ï¼ŒçŸ¥é“äº† Master æ˜¯ K8S æ˜¯é›†ç¾¤çš„å¤§è„‘ï¼Œ`Controller Manager` è´Ÿè´£å°†é›†ç¾¤è°ƒæ•´è‡³é¢„æœŸçš„çŠ¶æ€ï¼Œè€Œ `Scheduler` åˆ™æ˜¯é›†ç¾¤è°ƒåº¦å™¨ï¼Œå°†é¢„æœŸçš„ `Pod` èµ„æºè°ƒåº¦åˆ°æ­£ç¡®çš„ `Node` èŠ‚ç‚¹ä¸Šï¼Œè¿›è€Œä»¤è¯¥ `Pod` å¯å®Œæˆå¯åŠ¨ã€‚æœ¬èŠ‚æˆ‘ä»¬ä¸€åŒæ¥çœ‹çœ‹å®ƒå¦‚ä½•å‘æŒ¥å¦‚æ­¤å¤§çš„ä½œç”¨ã€‚

**ä¸‹æ–‡ç»Ÿä¸€ä½¿ç”¨ `kube-scheduler` è¿›è¡Œè¡¨è¿°**

## `kube-scheduler` æ˜¯ä»€ä¹ˆ

å¼•ç”¨[å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/)ä¸€å¥è¯ï¼š

> The Kubernetes scheduler is a policy-rich, topology-aware, workload-specific function that significantly impacts availability, performance, and capacity.

`kube-scheduler` æ˜¯ä¸€ä¸ªç­–ç•¥ä¸°å¯Œï¼Œæ‹“æ‰‘æ„ŸçŸ¥çš„è°ƒåº¦ç¨‹åºï¼Œä¼šæ˜¾è‘—å½±å“å¯ç”¨æ€§ï¼Œæ€§èƒ½å’Œå®¹é‡ã€‚

æˆ‘ä»¬çŸ¥é“èµ„æºè°ƒåº¦æœ¬å°±æ˜¯ K8S è¿™ç±»ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¾ˆå¤æ‚çš„äº‹æƒ…ï¼Œæ—¢è¦èƒ½æ»¡è¶³ç³»ç»Ÿå¯¹èµ„æºåˆ©ç”¨ç‡çš„éœ€è¦ï¼ŒåŒæ ·è¿˜éœ€è¦é¿å…èµ„æºç«äº‰ï¼Œæ¯”å¦‚è¯´ç«¯å£å†²çªä¹‹ç±»çš„ã€‚

ä¸ºäº†èƒ½å®Œæˆè¿™æ ·çš„éœ€æ±‚ï¼Œ`kube-scheduler` ä¾¿åœ¨ä¸æ–­çš„è¿­ä»£å’Œå‘å±•ï¼Œé€šè¿‡æ”¯æŒå¤šç§ç­–ç•¥æ»¡è¶³å„ç±»éœ€æ±‚ï¼Œé€šè¿‡æ„ŸçŸ¥æ‹“æ‰‘é¿å…èµ„æºç«äº‰å’Œä¿éšœç³»ç»Ÿçš„å¯ç”¨æ€§åŠå®¹é‡ç­‰ã€‚

æˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚ä¸‹è½½æœåŠ¡ç«¯äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹åï¼Œä¾¿å¯çœ‹åˆ° `kube-scheduler` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å½“ç»™å®ƒä¼ é€’ `--help` æŸ¥çœ‹å…¶æ”¯æŒå‚æ•°çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥çœ‹åˆ°å®ƒæ”¯æŒä½¿ç”¨ `--address` æˆ–è€… `--bind-address` ç­‰å‚æ•°æŒ‡å®šæ‰€å¯åŠ¨çš„ HTTP server æ‰€ç»‘å®šçš„åœ°å€ä¹‹ç±»çš„ã€‚

å®ƒå’Œ `kube-controller-manager` æœ‰ç‚¹ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯é€šè¿‡å®šæ—¶çš„å‘ `kube-apiserver` è¯·æ±‚è·å–ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚è€Œä»–ä»¬æ‰€èµ·åˆ°çš„ä½œç”¨å¹¶ä¸ç›¸åŒã€‚

## `kube-scheduler` æœ‰ä»€ä¹ˆä½œç”¨

ä»ä¸Šå±‚çš„è§’åº¦æ¥çœ‹ï¼Œ`kube-scheduler` çš„ä½œç”¨å°±æ˜¯å°†å¾…è°ƒåº¦çš„ `Pod` è°ƒåº¦è‡³æœ€ä½³çš„ `Node` ä¸Šï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¸­åˆ™éœ€è¦æ ¹æ®ä¸åŒçš„ç­–ç•¥ï¼Œè€ƒè™‘åˆ° `Node` çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚ç«¯å£ï¼Œå†…å­˜ï¼Œå­˜å‚¨ç­‰ã€‚

## `kube-scheduler` æ˜¯å¦‚ä½•å·¥ä½œçš„

æ•´ä½“çš„è¿‡ç¨‹å¯é€šè¿‡ `pkg/scheduler/core/generic_scheduler.go` çš„ä»£ç æ¥çœ‹

```
func (g *genericScheduler) Schedule(pod *v1.Pod, nodeLister algorithm.NodeLister) (string, error) {
	trace := utiltrace.New(fmt.Sprintf("Scheduling %s/%s", pod.Namespace, pod.Name))
	defer trace.LogIfLong(100 * time.Millisecond)

	if err := podPassesBasicChecks(pod, g.pvcLister); err != nil {
		return "", err
	}

	nodes, err := nodeLister.List()
	if err != nil {
		return "", err
	}
	if len(nodes) == 0 {
		return "", ErrNoNodesAvailable
	}

	err = g.cache.UpdateNodeNameToInfoMap(g.cachedNodeInfoMap)
	if err != nil {
		return "", err
	}

	trace.Step("Computing predicates")
	startPredicateEvalTime := time.Now()
	filteredNodes, failedPredicateMap, err := g.findNodesThatFit(pod, nodes)
	if err != nil {
		return "", err
	}

	if len(filteredNodes) == 0 {
		return "", &FitError{
			Pod:              pod,
			NumAllNodes:      len(nodes),
			FailedPredicates: failedPredicateMap,
		}
	}
	metrics.SchedulingAlgorithmPredicateEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPredicateEvalTime))
	metrics.SchedulingLatency.WithLabelValues(metrics.PredicateEvaluation).Observe(metrics.SinceInSeconds(startPredicateEvalTime))

	trace.Step("Prioritizing")
	startPriorityEvalTime := time.Now()
	// When only one node after predicate, just use it.
	if len(filteredNodes) == 1 {
		metrics.SchedulingAlgorithmPriorityEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPriorityEvalTime))
		return filteredNodes[0].Name, nil
	}

	metaPrioritiesInterface := g.priorityMetaProducer(pod, g.cachedNodeInfoMap)
	priorityList, err := PrioritizeNodes(pod, g.cachedNodeInfoMap, metaPrioritiesInterface, g.prioritizers, filteredNodes, g.extenders)
	if err != nil {
		return "", err
	}
	metrics.SchedulingAlgorithmPriorityEvaluationDuration.Observe(metrics.SinceInMicroseconds(startPriorityEvalTime))
	metrics.SchedulingLatency.WithLabelValues(metrics.PriorityEvaluation).Observe(metrics.SinceInSeconds(startPriorityEvalTime))

	trace.Step("Selecting host")
	return g.selectHost(priorityList)
}
```

å®ƒçš„è¾“å…¥æœ‰ä¸¤ä¸ªï¼š

- `pod`ï¼šå¾…è°ƒåº¦çš„ `Pod` å¯¹è±¡ï¼›
- `nodeLister`ï¼šæ‰€æœ‰å¯ç”¨çš„ `Node` åˆ—è¡¨

å¤‡æ³¨ï¼š`nodeLister` çš„å®ç°ç¨å¾®ç”¨äº†ç‚¹æŠ€å·§ï¼Œè¿”å›çš„æ˜¯ `[]*v1.Node` è€Œä¸æ˜¯ `v1.NodeList` å¯é¿å…æ‹·è´å¸¦æ¥çš„æ€§èƒ½æŸå¤±ã€‚

```
type NodeLister interface {
	List() ([]*v1.Node, error)
}
```

### å¤„ç†é˜¶æ®µ

`kube-scheduler` å°†å¤„ç†é˜¶æ®µä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ `Computing predicates`ï¼Œ`Prioritizing`å’Œ `Selecting host`ï¼š

- `Computing predicates`ï¼šä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯ `Pod` èƒ½å¦è°ƒåº¦åˆ°é›†ç¾¤çš„ `Node` ä¸Šï¼›

  ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªåä¸º `podFitsOnNode` çš„å‡½æ•°è¿›è¡Œå®ç°ï¼Œåœ¨æ£€æŸ¥çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šå…ˆå»æ£€æŸ¥ä¸‹æ˜¯å¦å·²ç»æœ‰å·²ç¼“å­˜çš„åˆ¤æ–­ç»“æœï¼Œ å½“ç„¶ä¹Ÿä¼šæ£€æŸ¥ `Pod` æ˜¯å¦æ˜¯å¯è°ƒåº¦çš„ï¼Œä»¥é˜²æœ‰ `Pod Affinity` (äº²åˆæ€§) ä¹‹ç±»çš„å­˜åœ¨ã€‚

- `Prioritizing`ï¼šä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯åœ¨ä¸Šä¸ªé˜¶æ®µé€šè¿‡ `findNodesThatFit` å¾—åˆ°äº† `filteredNodes` çš„åŸºç¡€ä¹‹ä¸Šè§£å†³å“ªäº› `Node` æ˜¯æœ€ä¼˜çš„ï¼Œå¾—åˆ°ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ `priorityList`;

  è‡³äºä¼˜å…ˆçº§çš„éƒ¨åˆ†ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼š

  ```
  for i := range nodes {
  	result = append(result, schedulerapi.HostPriority{Host: nodes[i].Name, Score: 0})
  	for j := range priorityConfigs {
  		result[i].Score += results[j][i].Score * priorityConfigs[j].Weight
  	}
  }
  ```

  ç»™æ¯ä¸ªç»è¿‡ç¬¬ä¸€æ­¥ç­›é€‰å‡ºæ¥çš„ `Node` ä¸€ä¸ª `Score`ï¼Œå†æŒ‰ç…§å„ç§æ¡ä»¶è¿›è¡Œæ‰“åˆ†ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ã€‚

- `Selecting host`ï¼šåˆ™æ˜¯æœ€ç»ˆé€‰æ‹© `Node` è°ƒåº¦åˆ°å“ªå°æœºå™¨ä¸Šã€‚

  æœ€åï¼Œåˆ™æ˜¯é€šè¿‡ `selectHost` é€‰æ‹©å‡ºæœ€ç»ˆè¦è°ƒåº¦åˆ°å“ªå°æœºå™¨ä¸Šã€‚

  ```
  func (g *genericScheduler) selectHost(priorityList schedulerapi.HostPriorityList) (string, error) {
      if len(priorityList) == 0 {
          return "", fmt.Errorf("empty priorityList")
      }
  
      sort.Sort(sort.Reverse(priorityList))
      maxScore := priorityList[0].Score
      firstAfterMaxScore := sort.Search(len(priorityList), func(i int) bool { return priorityList[i].Score < maxScore })
  
      g.lastNodeIndexLock.Lock()
      ix := int(g.lastNodeIndex % uint64(firstAfterMaxScore))
      g.lastNodeIndex++
      g.lastNodeIndexLock.Unlock()
  
      return priorityList[ix].Host, nil
  }
  ```

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `kube-scheduler` ä»¥åŠå®ƒåœ¨è°ƒåº¦ `Pod` çš„è¿‡ç¨‹ä¸­çš„å¤§è‡´æ­¥éª¤ã€‚

ä¸è¿‡å®ƒå®é™…ä½¿ç”¨çš„å„ç§ç­–ç•¥åŠåˆ¤æ–­æ¡ä»¶å¾ˆå¤šï¼Œæ— æ³•åœ¨ä¸€èŠ‚ä¸­å®Œå…¨éƒ½è¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æŒ‰ç…§æœ¬èŠ‚ä¸­æä¾›çš„æ€è·¯å¤§è‡´å»çœ‹çœ‹å®ƒçš„å®ç°ã€‚

æˆ‘ä»¬é€šè¿‡å‰é¢å‡ èŠ‚çš„ä»‹ç»ï¼Œå·²ç»çŸ¥é“äº†å½“å®é™…è¿›è¡Œéƒ¨ç½²æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šé€šè¿‡ `kubectl` ä¹‹ç±»çš„å®¢æˆ·ç«¯å·¥å…·ä¸ `kube-apiserver` è¿›è¡Œäº¤äº’ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†åï¼Œæ•°æ®å°†æŒä¹…åŒ–åˆ° `etcd` ä¸­ï¼›

æ­¤æ—¶ï¼Œ`kube-controller-manager` é€šè¿‡æŒç»­çš„è§‚å¯Ÿï¼Œå¼€å§‹æŒ‰ç…§æˆ‘ä»¬çš„é…ç½®ï¼Œå°†é›†ç¾¤çš„çŠ¶æ€è°ƒæ•´è‡³é¢„æœŸçŠ¶æ€ï¼›

è€Œ `kube-scheduler` ä¹Ÿåœ¨å‘æŒ¥ä½œç”¨ï¼Œå†³å®š `Pod` åº”è¯¥è°ƒåº¦è‡³å“ªä¸ªæˆ–è€…å“ªäº› `Node` ä¸Šï¼›ä¹‹ååˆ™é€šè¿‡å…¶ä»–ç»„ä»¶çš„åä½œï¼Œæœ€æ€»å°†è¯¥ `Pod` åœ¨ç›¸åº”çš„ `Node` ä¸Šéƒ¨ç½²å¯åŠ¨ã€‚

æˆ‘ä»¬åœ¨ä¸‹èŠ‚å°†è¦ä»‹ç»çš„ `kubelet` ä¾¿æ˜¯åé¢è¿™éƒ¨åˆ†â€œå®é™…éƒ¨ç½²åŠ¨ä½œâ€ç›¸å…³çš„ç»„ä»¶ä¸­å°¤ä¸ºé‡è¦çš„ä¸€ä¸ªï¼Œä¸‹èŠ‚æˆ‘ä»¬å†è¯¦ç»†ä»‹ç»å®ƒæ˜¯å¦‚ä½•å®Œæˆè¿™äº›åŠŸèƒ½çš„ã€‚

# åº–ä¸è§£ç‰›ï¼škubelet

## æ•´ä½“æ¦‚è§ˆ

```
+--------------------------------------------------------+       
| +---------------------+        +---------------------+ |       
| |      kubelet        |        |     kube-proxy      | |       
| |                     |        |                     | |       
| +---------------------+        +---------------------+ |       
| +----------------------------------------------------+ |       
| | Container Runtime (Docker)                         | |       
| | +---------------------+    +---------------------+ | |       
| | |Pod                  |    |Pod                  | | |       
| | | +-----+ +-----+     |    |+-----++-----++-----+| | |       
| | | |C1   | |C2   |     |    ||C1   ||C2   ||C3   || | |       
| | | |     | |     |     |    ||     ||     ||     || | |       
| | | +-----+ +-----+     |    |+-----++-----++-----+| | |       
| | +---------------------+    +---------------------+ | |       
| +----------------------------------------------------+ |       
+--------------------------------------------------------+  
```

åœ¨ç¬¬ 3 èŠ‚ã€Šå®è§‚è®¤è¯†ï¼šæ•´ä½“æ¶æ„ã€‹ ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“äº† K8S ä¸­ Node ç”±ä¸€äº›å¿…è¦çš„ç»„ä»¶æ„æˆï¼Œè€Œå…¶ä¸­æœ€ä¸ºæ ¸å¿ƒçš„å½“å± `kubelet` äº†ï¼Œå¦‚æœæ²¡æœ‰ `kubelet` çš„å­˜åœ¨ï¼Œé‚£æˆ‘ä»¬é¢„æœŸçš„å„ç±»èµ„æºå°±åªèƒ½å­˜åœ¨äº `Master` çš„ç›¸å…³ç»„ä»¶ä¸­äº†ï¼Œè€Œ K8S ä¹Ÿå¾ˆèƒ½åªæ˜¯ä¸€ä¸ª CRUD çš„æ™®é€šç¨‹åºäº†ã€‚æœ¬èŠ‚ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ `kubelet` åŠå®ƒæ˜¯å¦‚ä½•å®Œæˆè¿™ä¸€ç³»åˆ—ä»»åŠ¡çš„ã€‚

## `kubelet` æ˜¯ä»€ä¹ˆ

æŒ‰ç…§ä¸€èˆ¬æ¶æ„è®¾è®¡ä¸Šçš„ä¹ æƒ¯ï¼Œ`kubelet` æ‰€æ‰¿æ‹…çš„è§’è‰²ä¸€èˆ¬ä¼šè¢«å«åš `agent`ï¼Œè¿™é‡Œå«åš `kubelet` å¾ˆå¤§ç¨‹åº¦ä¸Šå— `Borg` çš„å‘½åå½±å“ï¼Œ`Borg` é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ª `Borglet` çš„ç»„ä»¶å­˜åœ¨ã€‚`kubelet` ä¾¿æ˜¯ K8S ä¸­çš„ `agent`ï¼Œè´Ÿè´£ `Node` å’Œ `Pod` ç›¸å…³çš„ç®¡ç†ä»»åŠ¡ã€‚

åŒæ ·çš„ï¼Œåœ¨æˆ‘ä»¬ä¸‹è½½ K8S äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹åï¼Œä¾¿å¯ä»¥å¾—åˆ° `kubelet` çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨ç¬¬ 5 èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå®Œæˆäº† `kubelet` ä»¥ `systemd` è¿›è¡Œå¯åŠ¨å’Œç®¡ç†çš„ç›¸å…³é…ç½®ã€‚

## `kubelet` æœ‰ä»€ä¹ˆä½œç”¨

é€šå¸¸æ¥è®² `agent` è¿™æ ·çš„è§’è‰²èµ·åˆ°çš„ä½œç”¨é¦–å…ˆä¾¿æ˜¯è¦èƒ½å¤Ÿæ³¨å†Œï¼Œè®© `server` ç«¯çŸ¥é“å®ƒçš„å­˜åœ¨ï¼Œæ‰€ä»¥è¿™ä¾¿æ˜¯å®ƒçš„ç¬¬ä¸€ä¸ªä½œç”¨ï¼šèŠ‚ç‚¹ç®¡ç†ã€‚

### èŠ‚ç‚¹ç®¡ç†

å½“æˆ‘ä»¬æ‰§è¡Œ `kubelet --help` çš„æ—¶å€™ï¼Œä¼šçœ‹åˆ°å®ƒæ‰€æ”¯æŒçš„å¯é…ç½®å‚æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª `--register-node` å‚æ•°ä¾¿æ˜¯ç”¨äºæ§åˆ¶æ˜¯å¦å‘ `kube-apiserver` æ³¨å†ŒèŠ‚ç‚¹çš„ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ã€‚

æˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚ä¸­è¿˜ä»‹ç»äº†å¦‚ä½•æ–°å¢ä¸€ä¸ª `Node`ï¼Œå½“ `kubeadm join` æ‰§è¡ŒæˆåŠŸåï¼Œä½ ä¾¿å¯ä»¥é€šè¿‡ `kubectl get node` æŸ¥çœ‹åˆ°æ–°åŠ å…¥é›†ç¾¤ä¸­çš„ `Node`ï¼Œä¸æ­¤åŒæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¯¥èŠ‚ç‚¹ä¸Šé€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ `kubelet` çš„çŠ¶æ€ã€‚

```
master $ systemctl status kubelet
â— kubelet.service - kubelet: The Kubernetes Agent
   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)
  Drop-In: /etc/systemd/system/kubelet.service.d
           â””â”€kubeadm.conf
   Active: active (running) since Thu 2018-12-13 07:49:51 UTC; 32min ago
     Docs: http://kubernetes.io/docs/
 Main PID: 3876259 (kubelet)
   Memory: 66.3M
   CGroup: /system.slice/kubelet.service
           â””â”€3876259 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernete...
```

å½“æˆ‘ä»¬æŸ¥çœ‹ `Node` ä¿¡æ¯æ—¶ï¼Œä¹Ÿèƒ½å¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
master $ kubectl get nodes node01 -o yaml
apiVersion: v1
kind: Node
metadata:
  annotations:
    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
    node.alpha.kubernetes.io/ttl: "0"
    volumes.kubernetes.io/controller-managed-attach-detach: "true"
  creationTimestamp: 2018-12-13T07:50:47Z
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/hostname: node01
  name: node01
  resourceVersion: "4242"
  selfLink: /api/v1/nodes/node01
  uid: cd612df6-feab-11e8-9a0b-0242ac110096
spec: {}
status:
  addresses:
  - address: 172.17.0.152
    type: InternalIP
  - address: node01
    type: Hostname
  allocatable:
    cpu: "4"
    ephemeral-storage: "89032026784"
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 3894788Ki
    pods: "110"
  capacity:
    cpu: "4"
    ephemeral-storage: 96605932Ki
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 3997188Ki
    pods: "110"
  conditions:
  - lastHeartbeatTime: 2018-12-13T08:39:41Z
    lastTransitionTime: 2018-12-13T07:50:47Z
    message: kubelet has sufficient disk space available
    reason: KubeletHasSufficientDisk
    status: "False"
    type: OutOfDisk
  - lastHeartbeatTime: 2018-12-13T08:39:41Z
    lastTransitionTime: 2018-12-13T07:50:47Z
    message: kubelet has sufficient memory available
    reason: KubeletHasSufficientMemory
    status: "False"
    type: MemoryPressure
  - lastHeartbeatTime: 2018-12-13T08:39:41Z
    lastTransitionTime: 2018-12-13T07:50:47Z
    message: kubelet has no disk pressure
    reason: KubeletHasNoDiskPressure
    status: "False"
    type: DiskPressure
  - lastHeartbeatTime: 2018-12-13T08:39:41Z
    lastTransitionTime: 2018-12-13T07:50:47Z
    message: kubelet has sufficient PID available
    reason: KubeletHasSufficientPID
    status: "False"
    type: PIDPressure
  - lastHeartbeatTime: 2018-12-13T08:39:41Z
    lastTransitionTime: 2018-12-13T07:51:37Z
    message: kubelet is posting ready status. AppArmor enabled
    reason: KubeletReady
    status: "True"
    type: Ready
  daemonEndpoints:
    kubeletEndpoint:
      Port: 10250
  images:
  - names:
    - k8s.gcr.io/kube-apiserver-amd64@sha256:956bea8c139620c9fc823fb81ff9b5647582b53bd33904302987d56ab24fc187
    - k8s.gcr.io/kube-apiserver-amd64:v1.11.3
    sizeBytes: 186676561
  nodeInfo:
    architecture: amd64
    bootID: 89ced22c-f7f8-4c4d-ad0d-d10887ab900e
    containerRuntimeVersion: docker://18.6.0
    kernelVersion: 4.4.0-62-generic
    kubeProxyVersion: v1.11.3
    kubeletVersion: v1.11.3
    machineID: 26ba042302eea8095d6576975c120eeb
    operatingSystem: linux
    osImage: Ubuntu 16.04.2 LTS
    systemUUID: 26ba042302eea8095d6576975c120eeb
```

å¯ä»¥çœ‹åˆ° `kubelet` ä¸ä»…å°†è‡ªå·±æ³¨å†Œç»™äº† `kube-apiserver`ï¼ŒåŒæ—¶å®ƒæ‰€åœ¨æœºå™¨çš„ä¿¡æ¯ä¹Ÿéƒ½è¿›è¡Œäº†ä¸ŠæŠ¥ï¼ŒåŒ…æ‹¬ CPUï¼Œå†…å­˜ï¼ŒIP ä¿¡æ¯ç­‰ã€‚

è¿™å…¶ä¸­æœ‰æˆ‘ä»¬åœ¨ç¬¬ 2 èŠ‚ä¸­æåˆ°çš„å…³äº `Node` çŠ¶æ€ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ï¼Œå¯ä»¥å¯¹ç…§ç€çœ‹çœ‹ã€‚

å½“ç„¶è¿™é‡Œé™¤äº†è¿™äº›ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰äº›å€¼å¾—æ³¨æ„çš„ï¼Œæ¯”å¦‚ `daemonEndpoints` ä¹‹ç±»çš„ï¼Œå¯ä»¥çœ‹åˆ°ç›®å‰ `kubelet` ç›‘å¬åœ¨äº† `10250` ç«¯å£ï¼Œè¿™ä¸ªç«¯å£å¯é€šè¿‡ `--port` é…ç½®ï¼Œä½†æ˜¯ä¹‹åä¼šè¢«åºŸå¼ƒæ‰ï¼Œæˆ‘ä»¬æ˜¯å†™å…¥äº† `/var/lib/kubelet/config.yaml` çš„é…ç½®æ–‡ä»¶ä¸­ã€‚

```
master $ cat /var/lib/kubelet/config.yaml
address: 0.0.0.0
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: cgroupfs
cgroupsPerQOS: true
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: true
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: true
enableDebuggingHandlers: true
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: true
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kind: KubeletConfiguration
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: true
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
port: 10250
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 2m0s
serializeImagePulls: true
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s
master $
```

è¿™å…¶ä¸­æœ‰ä¸€äº›éœ€è¦å…³æ³¨çš„é…ç½®ï¼š

- `maxPods`ï¼šæœ€å¤§çš„ `Pod` æ•°

- `healthzBindAddress` å’Œ `healthzPort`ï¼šé…ç½®äº†å¥åº·æ£€æŸ¥æ‰€ç›‘å¬çš„åœ°å€å’Œç«¯å£

  æˆ‘ä»¬å¯ç”¨ä»¥ä¸‹æ–¹å¼è¿›è¡ŒéªŒè¯ï¼š

  ```
  master $ curl 127.0.0.1:10248/healthz
  ok 
  ```

- `authentication` å’Œ `authorization` ï¼šè®¤è¯æˆæƒç›¸å…³

- `evictionHard`ï¼šæ¶‰åŠåˆ° `kubelet` çš„é©±é€ç­–ç•¥ï¼Œå¯¹ `Pod` è°ƒåº¦åˆ†é…ä¹‹ç±»çš„å½±å“å¾ˆå¤§

å…¶ä½™éƒ¨åˆ†ï¼Œå¯å‚è€ƒ[æ‰‹å†Œå†…å®¹](https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/)

### Pod ç®¡ç†

ä»ä¸Šé¢çš„é…ç½®ä»¥åŠæˆ‘ä»¬ä¹‹å‰çš„ä»‹ç»ä¸­ï¼Œ`kube-scheduler` å¤„ç†äº† `Pod` åº”è¯¥è°ƒåº¦è‡³å“ªä¸ª `Node`ï¼Œè€Œ `kubelet` åˆ™æ˜¯ä¿éšœè¯¥ `Pod` èƒ½æŒ‰ç…§é¢„æœŸï¼Œåœ¨å¯¹åº” `Node` ä¸Šå¯åŠ¨å¹¶ä¿æŒå·¥ä½œã€‚

åŒæ—¶ï¼Œ`kubelet` åœ¨ä¿éšœ `Pod` èƒ½æŒ‰é¢„æœŸå·¥ä½œï¼Œä¸»è¦æ˜¯åšäº†ä¸¤æ–¹é¢çš„äº‹æƒ…ï¼š

- å¥åº·æ£€æŸ¥ï¼šé€šè¿‡ `LivenessProbe` å’Œ `ReadinessProbe` æ¢é’ˆè¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦å¥åº·åŠæ˜¯å¦å·²ç»å‡†å¤‡å¥½æ¥å—è¯·æ±‚ã€‚
- èµ„æºç›‘æ§ï¼šé€šè¿‡ `cAdvisor` è¿›è¡Œèµ„æºç›‘ã€‚

## `kubelet` æ˜¯å¦‚ä½•å·¥ä½œçš„

å¤§è‡´çš„åŠŸèƒ½å·²ç»ä»‹ç»äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒå¤§ä½“çš„å®ç°ã€‚

é¦–å…ˆæ˜¯åœ¨ `cmd/kubelet/app/server.go` æ–‡ä»¶ä¸­çš„ `Run` æ–¹æ³•ï¼š

```
func Run(s *options.KubeletServer, kubeDeps *kubelet.Dependencies, stopCh <-chan struct{}) error {
	glog.Infof("Version: %+v", version.Get())
	if err := initForOS(s.KubeletFlags.WindowsService); err != nil {
		return fmt.Errorf("failed OS init: %v", err)
	}
	if err := run(s, kubeDeps, stopCh); err != nil {
		return fmt.Errorf("failed to run Kubelet: %v", err)
	}
	return nil
}
```

è¿™ä¸ªæ–¹æ³•çœ‹èµ·æ¥å¾ˆç®€å•é‚£ï¼Œå®ƒæ˜¯åœ¨è¯»å–å®Œä¸€ç³»åˆ—çš„é…ç½®å’Œæ ¡éªŒä¹‹åå¼€å§‹è¢«è°ƒç”¨çš„ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨æ—¥å¿—ä¸­è¾“å‡ºå½“å‰çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœä½ çš„ `kubelet` å·²ç»æ­£å¸¸è¿è¡Œï¼Œå½“ä½ æ‰§è¡Œ `journalctl -u kubelet` çš„æ—¶å€™ï¼Œä¾¿ä¼šçœ‹åˆ°ä¸€æ¡ç›¸å…³çš„æ—¥å¿—è¾“å‡ºã€‚

ä¹‹åï¼Œä¾¿æ˜¯ä¸€ä¸ª `run` æ–¹æ³•ï¼Œå…¶ä¸­åŒ…å«ç€å„ç§ç¯å¢ƒæ£€æŸ¥ï¼Œå®¹å™¨ç®¡ç†ï¼Œ`cAdvisor` åˆå§‹åŒ–ä¹‹ç±»çš„æ“ä½œï¼Œç›´åˆ° `kubelet` åŸºæœ¬æ­£ç¡®è¿è¡Œåï¼Œåˆ™ä¼šè°ƒç”¨ `pkg/kubelet/kubelet.go` ä¸­çš„ä¸€ä¸ª `BirthCry` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»å‘½åå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒå…¶å®å°±æ˜¯å®£å‘Š `kubelet` å·²ç»å¯åŠ¨ï¼š

```
func (kl *Kubelet) BirthCry() {
	kl.recorder.Eventf(kl.nodeRef, v1.EventTypeNormal, events.StartingKubelet, "Starting kubelet.")
}
```

åç»­åˆ™æ˜¯å…³äºæ³¨å†Œï¼Œ`Pod` ç®¡ç†ä»¥åŠèµ„æºç›¸å…³çš„å¤„ç†é€»è¾‘ï¼Œå†…å®¹è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚

## æ€»ç»“

æœ¬èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº† `kubelet` çš„ä¸»è¦åŠŸèƒ½å’ŒåŸºæœ¬å®ç°ï¼Œäº†è§£åˆ°äº†å®ƒä¸ä»…å¯å°†è‡ªèº«æ³¨å†Œåˆ°é›†ç¾¤ï¼ŒåŒæ—¶è¿˜æ‰¿æ‹…ç€ä¿éšœ `Pod` å¯åœ¨è¯¥ `Node` ä¸ŠæŒ‰é¢„æœŸå·¥ä½œã€‚å¦å¤– `kubelet` å…¶å®è¿˜æ‰¿æ‹…ç€æ¸…ç† `Node` ä¸Šä¸€äº›ç”± K8S è°ƒåº¦ `Pod` æ‰€é€ æˆçš„ç£ç›˜å ç”¨ä¹‹ç±»çš„å·¥ä½œã€‚

ä»ä¸Šé¢çš„é…ç½®ä¸­åŸºæœ¬èƒ½çœ‹å‡ºæ¥ä¸€äº›ï¼Œè¿™éƒ¨åˆ†çš„åŠŸèƒ½å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦å¤§å®¶äººä¸ºå¹²é¢„ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å†å±•å¼€äº†ã€‚

å½“ `Pod` åœ¨ `Node` ä¸Šæ­£å¸¸è¿è¡Œä¹‹åï¼Œè‹¥æ˜¯éœ€è¦å¯¹å¤–æä¾›æœåŠ¡ï¼Œåˆ™éœ€è¦å°†å…¶æš´éœ²å‡ºæ¥ã€‚ä¸‹èŠ‚ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ `kube-proxy` æ˜¯å¦‚ä½•æ¥å¤„ç†è¿™äº›å·¥ä½œçš„ã€‚

# åº–ä¸è§£ç‰›ï¼škube-proxy

## æ•´ä½“æ¦‚è§ˆ

åœ¨ç¬¬ 3 èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° `kube-proxy` çš„å­˜åœ¨ï¼Œè€Œåœ¨ç¬¬ 7 ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†å¦‚ä½•å°†è¿è¡Œäº K8S ä¸­çš„æœåŠ¡ä»¥ `Service` çš„æ–¹å¼æš´éœ²å‡ºæ¥ï¼Œä»¥ä¾›è®¿é—®ã€‚

æœ¬èŠ‚ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹ `kube-proxy` äº†è§£ä¸‹å®ƒæ˜¯å¦‚ä½•æ”¯æ’‘èµ·è¿™ç§ç±»ä¼¼æœåŠ¡å‘ç°å’Œä»£ç†ç›¸å…³åŠŸèƒ½çš„ã€‚

## `kube-proxy` æ˜¯ä»€ä¹ˆ

`kube-proxy` æ˜¯ K8S è¿è¡Œäºæ¯ä¸ª `Node` ä¸Šçš„ç½‘ç»œä»£ç†ç»„ä»¶ï¼Œæä¾›äº† TCP å’Œ UDP çš„è¿æ¥è½¬å‘æ”¯æŒã€‚

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå½“ `Pod` åœ¨åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ä¸­ï¼ŒIP å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè€Œè¿™å°±å®¹æ˜“é€ æˆå¯¹å…¶æœ‰ä¾èµ–çš„æœåŠ¡çš„å¼‚å¸¸ï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨ `Service` å°†åç«¯ `Pod` æš´éœ²å‡ºæ¥ï¼Œè€Œ `Service` åˆ™è¾ƒä¸ºç¨³å®šã€‚

è¿˜æ˜¯ä»¥æˆ‘ä»¬ä¹‹å‰çš„ [`SayThx`](https://github.com/tao12345666333/saythx) é¡¹ç›®ä¸ºä¾‹ï¼Œä½†æˆ‘ä»¬åªéƒ¨ç½²å…¶ä¸­æ²¡æœ‰ä»»ä½•ä¾èµ–çš„åç«¯èµ„æº `Redis` ã€‚

```
master $ git clone https://github.com/tao12345666333/saythx.git
Cloning into 'saythx'...
remote: Enumerating objects: 110, done.
remote: Counting objects: 100% (110/110), done.
remote: Compressing objects: 100% (82/82), done.
remote: Total 110 (delta 27), reused 102 (delta 20), pack-reused 0
Receiving objects: 100% (110/110), 119.42 KiB | 0 bytes/s, done.
Resolving deltas: 100% (27/27), done.
Checking connectivity... done.
master $ cd saythx/deploy
master $ ls
backend-deployment.yaml  frontend-deployment.yaml  namespace.yaml         redis-service.yaml
backend-service.yaml     frontend-service.yaml     redis-deployment.yaml  work-deployment.yaml
```

è¿›å…¥é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•åï¼Œå¼€å§‹åˆ›å»ºç›¸å…³èµ„æºï¼š

```
master $ kubectl apply -f namespace.yaml
namespace/work created
master $ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
master $ kubectl  apply -f redis-service.yaml
service/saythx-redis created
master $ kubectl -n work get all
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          21s

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.103.193.175   <none>        6379:31269/TCP   6s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            1           21s

NAME                                     DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-8558c7d7d   1         1         1         21s
```

å¯ä»¥çœ‹åˆ° Redis æ­£åœ¨è¿è¡Œï¼Œå¹¶é€šè¿‡ `NodePort` ç±»å‹çš„ `Service` æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬è®¿é—®æ¥ç¡®è®¤ä¸‹ã€‚

```
master $ docker run --rm -it --network host redis:alpine redis-cli -p 31269
Unable to find image 'redis:alpine' locally
alpine: Pulling from library/redis
4fe2ade4980c: Already exists
fb758dc2e038: Pull complete
989f7b0c858b: Pull complete
8dd99d530347: Pull complete
7137334fa8f0: Pull complete
30610ca64487: Pull complete
Digest: sha256:8fd83c5986f444f1a5521e3eda7395f0f21ff16d33cc3b89d19ca7c58293c5dd
Status: Downloaded newer image for redis:alpine
127.0.0.1:31269> set name kubernetes
OK
127.0.0.1:31269> get name 
"kubernetes"
```

å¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æ­£å¸¸è®¿é—®ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ `31269` è¿™ä¸ªç«¯å£çš„çŠ¶æ€ã€‚

```
master $ netstat  -ntlp |grep 31269
tcp6       0      0 :::31269                :::*                    LISTEN      2716/kube-proxy
```

å¯ä»¥çœ‹åˆ°è¯¥ç«¯å£æ˜¯ç”± `kube-proxy` æ‰€å ç”¨çš„ã€‚

æ¥ä¸‹æ¥ï¼ŒæŸ¥çœ‹å½“å‰é›†ç¾¤çš„ `Service` å’Œ `Endpoint`

```
master $ kubectl -n work get svc
NAME           TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
saythx-redis   NodePort   10.103.193.175   <none>        6379:31269/TCP   10m
master $ kubectl -n work get endpoints
NAME           ENDPOINTS        AGE
saythx-redis   10.32.0.2:6379   10m
master $ kubectl -n work get pod -o wide
NAME                           READY     STATUS    RESTARTS   AGE       IP          NODE      NOMINATED NODE
saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          12m       10.32.0.2   node01    <none>
```

å¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ° `Endpoint` å½“ä¸­çš„ä¾¿æ˜¯ `Pod` çš„ IPï¼Œç°åœ¨æˆ‘ä»¬å°†è¯¥æœåŠ¡è¿›è¡Œæ‰©å®¹ï¼ˆå®é™…æƒ…å†µä¸‹å¹¶ä¸ä¼šè¿™æ ·å¤„ç†ï¼‰ã€‚

ç›´æ¥é€šè¿‡ `kubectl scale` æ“ä½œ

```
master $ kubectl  -n work scale --replicas=2 deploy/saythx-redis
deployment.extensions/saythx-redis scaled
master $ kubectl  -n work get all
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-sslpj   1/1       Running   0          10s
pod/saythx-redis-8558c7d7d-wsn2w   1/1       Running   0          16m

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.103.193.175   <none>        6379:31269/TCP   16m

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   2         2         2            2           16m
```

æŸ¥çœ‹ `Endpoint` ä¿¡æ¯ï¼š

```
master $ kubectl -n work get endpoints
NAME           ENDPOINTS                       AGE
saythx-redis   10.32.0.2:6379,10.32.0.3:6379   17m
```

å¯ä»¥çœ‹åˆ° `Endpoint` å·²ç»è‡ªåŠ¨å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œè¿™ä¹Ÿæ„å‘³ç€ `Service` ä»£ç†çš„åç«¯èŠ‚ç‚¹å°†å¢åŠ ä¸€ä¸ªã€‚

## `kube-proxy` å¦‚ä½•å·¥ä½œ

`kube-proxy` åœ¨ Linux ç³»ç»Ÿä¸Šå½“å‰æ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œå¯é€šè¿‡ `--proxy-mode` é…ç½®ï¼š

- `userspace`ï¼šè¿™æ˜¯å¾ˆæ—©æœŸçš„ä¸€ç§æ–¹æ¡ˆï¼Œä½†æ•ˆç‡ä¸Šæ˜¾è‘—ä¸è¶³ï¼Œä¸æ¨èä½¿ç”¨ã€‚
- `iptables`ï¼šå½“å‰çš„é»˜è®¤æ¨¡å¼ã€‚æ¯” `userspace` è¦å¿«ï¼Œä½†é—®é¢˜æ˜¯ä¼šç»™æœºå™¨ä¸Šäº§ç”Ÿå¾ˆå¤š `iptables` è§„åˆ™ã€‚
- `ipvs`ï¼šä¸ºäº†è§£å†³ `iptables` çš„æ€§èƒ½é—®é¢˜è€Œå¼•å…¥ï¼Œé‡‡ç”¨å¢é‡çš„æ–¹å¼è¿›è¡Œæ›´æ–°ã€‚

ä¸‹é¢æˆ‘ä»¬ä»¥ `iptables` çš„æ¨¡å¼ç¨ä½œä»‹ç»ã€‚

```
master $ iptables -t nat -L 
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
DOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
KUBE-SERVICES  all  --  anywhere             anywhere             /* kubernetes service portals */
DOCKER     all  --  anywhere            !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
KUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */
MASQUERADE  all  --  172.18.0.0/24        anywhere

Chain DOCKER (2 references)
target     prot opt source               destination
RETURN     all  --  anywhere             anywhere

Chain KUBE-MARK-DROP (0 references)
target     prot opt source               destination
MARK       all  --  anywhere             anywhere             MARK or 0x8000

Chain KUBE-MARK-MASQ (7 references)
target     prot opt source               destination
MARK       all  --  anywhere             anywhere             MARK or 0x4000

Chain KUBE-NODEPORTS (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp dpt:31269
KUBE-SVC-SMQNAAUIAENDDGYQ  tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp dpt:31269

Chain KUBE-POSTROUTING (1 references)
target     prot opt source               destination
MASQUERADE  all  --  anywhere             anywhere             /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000

Chain KUBE-SEP-2LZPYBS4HUAJKDFL (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* kube-system/kube-dns:dns-tcp */
DNAT       tcp  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ tcp to:10.32.0.2:53

Chain KUBE-SEP-3E4LNQKKWZF7G6SH (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.1            anywhere             /* kube-system/kube-dns:dns-tcp */
DNAT       tcp  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ tcp to:10.32.0.1:53

Chain KUBE-SEP-3IDG7DUGN3QC2UZF (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  172.17.0.120         anywhere             /* default/kubernetes:https */
DNAT       tcp  --  anywhere             anywhere             /* default/kubernetes:https */ tcp to:172.17.0.120:6443

Chain KUBE-SEP-JZWS2VPNIEMNMNB2 (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* kube-system/kube-dns:dns */
DNAT       udp  --  anywhere             anywhere             /* kube-system/kube-dns:dns */ udp to:10.32.0.2:53

Chain KUBE-SEP-OEY6JJQSBCQPRKHS (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.1            anywhere             /* kube-system/kube-dns:dns */
DNAT       udp  --  anywhere             anywhere             /* kube-system/kube-dns:dns */ udp to:10.32.0.1:53

Chain KUBE-SEP-QX7VDAS5KDY6V3EV (1 references)
target     prot opt source               destination
KUBE-MARK-MASQ  all  --  10.32.0.2            anywhere             /* work/saythx-redis: */
DNAT       tcp  --  anywhere             anywhere             /* work/saythx-redis: */ tcp to:10.32.0.2:6379

Chain KUBE-SERVICES (2 references)
target     prot opt source               destination
KUBE-SVC-SMQNAAUIAENDDGYQ  tcp  --  anywhere             10.103.193.175       /* work/saythx-redis: cluster IP */ tcp dpt:6379
KUBE-NODEPORTS  all  --  anywhere             anywhere             /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL

Chain KUBE-SVC-ERIFXISQEP7F7OF4 (1 references)
target     prot opt source               destination
KUBE-SEP-3E4LNQKKWZF7G6SH  all  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */ statistic mode random probability 0.50000000000
KUBE-SEP-2LZPYBS4HUAJKDFL  all  --  anywhere             anywhere             /* kube-system/kube-dns:dns-tcp */


Chain KUBE-SVC-SMQNAAUIAENDDGYQ (2 references)
target     prot opt source               destination
KUBE-SEP-QX7VDAS5KDY6V3EV  all  --  anywhere             anywhere             /* work/saythx-redis: */
```

ä»¥ä¸Šè¾“å‡ºå·²ç»å°½é‡åˆ æ‰äº†æ— å…³çš„å†…å®¹ã€‚

å½“å¼€å§‹è®¿é—®çš„æ—¶å€™å…ˆè¦ç»è¿‡ `PREROUTING` é“¾ï¼Œè½¬åˆ° `KUBE-SERVICES` é“¾ï¼Œå½“æŸ¥è¯¢åˆ°åŒ¹é…çš„è§„åˆ™ä¹‹åï¼Œè¯·æ±‚å°†è½¬å‘ `KUBE-SVC-SMQNAAUIAENDDGYQ` é“¾ï¼Œè¿›è€Œåˆ°è¾¾ `KUBE-SEP-QX7VDAS5KDY6V3EV` å¯¹åº”äºæˆ‘ä»¬çš„ `Pod`ã€‚(æ³¨ï¼šä¸ºäº†ç®€æ´ï¼Œä¸Šè¿° iptables è§„åˆ™æ˜¯éƒ¨ç½²ä¸€ä¸ª `Pod` æ—¶çš„åœºæ™¯)

å½“ææ‡‚äº†è¿™äº›ä¹‹åï¼Œå¦‚æœä½ æƒ³äº†è§£è¿™äº› `iptables` è§„åˆ™å®é™…åˆæ˜¯å¦‚ä½•åˆ›å»ºå’Œç»´æŠ¤çš„ï¼Œé‚£å¯ä»¥å‚è€ƒä¸‹ `proxier` çš„å…·ä½“å®ç°ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚

## æ€»ç»“

æœ¬èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº† `kube-proxy` çš„ä¸»è¦åŠŸèƒ½å’ŒåŸºæœ¬æµç¨‹ï¼Œäº†è§£åˆ°äº†å®ƒå¯¹äºæœåŠ¡æ³¨å†Œå‘ç°å’Œä»£ç†è®¿é—®ç­‰èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚è€Œå®ƒåœ¨ Linux ä¸‹çš„ä»£ç†æ¨¡å¼ä¹Ÿæœ‰ `userspace`ï¼Œ`iptables` å’Œ `ipvs` ç­‰ã€‚

é»˜è®¤æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨ `iptables` çš„ä»£ç†æ¨¡å¼ï¼Œå½“åˆ›å»ºæ–°çš„ `Service` ï¼Œæˆ–è€… `Pod` è¿›è¡Œå˜åŒ–æ—¶ï¼Œ`kube-proxy` ä¾¿ä¼šå»ç»´æŠ¤ `iptables` è§„åˆ™ï¼Œä»¥ç¡®ä¿è¯·æ±‚å¯ä»¥æ­£ç¡®çš„åˆ°è¾¾åç«¯æœåŠ¡ã€‚

å½“ç„¶ï¼Œæœ¬èŠ‚ä¸­å¹¶æ²¡æœ‰æåˆ° `kube-proxy` çš„ `session affinity` ç›¸å…³çš„ç‰¹æ€§ï¼Œå¦‚æœ‰éœ€è¦å¯è¿›è¡Œä¸‹å°è¯•ã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»å®é™…è¿è¡Œç€å®¹å™¨çš„ `Docker`ï¼Œå¤§è‡´äº†è§£ä¸‹åœ¨ K8S ä¸­å®ƒæ‰€èµ·çš„ä½œç”¨ï¼ŒåŠä»–ä»¬ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚

# åº–ä¸è§£ç‰›ï¼šContainer Runtime ï¼ˆDockerï¼‰

## æ•´ä½“æ¦‚è§ˆ

æˆ‘ä»¬åœ¨ç¬¬ 3 èŠ‚çš„æ—¶å€™ï¼Œæåˆ°è¿‡ `Container Runtime` çš„æ¦‚å¿µï¼Œä¹Ÿå¤§è‡´ä»‹ç»è¿‡å®ƒçš„ä¸»è¦ä½œç”¨åœ¨äºä¸‹è½½é•œåƒï¼Œè¿è¡Œå®¹å™¨ç­‰ã€‚

ç»è¿‡æˆ‘ä»¬å‰é¢çš„å­¦ä¹ ï¼Œ`kube-scheduler` å†³å®šäº† `Pod` å°†è¢«è°ƒåº¦åˆ°å“ªä¸ª `Node` ä¸Šï¼Œè€Œ `kubelet` åˆ™è´Ÿè´£ `Pod` åœ¨æ­¤ `Node` ä¸Šå¯æŒ‰é¢„æœŸå·¥ä½œã€‚å¦‚æœæ²¡æœ‰ `Container Runtime`ï¼Œé‚£ `Pod` ä¸­çš„ `container` åœ¨è¯¥ `Node` ä¸Šä¹Ÿä¾¿æ— æ³•æ­£å¸¸å¯åŠ¨è¿è¡Œäº†ã€‚

æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»¥å½“å‰æœ€ä¸ºé€šç”¨çš„ `Container Runtime` Docker ä¸ºä¾‹è¿›è¡Œä»‹ç»ã€‚

## Container Runtime æ˜¯ä»€ä¹ˆ

`Container Runtime` æˆ‘ä»¬é€šå¸¸å«å®ƒå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œè¿™ä¸€æ¦‚å¿µçš„äº§ç”Ÿä¹Ÿæ˜¯ç”±äºå®¹å™¨åŒ–æŠ€æœ¯å’Œ K8S çš„å¤§åŠ›å‘å±•ï¼Œä¸ºäº†ç»Ÿä¸€å·¥ä¸šæ ‡å‡†ï¼Œä¹Ÿä¸ºäº†é¿å… K8S ç»‘å®šäºç‰¹å®šçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥ä¾¿æˆç«‹äº† [Open Container Initiative (OCI)](https://www.opencontainers.org/) ç»„ç»‡ï¼Œè‡´åŠ›äºå°†å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†åŒ–å’Œå®¹å™¨é•œåƒæ ‡å‡†åŒ–ã€‚

å‡¡æ˜¯éµå®ˆæ­¤æ ‡å‡†çš„å®ç°ï¼Œå‡å¯ç”±æ ‡å‡†æ ¼å¼çš„é•œåƒå¯åŠ¨ç›¸åº”çš„å®¹å™¨ï¼Œå¹¶å®Œæˆä¸€äº›ç‰¹å®šçš„æ“ä½œã€‚

## Docker æ˜¯ä»€ä¹ˆ

Docker æ˜¯ä¸€ä¸ªå®¹å™¨ç®¡ç†å¹³å°ï¼Œå®ƒæœ€åˆæ˜¯è¢«è®¾è®¡ç”¨äºå¿«é€Ÿåˆ›å»ºï¼Œå‘å¸ƒå’Œè¿è¡Œå®¹å™¨çš„å·¥å…·ï¼Œä¸è¿‡éšç€å®ƒçš„å‘å±•ï¼Œå…¶ä¸­é›†æˆäº†è¶Šæ¥è¶Šå¤šçš„åŠŸèƒ½ã€‚

Docker ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªåŒ…å«æ ‡å‡†å®¹å™¨è¿è¡Œæ—¶çš„å·¥å…·é›†ï¼Œå½“å‰ç‰ˆæœ¬ä¸­é»˜è®¤çš„ `runtime` ç§°ä¹‹ä¸º `runc`ã€‚ å…³äº `runc` ç›¸å…³çš„ä¸€äº›å†…å®¹å¯å‚è€ƒ[æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ](http://moelove.info/2018/11/23/runc-1.0-rc6-å‘å¸ƒä¹‹é™…/)ã€‚

å½“ç„¶ï¼Œè¿™é‡Œæåˆ°äº† **é»˜è®¤çš„è¿è¡Œæ—¶** é‚£ä¹Ÿå°±æ„å‘³ç€å®ƒå¯æ”¯æŒå…¶ä»–çš„è¿è¡Œæ—¶å®ç°ã€‚

## CRI æ˜¯ä»€ä¹ˆ

è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ï¼ŒK8S ä½œä¸ºç›®å‰äº‘åŸç”ŸæŠ€æœ¯ä½“ç³»ä¸­æœ€é‡è¦çš„ä¸€ç¯ï¼Œä¸ºäº†è®©å®ƒæ›´æœ‰æ‰©å±•æ€§ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå°†è‡ªå·±å®Œå…¨å±€é™äºæŸä¸€ç§ç‰¹å®šçš„å®¹å™¨è¿è¡Œæ—¶ã€‚

è‡ª K8S 1.5 ï¼ˆ2016 å¹´ 11 æœˆï¼‰å¼€å§‹ï¼Œæ–°å¢äº†ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶çš„æ’ä»¶ APIï¼Œå¹¶ç§°ä¹‹ä¸º `CRI` ï¼ˆContainer Runtime Interfaceï¼‰ï¼Œé€šè¿‡ `CRI` å¯ä»¥æ”¯æŒ `kubelet` ä½¿ç”¨ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚

`CRI` ä¸»è¦æ˜¯åŸºäº gRPC å®ç°äº† `RuntimeService` å’Œ `ImageService` è¿™ä¸¤ä¸ªæœåŠ¡ï¼Œå¯ä»¥å‚è€ƒ `pkg/kubelet/apis/cri/runtime/v1alpha2/api.proto` ä¸­çš„ API å®šä¹‰ã€‚ç”±äºæœ¬èŠ‚ä¾§é‡äº `Container Runtime/Docker` è¿™é‡Œå°±ä¸å¯¹ `CRI` çš„å…·ä½“å®ç°è¿›è¡Œå±•å¼€äº†ã€‚

åªè¦ç»§ç»­å°† `kubelet` å½“ä½œ agent çš„è§’è‰²ï¼Œè€Œå®ƒä¸åŸºäº `CRI` å®ç°çš„ `CRI shim` æœåŠ¡è¿›è¡Œé€šä¿¡ç†è§£å³å¯ã€‚

## Docker å¦‚ä½•å·¥ä½œ

è¿™é‡Œæˆ‘ä»¬ä¸»è¦ä»‹ç»åœ¨ K8S ä¸­ä¸€äº› Docker å¸¸è§çš„åŠ¨ä½œã€‚

### éƒ¨ç½²ä¸€ä¸ª Redis

```
master $ kubectl run redis --image=redis
deployment.apps/redis created
master $ kubectl get all
NAME                        READY     STATUS              RESTARTS   AGE
pod/redis-bb7894d65-7vsj8   0/1       ContainerCreating   0          6s

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   26m

NAME                    DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/redis   1         1         1            0           6s

NAME                              DESIRED   CURRENT   READY     AGE
replicaset.apps/redis-bb7894d65   1         1         0         6s
```

æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `kubectl run` çš„æ–¹å¼éƒ¨ç½²äº†ä¸€ä¸ª Redis

### æŸ¥çœ‹è¯¦æƒ…

```
master $ kubectl describe pod/redis-bb7894d65-7vsj8
Name:               redis-bb7894d65-7vsj8
Namespace:          default
Priority:           0
PriorityClassName:  <none>
Node:               node01/172.17.0.21
Start Time:         Sat, 15 Dec 2018 04:48:49 +0000
Labels:             pod-template-hash=663450821
                    run=redis
Annotations:        <none>
Status:             Running
IP:                 10.40.0.1
Controlled By:      ReplicaSet/redis-bb7894d65
Containers:
  redis:
    Container ID:   docker://ab87085456aca76825dd639bcde27160d9c2c84cac5388585bcc9ed3afda6522
    Image:          redis
    Image ID:       docker-pullable://redis@sha256:010a8bd5c6a9d469441aa35187d18c181e3195368bce309348b3ee639fce96e0
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Sat, 15 Dec 2018 04:48:57 +0000
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-zxt27 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-zxt27:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-zxt27
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  7m    default-scheduler  Successfully assigned default/redis-bb7894d65-7vsj8to node01
  Normal  Pulling    7m    kubelet, node01    pulling image "redis"
  Normal  Pulled     7m    kubelet, node01    Successfully pulled image "redis"
  Normal  Created    7m    kubelet, node01    Created container
  Normal  Started    7m    kubelet, node01    Started container
```

å¯ä»¥é€šè¿‡ `kubectl describe` æŸ¥çœ‹è¯¥ `Pod` çš„äº‹ä»¶è¯¦æƒ…ã€‚è¿™é‡Œä¸»è¦æœ‰å‡ ä¸ªé˜¶æ®µã€‚

#### è°ƒåº¦

```
Normal  Scheduled  7m    default-scheduler  Successfully assigned default/redis-bb7894d65-7vsj8to node01
```

åœ¨ç¬¬ 15 å°èŠ‚ `kube-scheduler` ä¸­æˆ‘ä»¬ä»‹ç»è¿‡ï¼Œé€šè¿‡ `kube-scheduler` å¯ä»¥å†³å®š `Pod` ä¼šè°ƒåº¦åˆ°å“ªä¸ª `Node`ã€‚æœ¬ä¾‹ä¸­ï¼Œ`redis-bb7894d65-7vsj8to` è¢«è°ƒåº¦åˆ°äº† `node01`ã€‚

#### pull é•œåƒ

```
Normal  Pulling    7m    kubelet, node01    pulling image "redis"
Normal  Pulled     7m    kubelet, node01    Successfully pulled image "redis"
```

è¿™é‡Œ `kubelet` åŠè¯¥èŠ‚ç‚¹ä¸Šçš„ `Container Runtime` ï¼ˆDockerï¼‰å¼€å§‹å‘æŒ¥ä½œç”¨ï¼Œå…ˆæ‹‰å–é•œåƒã€‚å¦‚æœæ­¤åˆ»ä½ ç™»å½• `node01` çš„æœºå™¨ï¼Œæ‰§è¡Œ `docker pull redis` ä¾¿å¯åŒæ­¥çœ‹åˆ°æ‹‰å–è¿›åº¦ã€‚

#### åˆ›å»ºé•œåƒå¹¶å¯åŠ¨

```
Normal  Created    7m    kubelet, node01    Created container
Normal  Started    7m    kubelet, node01    Started container
```

æ‹‰å–é•œåƒå®Œæˆåï¼Œä¾¿ä¼šå¼€å§‹åˆ›å»ºå¹¶å¯åŠ¨è¯¥å®¹å™¨ï¼Œå¹¶è¿”å›ä»»åŠ¡ç»“æœã€‚æ­¤åˆ»ç™»å½• `node01` æœºå™¨ï¼Œä¾¿ä¼šçœ‹åˆ°å½“å‰åœ¨è¿è¡Œçš„å®¹å™¨äº†ã€‚

```
node01 $ docker ps |grep redis
ab87085456ac        redis@sha256:010a8bd5c6a9d469441aa35187d18c181e3195368bce309348b3ee639fce96e0  "docker-entrypoint..."   19 minutes ago      Up 19 minutes                           k8s_redis_redis-bb7894d65-7vsj8_default_b693b56c-0024-11e9-9bab-0242ac11000a_0
8f264abd82fe        k8s.gcr.io/pause:3.1  "/pause"                 19 minutes ago      Up 19 minutes                           k8s_POD_redis-bb7894d65-7vsj8_default_b693b56c-0024-11e9-9bab-0242ac11000a_0
```

## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬ä»‹ç»äº† `Container Runtime` çš„åŸºæœ¬æ¦‚å¿µï¼ŒåŠ K8S ä¸ºäº†èƒ½å¢åŠ æ‰©å±•æ€§ï¼Œæä¾›äº†ç»Ÿä¸€çš„ `CRI` æ’ä»¶æ¥å£ï¼Œå¯ç”¨äºæ”¯æŒå¤šç§å®¹å™¨è¿è¡Œæ—¶ã€‚

å½“å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„æ˜¯ [`Docker`](https://github.com/moby/moby/)ï¼Œå½“å‰è¿˜æ”¯æŒçš„ä¸»è¦æœ‰ [`runc`](https://github.com/opencontainers/runc)ï¼Œ[`Containerd`](https://github.com/containerd/containerd)ï¼Œ[`runV`](https://github.com/hyperhq/runv) ä»¥åŠ [`rkt`](https://github.com/rkt/rkt) ç­‰ã€‚

ç”±äº Docker çš„çŸ¥è¯†ç‚¹å¾ˆå¤šï¼Œå…³äº Docker çš„å®è·µå’Œå†…éƒ¨åŸç†å¯å‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€æ¬¡åˆ†äº« [Docker å®æˆ˜å’ŒåŸºæœ¬åŸç†](https://github.com/tao12345666333/slides/raw/master/2018.09.13-Tech-Talk-Time/Dockerå®æˆ˜å’ŒåŸºæœ¬åŸç†-å¼ æ™‹æ¶›.pdf)ã€‚

åœ¨ä½¿ç”¨ K8S æ—¶ï¼Œä¹Ÿæœ‰æä¸ªåˆ«æƒ…å†µéœ€è¦é€šè¿‡æ’æŸ¥ Docker çš„æ—¥å¿—æ¥åˆ†æé—®é¢˜ã€‚

è‡³æ­¤ï¼ŒK8S ä¸­ä¸»è¦çš„æ ¸å¿ƒç»„ä»¶æˆ‘ä»¬å·²ç»ä»‹ç»å®Œæ¯•ï¼Œä¸‹èŠ‚æˆ‘ä»¬ä¸»è¦é›†ä¸­äºåœ¨ K8S ç¯å¢ƒä¸­ï¼Œå¦‚ä½•å®šä½å’Œè§£å†³é—®é¢˜ï¼Œä»¥åŠç±»ä¼¼åˆšæ‰æåˆ°çš„éœ€è¦é€šè¿‡ Docker è¿›è¡Œæ’æŸ¥é—®é¢˜çš„æƒ…å†µã€‚

# Troubleshoot

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»äº†è§£åˆ°äº† K8S çš„åŸºç¡€çŸ¥è¯†ï¼Œæ ¸å¿ƒç»„ä»¶åŸç†ä»¥åŠå¦‚ä½•åœ¨ K8S ä¸­éƒ¨ç½²æœåŠ¡åŠç®¡ç†æœåŠ¡ç­‰ã€‚

ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ‰€é¢ä¸´çš„ç¯å¢ƒå¤šç§å¤šæ ·ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§é—®é¢˜ã€‚æœ¬èŠ‚å°†ç»“åˆæˆ‘ä»¬å·²ç»äº†è§£åˆ°çš„çŸ¥è¯†ï¼Œä»‹ç»ä¸€äº›å¸¸è§é—®é¢˜å®šä½å’Œè§£å†³çš„æ€è·¯æˆ–æ–¹æ³•ï¼Œä»¥ä¾¿å¤§å®¶åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ K8S èƒ½å¦‚é±¼å¾—æ°´ã€‚

## åº”ç”¨éƒ¨ç½²é—®é¢˜

é¦–å…ˆæˆ‘ä»¬ä»åº”ç”¨éƒ¨ç½²ç›¸å…³çš„é—®é¢˜æ¥å…¥æ‰‹ã€‚è¿™é‡Œä»ç„¶ä½¿ç”¨æˆ‘ä»¬çš„[ç¤ºä¾‹é¡¹ç›® SayThx](https://github.com/tao12345666333/saythx)ã€‚

clone è¯¥é¡¹ç›®ï¼Œè¿›å…¥åˆ° deploy ç›®å½•ä¸­ï¼Œå…ˆ `kubectl apply -f namespace.yaml` æˆ–è€… `kubectl create ns work` æ¥åˆ›å»ºä¸€ä¸ªç”¨äºå®éªŒçš„ `Namespace` ã€‚

### ä½¿ç”¨ `describe` æ’æŸ¥é—®é¢˜

å¯¹ `redis-deployment.yaml` ç¨ä½œä¿®æ”¹ï¼ŒæŒ‰ä»¥ä¸‹æ–¹å¼æ“ä½œï¼š

```
master $ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
master $ kubectl -n work get all
NAME                                READY     STATUS             RESTARTS   AGE
pod/saythx-redis-7574c98f5d-v66fx   0/1       ImagePullBackOff   0          9s

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            0           9s

NAME                                      DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-7574c98f5d   1         1         0         9s
```

å¯ä»¥çœ‹åˆ° `Pod` æ­¤åˆ»çš„çŠ¶æ€æ˜¯ `ImagePullBackOff`ï¼Œè¿™ä¸ªçŠ¶æ€è¡¨ç¤ºé•œåƒæ‹‰å–å¤±è´¥ï¼Œ`kubelet` é€€å‡ºé•œåƒæ‹‰å–ã€‚

æˆ‘ä»¬åœ¨å‰é¢çš„å†…å®¹ä¸­ä»‹ç»è¿‡ `kubelet` çš„ä½œç”¨ä¹‹ä¸€å°±æ˜¯è´Ÿè´£é•œåƒæ‹‰å–ï¼Œè€Œå®é™…ä¸Šï¼Œåœ¨é•œåƒæ–¹é¢çš„é”™è¯¯ä¸»è¦é¢„è®¾äº† 6 ç§ï¼Œåˆ†åˆ«æ˜¯ `ImagePullBackOff`ï¼Œ`ImageInspectError`ï¼Œ`ErrImagePull`ï¼Œ`ErrImageNeverPull`ï¼Œ`RegistryUnavailable`ï¼Œ`InvalidImageName`ã€‚

å½“é‡åˆ°ä»¥ä¸Šæ‰€è¿°æƒ…å†µæ—¶ï¼Œä¾¿å¯å®šä½ä¸ºé•œåƒç›¸å…³å¼‚å¸¸ã€‚

æˆ‘ä»¬å›åˆ°ä¸Šé¢çš„é—®é¢˜å½“ä¸­ï¼Œå®šä½é—®é¢˜æ‰€åœ¨ã€‚

```
master $ kubectl -n work describe pod/saythx-redis-7574c98f5d-v66fx
Name:               saythx-redis-7574c98f5d-v66fx
Namespace:          work
Priority:           0
PriorityClassName:  <none>
Node:               node01/172.17.0.132
Start Time:         Tue, 18 Dec 2018 17:27:56 +0000
Labels:             app=redis
                    pod-template-hash=3130754918
Annotations:        <none>
Status:             Pending
IP:                 10.40.0.1
Controlled By:      ReplicaSet/saythx-redis-7574c98f5d
Containers:
  redis:
    Container ID:
    Image:          redis:5xx
    Image ID:
    Port:           6379/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       ImagePullBackOff
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-787w5 (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  default-token-787w5:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-787w5
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason          Age                 From               Message
  ----     ------          ----                ----               -------
  Normal   Scheduled       11m                 default-scheduler  Successfully assigned work/saythx-redis-7574c98f5d-v66fx to node01
  Normal   SandboxChanged  10m                 kubelet, node01    Pod sandbox changed, it will bekilled and re-created.
  Normal   BackOff         9m (x6 over 10m)    kubelet, node01    Back-off pulling image "redis:5xx"
  Normal   Pulling         9m (x4 over 10m)    kubelet, node01    pulling image "redis:5xx"
  Warning  Failed          9m (x4 over 10m)    kubelet, node01    Failed to pull image "redis:5xx": rpc error: code = Unknown desc = Error response from daemon: manifest for redis:5xx not found
  Warning  Failed          9m (x4 over 10m)    kubelet, node01    Error: ErrImagePull
  Warning  Failed          49s (x44 over 10m)  kubelet, node01    Error: ImagePullBackOff
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç°åœ¨ pull çš„é•œåƒæ˜¯ `redis:5xx` è€Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨æ­¤ tag çš„é•œåƒï¼Œæ‰€ä»¥å¯¼è‡´æ‹‰å–å¤±è´¥ã€‚

### ä½¿ç”¨ `events` æ’æŸ¥é—®é¢˜

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜æœ‰å¦ä¸€ç§æ–¹å¼åŒæ ·å¯è¿›è¡Œé—®é¢˜æ’æŸ¥ï¼š

```
master $ kubectl -n work get events
LAST SEEN   FIRST SEEN   COUNT     NAME                                             KIND         SUBOBJECT                TYPE      REASON              SOURCE                  MESSAGE
21m         21m          1         saythx-redis.15717d6361a741a8                    Deployment                        Normal    ScalingReplicaSet   deployment-controller   Scaled up replica set saythx-redis-7574c98f5d to 1
21m         21m          1         saythx-redis-7574c98f5d-qwxgm.15717d6363eb60ff   Pod                        Normal    Scheduled           default-scheduler       Successfully assigned work/saythx-redis-7574c98f5d-qwxgm to node01
21m         21m          1         saythx-redis-7574c98f5d.15717d636309afa8         ReplicaSet                        Normal    SuccessfulCreate    replicaset-controller   Created pod: saythx-redis-7574c98f5d-qwxgm
20m         21m          2         saythx-redis-7574c98f5d-qwxgm.15717d63fa501b3f   Pod          spec.containers{redis}   Normal    BackOff             kubelet, node01         Back-off pulling image "redis:5xx"
20m         21m          2         saythx-redis-7574c98f5d-qwxgm.15717d63fa5049a9   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Error: ImagePullBackOff
20m         21m          3         saythx-redis-7574c98f5d-qwxgm.15717d6393a1993c   Pod          spec.containers{redis}   Normal    Pulling             kubelet, node01         pulling image "redis:5xx"
20m         21m          3         saythx-redis-7574c98f5d-qwxgm.15717d63e11efc7a   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Error: ErrImagePull
20m         21m          3         saythx-redis-7574c98f5d-qwxgm.15717d63e11e9c25   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Failed to pull image "redis:5xx": rpc error: code = Unknown desc = Error response from daemon: manifest for redis:5xxnot found
20m         20m          1         saythx-redis-54984ff94-2bb6g.15717d6dc03799cd    Pod          spec.containers{redis}   Normal    Killing             kubelet, node01         Killing container with id docker://redis:Need to kill Pod
19m         19m          1         saythx-redis-7574c98f5d-v66fx.15717d72356528ec   Pod                        Normal    Scheduled           default-scheduler       Successfully assigned work/saythx-redis-7574c98f5d-v66fx to node01
19m         19m          1         saythx-redis-7574c98f5d.15717d722f7f1732         ReplicaSet                        Normal    SuccessfulCreate    replicaset-controller   Created pod: saythx-redis-7574c98f5d-v66fx
19m         19m          1         saythx-redis.15717d722b49e758                    Deployment                        Normal    ScalingReplicaSet   deployment-controller   Scaled up replica set saythx-redis-7574c98f5d to 1
19m         19m          1         saythx-redis-7574c98f5d-v66fx.15717d731a09b0ad   Pod                        Normal    SandboxChanged      kubelet, node01         Pod sandbox changed, it will be killed and re-created.
18m         19m          6         saythx-redis-7574c98f5d-v66fx.15717d733ab20b3d   Pod          spec.containers{redis}   Normal    BackOff             kubelet, node01         Back-off pulling image "redis:5xx"
18m         19m          4         saythx-redis-7574c98f5d-v66fx.15717d729de13541   Pod          spec.containers{redis}   Normal    Pulling             kubelet, node01         pulling image "redis:5xx"
18m         19m          4         saythx-redis-7574c98f5d-v66fx.15717d72e6ded95d   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Error: ErrImagePull
18m         19m          4         saythx-redis-7574c98f5d-v66fx.15717d72e6de7b1c   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Failed to pull image "redis:5xx": rpc error: code = Unknown desc = Error response from daemon: manifest for redis:5xxnot found
4m          19m          66        saythx-redis-7574c98f5d-v66fx.15717d733ab23f2c   Pod          spec.containers{redis}   Warning   Failed              kubelet, node01         Error: ImagePullBackOff
master
```

æˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»æ—¶ï¼Œä¹Ÿæåˆ°è¿‡ `kubelet` æˆ–è€… `kube-scheduler` ç­‰ç»„ä»¶ä¼šæ¥å—æŸäº›äº‹ä»¶ç­‰ï¼Œ`event` ä¾¿æ˜¯ç”¨äºè®°å½•é›†ç¾¤å†…å„å¤„å‘ç”Ÿçš„äº‹ä»¶ä¹‹ç±»çš„ã€‚

### ä¿®æ­£é”™è¯¯

- ä¿®æ­£é…ç½®æ–‡ä»¶

  ä¿®æ­£é…ç½®æ–‡ä»¶ï¼Œç„¶å `kubectl apply -f redis-deployment.yaml` ä¾¿å¯åº”ç”¨ä¿®æ­£åçš„é…ç½®æ–‡ä»¶ã€‚è¿™ç§æ–¹æ³•æ¯”è¾ƒæ¨èï¼Œå¹¶ä¸”å¯ä»¥å°†ä¿®æ”¹è¿‡çš„ä½ç½®çº³å…¥åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œæœ‰åˆ©äºåç»­ç»´æŠ¤ã€‚

- åœ¨çº¿ä¿®æ”¹é…ç½®

  ä½¿ç”¨ `kubectl -n work edit deploy/saythx-redis`ï¼Œä¼šæ‰“å¼€é»˜è®¤çš„ç¼–è¾‘å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä½¿ç”¨çš„é•œåƒåŠ tag ä¿®æ­£ä¸º `redis:5` ä¿å­˜é€€å‡ºï¼Œä¾¿ä¼šè‡ªåŠ¨åº”ç”¨æ–°çš„é…ç½®ã€‚è¿™ç§åšæ³•æ¯”è¾ƒé€‚åˆæ¯”è¾ƒç´§æ€¥æˆ–è€…èµ„æºæ˜¯ç›´æ¥é€šè¿‡å‘½ä»¤è¡Œåˆ›å»ºç­‰æƒ…å†µã€‚ **éç‰¹æ®Šæƒ…å†µå°½é‡ä¸è¦åœ¨çº¿ä¿®æ”¹ã€‚** ä¸”è¿™æ ·ä¿®æ”¹å¹¶ä¸åˆ©äºåæœŸç»´æŠ¤ã€‚

### é€šè¿‡è¯¦ç»†å†…å®¹æ’æŸ¥é”™è¯¯

```
master $ kubectl apply -f namespace.yaml
namespace/work created
master $ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
master $ vi redis-service.yaml # ç¨å¾®åšäº†ç‚¹ä¿®æ”¹
master $ kubectl apply -f redis-service.yaml
service/saythx-redis created
master $ kubectl -n work get pods,svc
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-z8prg   1/1       Running   0          47s

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.108.202.170   <none>        6379:32355/TCP   16s
```

é€šè¿‡ä»¥ä¸Šçš„è¾“å‡ºï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬çš„ `Service` åº”è¯¥æ˜¯å¯ä»¥å¯ä»¥æ­£å¸¸è®¿é—®äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿›è¡Œä¸‹æµ‹è¯•ï¼š

```
master $ docker run --rm -it --net host redis redis-cli -p 32355
Unable to find image 'redis:latest' locally
latest: Pulling from library/redis
a5a6f2f73cd8: Pull complete
a6d0f7688756: Pull complete
53e16f6135a5: Pull complete
f52b0cc4e76a: Pull complete
e841feee049e: Pull complete
ccf45e5191d0: Pull complete
Digest: sha256:bf65ecee69c43e52d0e065d094fbdfe4df6e408d47a96e56c7a29caaf31d3c35
Status: Downloaded newer image for redis:latest
Could not connect to Redis at 127.0.0.1:32355: Connection refused
not connected>
```

æˆ‘ä»¬å…ˆæ¥ä»‹ç»è¿™é‡Œçš„æµ‹è¯•æ–¹æ³•ã€‚ ä½¿ç”¨ Docker çš„ Redis å®˜æ–¹é•œåƒï¼Œ `--net host` æ˜¯ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼› `--rm` è¡¨ç¤ºåœæ­¢å®Œåå³æ¸…é™¤ï¼› `-it` åˆ†åˆ«è¡¨ç¤ºè·å–è¾“å…¥åŠè·å– TTYã€‚

é€šè¿‡ä»¥ä¸Šæµ‹è¯•å‘ç°ä¸èƒ½æ­£å¸¸è¿æ¥ï¼Œæ•…è€Œè¯´æ˜ `Service` è¿˜æ˜¯æœªé…ç½®å¥½ã€‚ä½¿ç”¨å‰é¢æåˆ°çš„æ–¹æ³•ä¹Ÿå¯ä»¥è¿›è¡Œæ’æŸ¥ï¼Œä¸è¿‡è¿™é‡Œæä¾›å¦ä¸€ç§æ’æŸ¥è¿™ç±»é—®é¢˜çš„æ€è·¯ã€‚

```
master $ kubectl -n work get endpoints
NAME           ENDPOINTS        AGE
saythx-redis   10.32.0.4:6380   9m
```

é€šè¿‡ä¹‹å‰çš„ç« èŠ‚ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ `Service` å·¥ä½œçš„æ—¶å€™æ˜¯æŒ‰ `Endpoints` æ¥çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å‘ç°æ­¤å¤„çš„ `Endpoints` æ˜¯ `6380` ä¸æˆ‘ä»¬é¢„æœŸçš„ `6379` å¹¶ä¸ç›¸åŒã€‚æ‰€ä»¥é—®é¢˜å®šä½äºç«¯å£é…ç½®æœ‰è¯¯ã€‚

å‰é¢å·²ç»è¯´è¿‡ä¿®æ­£æ–¹æ³•äº†ï¼Œä¸å†èµ˜è¿°ã€‚å½“ä¿®æ­£å®Œæˆåï¼Œå†æ¬¡éªŒè¯ï¼š

```
master $ kubectl -n work get endpoints
NAME           ENDPOINTS        AGE
saythx-redis   10.32.0.4:6379   15m
```

`Endpoints` å·²ç»æ­£å¸¸ï¼ŒéªŒè¯ä¸‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼š

```
master $ docker run --rm -it --net host redis redis-cli -p 32355
127.0.0.1:32355> ping
PONG
```

éªŒè¯æ— è¯¯ã€‚

## é›†ç¾¤é—®é¢˜

ç”±äºæˆ‘ä»¬æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œå†µä¸”åœ¨é›†ç¾¤æ­å»ºå’Œç»´æŠ¤è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ¯”è¾ƒå¸¸è§åˆ°é›†ç¾¤ç›¸å…³çš„é—®é¢˜ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆä¸¾ä¸ªå®é™…ä¾‹å­è¿›è¡Œåˆ†æï¼š

```
master $ kubectl get nodes
NAME      STATUS     ROLES     AGE       VERSION
master    Ready      master    58m       v1.11.3
node01    NotReady   <none>    58m       v1.11.3
```

é€šè¿‡ kubectl æŸ¥çœ‹ï¼Œå‘ç°æœ‰ä¸€ä¸ªèŠ‚ç‚¹ NotReady ï¼Œè¿™åœ¨æ­å»ºé›†ç¾¤çš„è¿‡ç¨‹ä¸­ä¹Ÿæœ‰å¯èƒ½é‡åˆ°ã€‚

```
master $ kubectl get  node/node01 -o yaml
apiVersion: v1
kind: Node
metadata:
  annotations:
    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
    node.alpha.kubernetes.io/ttl: "0"
    volumes.kubernetes.io/controller-managed-attach-detach: "true"
  creationTimestamp: 2018-12-19T16:46:59Z
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/hostname: node01
  name: node01
  resourceVersion: "4850"
  selfLink: /api/v1/nodes/node01
  uid: b440d3d5-03ad-11e9-917e-0242ac110035
spec: {}
status:
  addresses:
  - address: 172.17.0.66
    type: InternalIP
  - address: node01
    type: Hostname
  allocatable:
    cpu: "4"
    ephemeral-storage: "89032026784"
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 3894652Ki
    pods: "110"
  capacity:
    cpu: "4"
    ephemeral-storage: 96605932Ki
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 3997052Ki
    pods: "110"
  conditions:
  - lastHeartbeatTime: 2018-12-19T17:42:16Z
    lastTransitionTime: 2018-12-19T17:43:00Z
    message: Kubelet stopped posting node status.
    reason: NodeStatusUnknown
    status: Unknown
    type: OutOfDisk
  - lastHeartbeatTime: 2018-12-19T17:42:16Z
    lastTransitionTime: 2018-12-19T17:43:00Z
    message: Kubelet stopped posting node status.
    reason: NodeStatusUnknown
    status: Unknown
    type: MemoryPressure
  - lastHeartbeatTime: 2018-12-19T17:42:16Z
    lastTransitionTime: 2018-12-19T17:43:00Z
    message: Kubelet stopped posting node status.
    reason: NodeStatusUnknown
    status: Unknown
    type: DiskPressure
  - lastHeartbeatTime: 2018-12-19T17:42:16Z
    lastTransitionTime: 2018-12-19T16:46:59Z
    message: kubelet has sufficient PID available
    reason: KubeletHasSufficientPID
    status: "False"
    type: PIDPressure
  - lastHeartbeatTime: 2018-12-19T17:42:16Z
    lastTransitionTime: 2018-12-19T17:43:00Z
    message: Kubelet stopped posting node status.
    reason: NodeStatusUnknown
    status: Unknown
    type: Ready
  daemonEndpoints:
    kubeletEndpoint:
      Port: 10250
  ...
```

æˆ‘ä»¬ä¹‹å‰ä»‹ç» `kubelet` æ—¶è¯´è¿‡ï¼Œ `kubelet` çš„ä½œç”¨ä¹‹ä¸€ä¾¿æ˜¯å°†è‡ªèº«æ³¨å†Œè‡³ `kube-apiserver`ã€‚

è¿™é‡Œçš„ message ä¿¡æ¯è¯´æ˜ `kubelet` ä¸å†å‘ `kube-apiserver` å‘é€å¿ƒè·³åŒ…ä¹‹ç±»çš„äº†ï¼Œæ‰€ä»¥è¢«åˆ¤å®šä¸º NotReady çš„çŠ¶æ€ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç™»å½• node01 æœºå™¨æŸ¥çœ‹ `kubelet` çš„çŠ¶æ€ã€‚

```
node01 $ systemctl status kubelet
â— kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
  Drop-In: /etc/systemd/system/kubelet.service.d
           â””â”€kubeadm.conf
   Active: inactive (dead) since Wed 2018-12-19 17:42:17 UTC; 18min ago
     Docs: https://kubernetes.io/docs/home/
  Process: 1693 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_
 Main PID: 1693 (code=exited, status=0/SUCCESS)
```

å¯ä»¥çœ‹åˆ°è¯¥æœºå™¨ä¸Š `kubelet` æ²¡æœ‰å¯åŠ¨ã€‚ç°åœ¨å°†å…¶å¯åŠ¨ï¼Œç¨ç­‰ç‰‡åˆ»çœ‹çœ‹èŠ‚ç¾¤ä¸­ `Node` çš„çŠ¶æ€ã€‚

```
master $ kubectl get nodes
NAME      STATUS    ROLES     AGE       VERSION
master    Ready     master    1h        v1.11.3
node01    Ready     <none>    1h        v1.11.3
```

## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬ä»‹ç»äº† K8S ä¸­å¸¸ç”¨çš„é—®é¢˜æ’æŸ¥å’Œè§£å†³æ€è·¯ï¼Œä½†å®é™…ç”Ÿäº§ç¯å¢ƒä¸­æƒ…å†µä¼šæœ‰å’Œæ›´å¤šä¸ç¡®å®šå› ç´ ï¼ŒæŒæ¡æœ¬èŠ‚ä¸­ä»‹ç»çš„åŸºç¡€ï¼Œæœ‰åˆ©äºä¹‹åç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œå¸¸è§„é—®é¢˜çš„æ’æŸ¥ã€‚

å½“ç„¶ï¼Œæœ¬èŠ‚åªæ˜¯ä»‹ç»é€šè¿‡ kubectl æ¥å®šä½å’Œè§£å†³é—®é¢˜ï¼Œä¸ªåˆ«æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦ç™»å½•ç›¸å…³çš„èŠ‚ç‚¹ï¼Œå®é™…å»ä½¿ç”¨ `Docker` å·¥å…·ç­‰è¿›è¡Œé—®é¢˜çš„è¯¦ç»†æ’æŸ¥ã€‚

è‡³æ­¤ï¼ŒK8S çš„åŸºç¡€åŸç†å’Œå¸¸è§„é—®é¢˜æ’æŸ¥æ€è·¯ç­‰éƒ½å·²ç»é€šè¿‡åŒ…æ‹¬æœ¬èŠ‚åœ¨å†…çš„ 19 å°èŠ‚ä»‹ç»å®Œæ¯•ï¼Œç›¸ä¿¡ä½ ç°åœ¨å·²ç»è¿«ä¸åŠå¾…çš„æƒ³è¦ä½¿ç”¨ K8S äº†ã€‚

ä¸è¿‡ kubectl ä½œä¸ºå‘½ä»¤è¡Œå·¥å…·ä¹Ÿè®¸æœ‰äº›äººä¼šä¸ä¹ æƒ¯ä½¿ç”¨ï¼Œä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç» K8S çš„æ‰©å±•ç»„ä»¶ `kube-dashboard` äº†è§£å®ƒçš„ä¸»è¦åŠŸèƒ½åŠå¸¦ç»™æˆ‘ä»¬çš„ä¾¿åˆ©ã€‚

# æ‰©å±•å¢å¼ºï¼šDashboard

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„ä»‹ç»ï¼Œæƒ³å¿…ä½ å·²ç»è¿«ä¸åŠå¾…çš„æƒ³è¦å°†åº”ç”¨éƒ¨ç½²è‡³ K8S ä¸­ï¼Œä½†æ€»æ˜¯ä½¿ç”¨ `kubectl` æˆ–è€… `Helm` ç­‰å‘½ä»¤è¡Œå·¥å…·ä¹Ÿè®¸ä¸å¤ªç›´è§‚ï¼Œä½ å¯èƒ½æƒ³è¦ä¸€çœ¼å°±çœ‹åˆ°é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼Œæˆ–è€…æƒ³è¦æ›´æ–¹ä¾¿çš„å¯¹é›†ç¾¤è¿›è¡Œç®¡ç†ã€‚

æœ¬èŠ‚å°†ä»‹ç»ä¸€ä¸ª Web é¡¹ç›® [`Dashboard`](https://github.com/kubernetes/dashboard) å¯ç”¨äºéƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºï¼Œç®¡ç†é›†ç¾¤ä¸­çš„èµ„æºï¼Œç”šè‡³æ˜¯æ’æŸ¥å’Œè§£å†³é—®é¢˜ã€‚

å½“ç„¶å®ƒå’Œå¤§å¤šæ•° Dashboard ç±»çš„é¡¹ç›®ç±»ä¼¼ï¼Œä¹Ÿä¸ºé›†ç¾¤çš„çŠ¶æ€æä¾›äº†ä¸€ä¸ªå¾ˆç›´è§‚çš„å±•ç¤ºã€‚



![img](https://user-gold-cdn.xitu.io/2018/12/23/167d6b6e66c60e89?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## å¦‚ä½•å®‰è£…

è¦æƒ³ä½¿ç”¨ Dashboardï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…å®ƒï¼Œè€Œ Dashboard çš„å®‰è£…å…¶å®ä¹Ÿå¾ˆç®€å•ã€‚ä¸è¿‡å¯¹äºå›½å†…ç”¨æˆ·éœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦è§£å†³ç½‘ç»œé—®é¢˜ï¼Œæˆ–æ›¿æ¢é•œåƒåœ°å€ç­‰ã€‚

è¿™é‡Œæˆ‘ä»¬å®‰è£…å½“å‰æœ€æ–°ç‰ˆ `v1.10.1` çš„ Dashboardï¼š

- å¯¹äºå·²ç»è§£å†³ç½‘ç»œé—®é¢˜çš„ç”¨æˆ·ï¼š

  å¯ä½¿ç”¨å®˜æ–¹æ¨èåšæ³•è¿›è¡Œå®‰è£…ï¼Œä»¥ä¸‹é“¾æ¥æ˜¯ä½¿ç”¨äº†æˆ‘æäº¤äº† path çš„ç‰ˆæœ¬ï¼Œç”±äºå®˜æ–¹æœ€è¿‘çš„ä¸€æ¬¡æ›´æ–°å¯¼è‡´é…ç½®æ–‡ä»¶ä¸­çš„é•œåƒæé”™äº†ã€‚

  ```
  master $ kubectl apply -f https://raw.githubusercontent.com/tao12345666333/dashboard/67970554aa9275cccec1d1ee5fbf89ae81b3b614/aio/deploy/recommended/kubernetes-dashboard.yaml
  secret/kubernetes-dashboard-certs created
  serviceaccount/kubernetes-dashboard created
  role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
  rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
  deployment.apps/kubernetes-dashboard created
  service/kubernetes-dashboard created
  ```

- ä¹Ÿå¯ä½¿ç”¨æˆ‘ä¿®æ”¹è¿‡çš„è¿™ä»½ï¼ˆä½¿ç”¨ Docker Hub åŒæ­¥äº†é•œåƒï¼‰ä»“åº“åœ°å€ [GitHub](https://github.com/tao12345666333/k8s-dashboard), å›½å†… [Gitee](https://gitee.com/K8S-release/k8s-dashboard)ï¼š

  ```
  master $ kubectl apply -f https://gitee.com/K8S-release/k8s-dashboard/raw/master/kubernetes-dashboard.yaml
  secret/kubernetes-dashboard-certs created
  serviceaccount/kubernetes-dashboard created
  role.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
  rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-minimal created
  deployment.apps/kubernetes-dashboard created
  service/kubernetes-dashboard created
  ```

å½“å·²ç»æ‰§è¡Œå®Œä»¥ä¸Šæ­¥éª¤åï¼Œå¯æ£€æŸ¥ä¸‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```
master $ kubectl -n kube-system get all  -l k8s-app=kubernetes-dashboard
NAME                                        READY     STATUS    RESTARTS   AGE
pod/kubernetes-dashboard-67896bc598-dhdpz   1/1       Running   0          3m

NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
service/kubernetes-dashboard   ClusterIP   10.109.92.207   <none>        443/TCP   3m

NAME                                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/kubernetes-dashboard   1         1         1            1           3m

NAME                                              DESIRED   CURRENT   READY     AGE
replicaset.apps/kubernetes-dashboard-67896bc598   1         1         1         3m
```

å¯ä»¥çœ‹åˆ° `Pod` å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯è®¿é—® Dashboard.

## è®¿é—® Dashboard

ä»¥å½“å‰çš„éƒ¨ç½²æ–¹å¼ï¼Œ`Service` ä½¿ç”¨äº† `ClusterIP` çš„ç±»å‹ï¼Œæ‰€ä»¥åœ¨é›†ç¾¤å¤–ä¸èƒ½ç›´æ¥è®¿é—®ã€‚æˆ‘ä»¬å…ˆä½¿ç”¨ `kubectl` æä¾›çš„ `port-forward` åŠŸèƒ½è¿›è¡Œè®¿é—®ã€‚

```
master $ kubectl -n kube-system port-forward pod/kubernetes-dashboard-67896bc598-dhdpz 8443
Forwarding from 127.0.0.1:8443 -> 8443
Forwarding from [::1]:8443 -> 8443
```

è¿˜è®°å¾—ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 5 èŠ‚æ—¶å€™å®‰è£…è¿‡ä¸€ä¸ªåä¸º `socat` çš„ä¾èµ–é¡¹å—ï¼Ÿ `socat` çš„ä¸»è¦åŠŸèƒ½ä¾¿æ˜¯ç«¯å£è½¬å‘ã€‚

ç°åœ¨åœ¨æµè§ˆå™¨æ‰“å¼€ [`https://127.0.0.1:8443`](https://127.0.0.1:8443/) ä¾¿å¯çœ‹åˆ°å¦‚ä¸‹çš„ç™»å½•ç•Œé¢ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1176" height="565"></svg>)



å¯¹äºæˆ‘ä»¬çš„ **æ–°ç‰ˆæœ¬** è€Œè¨€ï¼Œæˆ‘ä»¬ **ä½¿ç”¨ä»¤ç‰Œç™»å½•** çš„æ–¹å¼ã€‚

### æŸ¥æ‰¾ Token

```
master $ kubectl -n kube-system get serviceaccount -l k8s-app=kubernetes-dashboard -o yaml
apiVersion: v1
items:
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    annotations:
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"ServiceAccount","metadata":{"annotations":{},"labels":{"k8s-app":"kubernetes-dashboard"},"name":"kubernetes-dashboard","namespace":"kube-system"}}
    creationTimestamp: 2018-12-20T17:27:14Z
    labels:
      k8s-app: kubernetes-dashboard
    name: kubernetes-dashboard
    namespace: kube-system
    resourceVersion: "1400"
    selfLink: /api/v1/namespaces/kube-system/serviceaccounts/kubernetes-dashboard
    uid: 7e01ddda-047c-11e9-b55c-0242ac11002a
  secrets:
  - name: kubernetes-dashboard-token-6ck2l
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""
```

é¦–å…ˆï¼Œæˆ‘ä»¬æŸ¥çœ‹åˆšæ‰åˆ›å»ºå‡ºçš„ `serviceaccount` å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰é…ç½® `secrets` ã€‚

æŸ¥çœ‹è¯¥ `secret` è¯¦æƒ…è·å¾— Token

```
master $ kubectl -n kube-system describe secrets kubernetes-dashboard-token-6ck2l
Name:         kubernetes-dashboard-token-6ck2l
Namespace:    kube-system
Labels:       <none>
Annotations:  kubernetes.io/service-account.name=kubernetes-dashboard
              kubernetes.io/service-account.uid=7e01ddda-047c-11e9-b55c-0242ac11002a

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1025 bytes
namespace:  11 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi02Y2sybCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjdlMDFkZGRhLTA0N2MtMTFlOS1iNTVjLTAyNDJhYzExMDAyYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.WZ5YRUkGlKRSpkBFCk3BrZ6p2t1qVxEs7Kb18DP5X2C2lfMhDrB931PeN05uByLD6biz_4IQvKh4xmvY2RqekfV1BLCfcIiMUbc1lcXGbhH4g4vrsjYx3NZifaBh_5HuBlEL5zs5e_zFkPEhhIqjsY3KueFEuGwxTAsqGBQwawc-v6wqzB3Gzb01o1iN5aTb37PVG5gTTE8cQLih_urKhvdNEKBSRg_zHQlYjFrtUUWYRYMlYz_sWmamYVXHy_7NvKrBfw44WU5tLxMITkoUEGVwROBnHf_BcWVedozLg2uLVontB12YvhmTfJCDEAJ8o937bS-Fq3tLfu_xM40fqw
```

å°†æ­¤å¤„çš„ token å¡«å…¥è¾“å…¥æ¡†å†…ä¾¿å¯ç™»å½•ï¼Œ**æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ `describe`ã€‚**



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="635"></svg>)



### ä¿®æ­£æƒé™

ä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°è¿™é‡Œæœ‰å¾ˆå¤šæç¤º `configmaps is forbidden: User "system:serviceaccount:kube-system:kubernetes-dashboard" cannot list resource "configmaps" in API group "" in the namespace "default"` ã€‚æ ¹æ®æˆ‘ä»¬å‰é¢çš„ä»‹ç»ï¼Œè¿™å¾ˆæ˜æ˜¾å°±æ˜¯ç”¨æˆ·æƒé™ä¸è¶³ã€‚

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå½“å‰æˆ‘ä»¬çš„é›†ç¾¤æ˜¯å¼€å¯äº† `RBAC` çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥å‰é¢å­¦åˆ°çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªç”¨æˆ·å¹¶è¿›è¡Œæˆæƒã€‚

- åˆ›å»º ServiceAccountï¼š

  ```
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: admin-user
    namespace: kube-system
  ```

- åˆ›å»º RoleBinding: è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç›´æ¥ç»‘å®šäº† `cluster-admin` çš„ ClusterRole ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè¯·æŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œæˆæƒï¼Œå‚è€ƒå‰é¢ç¬¬ 8 èŠ‚ç›¸å…³çš„å†…å®¹ã€‚

  ```
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: admin-user
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: cluster-admin
  subjects:
  - kind: ServiceAccount
    name: admin-user
    namespace: kube-system
  ```

ä½¿ç”¨ä»¥ä¸Šé…ç½®åˆ›å»ºäº†ç”¨æˆ·å’Œç»‘å®šï¼Œç„¶åè¿˜æ˜¯åŒæ ·çš„åŠæ³•è·å– Tokenã€‚

ç‚¹å‡» Dashboard å³ä¸Šè§’ï¼Œé€€å‡ºç™»å½•åï¼Œé‡æ–°ä½¿ç”¨æ–°çš„ Token è¿›è¡Œç™»å½•ã€‚ç™»å½•å®Œæˆåä¾¿å¯çœ‹åˆ°å¦‚ä¸‹å›¾ï¼š



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="607"></svg>)



## éƒ¨ç½²åº”ç”¨

ç‚¹å‡»å³ä¸Šè§’çš„ **+åˆ›å»º** å¯è¿›å…¥åˆ›å»ºé¡µé¢ï¼Œç°åœ¨æ”¯æŒä¸‰ç§æ¨¡å¼ï¼šä»æ–‡æœ¬æ¡†è¾“å…¥ï¼›ä»æ–‡ä»¶åˆ›å»ºï¼›ç›´æ¥åˆ›å»ºåº”ç”¨ã€‚

æˆ‘ä»¬ä»ç„¶ä»¥æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›® [SayThx](https://github.com/tao12345666333/saythx) ä¸ºä¾‹ã€‚å…ˆ `clone` è¯¥é¡¹ç›®ï¼Œå¹¶è¿›å…¥é¡¹ç›®çš„ `deploy` ç›®å½•ä¸­ã€‚å°† `namespace.yaml` çš„å†…å®¹å¤åˆ¶è¿›è¾“å…¥æ¡†ï¼Œç‚¹å‡»ä¸Šä¼ æŒ‰é’®ï¼Œä¾¿å¯åˆ›å»ºåä¸º `work` çš„ `Namespace` äº†ã€‚

é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```
master $ kubectl get ns
NAME          STATUS    AGE
default       Active    2h
kube-public   Active    2h
kube-system   Active    2h
work          Active    10s
```

å¯ä»¥çœ‹åˆ° Namespace å·²ç»åˆ›å»ºæˆåŠŸã€‚æˆ–è€…åˆ·æ–°ä¸‹ç½‘é¡µï¼Œç‚¹å‡»å·¦ä¾§çš„å‘½åç©ºé—´å³å¯çœ‹åˆ°å½“å‰çš„æ‰€æœ‰ `Namespace` ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="196" height="246"></svg>)



æˆ‘ä»¬å…ˆå°†å·¦ä¾§çš„å‘½åç©ºé—´é€‰æ‹©ä¸º **å…¨éƒ¨å‘½åç©ºé—´** æˆ– **work** (å½“åˆ·æ–°è¿‡ç½‘é¡µå) ï¼Œæ¥ä¸‹æ¥ç»§ç»­ç‚¹å‡»å³ä¸Šè§’çš„ **+åˆ›å»º** æŒ‰é’®ï¼Œå°† `redis-deployment.yaml` çš„å†…å®¹å¤åˆ¶è¿›è¾“å…¥æ¡†ï¼Œç‚¹å‡»ä¸Šä¼ æŒ‰é’®ï¼Œéƒ¨ç½² Redis ã€‚

éƒ¨ç½²æˆåŠŸåï¼Œç‚¹å‡» éƒ¨ç½² ï¼Œç‚¹å‡»åˆšæ‰çš„ `saythx-redis` ä¾¿å¯çœ‹åˆ°å…¶è¯¦æƒ…ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="603"></svg>)



ç‚¹å‡»å·¦ä¾§çš„å®¹å™¨ç»„ï¼Œä¾¿å¯çœ‹åˆ°åˆšæ‰éƒ¨ç½²çš„ Podï¼Œ



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="612"></svg>)



åœ¨æ­¤é¡µé¢çš„å³ä¸Šè§’ï¼Œå¯ä»¥ç‚¹å‡»å‘½ä»¤è¡ŒæŒ‰é’®ï¼Œæ‰“å¼€æ–°æ ‡ç­¾é¡µè¿›å…¥å…¶å†…éƒ¨æ‰§è¡Œå‘½ä»¤ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="609"></svg>)



æˆ–è€…æ˜¯ç‚¹å‡»æ—¥å¿—æŒ‰é’®ï¼Œå¯æ‰“å¼€æ–°æ ‡ç­¾é¡µï¼ŒæŸ¥çœ‹æ—¥å¿—ã€‚



![img](https://user-gold-cdn.xitu.io/2018/12/23/167d6bafed569ab1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## æ€»ç»“

æœ¬èŠ‚æˆ‘ä»¬ä»‹ç»äº† `Kubernetes Dashboard` çš„åŸºæœ¬åŠŸèƒ½ï¼Œä»¥åŠå¦‚ä½•å®‰è£…å’Œä½¿ç”¨å®ƒã€‚

Dashboard ç›¸æ¯” `kubectl` ä¸ºç”¨æˆ·æä¾›äº†ä¸€ç§ç›¸å¯¹ç›´è§‚çš„ Web ç«¯æ“ä½œæ–¹å¼ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œå…¨å–ä»£ `kubectl`ï¼Œè¿™ä¸¤è€…åº”è¯¥æ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚

å¦‚æœä½ æ‰€éœ€çš„åŠŸèƒ½ç›¸å¯¹ç®€å•æˆ–æ˜¯æƒ³è¦ç»™æŸäº›ç”¨æˆ·æä¾›ä¸€ç§é€šè¿‡ Web æ“ä½œçš„æ–¹å¼ï¼Œé‚£ä¾¿æ¨èä½¿ç”¨ Dashboardã€‚Dashboard çš„åç«¯ä½¿ç”¨äº† K8S çš„ [`client-go`](https://github.com/kubernetes/client-go) ï¼Œå‰ç«¯ä¸»è¦ä½¿ç”¨äº† [Angular](https://angular.io/)ï¼Œæœ‰å…´è¶£å¯ä»¥å¤§è‡´çœ‹çœ‹å…¶æºä»£ç ï¼Œå¯¹äºå¼€å‘åŸºäº K8S çš„äº‘å¹³å°ä¼šæœ‰äº›å¯å‘ã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç”¨äº DNS å’ŒæœåŠ¡å‘ç°çš„æ’ä»¶ [CoreDNS](https://coredns.io/)ï¼Œå­¦ä¹ å¦‚ä½•åˆ©ç”¨å®ƒå®Œæˆè¿™äº›éœ€æ±‚ã€‚å¹¶ä¸”å®ƒåœ¨ K8S 1.13 ç‰ˆæœ¬ä¸­ï¼Œå·²ç»æˆä¸ºäº†é»˜è®¤çš„ DNS serverã€‚

# æ‰©å±•å¢å¼ºï¼šCoreDNS

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ K8S ä¸­æœ‰ä¸€å¥—é»˜è®¤çš„[é›†ç¾¤å†… DNS æœåŠ¡](https://github.com/kubernetes/dns)ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åš `kube-dns`ï¼Œå®ƒåŸºäº SkyDNSï¼Œä¸ºæˆ‘ä»¬åœ¨æœåŠ¡æ³¨å†Œå‘ç°æ–¹é¢æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚

æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›® [SayThx](https://github.com/tao12345666333/saythx) ä¸­ï¼Œå„ç»„ä»¶ä¾¿æ˜¯ä¾èµ– DNS è¿›è¡Œå½¼æ­¤é—´çš„è°ƒç”¨ã€‚

æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»çš„ [CoreDNS](https://coredns.io/) æ˜¯ CNCF æ——ä¸‹åˆä¸€å­µåŒ–é¡¹ç›®ï¼Œåœ¨ K8S 1.9 ç‰ˆæœ¬ä¸­åŠ å…¥å¹¶è¿›å…¥ Alpha é˜¶æ®µã€‚æˆ‘ä»¬å½“å‰æ˜¯ä»¥ K8S 1.11 çš„ç‰ˆæœ¬è¿›è¡Œä»‹ç»ï¼Œå®ƒå¹¶ä¸æ˜¯é»˜è®¤çš„ DNS æœåŠ¡ï¼Œä½†æ˜¯[å®ƒä½œä¸º K8S çš„ DNS æ’ä»¶çš„åŠŸèƒ½å·²ç» GA](https://github.com/kubernetes/enhancements/issues/427) ã€‚

CoreDNS åœ¨ K8S 1.13 ç‰ˆæœ¬ä¸­æ‰æ­£å¼æˆä¸º[é»˜è®¤çš„ DNS æœåŠ¡](https://kubernetes.io/blog/2018/12/03/kubernetes-1-13-release-announcement/)ã€‚

## CoreDNS æ˜¯ä»€ä¹ˆ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡® CoreDNS æ˜¯ä¸€ä¸ªç‹¬ç«‹é¡¹ç›®ï¼Œå®ƒä¸ä»…å¯æ”¯æŒåœ¨ K8S ä¸­ä½¿ç”¨ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä½ ä»»ä½•éœ€è¦ DNS æœåŠ¡çš„æ—¶å€™ä½¿ç”¨å®ƒã€‚

CoreDNS ä½¿ç”¨ Go è¯­è¨€å®ç°ï¼Œéƒ¨ç½²éå¸¸æ–¹ä¾¿ã€‚

å®ƒçš„æ‰©å±•æ€§å¾ˆå¼ºï¼Œå¾ˆå¤šåŠŸèƒ½ç‰¹æ€§éƒ½æ˜¯é€šè¿‡æ’ä»¶å®Œæˆçš„ï¼Œå®ƒä¸ä»…æœ‰å¤§é‡çš„[å†…ç½®æ’ä»¶](https://coredns.io/plugins/)ï¼ŒåŒæ—¶ä¹Ÿæœ‰å¾ˆä¸°å¯Œçš„[ç¬¬ä¸‰æ–¹æ’ä»¶](https://coredns.io/explugins/)ã€‚ç”šè‡³ä½ è‡ªå·±[å†™ä¸€ä¸ªæ’ä»¶](https://coredns.io/2016/12/19/writing-plugins-for-coredns/)ä¹Ÿéå¸¸çš„å®¹æ˜“ã€‚

## å¦‚ä½•å®‰è£…ä½¿ç”¨ CoreDNS

æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†è¯´æ˜å¦‚ä½•åœ¨ K8S ç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œæ‰€ä»¥å¯¹äºç‹¬ç«‹å®‰è£…éƒ¨ç½²å®ƒä¸åšè¯´æ˜ã€‚

æœ¬å°å†Œä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ K8S 1.11 ç‰ˆæœ¬ï¼Œåœ¨ç¬¬ 5 å°èŠ‚ ã€Šæ­å»º Kubernetes é›†ç¾¤ã€‹ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä½¿ç”¨ `kubeadm` æ­å»ºé›†ç¾¤ã€‚

ä½¿ç”¨ `kubeadm` åˆ›å»ºé›†ç¾¤æ—¶å€™ `kubeadm init` å¯ä»¥ä¼ é€’ `--feature-gates` å‚æ•°ï¼Œç”¨äºå¯ç”¨ä¸€äº›é¢å¤–çš„ç‰¹æ€§ã€‚

æ¯”å¦‚åœ¨ä¹‹å‰ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `kubeadm init --feature-gates CoreDNS=true` åœ¨åˆ›å»ºé›†ç¾¤æ—¶å€™å¯ç”¨ CoreDNSã€‚

è€Œåœ¨ 1.11 ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨ `kubeadm` åˆ›å»ºé›†ç¾¤æ—¶ `CoreDNS` å·²ç»è¢«é»˜è®¤å¯ç”¨ï¼Œè¿™ä¹Ÿä»ä¾§é¢è¯æ˜äº† CoreDNS åœ¨ K8S ä¸­è¾¾åˆ°äº†ç”Ÿäº§å¯ç”¨çš„çŠ¶æ€ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åˆ›å»ºé›†ç¾¤æ—¶çš„æ—¥å¿—è¾“å‡ºï¼š

```
[root@master ~]# kubeadm init
[init] using Kubernetes version: v1.11.3               
[preflight] running pre-flight checks
...
[bootstraptoken] creating the "cluster-info" ConfigMap in the "kube-public" namespace
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes master has initialized successfully!
```

å¯ä»¥çœ‹åˆ°åˆ›å»ºæ—¶å·²ç»å¯ç”¨äº† CoreDNS çš„æ‰©å±•ï¼Œå¾…é›†ç¾¤åˆ›å»ºå®Œæˆåï¼Œå¯ç”¨è¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡ŒæŸ¥çœ‹ï¼š

```
master $ kubectl -n kube-system get all  -l k8s-app=kube-dns -o wide
NAME                           READY     STATUS    RESTARTS   AGE       IP          NODE      NOMINATED NODE
pod/coredns-78fcdf6894-5zbx4   1/1       Running   0          1h        10.32.0.3   node01    <none>
pod/coredns-78fcdf6894-cxdw8   1/1       Running   0          1h        10.32.0.2   node01    <none>

NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE       SELECTOR
service/kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP   1h        k8s-app=kube-dns

NAME                      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE       CONTAINERS   IMAGES                     SELECTOR
deployment.apps/coredns   2         2         2            2           1h        coredns      k8s.gcr.io/coredns:1.1.3   k8s-app=kube-dns

NAME                                 DESIRED   CURRENT   READY     AGE       CONTAINERS   IMAGES                   SELECTOR
replicaset.apps/coredns-78fcdf6894   2         2         2         1h        coredns      k8s.gcr.io/coredns:1.1.3   k8s-app=kube-dns,pod-template-hash=3497892450
```

è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹ K8S åŸæœ‰çš„ `kube-dns` æ‰€ä»¥æ ‡ç­¾å’Œ `Service` çš„åå­—éƒ½è¿˜ä½¿ç”¨äº† `kube-dns`ï¼Œä½†å®é™…åœ¨è¿è¡Œçš„åˆ™æ˜¯ CoreDNSã€‚

## éªŒè¯ CoreDNS åŠŸèƒ½

ä»ä¸Šé¢çš„è¾“å‡ºæˆ‘ä»¬çœ‹åˆ° CoreDNS çš„ `Pod` è¿è¡Œæ­£å¸¸ï¼Œç°åœ¨æµ‹è¯•ä¸‹å®ƒæ˜¯å¦èƒ½æ­£ç¡®è§£æã€‚ä»ç„¶ä»¥æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›® [SayThx](https://github.com/tao12345666333/saythx) ä¸ºä¾‹ï¼Œå…ˆ clone é¡¹ç›®ï¼Œè¿›å…¥åˆ°é¡¹ç›®çš„ deploy ç›®å½•ä¸­ã€‚

```
master $ cd saythx/deploy/
master $ ls
backend-deployment.yaml  frontend-deployment.yaml  namespace.yaml         redis-service.yaml
backend-service.yaml     frontend-service.yaml     redis-deployment.yaml  work-deployment.yaml
master $ kubectl apply -f namespace.yaml
namespace/work created
master $ kubectl apply -f redis-deployment.yaml
deployment.apps/saythx-redis created
master $ kubectl apply -f redis-service.yaml
service/saythx-redis created
```

- æŸ¥çœ‹å…¶éƒ¨ç½²æƒ…å†µï¼š

```
master $ kubectl -n work get all
NAME                               READY     STATUS    RESTARTS   AGE
pod/saythx-redis-8558c7d7d-8v4lp   1/1       Running   0          2m

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/saythx-redis   NodePort   10.109.215.147   <none>        6379:31438/TCP   2m

NAME                           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/saythx-redis   1         1         1            1           2m

NAME                                     DESIRED   CURRENT   READY     AGE
replicaset.apps/saythx-redis-8558c7d7d   1         1         1         2m
```

- éªŒè¯ DNS æ˜¯å¦æ­£ç¡®è§£æ:

```
# ä½¿ç”¨ AlpineLinux çš„é•œåƒåˆ›å»ºä¸€ä¸ª Pod å¹¶è¿›å…¥å…¶ä¸­
master $ kubectl run alpine -it --rm --restart='Never' --image='alpine' sh
If you don't see a command prompt, try pressing enter.
/ # apk add --no-cache bind-tools
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/5) Installing libgcc (6.4.0-r9)
(2/5) Installing json-c (0.13.1-r0)
(3/5) Installing libxml2 (2.9.8-r1)
(4/5) Installing bind-libs (9.12.3-r0)
(5/5) Installing bind-tools (9.12.3-r0)
Executing busybox-1.28.4-r2.trigger
OK: 9 MiB in 18 packages

# å®‰è£…å®Œ dig å‘½ä»¤æ‰€åœ¨åŒ…ä¹‹åï¼Œä½¿ç”¨ dig å‘½ä»¤è¿›è¡ŒéªŒè¯
/ # dig @10.32.0.2 saythx-redis.work.svc.cluster.local +noall +answer

; <<>> DiG 9.12.3 <<>> @10.32.0.2 saythx-redis.work.svc.cluster.local +noall +answer
; (1 server found)
;; global options: +cmd
saythx-redis.work.svc.cluster.local. 5 IN A     10.109.215.147
```

é€šè¿‡ä»¥ä¸Šæ“ä½œï¼Œå¯ä»¥çœ‹åˆ°ç›¸åº”çš„ `Service` è®°å½•å¯è¢«æ­£ç¡®è§£æã€‚è¿™é‡Œæœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š

- åŸŸåè§£ææ˜¯å¯è·¨ `Namespace` çš„

  åˆšæ‰çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æŒ‡å®š `Namespace` æ‰€ä»¥åˆšæ‰æˆ‘ä»¬æ‰€åœ¨çš„ `Namespace` æ˜¯ `default`ã€‚è€Œæˆ‘ä»¬çš„è§£æå®éªŒæˆåŠŸäº†ã€‚è¯´æ˜ CoreDNS çš„è§£ææ˜¯å…¨å±€çš„ã€‚**è™½ç„¶è§£ææ˜¯å…¨å±€çš„ï¼Œä½†ä¸ä»£è¡¨ç½‘ç»œäº’é€š**

- åŸŸåæœ‰ç‰¹å®šæ ¼å¼

  å¯ä»¥çœ‹åˆ°åˆšæ‰æˆ‘ä»¬ä½¿ç”¨çš„å®Œæ•´åŸŸåæ˜¯ `saythx-redis.work.svc.cluster.local` , æ³¨æ„å¼€å¤´çš„ä¾¿æ˜¯ **Service å.Namespace å** å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ `host` å‘½ä»¤æŸ¥è¯¢:

  ```
  / # host -t srv  saythx-redis.work
  saythx-redis.work.svc.cluster.local has SRV record 0 100 6379 saythx-redis.work.svc.cluster.local.
  ```

## é…ç½®å’Œç›‘æ§

CoreDNS ä½¿ç”¨ `ConfigMap` çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œä½†æ˜¯å¦‚æœæ›´æ”¹äº†é…ç½®ï¼Œ`Pod` é‡å¯åæ‰ä¼šç”Ÿæ•ˆã€‚

æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯æŸ¥çœ‹å…¶é…ç½®ï¼š

```
master $ kubectl -n kube-system get configmap coredns -o yaml
apiVersion: v1
data:
  Corefile: |
    .:53 {
        errors
        health
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           upstream
           fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        proxy . /etc/resolv.conf
        cache 30
        reload
    }
kind: ConfigMap
metadata:
  creationTimestamp: 2018-12-22T16:45:47Z
  name: coredns
  namespace: kube-system
  resourceVersion: "217"
  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns
  uid: 0882e51b-0609-11e9-b25e-0242ac110057
```

`Corefile` ä¾¿æ˜¯å®ƒçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å®ƒå¯åŠ¨äº†ç±»ä¼¼ `kubernetes`, `prometheus` ç­‰æ’ä»¶ã€‚

æ³¨æ„ `kubernetes` æ’ä»¶çš„é…ç½®ï¼Œä½¿ç”¨çš„åŸŸæ˜¯ `cluster.local` ï¼Œè¿™ä¹Ÿæ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°åŸŸåæ ¼å¼æ—¶å€™ååŠéƒ¨åˆ†æœªè§£é‡Šçš„éƒ¨åˆ†ã€‚

è‡³äº `prometheus` æ’ä»¶ï¼Œåˆ™æ˜¯ç›‘å¬åœ¨ 9153 ç«¯å£ä¸Šæä¾›äº†ç¬¦åˆ Prometheus æ ‡å‡†çš„ metrics æ¥å£ï¼Œå¯ç”¨äºç›‘æ§ç­‰ã€‚å…³äºç›‘æ§çš„éƒ¨åˆ†ï¼Œå¯å‚è€ƒç¬¬ 23 èŠ‚ã€‚

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† CoreDNS çš„åŸºæœ¬æƒ…å†µï¼Œå®ƒæ˜¯ä»¥ Go ç¼–å†™çš„çµæ´»å¯æ‰©å±•çš„ DNS æœåŠ¡å™¨ã€‚

ä½¿ç”¨ CoreDNS ä»£æ›¿ kube-dns ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸€äº› kube-dns æ—¶æœŸçš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´åŸå…ˆ kube-dns çš„æ—¶å€™ï¼Œä¸€ä¸ª Pod ä¸­è¿˜éœ€è¦åŒ…å« `kube-dns`, `sidecar` å’Œ `dnsmasq` çš„å®¹å™¨ï¼Œè€Œæ¯å½“ `dnsmasq` å‡ºç°æ¼æ´æ—¶ï¼Œå°±ä¸å¾—ä¸è®© K8S å‘ä¸ªå®‰å…¨è¡¥ä¸æ‰èƒ½è¿›è¡Œæ›´æ–°ã€‚

CoreDNS æœ‰ä¸°å¯Œçš„æ’ä»¶ï¼Œå¯ä»¥æ»¡è¶³æ›´å¤šæ ·çš„åº”ç”¨éœ€æ±‚ï¼ŒåŒæ—¶ `kubernetes` æ’ä»¶è¿˜åŒ…å«äº†ä¸€äº›ç‹¬ç‰¹çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ Pod éªŒè¯ä¹‹ç±»çš„ï¼Œå¯å¢åŠ å®‰å…¨æ€§ã€‚

åŒæ—¶ CoreDNS åœ¨ 1.13 ç‰ˆæœ¬ä¸­ä¼šä½œä¸ºé»˜è®¤çš„ DNS æœåŠ¡å™¨ä½¿ç”¨ï¼Œæ‰€ä»¥åº”è¯¥ç»™å®ƒæ›´å¤šçš„å…³æ³¨ã€‚

åœ¨ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç» `Ingress`ï¼Œçœ‹çœ‹å¦‚æœä½¿ç”¨ä¸åŒäºä¹‹å‰ä½¿ç”¨çš„ `NodePort` çš„æ–¹å¼å°†æœåŠ¡æš´éœ²äºå¤–éƒ¨ã€‚

# æœåŠ¡å¢å¼ºï¼šIngress

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ K8S ä¸­æœ‰ `Service` çš„æ¦‚å¿µï¼ŒåŒæ—¶é»˜è®¤æƒ…å†µä¸‹è¿˜æœ‰ `CoreDNS` å®Œæˆé›†ç¾¤å†…éƒ¨çš„åŸŸåè§£æç­‰å·¥ä½œï¼Œä»¥æ­¤å®ŒæˆåŸºç¡€çš„æœåŠ¡æ³¨å†Œå‘ç°èƒ½åŠ›ã€‚

åœ¨ç¬¬ 7 èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `Service` çš„ 4 ç§åŸºç¡€ç±»å‹ï¼Œåœ¨å‰é¢çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½åœ¨ä½¿ç”¨ `ClusterIP` æˆ– `NodePort` ç­‰æ–¹å¼å°†æœåŠ¡æš´éœ²åœ¨é›†ç¾¤å†…æˆ–è€…é›†ç¾¤å¤–ã€‚

æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦ä¸€ç§å¤„ç†æœåŠ¡è®¿é—®çš„æ–¹å¼ `Ingress`ã€‚

## Ingress æ˜¯ä»€ä¹ˆ

é€šè¿‡ `kubectl explain ingress` å‘½ä»¤ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¯¹ Ingress çš„æè¿°ã€‚

> Ingress is a collection of rules that allow inbound connections to reach the endpoints defined by a backend. An Ingress can be configured to give services externally-reachable urls, load balance traffic, terminate SSL, offer name based virtual hosting etc.

`Ingress` æ˜¯ä¸€ç»„å…è®¸å¤–éƒ¨è¯·æ±‚è¿›å…¥é›†ç¾¤çš„è·¯ç”±è§„åˆ™çš„é›†åˆã€‚å®ƒå¯ä»¥ç»™ `Service` æä¾›é›†ç¾¤å¤–éƒ¨è®¿é—®çš„ URLï¼Œè´Ÿè½½å‡è¡¡ï¼ŒSSL ç»ˆæ­¢ç­‰ã€‚

ç›´ç™½ç‚¹è¯´ï¼Œ`Ingress` å°±ç±»ä¼¼èµ·åˆ°äº†æ™ºèƒ½è·¯ç”±çš„è§’è‰²ï¼Œå¤–éƒ¨æµé‡åˆ°è¾¾ `Ingress` ï¼Œå†ç”±å®ƒæŒ‰å·²ç»åˆ¶å®šå¥½çš„è§„åˆ™åˆ†å‘åˆ°ä¸åŒçš„åç«¯æœåŠ¡ä¸­å»ã€‚

çœ‹èµ·æ¥å®ƒå¾ˆåƒæˆ‘ä»¬ä½¿ç”¨çš„è´Ÿè½½å‡è¡¡å™¨ä¹‹ç±»çš„ã€‚é‚£ä½ å¯èƒ½ä¼šé—®ï¼Œ`Ingress` ä¸ `LoadBalancer` ç±»å‹çš„ `Service` çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- `Ingress` ä¸æ˜¯ä¸€ç§ `Service` ç±»å‹

  `Ingress` æ˜¯ K8S ä¸­çš„ä¸€ç§èµ„æºç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ `kubectl get ingress` çš„æ–¹å¼è·å–æˆ‘ä»¬å·²æœ‰çš„ `Ingress` èµ„æºã€‚

- `Ingress` å¯ä»¥æœ‰å¤šç§æ§åˆ¶å™¨ï¼ˆå®ç°ï¼‰

  é€šè¿‡ä¹‹å‰çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ K8S ä¸­æœ‰å¾ˆå¤šçš„ `Controller` (æ§åˆ¶å™¨)ï¼Œè€Œè¿™äº› `Controller` å·²ç»æ‰“åŒ…è¿›äº† `kube-controller-manager` ä¸­ï¼Œé€šè¿‡ `--controllers` å‚æ•°æ§åˆ¶å¯ç”¨å“ªäº›ã€‚

  ä½†æ˜¯ `Ingress` çš„ `Controller` å¹¶æ²¡æœ‰åŒ…å«åœ¨å…¶ä¸­ï¼Œè€Œä¸”æœ‰å¤šç§é€‰æ‹©ã€‚

  ç”±ç¤¾åŒºç»´æŠ¤ï¼ˆæˆ–æ˜¯è¯´å®˜æ–¹æ”¯æŒçš„ï¼‰æœ‰ä¸¤ä¸ªï¼šé€‚ç”¨äº Google Cloud çš„ [GLBC](https://github.com/kubernetes/ingress-gce)ï¼Œå½“ä½ ä½¿ç”¨ GKE çš„æ—¶å€™ï¼Œä¾¿ä¼šçœ‹åˆ°å®ƒï¼›å’Œ [NGINX Ingress Controller](https://github.com/kubernetes/ingress-nginx) å®ƒæ˜¯ä½¿ç”¨ `ConfigMap` å­˜å‚¨ NGINX é…ç½®å®ç°çš„ã€‚

  ç¬¬ä¸‰æ–¹çš„å®ç°è¿˜æœ‰ï¼šåŸºäº Envoy çš„ [Contour](https://github.com/heptio/contour); F5 çš„ [F5 BIG-IP Controller](https://clouddocs.f5.com/products/connectors/k8s-bigip-ctlr/v1.7/); åŸºäº HAProxy çš„ [haproxy-ingress](https://github.com/jcmoraisjr/haproxy-ingress); åŸºäº Istio çš„ [Control Ingress Traffic](https://istio.io/docs/tasks/traffic-management/ingress/); ç°ä»£åŒ–çš„åå‘ä»£ç†æœåŠ¡å™¨ [Traefik](https://github.com/containous/traefik); ä»¥åŠ Kong æ”¯æŒçš„ [Kong Ingress Controller for Kubernetes](https://konghq.com/blog/kubernetes-ingress-controller-for-kong/) å’Œ NGINX å®˜æ–¹æ”¯æŒçš„ [NGINX Ingress Controller](https://github.com/nginxinc/kubernetes-ingress)ã€‚

  è¿™é‡Œå¯ä»¥çœ‹åˆ° K8S ç¤¾åŒºå’Œ NGINX éƒ½æœ‰ NGINX Ingress Controllerï¼Œå¾ˆå¤šäººåœ¨ä¸€å¼€å§‹æ¥è§¦ Ingress çš„æ—¶å€™ä¾¿é™·å…¥äº†é€‰æ‹©çš„è‹¦æ¼ä¸­ï¼Œé™¤å»å‰é¢çš„é‚£äº›é€‰æ‹©å¤–ï¼Œå• NGINX çš„æ§åˆ¶å™¨å°±æœ‰ä¸¤ä¸ªï¼Œåˆ°åº•åº”è¯¥æ€ä¹ˆé€‰ã€‚

  è¿™é‡Œæä¾›ä¸¤ç‚¹å»ºè®®ï¼š

  - å¯èƒ½å¤šæ•°äººä½¿ç”¨çš„éƒ½æ˜¯ NGINX è€Œé NGINX Plusï¼Œå¦‚æœä½ éœ€è¦ä¼šè¯ä¿æŒï¼ˆSession persistenceï¼‰çš„è¯ï¼Œé‚£ä½ åº”è¯¥é€‰æ‹© K8S ç¤¾åŒºç»´æŠ¤çš„ç‰ˆæœ¬
  - å³ä½¿æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ NGINX çš„æ—¶å€™ï¼Œä¹Ÿå¸¸å¸¸ä¼šæœ‰åŠ¨æ€é…ç½®çš„éœ€æ±‚ï¼Œå¦‚æœä½ ä»ç„¶æœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œé‚£ä½ è¿˜æ˜¯ç»§ç»­ä½¿ç”¨ K8S ç¤¾åŒºç»´æŠ¤çš„ç‰ˆæœ¬ï¼ˆå…¶ä¸­å†…ç½®äº† Lua æ”¯æŒï¼‰ã€‚

## å¦‚ä½•ä½¿ç”¨

å‰é¢ä¹Ÿå·²ç»è¯´åˆ°äº†ï¼Œå•çº¯çš„åˆ›å»ºä¸€ä¸ª `Ingress` èµ„æºæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé…ç½®ä¸€ä¸ª `Controller` ï¼Œæ‰èƒ½è®©å®ƒæ­£å¸¸å·¥ä½œã€‚å›½å†…ä½¿ç”¨ GKE çš„å¯èƒ½ä¸æ˜¯å¾ˆå¤šï¼Œä¸ºäº†æ›´åŠ é€šç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© K8S ç¤¾åŒºç»´æŠ¤çš„ NGINX Ingress Controllerã€‚

### å®‰è£…

æ•´ä¸ªå®‰è£…è¿‡ç¨‹å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼ˆä»¥ä¸‹æ­¥éª¤ä¸­éƒ½å°†ç›´æ¥å±•ç¤ºè¯¥æ­¥éª¤æ‰€éœ€çš„ YAML é…ç½®æ–‡ä»¶ï¼‰ï¼š

- åˆ›å»º `Namespace`

  ```
  apiVersion: v1
  kind: Namespace
  metadata:
    name: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  ```

  å°†ä»¥ä¸Šå†…å®¹ä¿å­˜ä¸º namespace.yaml æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ `kubectl apply -f namespace.yaml` å³å¯ã€‚ä»¥ä¸‹æ­¥éª¤å‡ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚ æ³¨æ„ï¼šè¿™é‡Œåˆ›å»º `Namespace` åªæ˜¯ä¸ºäº†ä¿æŒé›†ç¾¤ç›¸å¯¹è§„èŒƒï¼Œéå¼ºåˆ¶ï¼Œä½†æ¨èæ­¤åšæ³•ã€‚

- åˆ›å»º `ConfigMap`

  ```
  kind: ConfigMap
  apiVersion: v1
  metadata:
    name: nginx-configuration
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  
  ---
  kind: ConfigMap
  apiVersion: v1
  metadata:
    name: tcp-services
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  
  ---
  kind: ConfigMap
  apiVersion: v1
  metadata:
    name: udp-services
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  
  ---
  ```

  è¿™é‡Œåˆ›å»ºäº†å‡ ä¸ª `ConfigMap`ï¼Œä¸»è¦æ˜¯ç»™ `Controller` ä½¿ç”¨ã€‚

- ç”±äºæˆ‘ä»¬çš„é›†ç¾¤ä½¿ç”¨ `kubeadm` åˆ›å»ºæ—¶ï¼Œé»˜è®¤å¼€å¯äº† `RBAC` ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç›¸åº”çš„åˆ›å»ºå¯¹åº”çš„ `Role` å’Œ `RoleBinding`ã€‚

  ```
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: nginx-ingress-serviceaccount
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  
  ---
  apiVersion: rbac.authorization.k8s.io/v1beta1
  kind: ClusterRole
  metadata:
    name: nginx-ingress-clusterrole
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  rules:
    - apiGroups:
        - ""
      resources:
        - configmaps
        - endpoints
        - nodes
        - pods
        - secrets
      verbs:
        - list
        - watch
    - apiGroups:
        - ""
      resources:
        - nodes
      verbs:
        - get
    - apiGroups:
        - ""
      resources:
        - services
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - "extensions"
      resources:
        - ingresses
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - ""
      resources:
        - events
      verbs:
        - create
        - patch
    - apiGroups:
        - "extensions"
      resources:
        - ingresses/status
      verbs:
        - update
  
  ---
  apiVersion: rbac.authorization.k8s.io/v1beta1
  kind: Role
  metadata:
    name: nginx-ingress-role
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  rules:
    - apiGroups:
        - ""
      resources:
        - configmaps
        - pods
        - secrets
        - namespaces
      verbs:
        - get
    - apiGroups:
        - ""
      resources:
        - configmaps
      resourceNames:
        - "ingress-controller-leader-nginx"
      verbs:
        - get
        - update
    - apiGroups:
        - ""
      resources:
        - configmaps
      verbs:
        - create
    - apiGroups:
        - ""
      resources:
        - endpoints
      verbs:
        - get
  
  ---
  apiVersion: rbac.authorization.k8s.io/v1beta1
  kind: RoleBinding
  metadata:
    name: nginx-ingress-role-nisa-binding
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: Role
    name: nginx-ingress-role
  subjects:
    - kind: ServiceAccount
      name: nginx-ingress-serviceaccount
      namespace: ingress-nginx
  
  ---
  apiVersion: rbac.authorization.k8s.io/v1beta1
  kind: ClusterRoleBinding
  metadata:
    name: nginx-ingress-clusterrole-nisa-binding
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: nginx-ingress-clusterrole
  subjects:
    - kind: ServiceAccount
      name: nginx-ingress-serviceaccount
      namespace: ingress-nginx
  
  ---
  ```

  å…³äº `RBAC` ç›¸å…³çš„å†…å®¹ï¼Œå¯æŸ¥çœ‹ç¬¬ 8 èŠ‚ ã€Šå®‰å…¨é‡ç‚¹: è®¤è¯å’Œæˆæƒã€‹ï¼Œäº†è§£æ­¤å¤„çš„é…ç½®åŠå…¶å«ä¹‰ã€‚

- éƒ¨ç½² NGINX Ingress Controller

  ```
  apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    name: nginx-ingress-controller
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
    template:
      metadata:
        labels:
          app.kubernetes.io/name: ingress-nginx
          app.kubernetes.io/part-of: ingress-nginx
        annotations:
          prometheus.io/port: "10254"
          prometheus.io/scrape: "true"
      spec:
        serviceAccountName: nginx-ingress-serviceaccount
        containers:
          - name: nginx-ingress-controller
            image: taobeier/nginx-ingress-controller:0.21.0
            args:
              - /nginx-ingress-controller
              - --configmap=$(POD_NAMESPACE)/nginx-configuration
              - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
              - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
              - --publish-service=$(POD_NAMESPACE)/ingress-nginx
              - --annotations-prefix=nginx.ingress.kubernetes.io
            securityContext:
              capabilities:
                drop:
                  - ALL
                add:
                  - NET_BIND_SERVICE
              # www-data -> 33
              runAsUser: 33
            env:
              - name: POD_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              - name: POD_NAMESPACE
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.namespace
            ports:
              - name: http
                containerPort: 80
              - name: https
                containerPort: 443
            livenessProbe:
              failureThreshold: 3
              httpGet:
                path: /healthz
                port: 10254
                scheme: HTTP
              initialDelaySeconds: 10
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 1
            readinessProbe:
              failureThreshold: 3
              httpGet:
                path: /healthz
                port: 10254
                scheme: HTTP
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 1
  ```

  æ³¨æ„ï¼Œè¿™é‡Œçš„é•œåƒæ˜¯æˆ‘ä»å®˜æ–¹é•œåƒç›´æ¥åŒæ­¥çš„ï¼Œä¸ºäº†è§£å†³å›½å†…æ— æ³•ä¸‹è½½é•œåƒçš„æƒ…å†µã€‚

  å¦å¤–ï¼Œåœ¨å¯åŠ¨å‚æ•°ä¸­ï¼ŒæŒ‡å®šäº†æˆ‘ä»¬ç¬¬äºŒæ­¥ä¸­åˆ›å»ºçš„ `ConfigMap` ã€‚ä»¥åŠï¼Œåœ¨æ­¤éƒ¨ç½²ä¸­ï¼Œç”¨åˆ°äº†ä¹‹å‰å°šæœªè¯¦ç»†è¯´æ˜çš„ `readinessProbe` å’Œ `livenessProbe`ï¼šæˆ‘ä»¬ä¹‹å‰åœ¨è¯¦è§£ `kubelet` æ—¶ï¼Œå¤§è‡´æåˆ°è¿‡å…³äºå®ƒæ‰€å…·å¤‡çš„èŒè´£ï¼Œè¿™ä¸¤ä¸ªé…ç½®ä¸»è¦æ˜¯ç”¨äºåšæ¢é’ˆï¼Œç”¨æˆ·æ£€æŸ¥ Pod æ˜¯å¦å·²ç»å‡†å¤‡å¥½æ¥å—è¯·æ±‚æµé‡å’Œæ˜¯å¦å­˜æ´»ã€‚

  è¿™é‡Œè¿˜è¿›è¡Œäº† `annotations` é‡Œé¢æ ‡æ³¨äº†å…³äº `Prometheus` çš„ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹èŠ‚ä¸­æè¿°ã€‚

  ```
  master $ kubectl -n ingress-nginx get all
  NAME                                            READY     STATUS    RESTARTS   AGE
  pod/nginx-ingress-controller-6f647f7866-659ph   1/1       Running   0          75s
  
  NAME                                       DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
  deployment.apps/nginx-ingress-controller   1         1         1            1           75s
  
  NAME                                                  DESIRED   CURRENT   READY     AGE
  replicaset.apps/nginx-ingress-controller-6f647f7866   1         1         1         75s
  ```

  å¯ä»¥çœ‹åˆ° NGINX Ingress Controller å·²ç»éƒ¨ç½²æˆåŠŸã€‚

- **å°† NGINX Ingress Controller æš´éœ²è‡³é›†ç¾¤å¤–**

  ç»è¿‡å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ Ingress çš„ä½œç”¨åœ¨äºå°†é›†ç¾¤å¤–çš„è¯·æ±‚æµé‡è½¬å‘é›†ç¾¤å†…çš„æœåŠ¡ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ï¼Œé»˜è®¤æƒ…å†µä¸‹é›†ç¾¤å¤–å’Œé›†ç¾¤å†…æ˜¯ä¸äº’é€šçš„ï¼Œæ‰€ä»¥å¿…é¡»å°† NGINX Ingress Controller æš´éœ²è‡³é›†ç¾¤å¤–ï¼Œä»¥ä¾¿è®©å…¶èƒ½æ¥å—æ¥è‡ªé›†ç¾¤å¤–çš„è¯·æ±‚ã€‚

  å°†å…¶æš´éœ²çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æˆ‘ä»¬ä¹‹å‰å·²ç»ä»‹ç»è¿‡çš„ `NodePort` çš„æ–¹å¼ã€‚é€‰æ‹©å®ƒä¸»è¦æœ‰ä»¥ä¸‹åŸå› ï¼š

  - æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¯çš„ LB å®ç°å®ŒæˆæœåŠ¡æš´éœ²ï¼Œæ¯”å¦‚ [MetalLB](https://metallb.universe.tf/)ï¼Œä½†å®ƒè¿˜å¤„äº Beta é˜¶æ®µï¼Œå°šæœªæœ‰å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„éªŒè¯ã€‚
  - æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼Œåªéœ€è®¾ç½® `hostNetwork: true` å³å¯ï¼Œä½†è¿™ä¸ªæ–¹å¼å¯èƒ½ä¼šå¸¦æ¥å®‰å…¨é—®é¢˜ã€‚
  - æˆ‘ä»¬å¯ä»¥é€‰æ‹© External IPs çš„æ–¹å¼ï¼Œä½†è¿™ç§æ–¹å¼æ— æ³•ä¿ç•™è¯·æ±‚çš„æº IPï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¾ˆå¥½ã€‚
  - å…¶å®æˆ‘ä»¬ä¸€èˆ¬ä¼šé€‰æ‹©è‡ªå·±æä¾›è¾¹ç¼˜èŠ‚ç‚¹çš„æ–¹å¼ï¼Œä¸è¿‡è¿™ç§æ–¹å¼æ˜¯å»ºç«‹åœ¨ `NodePort` çš„æ–¹å¼ä¹‹ä¸Šï¼Œå¹¶ä¸”éœ€è¦æä¾›é¢å¤–çš„ç»„ä»¶ï¼Œæ­¤å¤„å°±æš‚ä¸åšå±•å¼€äº†ã€‚

  æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹çš„é…ç½®ï¼Œå°† NGINX Ingress Controller æš´éœ²è‡³é›†ç¾¤å¤–

  ```
  apiVersion: v1
  kind: Service
  metadata:
    name: ingress-nginx
    namespace: ingress-nginx
    labels:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  spec:
    type: NodePort
    ports:
      - name: http
        port: 80
        targetPort: 80
        protocol: TCP
      - name: https
        port: 443
        targetPort: 443
        protocol: TCP
    selector:
      app.kubernetes.io/name: ingress-nginx
      app.kubernetes.io/part-of: ingress-nginx
  ```

  åˆ›å»ºè¯¥ `Service`ã€‚

  ```
  master $ kubectl -n ingress-nginx get svc                                                  
  NAME            TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)                      AGE
  ingress-nginx   NodePort   10.0.38.53   <none>        80:30871/TCP,443:30356/TCP   11s
  ```

  ç°åœ¨ï¼Œæˆ‘ä»¬ç›´æ¥è®¿é—® `Node:Port` ä¾¿å¯è®¿é—®åˆ°è¯¥ Controllerã€‚

  ```
  master $ curl 172.17.0.3:30871                    
  <html>
  <head><title>404 Not Found</title></head>
  <body>
  <center><h1>404 Not Found</h1></center>
  <hr><center>nginx/1.15.6</center>
  </body>
  </html>
  ```

  ç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®ä»»ä½•çš„é»˜è®¤å“åº”åç«¯ï¼Œæ‰€ä»¥å½“ç›´æ¥è¯·æ±‚æ—¶ï¼Œä¾¿è¿”å› 404 ã€‚

### å®è·µ

å°†æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›® [SayThx](https://github.com/tao12345666333/saythx) é€šè¿‡ `Ingress` çš„æ–¹å¼è¿›è¡Œè®¿é—®ã€‚

è¯¥ç¤ºä¾‹é¡¹ç›®çš„éƒ¨ç½²ï¼Œä¸å†è¿›è¡Œèµ˜è¿°ã€‚å¯åœ¨ [ingress åˆ†æ”¯](https://github.com/tao12345666333/saythx/blob/ingress/deploy/ingress.yaml) æŸ¥çœ‹æ­¤å¤„æ‰€éœ€é…ç½®ã€‚

åœ¨æˆ‘ä»¬å°† NGINX Ingress Controller åŠ SayThx é¡¹ç›®éƒ¨ç½²å¥½ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹çš„é…ç½®åˆ›å»º `Ingress` èµ„æºã€‚

```
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: saythx-ing
  namespace: work
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  rules:
  - host: saythx.moelove.info
    http:
      paths:
      - path: /
        backend:
          serviceName: saythx-frontend
          servicePort: 80
```

- åˆ›å»º

  ```
  master $ kubectl apply -f ingress.yaml         
  ingress.extensions/saythx-ing created
  master $ kubectl -n work get ing
  NAME         HOSTS                 ADDRESS   PORTS     AGE
  saythx-ing   saythx.moelove.info             80        23s
  ```

- éªŒè¯

  è¿™é‡Œæ¥è§£é‡Šä¸‹åˆšæ‰çš„é…ç½®æ–‡ä»¶ã€‚é¦–å…ˆï¼ŒæŒ‡å®šäº† `host: saythx.moelove.info` è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦ä»¥ `saythx.moelove.info` è¿™ä¸ªåŸŸåæ¥è®¿é—®å®ƒã€‚`path` ç›´æ¥å†™ `/` è¡¨ç¤ºæ‰€æœ‰çš„è¯·æ±‚éƒ½è½¬å‘è‡³åä¸º `saythx-frontend` çš„æœåŠ¡ã€‚

  ä¸æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ NGINX åŸºæœ¬ä¸€è‡´ã€‚ ç°åœ¨ç¼–è¾‘æœ¬åœ°çš„ HOSTS æ–‡ä»¶ç»‘å®š Node çš„IP ä¸ `saythx.moelove.info` è¿™ä¸ªåŸŸåã€‚ä½¿ç”¨æµè§ˆå™¨è¿›è¡Œè®¿é—® `saythx.moelove.info:åˆšæ‰ Controller ä½¿ç”¨ NodePort æš´éœ²æœåŠ¡æ—¶çš„ç«¯å£`ï¼š



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1280" height="586"></svg>)



```
å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè®¿é—®ã€‚
```

## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `Ingress` çš„åŸºæœ¬æƒ…å†µï¼Œäº†è§£äº†å®ƒæ˜¯ K8S ä¸­çš„ä¸€ç§èµ„æºå¯¹è±¡ï¼Œä¸»è¦è´Ÿè´£å°†é›†ç¾¤å¤–éƒ¨æµé‡ä¸é›†ç¾¤å†…æœåŠ¡çš„é€šä¿¡ã€‚ä½†å®ƒçš„æ­£å¸¸å·¥ä½œç¦»ä¸å¼€ `Ingress Controller` ï¼Œå½“å‰å®˜æ–¹å›¢é˜Ÿç»´æŠ¤çš„ä¸»è¦æœ‰ä¸¤ä¸ª GLBC å’Œ NGINX Ingress Controllerã€‚

æˆ‘ä»¬å¤§è‡´ä»‹ç»äº†ç°æœ‰çš„ Controller å®ç°ï¼Œä¹Ÿå®è·µäº†å¦‚ä½•éƒ¨ç½² NGINX Ingress Controller ä»¥åŠå¦‚ä½•ä½¿ç”¨ Ingress å°†æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›®æš´éœ²è‡³é›†ç¾¤å¤–ã€‚

NGINX Ingress Controller çš„ä½¿ç”¨ï¼Œæ¯”è¾ƒç¬¦åˆæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ NGINX çš„ä¹ æƒ¯ï¼Œç›¸å¯¹æ¥è¯´ä¹Ÿæ¯”è¾ƒçµæ´»ï¼Œåç»­å¯çœ‹å®é™…æƒ…å†µå†è¿›è¡Œæ›´å¤šçš„å®è·µã€‚

è‡³æ­¤ï¼ŒK8S é›†ç¾¤çš„ç®¡ç†ï¼Œç›¸å…³åŸç†ä»¥åŠæœåŠ¡çš„éƒ¨ç½²ç­‰å†…å®¹å°±åŸºæœ¬ä»‹ç»å®Œæ¯•ã€‚ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç”Ÿäº§å®è·µä¸­è‡³å…³é‡è¦çš„ä¸€ç¯ **ç›‘æ§** ç›¸å…³çš„å®è·µã€‚

# ç›‘æ§å®è·µï¼šå¯¹ K8S é›†ç¾¤è¿›è¡Œç›‘æ§

## æ•´ä½“æ¦‚è§ˆ

é€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯¹ K8S æœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œä¹Ÿå…·å¤‡äº†ä¸€å®šçš„é›†ç¾¤ç®¡ç†å’Œæ’é”™èƒ½åŠ›ã€‚ä½†å¦‚æœè¦åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸å¯èƒ½éšæ—¶éšåœ°çš„éƒ½ç›¯ç€é›†ç¾¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬å¯¹é›†ç¾¤çš„æ„ŸçŸ¥èƒ½åŠ›ã€‚

æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸‹ K8S é›†ç¾¤ç›‘æ§ç›¸å…³çš„å†…å®¹ã€‚

## ç›‘æ§ä»€ä¹ˆ

é™¤å» K8S å¤–ï¼Œæˆ‘ä»¬å¹³æ—¶è‡ªå·±å¼€å‘çš„ç³»ç»Ÿæˆ–è€…è´Ÿè´£çš„é¡¹ç›®ï¼Œä¸€èˆ¬éƒ½æ˜¯æœ‰ç›‘æ§çš„ã€‚ç›‘æ§å¯ä»¥æå‡æˆ‘ä»¬çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œä¾¿äºæˆ‘ä»¬åŠæ—¶äº†è§£é›†ç¾¤çš„å˜åŒ–ï¼Œä»¥åŠçŸ¥é“å“ªé‡Œå‡ºç°äº†é—®é¢˜ã€‚

K8S æ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç»„ä»¶å¾ˆå¤šï¼Œé‚£ä¹ˆç›‘æ§çš„ç›®æ ‡ï¼Œå°±å˜çš„å¾ˆé‡è¦äº†ã€‚

æ€»ä½“æ¥è®²ï¼Œå¯¹ K8S é›†ç¾¤çš„ç›‘æ§çš„è¯ï¼Œä¸»è¦æœ‰ä»¥ä¸‹æ–¹é¢ï¼š

- èŠ‚ç‚¹æƒ…å†µ
- K8S é›†ç¾¤è‡ªèº«çŠ¶æ€
- éƒ¨ç½²åœ¨ K8S å†…çš„åº”ç”¨çš„çŠ¶æ€

## Prometheus

å¯¹äº K8S çš„ç›‘æ§ï¼Œæˆ‘ä»¬é€‰æ‹© CNCF æ——ä¸‹æ¬¡äº K8S æ¯•ä¸šçš„é¡¹ç›®[ Prometheus ](https://prometheus.io/)ã€‚

Prometheus æ˜¯ä¸€ä¸ªéå¸¸çµæ´»æ˜“äºæ‰©å±•çš„ç›‘æ§ç³»ç»Ÿï¼Œå®ƒé€šè¿‡å„ç§ `exporter` æš´éœ²æ•°æ®ï¼Œå¹¶ç”± `prometheus server` å®šæ—¶å»æ‹‰æ•°æ®ï¼Œç„¶åå­˜å‚¨ã€‚

å®ƒè‡ªå·±æä¾›äº†ä¸€ä¸ªç®€å•çš„å‰ç«¯ç•Œé¢ï¼Œå¯åœ¨å…¶ä¸­ä½¿ç”¨ [PromQL ](https://prometheus.io/docs/prometheus/latest/querying/basics/)çš„è¯­æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶è¿›è¡Œå›¾å½¢åŒ–å±•ç¤ºã€‚

## å®‰è£… Prometheus

> è¿™é‡Œæ¨èä¸€ä¸ªé¡¹ç›® [Prometheus Operator](https://github.com/coreos/prometheus-operator), å°½ç®¡è¯¥é¡¹ç›®è¿˜å¤„äº Beta é˜¶æ®µï¼Œä½†æ˜¯å®ƒç»™åœ¨ K8S ä¸­æ­å»ºåŸºäº Prometheus çš„ç›‘æ§æä¾›äº†å¾ˆå¤§çš„ä¾¿åˆ©ã€‚

æˆ‘ä»¬æ­¤å¤„é€‰æ‹©ä»¥ä¸€èˆ¬çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œå¸¦ä½ äº†è§£å…¶æ•´ä½“çš„è¿‡ç¨‹ã€‚

- åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ `Namespace`ï¼š

  ```
  apiVersion: v1
  kind: Namespace
  metadata:
    name: monitoring
  
  # å°†æ–‡ä»¶ä¿å­˜ä¸º namespace.yaml çš„æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œ kubectl apply -f namespace.yaml å³å¯ï¼Œåé¢ä¸å†èµ˜è¿°ã€‚
  ```

  ```
  master $ kubectl apply -f namespace.yaml
  namespace/monitoring created
  ```

- RBAC

  æˆ‘ä»¬çš„é›†ç¾¤ä½¿ç”¨ `kubeadm` åˆ›å»ºï¼Œé»˜è®¤å¼€å¯äº† `RBAC`ï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦åˆ›å»ºç›¸å…³çš„ Role å’Œ bindingã€‚

  ```
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRoleBinding
  metadata:
    name: prometheus
  roleRef:
    apiGroup: rbac.authorization.k8s.io
    kind: ClusterRole
    name: prometheus
  subjects:
  - kind: ServiceAccount
    name: prometheus-k8s
    namespace: monitoring
  ---
  apiVersion: rbac.authorization.k8s.io/v1
  kind: ClusterRole
  metadata:
    name: prometheus
  rules:
  - apiGroups: [""]
    resources:
    - nodes
    - nodes/proxy
    - services
    - endpoints
    - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources:
    - configmaps
    verbs: ["get"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
  ---
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: prometheus-k8s
    namespace: monitoring
  ```

  æ‰§è¡Œåˆ›å»º

  ```
  master $ kubectl  apply -f rbac.yaml
  clusterrolebinding.rbac.authorization.k8s.io/prometheus created
  clusterrole.rbac.authorization.k8s.io/prometheus created
  serviceaccount/prometheus-k8s created
  ```

- åˆ›å»º Promethes çš„é…ç½®æ–‡ä»¶

  å…¶ä¸­çš„å†…å®¹ä¸»è¦å‚è€ƒ [Prometheus å®˜æ–¹æä¾›çš„ç¤ºä¾‹](https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml) å’Œ [Prometheus å®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config)ã€‚

  ```
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: prometheus-core
    namespace: monitoring
  data:
    prometheus.yaml: |
      global:
        scrape_interval: 30s
        scrape_timeout: 30s
      scrape_configs:
      - job_name: 'kubernetes-apiservers'
      
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
      
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      # Scrape config for nodes (kubelet).
      - job_name: 'kubernetes-nodes'
        scheme: https
      
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      
        kubernetes_sd_configs:
        - role: node
      
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics
      
      # Scrape config for Kubelet cAdvisor.
      - job_name: 'kubernetes-cadvisor'
      
        scheme: https
      
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      
        kubernetes_sd_configs:
        - role: node
      
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
      
      - job_name: 'kubernetes-service-endpoints'
      
        kubernetes_sd_configs:
        - role: endpoints
      
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_service_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_service_name]
          action: replace
          target_label: kubernetes_name
      
      - job_name: 'kubernetes-services'
      
        metrics_path: /probe
        params:
          module: [http_2xx]
      
        kubernetes_sd_configs:
        - role: service
      
        relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - target_label: __address__
          replacement: blackbox-exporter.example.com:9115
        - source_labels: [__param_target]
          target_label: instance
        - action: labelmap
          regex: __meta_kubernetes_service_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_service_name]
          target_label: kubernetes_name
      
      - job_name: 'kubernetes-ingresses'
      
        metrics_path: /probe
        params:
          module: [http_2xx]
      
        kubernetes_sd_configs:
        - role: ingress
      
        relabel_configs:
        - source_labels: [__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]
          regex: (.+);(.+);(.+)
          replacement: ${1}://${2}${3}
          target_label: __param_target
        - target_label: __address__
          replacement: blackbox-exporter.example.com:9115
        - source_labels: [__param_target]
          target_label: instance
        - action: labelmap
          regex: __meta_kubernetes_ingress_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_ingress_name]
          target_label: kubernetes_name
      
      - job_name: 'kubernetes-pods'
      
        kubernetes_sd_configs:
        - role: pod
      
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name
  ```

- éƒ¨ç½² Prometheus

  ```
  apiVersion: extensions/v1beta1
  kind: Deployment
  metadata:
    name: prometheus-core
    namespace: monitoring
    labels:
      app: prometheus
      component: core
  spec:
    replicas: 1
    template:
      metadata:
        name: prometheus-main
        labels:
          app: prometheus
          component: core
      spec:
        serviceAccountName: prometheus-k8s
        containers:
        - name: prometheus
          image: taobeier/prometheus:v2.6.0
          args:
            - '--storage.tsdb.retention=24h'
            - '--storage.tsdb.path=/prometheus'
            - '--config.file=/etc/prometheus/prometheus.yaml'
          ports:
          - name: webui
            containerPort: 9090
          resources:
            requests:
              cpu: 500m
              memory: 500M
            limits:
              cpu: 500m
              memory: 500M
          volumeMounts:
          - name: data
            mountPath: /prometheus
          - name: config-volume
            mountPath: /etc/prometheus
        volumes:
        - name: data
          emptyDir: {}
        - name: config-volume
          configMap:
            name: prometheus-core
  ```

- æŸ¥çœ‹éƒ¨ç½²æƒ…å†µ

  ```
  master $ kubectl  -n monitoring get all
  NAME                                   READY     STATUS    RESTARTS   AGE
  pod/prometheus-core-86b8455f76-mvrn4   1/1       Running   0          12s
  
  NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
  deployment.apps/prometheus-core   1         1         1            1           12s
  
  NAME                                         DESIRED   CURRENT   READY     AGE
  replicaset.apps/prometheus-core-86b8455f76   1         1         1         12s
  ```

  Prometheus çš„ä¸»ä½“å°±å·²ç»éƒ¨ç½²å®Œæˆã€‚

- ä½¿ç”¨ `Service` å°† `Promethes` çš„æœåŠ¡æš´éœ²å‡ºæ¥

  ```
  apiVersion: v1
  kind: Service
  metadata:
    labels:
      app: prometheus
      component: core
    name: prometheus
    namespace: monitoring
  spec:
    ports:
    - protocol: TCP
      port: 9090
      targetPort: 9090
    selector:
      app: prometheus
      component: core
    type: NodePort
  ```

  è¿™é‡Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œç›´æ¥ä½¿ç”¨äº† `NodePort` çš„æ–¹å¼æš´éœ²æœåŠ¡ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å‚è€ƒä¸Šä¸€èŠ‚ï¼Œä½¿ç”¨ `Ingress` çš„æ–¹å¼å°†æœåŠ¡æš´éœ²å‡ºæ¥ã€‚

- æŸ¥è¯¢å½“å‰çŠ¶æ€

  æˆ‘ä»¬ä½¿ç”¨ Promethes è‡ªå¸¦çš„ PromQL è¯­æ³•ï¼ŒæŸ¥è¯¢åœ¨å½“å‰ `monitoring` Namespace ä¸­ up çš„ä»»åŠ¡ã€‚è¿™é‡Œå¯¹æŸ¥è¯¢çš„ç»“æœæš‚ä¸è¿›è¡Œå±•å¼€ã€‚



![img](data:image/svg+xml;utf8,<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1275" height="766"></svg>)



## å®‰è£… Node exporter

æˆ‘ä»¬åˆšæ‰åœ¨ä»‹ç»æ—¶ï¼Œæåˆ°è¿‡ `Promethes` æ”¯æŒå¤šç§ `exporter` æš´éœ²æŒ‡æ ‡ã€‚æˆ‘ä»¬ç°åœ¨ä½¿ç”¨ [Node exporter](https://github.com/prometheus/node_exporter) å®Œæˆå¯¹é›†ç¾¤ä¸­æœºå™¨çš„åŸºç¡€ç›‘æ§ã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„ç‚¹ï¼š

- ä½¿ç”¨ä»€ä¹ˆæ–¹å¼éƒ¨ç½² Node exporter ï¼Ÿ

  Node exporter æœ‰å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œéƒ¨ç½²ã€‚å½“æˆ‘ä»¬è¦ç›‘æ§é›†ç¾¤ä¸­æ‰€æœ‰çš„æœºå™¨æ—¶ï¼Œæˆ‘ä»¬æ˜¯è¯¥å°†å®ƒç›´æ¥éƒ¨ç½²åœ¨æœºå™¨ä¸Šï¼Œè¿˜æ˜¯éƒ¨ç½²åœ¨é›†ç¾¤å†…ï¼Ÿ

  æˆ‘å»ºè®®æ˜¯ç›´æ¥éƒ¨ç½²åœ¨é›†ç¾¤å†…ï¼Œä½¿ç”¨ `DaemonSet` çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ã€‚è¿™é‡Œçš„è€ƒè™‘æ˜¯å½“æˆ‘ä»¬ç›´æ¥éƒ¨ç½²åœ¨å®¿ä¸»æœºä¸Šæ—¶ï¼Œæˆ‘ä»¬æœ€èµ·ç éœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š1. Promethes æœåŠ¡å¯ä¸å®ƒæ­£å¸¸é€šä¿¡ï¼ˆPromethes é‡‡ç”¨ Pull çš„æ–¹å¼é‡‡é›†æ•°æ®ï¼‰ ï¼›2. éœ€è¦æœåŠ¡ä¿æ´»ï¼Œå¦‚æœ exporter æŒ‚æ‰äº†ï¼Œé‚£è‡ªç„¶å°±å–ä¸åˆ°æ•°æ®ã€‚

  `DaemonSet` æ˜¯ä¸€ç§å¾ˆåˆé€‚çš„çš„éƒ¨ç½²æ–¹å¼ï¼Œå¯ç›´æ¥å°† Node exporter éƒ¨ç½²è‡³é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šã€‚

- åˆ›å»º `DaemonSet`

  ```
  apiVersion: extensions/v1beta1
  kind: DaemonSet
  metadata:
    name: prometheus-node-exporter
    namespace: monitoring
    labels:
      app: prometheus
      component: node-exporter
  spec:
    template:
      metadata:
        name: prometheus-node-exporter
        labels:
          app: prometheus
          component: node-exporter
      spec:
        tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
        containers:
        - image: taobeier/node-exporter:v0.17.0
          name: prometheus-node-exporter
          ports:
          - name: prom-node-exp
            containerPort: 9100
            hostPort: 9100
        hostNetwork: true
        hostPID: true
  ```

- è®© Promethes æŠ“å–æ•°æ®

  ```
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      prometheus.io/scrape: 'true'
    name: prometheus-node-exporter
    namespace: monitoring
    labels:
      app: prometheus
      component: node-exporter
  spec:
    clusterIP: None
    ports:
      - name: prometheus-node-exporter
        port: 9100
        protocol: TCP
    selector:
      app: prometheus
      component: node-exporter
    type: ClusterIP
  ```

  è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨äº†æ·»åŠ  `annotations` çš„æ–¹å¼ï¼Œè®© Promethes è‡ªåŠ¨çš„é€šè¿‡ Kubernetes SD å‘ç°æˆ‘ä»¬æ–°æ·»åŠ çš„ exporter ï¼ˆæˆ–è€…è¯´èµ„æºï¼‰

  æˆ‘ä»¬è®¿é—® Promethes çš„ web ç«¯ï¼Œè¿›è¡ŒéªŒè¯ã€‚



![img](https://user-gold-cdn.xitu.io/2018/12/24/167df6106b58b2fb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## æ€»ç»“

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† `Prometheus` çš„åŸºæœ¬æƒ…å†µï¼Œä¹Ÿéƒ¨ç½²äº† `Prometheus` çš„ä¸»ä½“æœåŠ¡ã€‚

ä½†è¿™æ˜¯ç»“æŸä¹ˆï¼Ÿè¿™å¹¶ä¸æ˜¯ï¼Œè¿™æ‰åˆšåˆšå¼€å§‹ã€‚

æˆ‘ä»¬æåˆ° `Prometheus` æ”¯æŒå¤šç§ `exporter` æš´éœ²å„ç§æŒ‡æ ‡ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ [Grafana](https://grafana.com/) ä½œä¸ºæˆ‘ä»¬ç›‘æ§çš„å±•ç¤ºæ‰‹æ®µã€‚

å¦‚æœè¦åš Dashboard æ¨èä½¿ç”¨ [Kubernetes cluster monitoring (via Prometheus)](https://grafana.com/dashboards/162) ã€‚

å¦å¤–ï¼Œç›‘æ§å…¶å®æ¶‰åŠçš„å†…å®¹å¾ˆå¤šï¼ŒåŒ…æ‹¬æ•°æ®æŒä¹…åŒ–æ–¹å¼ã€‚ä»¥åŠæ˜¯å¦è€ƒè™‘ä¸é›†ç¾¤å¤–çš„ Prometheus é›†ç¾¤åšé‚¦è”æ¨¡å¼ç­‰ã€‚è¿™é‡Œéœ€è¦è€ƒè™‘çš„å®é™…æƒ…å†µè¾ƒå¤šï¼Œæš‚ä¸ä¸€ä¸€å±•å¼€äº†ã€‚

Prometheus å·²ç»ä» CNCF æ¯•ä¸šï¼Œå…¶åœ¨äº‘åŸç”Ÿæ—¶ä»£ä¸‹ä½œä¸ºæ ‡å‡†çš„ç›‘æ§æŠ€æœ¯æ ˆä¹ŸåŸºæœ¬ç¡®ç«‹ã€‚è‡³äºåº”ç”¨ç›‘æ§ï¼Œä¹Ÿå¯ä½¿ç”¨å®ƒçš„ SDK æ¥å®Œæˆã€‚

ä¸‹èŠ‚ï¼Œæˆ‘ä»¬å°†å¯¹æœ¬å°å†Œè¿›è¡Œä¸€æ¬¡æ€»ç»“ã€‚

# æ€»ç»“

## å¿«é€Ÿå›é¡¾

ç»è¿‡äº†å‰é¢ 23 èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬ä» K8S çš„åŸºç¡€æ¦‚å¿µå…¥æ‰‹ï¼Œé€šè¿‡å…¶åŸºç¡€æ¶æ„äº†è§£åˆ°äº† K8S ä¸­æ‰€æ¶‰åŠåˆ°çš„å„ç±»ç»„ä»¶ã€‚

é€šè¿‡åŠ¨æ‰‹å®è·µï¼Œä½¿ç”¨ `minikube` æ­å»ºäº†æœ¬åœ°çš„é›†ç¾¤ï¼Œä½¿ç”¨ `kubeadm` å®Œæˆäº†æœåŠ¡å™¨ä¸Šçš„é›†ç¾¤æ­å»ºï¼Œå¯¹ K8S çš„éƒ¨ç½²æœ‰äº†æ›´åŠ æ¸…æ™°çš„è®¤è¯†ã€‚

è¿™é‡Œå†æ¨èå¦ä¸€ç§æ­£åœ¨å¿«é€Ÿè¿­ä»£çš„æ–¹å¼ [Kubernetes In Docker](https://github.com/kubernetes-sigs/kind) å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ›å»ºå»‰ä»·çš„ K8S é›†ç¾¤ï¼Œç›®å‰è‡³æ”¯æŒå•èŠ‚ç‚¹é›†ç¾¤ï¼Œå¤šèŠ‚ç‚¹æ”¯æŒæ­£åœ¨å¼€å‘ä¸­ã€‚

åé¢ï¼Œæˆ‘ä»¬é€šè¿‡å­¦ä¹  `kubectl` çš„ä½¿ç”¨ï¼Œéƒ¨ç½²äº† Redis æœåŠ¡ï¼Œäº†è§£åˆ°äº†ä¸€ä¸ªæœåŠ¡åœ¨ K8S ä¸­éƒ¨ç½²çš„æ“ä½œï¼Œä»¥åŠå¦‚ä½•å°†æœåŠ¡æš´éœ²è‡³é›†ç¾¤å¤–ï¼Œä»¥ä¾¿è®¿é—®ã€‚

å½“é›†ç¾¤çœŸæ­£è¦è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæƒé™ç®¡æ§ä¹Ÿæ„ˆå‘é‡è¦ï¼Œæˆ‘ä»¬é€šè¿‡å­¦ä¹  `RBAC` çš„ç›¸å…³çŸ¥è¯†ï¼Œå­¦ä¹ åˆ°äº†å¦‚ä½•åœ¨ K8S é›†ç¾¤ä¸­åˆ›å»ºæƒé™å¯æ§çš„ç”¨æˆ·ï¼Œè€Œè¿™éƒ¨åˆ†çš„å†…å®¹åœ¨åç»­å°èŠ‚ä¸­ä¹Ÿè¢«é¢‘ç¹ç”¨åˆ°ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»¥æˆ‘ä»¬å®é™…çš„ä¸€ä¸ªé¡¹ç›® [SayThx](https://github.com/tao12345666333/saythx) ä¸ºä¾‹ï¼Œä¸€æ­¥æ­¥çš„å®Œæˆäº†é¡¹ç›®çš„éƒ¨ç½²ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¹Ÿå­¦ä¹ åˆ°äº†é…ç½®æ–‡ä»¶çš„ç¼–å†™è§„èŒƒå’Œè¦æ±‚ã€‚

å½“é¡¹ç›®å˜å¤§æ—¶ï¼Œç»´æŠ¤é¡¹ç›®çš„æ›´æ–°ä¹Ÿå˜æˆäº†ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¼•å…¥äº† `Helm` ä½œä¸ºæˆ‘ä»¬çš„åŒ…ç®¡ç†è½¯ä»¶ï¼Œå¹¶ä½¿ç”¨å®ƒè¿›è¡Œäº†é¡¹ç›®çš„éƒ¨ç½²ã€‚

åœ¨æ­¤è¿‡ç¨‹ä¸­ä¹Ÿå­¦ä¹ åˆ°äº† Helm çš„æ¶æ„ï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ä¸€ä¸ª `Chart` ç­‰çŸ¥è¯†ã€‚

å‰é¢æˆ‘ä»¬ä¸»è¦é›†ä¸­äºå¦‚ä½•ä½¿ç”¨ K8S ä¸Šï¼Œæ¥ä¸‹äº†åº–ä¸è§£ç‰›ç³»åˆ—ä¾¿å¸¦æˆ‘ä»¬ä¸€åŒæ·±å…¥è‡³ K8S å†…éƒ¨ï¼Œäº†è§£åˆ°äº†å„åŸºç¡€ç»„ä»¶çš„å®é™…å·¥ä½œåŸç†ï¼Œä¹Ÿæ·±å…¥åˆ°äº†æºç å†…éƒ¨ï¼Œäº†è§£å…¶å®ç°é€»è¾‘ã€‚

æœ‰è¿™äº›ç†è®ºçŸ¥è¯†ä½œä¸ºåŸºç¡€ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¤§èƒ†çš„å°†åº”ç”¨éƒ¨ç½²è‡³ K8S ä¹‹ä¸Šäº†ã€‚ä½†å®é™…ç¯å¢ƒå¯èƒ½å¤šç§å¤šæ ·ï¼Œä½ å¯ä»¥ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ã€‚

è¿™é‡Œæˆ‘ä»¬ä»‹ç»äº†ä¸€äº›å¸¸è§çš„ Troubleshoot çš„æ–¹æ³•ï¼Œä»¥ä¾¿ä½ åœ¨åç»­ä½¿ç”¨ K8S çš„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ä¹Ÿå¯ä»¥å¿«é€Ÿçš„å®šä½å¹¶è§£å†³é—®é¢˜ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å­¦ä¹ äº† K8S çš„ä¸€äº›æ‰©å±•ï¼Œæ¯”å¦‚ Dashboard å’Œ CoreDNS ï¼Œ Dashboard æ˜¯ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„ç®¡ç†èµ„æºçš„æ–¹å¼ï¼Œå®ƒä¹Ÿè¿˜åœ¨å¿«é€Ÿçš„å‘å±•å’Œè¿­ä»£ä¸­ã€‚

CoreDNS åœ¨ K8S 1.13 ä¸­å·²ç»æˆä¸ºé»˜è®¤çš„ DNS æœåŠ¡å™¨ï¼Œç›¸ä¿¡åœ¨ä¸ä¹…ä¹‹åï¼Œ CoreDNS ä¹Ÿå°†ä¼šä» CNCF æ¯•ä¸šã€‚

æˆ‘ä»¬ä»‹ç»äº† `Ingress` å’Œåœ¨ K8S ä¸­ä½¿ç”¨ `Promethes` è¿›è¡Œç›‘æ§ï¼Œä¸è¿‡ç›‘æ§æ¶‰åŠçš„æ–¹é¢å¾ˆå¤šï¼Œé™¤äº†é›†ç¾¤è‡ªèº«çš„ç›‘æ§å¤–ï¼Œåº”ç”¨å±‚çš„ç›‘æ§ä¹ŸåŒæ ·å¾ˆé‡è¦ã€‚å¦å¤–ï¼Œç›‘æ§å’Œå‘Šè­¦ä¹Ÿæ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œåœ¨å·²æœ‰ç›‘æ§æ•°æ®çš„å‰æä¸‹ï¼Œå¦‚ä½•æ›´æ™ºèƒ½æ›´ä¼˜é›…çš„å‘Šè­¦ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„ç‚¹ã€‚å¦åˆ™ï¼Œå¾ˆå®¹æ˜“é€ æˆå‘Šè­¦é£æš´ï¼Œæœ‰ç”¨çš„å‘Šè­¦è¢«å¿½ç•¥ä¹‹ç±»çš„ã€‚

## æ‰©å±•é˜…è¯»

åŸºäº K8S çš„ç”Ÿæ€å·²ç»åœ¨é€æ­¥å½¢æˆï¼Œåªé ä¸€æœ¬å°å†Œè¿˜è¿œè¿œä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„å¯¹æ“ä½œç³»ç»Ÿçš„äº†è§£ï¼Œå¯¹ K8S åŠå…¶ç”Ÿæ€çš„äº†è§£ã€‚

ä»¥ä¸‹æ¨èä¸€äº›æ‰©å±•é˜…è¯»ï¼š

- [K8S ç”Ÿæ€](https://zhuanlan.zhihu.com/container)
- [K8S ç½‘ç«™](https://kubernetes.io/)
- [CNCF åšå®¢](https://www.cncf.io/newsroom/blog/)
- [K8S ç»„ç»‡](https://github.com/kubernetes/)
- [Docker æ–‡æ¡£](https://docs.docker.com/)
- [Promethes æ–‡æ¡£](https://prometheus.io/docs/introduction/overview/)
- [Grafana ä¸»é¡µ](https://grafana.com/)
- [Fluentd ä¸»é¡µ](https://www.fluentd.org/)

## æ€»ç»“

å›´ç»• K8S çš„äº‘åŸç”Ÿç”Ÿæ€å·²ç»é€æ­¥å½¢æˆï¼Œå¸Œæœ›æœ¬å°å†Œèƒ½åœ¨ä½ æœªæ¥å‘å±•é“è·¯ä¸Šèµ·åˆ°ä¸€å®šçš„å¸®åŠ©ã€‚

K8S æ¶‰åŠçš„çŸ¥è¯†é¢å¾ˆå¹¿ï¼Œå°å†Œä¸­ç¯‡å¹…æœ‰é™æœªèƒ½ä¸€ä¸€è¯¦è§£ï¼Œæ¬¢è¿å¤§å®¶å…±åŒè®¨æ¢ã€‚










