# 数仓介绍

## 概念

数据仓库(DataWarehouse)是为企业所有决策制定过程，促供所有系统数据支持的战略集合。通过对数据仓库中数据的分析可以帮助企业，改进业务程、控制成本、提高产品质量等。数据仓库，并不是数据的最终目的地，而是为数据最终的目的地做好准。这些准条包括对数据的：清洗转义，分类，重组：合并，拆分，统计等等。

![](https://user-gold-cdn.xitu.io/2020/6/28/172f8d626d2d6145?w=494&h=308&f=png&s=13939)



## 项目需求

一、项目需求

1、数据采集平台搭建

2、用户行为数据仓库分层搭建

3、业务数据仓库分层搭建

4、针对数据仓库中的数据进行， 留存、转化率、GMV、复购率、活跃等报表分析

二、思考题

1、项目技术选型?

2、框架版本选型(Apache、CDH、HDP)？

3、服务器使用物理机还是云主机?

4、确认集群规模?(假设每台服务器8T硬盘)

## 技术选型

数据采集传输：Flume，Kafka， Sqoop， Log stash， DataX，

数据存储：MySql， HDFS， HBase，Redis，MongoDB

数据计算：Hive， Tez，Spark，Flink， Storm

数据查询：Presto，Druid，Impala，Kylin

## 系统数据流程

Web/业务服务器业务交互数据：业务流程中产生的登录、订单、用户、App(Spring boo)业务日志数据(后瑞埋点数据)Ng in x商品、支付等相关的数据，通常存储在DB中，包括业务Mysql、Oracle等。

埋点用户行为数据：用户在使用产品过程中.与客户编产品交互SparkS tH base视化过程中产生的数据.比如页面浏览、点击、停留、评论、点赞、reaming收藏等。

![](https://user-gold-cdn.xitu.io/2020/6/28/172fb15e46619661?w=887&h=406&f=png&s=54214)

## 框架版本

(1) Apache：运维麻烦，组件间兼容性需要自己调研。(一般大厂使用，技术实力雄厚，有专业的运维人员)

(2) CDH：国内使用最多的版本， 但CM不开源， 但其实对中、小公司使用来说没有影响(建议使用)

(3) HDP；开源， 可以进行二次开发， 但是没有CDH稳定， 国内使用较少

## 具体版本型号

注意：下面所有产品的版本除了

(1) Apache框架版本产品版本

| 产品                                   | 版本     |
| -------------------------------------- | -------- |
| <span style='color:red;'>hadoop</span> | 2.7.2    |
| <span style='color:red;'>flume</span>  | 1.7.0    |
| kafka                                  | 0.11.0.2 |
| <span style='color:red;'>hive</span>   | 1.2.1    |
| sqoop                                  | 1.4.6    |
| zookeeper                              | 3.4.10   |
| java                                   | 1.8      |
| azkaban                                | 2.5.0    |
| presto                                 | 0.189    |
| mysql                                  | 5.6.24   |

(2) CDH框架版本

| 产品                                   | 版本  |
| -------------------------------------- | ----- |
| <span style='color:red;'>hadoop</span> | 2.6.0 |
| <span style='color:red;'>flume</span>  | 1.6.0 |
| <span style='color:red;'>spark</span>  | 1.6.0 |
| <span style='color:red;'>hive</span>   | 1.1.0 |
| sqoop                                  | 1.4.6 |
| zookeeper                              | 3.4.5 |
| oozie                                  | 4.1.0 |
| impala                                 | 2.9.0 |

注意事项：框架选型尽量不要选择最新的框架，选择最新框架半年前左右的稳定版。

## 服务器选型

选择物理机还是云主机?

1)机器成本考虑：物理机：以128G内存， 20核物理CPU， 40线程，8THDD和2TSSD硬盘， 戴尔品牌单台报价4W出头，需考虑托管服务器费用。一般物理机寿命5年左右；云主机，以阿里云为例，差不多相同配置，每年5W。

2)运维成本考虑：物理机：需要有专业的运维人员；云主机：很多运维工作都由阿里云完成，运维相对较轻松。

## 集群资源规划

1）如何确认集群规模？(假设：每台服务器8T磁盘，128G内存)

(1)每天日活跃用户100万，每人一天平均100条：100万*100条=10000万条*

(2)每条日志1K左右，每天1亿条：100000000/1024/1024=约100G

(3)半年内不扩容服务器来算：100G\*180天=约18T

(4)保存3副本：18T\*3=54T

(5)预留20%~30%Buf=54T/0.7=77T

(6)算到：约8T\*10台服务器

2）如果考虑数仓分层，服务器将近再扩容1-2倍，讲完数仓后详解。

3）测试集群服务器规划

| 服务名称           | 子服务                | 服务器  hadoop102 | 服务器  hadoop103 | 服务器  hadoop104 |
| ------------------ | --------------------- | ----------------- | ----------------- | ----------------- |
| HDFS               | NameNode              | √                 |                   |                   |
|                    | DataNode              | √                 | √                 | √                 |
|                    | SecondaryNameNode     |                   |                   | √                 |
| Yarn               | NodeManager           | √                 | √                 | √                 |
|                    | Resourcemanager       |                   | √                 |                   |
| Zookeeper          | Zookeeper Server      | √                 | √                 | √                 |
| Flume(采集日志)    | Flume                 | √                 | √                 |                   |
| Kafka              | Kafka                 | √                 | √                 | √                 |
| Flume（消费Kafka） | Flume                 |                   |                   | √                 |
| Hive               | Hive                  | √                 |                   |                   |
| MySQL              | MySQL                 | √                 |                   |                   |
| Sqoop              | Sqoop                 | √                 |                   |                   |
| Presto             | Coordinator           | √                 |                   |                   |
|                    | Worker                |                   | √                 | √                 |
| Azkaban            | AzkabanWebServer      | √                 |                   |                   |
|                    | AzkabanExecutorServer | √                 |                   |                   |
| Druid              | Druid                 | √                 | √                 | √                 |
| 服务数总计         |                       | 13                | 8                 | 9                 |

## 数仓分层

概念

ODS(Operation Data Store)原始数据层：存放原始数据， 直接加载原始日志、数据， 数据保原貌不做处理。

DWD(data warehouse detail)明细数据层：结构和粒度与原始表保持一致， 对ODS层数据进行清洗(去除空值， 脏数据，明田数据层超过极限范围的数据)。也有称呼为为DWI。

DWS(data warehouse service)服务数据层：以DWD为基础， 进行轻度汇总。一般聚集到以用户当日， 设备当日， 商家当日， 商品当日等等的粒度。在这层通常会有以某一个维度为线索，组成跨主题的宽表，比如，一个用户的当日的签到数、收藏数、评论数、抽奖数、订阅数、点赞数、浏览商品数、添加购物车数、下单数、支付数、退款数、点击广告数组成的多列表。

ADS(Applicaton Data Store)数据应用层： 为各种统计报表提供数据。也有别称为App层、DM层。

分层目的

1)把复杂问题单化：将一个复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单、并且方便定位问题。

2)减少重复开发：规范数据分层，通过的中间层数据，能够减少极大的重复计算，增加一次计算结果的复用性。

3)隔离原始数据：不论是数据的异常还是数据的敏感性，便真实数据与统计数据解耦。

数据集市与数据仓库概念

![](https://user-gold-cdn.xitu.io/2020/7/2/1730d434871f468e?w=1101&h=532&f=png&s=187623)

数仓命名规范
ODS层命名为ods
DWD层命名为dwd
DWS层命名为dws
ADS层命名为ads
临时表数据库命名为xxx_tmp
备份数据数据库命名为xxx_bak